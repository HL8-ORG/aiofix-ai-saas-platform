# é€šçŸ¥æ¨¡å—æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ

## æ–‡æ¡£æ¦‚è¿°

- **é¡¹ç›®åç§°**: Aiofix AI SAASå¹³å° - é€šçŸ¥æ¨¡å—æŠ€æœ¯è®¾è®¡
- **æ–‡æ¡£ç‰ˆæœ¬**: V2.0
- **æ’°å†™äºº**: AIå¼€å‘å›¢é˜Ÿ
- **æœ€åæ›´æ–°æ—¥æœŸ**: 2024-01-01
- **ç›®æ ‡è¯»è€…**: æ¶æ„å¸ˆã€å¼€å‘å·¥ç¨‹å¸ˆã€æµ‹è¯•å·¥ç¨‹å¸ˆ

## ğŸ“‹ ç›®å½•å¯¼èˆª

### 1. æ¶æ„è®¾è®¡

- [1.1 è®¾è®¡åŸåˆ™](#11-è®¾è®¡åŸåˆ™)
- [1.2 ä»£ç ç»„ç»‡æ¶æ„å›¾](#12-ä»£ç ç»„ç»‡æ¶æ„å›¾)
- [1.3 å­é¢†åŸŸåˆ’åˆ†ç­–ç•¥](#13-å­é¢†åŸŸåˆ’åˆ†ç­–ç•¥)
- [1.4 äº‹ä»¶é©±åŠ¨ç­–ç•¥](#14-äº‹ä»¶é©±åŠ¨ç­–ç•¥)
- [1.5 åŒ…ç»“æ„è®¾è®¡](#15-åŒ…ç»“æ„è®¾è®¡)
  - [1.5.1 ç‹¬ç«‹åŒ…ç»“æ„](#151-ç‹¬ç«‹åŒ…ç»“æ„)
  - [1.5.2 åŒ…ä¾èµ–å…³ç³»](#152-åŒ…ä¾èµ–å…³ç³»)
  - [1.5.3 åŒ…ç®¡ç†ç­–ç•¥](#153-åŒ…ç®¡ç†ç­–ç•¥)
  - [1.5.4 å‘½åçº¦å®š](#154-å‘½åçº¦å®š)
  - [1.5.5 åŒ…é…ç½®ç¤ºä¾‹](#155-åŒ…é…ç½®ç¤ºä¾‹)

### 2. é¢†åŸŸæ¨¡å‹è®¾è®¡

- [2.1 ç«™å†…ä¿¡å­é¢†åŸŸ](#21-ç«™å†…ä¿¡å­é¢†åŸŸ)
  - [2.1.1 InAppNotif (ç«™å†…é€šçŸ¥èšåˆæ ¹)](#211-inappnotif-ç«™å†…é€šçŸ¥èšåˆæ ¹)
- [2.2 é‚®ä»¶é€šçŸ¥å­é¢†åŸŸ](#22-é‚®ä»¶é€šçŸ¥å­é¢†åŸŸ)
  - [2.2.1 EmailNotif (é‚®ä»¶é€šçŸ¥èšåˆæ ¹)](#221-emailnotif-é‚®ä»¶é€šçŸ¥èšåˆæ ¹)
  - [2.2.2 EmailTemplate (é‚®ä»¶æ¨¡æ¿èšåˆæ ¹)](#222-emailtemplate-é‚®ä»¶æ¨¡æ¿èšåˆæ ¹)
- [2.3 æ¨é€é€šçŸ¥å­é¢†åŸŸ](#23-æ¨é€é€šçŸ¥å­é¢†åŸŸ)
  - [2.3.1 PushNotif (æ¨é€é€šçŸ¥èšåˆæ ¹)](#231-pushnotif-æ¨é€é€šçŸ¥èšåˆæ ¹)
  - [2.3.2 PushChannel (æ¨é€æ¸ é“èšåˆæ ¹)](#232-pushchannel-æ¨é€æ¸ é“èšåˆæ ¹)
- [2.4 çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸ](#24-çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸ)
  - [2.4.1 SmsNotif (çŸ­ä¿¡é€šçŸ¥èšåˆæ ¹)](#241-smsnotif-çŸ­ä¿¡é€šçŸ¥èšåˆæ ¹)
  - [2.4.2 SmsProvider (çŸ­ä¿¡æœåŠ¡å•†èšåˆæ ¹)](#242-smsprovider-çŸ­ä¿¡æœåŠ¡å•†èšåˆæ ¹)
- [2.5 é€šçŸ¥ç¼–æ’å­é¢†åŸŸ](#25-é€šçŸ¥ç¼–æ’å­é¢†åŸŸ)
  - [2.5.1 NotifOrchestrator (é€šçŸ¥ç¼–æ’æœåŠ¡)](#251-notificationorchestrator-é€šçŸ¥ç¼–æ’æœåŠ¡)
- [2.6 å€¼å¯¹è±¡å’Œæšä¸¾](#26-å€¼å¯¹è±¡å’Œæšä¸¾)
  - [2.6.1 é€šç”¨å€¼å¯¹è±¡](#261-é€šç”¨å€¼å¯¹è±¡)
  - [2.6.2 é€šçŸ¥ç±»å‹æšä¸¾](#262-é€šçŸ¥ç±»å‹æšä¸¾)
  - [2.6.3 é€šçŸ¥æ¸ é“æšä¸¾](#263-é€šçŸ¥æ¸ é“æšä¸¾)
  - [2.6.4 é€šçŸ¥çŠ¶æ€æšä¸¾](#264-é€šçŸ¥çŠ¶æ€æšä¸¾)
  - [2.6.5 é€šçŸ¥ä¼˜å…ˆçº§æšä¸¾](#265-é€šçŸ¥ä¼˜å…ˆçº§æšä¸¾)
  - [2.6.6 çŸ­ä¿¡æœåŠ¡å•†æšä¸¾](#266-çŸ­ä¿¡æœåŠ¡å•†æšä¸¾)
- [2.7 é¢†åŸŸäº‹ä»¶](#27-é¢†åŸŸäº‹ä»¶)
  - [2.7.1 ç«™å†…ä¿¡äº‹ä»¶](#271-ç«™å†…ä¿¡äº‹ä»¶)
  - [2.7.2 é‚®ä»¶é€šçŸ¥äº‹ä»¶](#272-é‚®ä»¶é€šçŸ¥äº‹ä»¶)
  - [2.7.3 æ¨é€é€šçŸ¥äº‹ä»¶](#273-æ¨é€é€šçŸ¥äº‹ä»¶)
  - [2.7.4 çŸ­ä¿¡é€šçŸ¥äº‹ä»¶](#274-çŸ­ä¿¡é€šçŸ¥äº‹ä»¶)

### 3. åº”ç”¨å±‚è®¾è®¡

- [3.1 ç«™å†…ä¿¡åº”ç”¨å±‚](#31-ç«™å†…ä¿¡åº”ç”¨å±‚)
  - [3.1.1 ç«™å†…ä¿¡å‘½ä»¤](#311-ç«™å†…ä¿¡å‘½ä»¤)
  - [3.1.2 ç«™å†…ä¿¡æŸ¥è¯¢](#312-ç«™å†…ä¿¡æŸ¥è¯¢)
  - [3.1.3 ç«™å†…ä¿¡å‘½ä»¤å¤„ç†å™¨](#313-ç«™å†…ä¿¡å‘½ä»¤å¤„ç†å™¨)
- [3.2 é‚®ä»¶é€šçŸ¥åº”ç”¨å±‚](#32-é‚®ä»¶é€šçŸ¥åº”ç”¨å±‚)
  - [3.2.1 é‚®ä»¶é€šçŸ¥å‘½ä»¤](#321-é‚®ä»¶é€šçŸ¥å‘½ä»¤)
  - [3.2.2 é‚®ä»¶é€šçŸ¥æŸ¥è¯¢](#322-é‚®ä»¶é€šçŸ¥æŸ¥è¯¢)
  - [3.2.3 é‚®ä»¶é€šçŸ¥å‘½ä»¤å¤„ç†å™¨](#323-é‚®ä»¶é€šçŸ¥å‘½ä»¤å¤„ç†å™¨)
- [3.3 æ¨é€é€šçŸ¥åº”ç”¨å±‚](#33-æ¨é€é€šçŸ¥åº”ç”¨å±‚)
  - [3.3.1 æ¨é€é€šçŸ¥å‘½ä»¤](#331-æ¨é€é€šçŸ¥å‘½ä»¤)
  - [3.3.2 æ¨é€é€šçŸ¥æŸ¥è¯¢](#332-æ¨é€é€šçŸ¥æŸ¥è¯¢)
  - [3.3.3 æ¨é€é€šçŸ¥å‘½ä»¤å¤„ç†å™¨](#333-æ¨é€é€šçŸ¥å‘½ä»¤å¤„ç†å™¨)
- [3.4 çŸ­ä¿¡é€šçŸ¥åº”ç”¨å±‚](#34-çŸ­ä¿¡é€šçŸ¥åº”ç”¨å±‚)
  - [3.4.1 çŸ­ä¿¡é€šçŸ¥å‘½ä»¤](#341-çŸ­ä¿¡é€šçŸ¥å‘½ä»¤)
  - [3.4.2 çŸ­ä¿¡é€šçŸ¥æŸ¥è¯¢](#342-çŸ­ä¿¡é€šçŸ¥æŸ¥è¯¢)
  - [3.4.3 çŸ­ä¿¡é€šçŸ¥å‘½ä»¤å¤„ç†å™¨](#343-çŸ­ä¿¡é€šçŸ¥å‘½ä»¤å¤„ç†å™¨)
- [3.5 é€šçŸ¥ç¼–æ’åº”ç”¨å±‚](#35-é€šçŸ¥ç¼–æ’åº”ç”¨å±‚)
  - [3.5.1 é€šçŸ¥ç¼–æ’å‘½ä»¤](#351-é€šçŸ¥ç¼–æ’å‘½ä»¤)
  - [3.5.2 é€šçŸ¥ç¼–æ’æŸ¥è¯¢](#352-é€šçŸ¥ç¼–æ’æŸ¥è¯¢)
  - [3.5.3 é€šçŸ¥ç¼–æ’å‘½ä»¤å¤„ç†å™¨](#353-é€šçŸ¥ç¼–æ’å‘½ä»¤å¤„ç†å™¨)

### 4. åŸºç¡€è®¾æ–½å±‚è®¾è®¡

- [4.1 æ•°æ®åº“è®¾è®¡](#41-æ•°æ®åº“è®¾è®¡)
- [4.2 ä»“å‚¨å®ç°](#42-ä»“å‚¨å®ç°)
- [4.3 å¤–éƒ¨æœåŠ¡é€‚é…å™¨](#43-å¤–éƒ¨æœåŠ¡é€‚é…å™¨)
- [4.4 äº‹ä»¶å­˜å‚¨](#44-äº‹ä»¶å­˜å‚¨)
- [4.5 ç¼“å­˜ç­–ç•¥](#45-ç¼“å­˜ç­–ç•¥)

### 5. æ¥å£å±‚è®¾è®¡

- [5.1 æ§åˆ¶å™¨è®¾è®¡](#51-æ§åˆ¶å™¨è®¾è®¡)
- [5.2 DTOè®¾è®¡](#52-dtoè®¾è®¡)
- [5.3 æƒé™æ§åˆ¶](#53-æƒé™æ§åˆ¶)
- [5.4 APIæ–‡æ¡£](#54-apiæ–‡æ¡£)

### 6. éƒ¨ç½²ä¸è¿ç»´

- [6.1 å®¹å™¨åŒ–éƒ¨ç½²](#61-å®¹å™¨åŒ–éƒ¨ç½²)
- [6.2 ç›‘æ§ä¸æ—¥å¿—](#62-ç›‘æ§ä¸æ—¥å¿—)
- [6.3 æ€§èƒ½ä¼˜åŒ–](#63-æ€§èƒ½ä¼˜åŒ–)
- [6.4 å®‰å…¨ç­–ç•¥](#64-å®‰å…¨ç­–ç•¥)

### 7. å¼€å‘æŒ‡å—

- [7.1 å¼€å‘ç¯å¢ƒæ­å»º](#71-å¼€å‘ç¯å¢ƒæ­å»º)
- [7.2 ä»£ç è§„èŒƒ](#72-ä»£ç è§„èŒƒ)
- [7.3 æµ‹è¯•ç­–ç•¥](#73-æµ‹è¯•ç­–ç•¥)
- [7.4 å‘å¸ƒæµç¨‹](#74-å‘å¸ƒæµç¨‹)

---

## ğŸš€ å¿«é€Ÿå¯¼èˆª

### æ ¸å¿ƒæ¦‚å¿µ

- [ğŸ—ï¸ ä»£ç ç»„ç»‡æ¶æ„å›¾](#12-ä»£ç ç»„ç»‡æ¶æ„å›¾) - æŸ¥çœ‹å®Œæ•´çš„ä»£ç ç›®å½•ç»“æ„å’Œåˆ†å±‚æ¶æ„
- [ğŸ“¦ åŒ…ç»“æ„è®¾è®¡](#15-åŒ…ç»“æ„è®¾è®¡) - äº†è§£9ä¸ªç‹¬ç«‹å­é¢†åŸŸåŒ…çš„ç»„ç»‡æ–¹å¼
- [ğŸ—ï¸ é¢†åŸŸæ¨¡å‹è®¾è®¡](#2-é¢†åŸŸæ¨¡å‹è®¾è®¡) - æŸ¥çœ‹èšåˆæ ¹ã€å€¼å¯¹è±¡å’Œé¢†åŸŸäº‹ä»¶
- [âš¡ åº”ç”¨å±‚è®¾è®¡](#3-åº”ç”¨å±‚è®¾è®¡) - äº†è§£CQRSå‘½ä»¤å’ŒæŸ¥è¯¢å¤„ç†å™¨
- [ğŸ”§ å‘½åçº¦å®š](#154-å‘½åçº¦å®š) - æŸ¥çœ‹notifç®€å†™è§„èŒƒ

### å¼€å‘æŒ‡å—

- [ğŸ“‹ åŒ…é…ç½®ç¤ºä¾‹](#155-åŒ…é…ç½®ç¤ºä¾‹) - æŸ¥çœ‹package.jsonå’Œtsconfigé…ç½®
- [ğŸ›ï¸ æ¶æ„è®¾è®¡åŸåˆ™](#11-è®¾è®¡åŸåˆ™) - äº†è§£DDDå’ŒClean Architecture
- [ğŸ”„ äº‹ä»¶é©±åŠ¨ç­–ç•¥](#14-äº‹ä»¶é©±åŠ¨ç­–ç•¥) - äº†è§£æ··åˆäº‹ä»¶é©±åŠ¨æ¶æ„

### æŠ€æœ¯å®ç°

- [ğŸ’¾ æ•°æ®åº“è®¾è®¡](#41-æ•°æ®åº“è®¾è®¡) - æŸ¥çœ‹è¡¨ç»“æ„å’Œç´¢å¼•è®¾è®¡
- [ğŸ”Œ å¤–éƒ¨æœåŠ¡é€‚é…å™¨](#43-å¤–éƒ¨æœåŠ¡é€‚é…å™¨) - äº†è§£ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ
- [ğŸ“Š ç›‘æ§ä¸æ—¥å¿—](#62-ç›‘æ§ä¸æ—¥å¿—) - æŸ¥çœ‹è¿ç»´ç›‘æ§æ–¹æ¡ˆ

---

## 1. æŠ€æœ¯æ¶æ„æ¦‚è¿°

### 1.1 æ¶æ„è®¾è®¡åŸåˆ™

- **DDDæ¶æ„**: éµå¾ªé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ŒæŒ‰ä¸šåŠ¡é¢†åŸŸç»„ç»‡ä»£ç 
- **Clean Architecture**: éµå¾ªæ¸…æ´æ¶æ„ï¼Œç¡®ä¿ä¾èµ–å€’ç½®
- **CQRS**: å‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼Œä¼˜åŒ–è¯»å†™æ€§èƒ½
- **å…¨é¢äº‹ä»¶é©±åŠ¨**: æ‰€æœ‰ä¸šåŠ¡æ“ä½œéƒ½é€šè¿‡äº‹ä»¶é©±åŠ¨ï¼Œå®ç°æ¾è€¦åˆå’Œæœ€ç»ˆä¸€è‡´æ€§
- **å¤šç§Ÿæˆ·**: æ”¯æŒç§Ÿæˆ·çº§æ•°æ®éš”ç¦»å’Œé…ç½®
- **å¾®æœåŠ¡**: æ”¯æŒç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- **å­é¢†åŸŸåˆ’åˆ†**: åŸºäºé¢‘é“å’Œé€šçŸ¥æ–¹å¼åˆ’åˆ†å­é¢†åŸŸ
- **èšåˆæ ¹ä¸å®ä½“åˆ†ç¦»**: èšåˆæ ¹è´Ÿè´£ä¸šåŠ¡åè°ƒï¼Œé¢†åŸŸå®ä½“è´Ÿè´£çŠ¶æ€ç®¡ç†

### 1.1.1 èšåˆæ ¹ä¸é¢†åŸŸå®ä½“è®¾è®¡æ¨¡å¼

æœ¬è®¾è®¡é‡‡ç”¨**èšåˆæ ¹ä¸é¢†åŸŸå®ä½“åˆ†ç¦»**çš„æ¶æ„æ¨¡å¼ï¼š

#### èšåˆæ ¹ (Aggregate Root)

- **èŒè´£**: ä¸šåŠ¡åè°ƒã€äº‹ä»¶å‘å¸ƒã€äº‹åŠ¡è¾¹ç•Œæ§åˆ¶
- **ç»§æ‰¿**: `EventSourcedAggregateRoot`
- **ç‰¹ç‚¹**: ä¸ç›´æ¥ç®¡ç†çŠ¶æ€ï¼Œé€šè¿‡ç»„åˆé¢†åŸŸå®ä½“å®ç°ä¸šåŠ¡é€»è¾‘

#### é¢†åŸŸå®ä½“ (Domain Entity)

- **èŒè´£**: çŠ¶æ€ç®¡ç†ã€ä¸šåŠ¡è§„åˆ™éªŒè¯ã€åŸºç¡€è®¾æ–½åŠŸèƒ½
- **ç»§æ‰¿**: `BaseEntity`
- **ç‰¹ç‚¹**: æä¾›å®¡è®¡è¿½è¸ªã€ä¹è§‚é”ã€è½¯åˆ é™¤ç­‰ä¼ä¸šçº§åŠŸèƒ½

#### è®¾è®¡ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**: èšåˆæ ¹ä¸“æ³¨ä¸šåŠ¡åè°ƒï¼Œå®ä½“ä¸“æ³¨çŠ¶æ€ç®¡ç†
2. **åŸºç¡€è®¾æ–½å¤ç”¨**: é€šè¿‡BaseEntityæä¾›ç»Ÿä¸€çš„å®¡è®¡å’Œç‰ˆæœ¬æ§åˆ¶
3. **äº‹ä»¶é©±åŠ¨**: èšåˆæ ¹è´Ÿè´£äº‹ä»¶å‘å¸ƒï¼Œå®ä½“è´Ÿè´£çŠ¶æ€å˜æ›´
4. **å¯æµ‹è¯•æ€§**: èšåˆæ ¹å’Œå®ä½“å¯ä»¥ç‹¬ç«‹æµ‹è¯•
5. **å¯ç»´æŠ¤æ€§**: ä¸šåŠ¡é€»è¾‘å’ŒåŸºç¡€è®¾æ–½åŠŸèƒ½åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤

### 1.2 ä»£ç ç»„ç»‡æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           é€šçŸ¥æ¨¡å—ä»£ç ç»„ç»‡æ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  packages/notification/                                                         â”‚
â”‚  â”œâ”€â”€ in-app/                    # ç«™å†…ä¿¡å­é¢†åŸŸåŒ…                                â”‚
â”‚  â”‚   â”œâ”€â”€ src/                                                                   â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ domain/            # é¢†åŸŸå±‚                                        â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ aggregates/    # èšåˆæ ¹                                        â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ in-app-notif.aggregate.ts                                 â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ entities/      # é¢†åŸŸå®ä½“                                      â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ in-app-notif.entity.ts                                    â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ value-objects/ # å€¼å¯¹è±¡                                        â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notif-id.vo.ts                                            â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ tenant-id.vo.ts                                           â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user-id.vo.ts                                             â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notif-type.vo.ts                                          â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ notif-priority.vo.ts                                      â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ read-status.vo.ts                                         â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ events/        # é¢†åŸŸäº‹ä»¶                                      â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ in-app-notif-created.event.ts                             â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ in-app-notif-read.event.ts                                â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ in-app-notif-archived.event.ts                            â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ services/      # é¢†åŸŸæœåŠ¡                                      â”‚
â”‚  â”‚   â”‚   â”‚       â””â”€â”€ notif-center.service.ts                                   â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ application/       # åº”ç”¨å±‚                                        â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ commands/      # å‘½ä»¤                                          â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create-in-app-notif.command.ts                            â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mark-as-read.command.ts                                   â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ archive-notif.command.ts                                  â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ queries/       # æŸ¥è¯¢                                          â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ get-in-app-notifs.query.ts                                â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ get-notif-stats.query.ts                                  â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ handlers/      # å‘½ä»¤/æŸ¥è¯¢å¤„ç†å™¨                               â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create-in-app-notif.handler.ts                            â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mark-as-read.handler.ts                                   â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ archive-notif.handler.ts                                  â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ services/      # åº”ç”¨æœåŠ¡                                      â”‚
â”‚  â”‚   â”‚   â”‚       â””â”€â”€ in-app-notif.service.ts                                   â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ infrastructure/    # åŸºç¡€è®¾æ–½å±‚                                    â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/  # ä»“å‚¨å®ç°                                      â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ in-app-notif.repository.ts                                â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ entities/      # æ•°æ®åº“å®ä½“                                    â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ in-app-notif.entity.ts                                    â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ adapters/      # å¤–éƒ¨æœåŠ¡é€‚é…å™¨                                â”‚
â”‚  â”‚   â”‚   â”‚       â””â”€â”€ database.adapter.ts                                       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ interface/         # æ¥å£å±‚                                        â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ controllers/   # æ§åˆ¶å™¨                                        â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ in-app-notif.controller.ts                                â”‚
â”‚  â”‚   â”‚   â”‚   â”œâ”€â”€ dtos/          # æ•°æ®ä¼ è¾“å¯¹è±¡                                  â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ create-in-app-notif.dto.ts                                â”‚
â”‚  â”‚   â”‚   â”‚   â”‚   â””â”€â”€ in-app-notif.dto.ts                                       â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ guards/        # å®ˆå«                                          â”‚
â”‚  â”‚   â”‚   â”‚       â””â”€â”€ notif.guard.ts                                            â”‚
â”‚  â”‚   â”‚   â””â”€â”€ index.ts           # åŒ…å…¥å£æ–‡ä»¶                                    â”‚
â”‚  â”‚   â”œâ”€â”€ package.json           # åŒ…é…ç½®                                        â”‚
â”‚  â”‚   â””â”€â”€ tsconfig.json          # TypeScripté…ç½®                                â”‚
â”‚  â”‚                                                                             â”‚
â”‚  â”œâ”€â”€ email/                     # é‚®ä»¶é€šçŸ¥å­é¢†åŸŸåŒ…                              â”‚
â”‚  â”œâ”€â”€ push/                      # æ¨é€é€šçŸ¥å­é¢†åŸŸåŒ…                              â”‚
â”‚  â”œâ”€â”€ sms/                       # çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸåŒ…                              â”‚
â”‚  â”œâ”€â”€ orchestration/             # é€šçŸ¥ç¼–æ’å­é¢†åŸŸåŒ…                              â”‚
â”‚  â”œâ”€â”€ preferences/               # ç”¨æˆ·åå¥½å­é¢†åŸŸåŒ…                              â”‚
â”‚  â”œâ”€â”€ analytics/                 # é€šçŸ¥ç»Ÿè®¡å­é¢†åŸŸåŒ…                              â”‚
â”‚  â”œâ”€â”€ templates/                 # æ¨¡æ¿ç®¡ç†å­é¢†åŸŸåŒ…                              â”‚
â”‚  â””â”€â”€ events/                    # äº‹ä»¶é›†æˆå­é¢†åŸŸåŒ…                              â”‚
â”‚                                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              æ¶æ„å±‚æ¬¡è¯´æ˜                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ğŸ“ domain/          # é¢†åŸŸå±‚ - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸ä¾èµ–å¤–éƒ¨æ¡†æ¶                    â”‚
â”‚  â”‚   â”œâ”€â”€ aggregates/ # èšåˆæ ¹ - ä¸šåŠ¡åè°ƒå’Œäº‹ä»¶å‘å¸ƒ                              â”‚
â”‚  â”‚   â”œâ”€â”€ entities/   # é¢†åŸŸå®ä½“ - çŠ¶æ€ç®¡ç†å’ŒåŸºç¡€è®¾æ–½åŠŸèƒ½                        â”‚
â”‚  â”‚   â”œâ”€â”€ value-objects/ # å€¼å¯¹è±¡ - ä¸å¯å˜çš„æ•°æ®ç»“æ„                             â”‚
â”‚  â”‚   â”œâ”€â”€ events/     # é¢†åŸŸäº‹ä»¶ - ä¸šåŠ¡çŠ¶æ€å˜æ›´é€šçŸ¥                              â”‚
â”‚  â”‚   â””â”€â”€ services/   # é¢†åŸŸæœåŠ¡ - è·¨èšåˆçš„ä¸šåŠ¡é€»è¾‘                              â”‚
â”‚  â”‚                                                                             â”‚
â”‚  ğŸ“ application/     # åº”ç”¨å±‚ - ç”¨ä¾‹åè°ƒï¼Œä¾èµ–é¢†åŸŸå±‚                            â”‚
â”‚  â”‚   â”œâ”€â”€ commands/   # å‘½ä»¤ - å†™æ“ä½œè¯·æ±‚                                        â”‚
â”‚  â”‚   â”œâ”€â”€ queries/    # æŸ¥è¯¢ - è¯»æ“ä½œè¯·æ±‚                                        â”‚
â”‚  â”‚   â”œâ”€â”€ handlers/   # å¤„ç†å™¨ - å‘½ä»¤/æŸ¥è¯¢å¤„ç†é€»è¾‘                               â”‚
â”‚  â”‚   â””â”€â”€ services/   # åº”ç”¨æœåŠ¡ - ç”¨ä¾‹åè°ƒæœåŠ¡                                  â”‚
â”‚  â”‚                                                                             â”‚
â”‚  ğŸ“ infrastructure/  # åŸºç¡€è®¾æ–½å±‚ - æŠ€æœ¯å®ç°ï¼Œä¾èµ–åº”ç”¨å±‚                        â”‚
â”‚  â”‚   â”œâ”€â”€ repositories/ # ä»“å‚¨å®ç° - æ•°æ®æŒä¹…åŒ–                                  â”‚
â”‚  â”‚   â”œâ”€â”€ entities/   # æ•°æ®åº“å®ä½“ - ORMæ˜ å°„                                     â”‚
â”‚  â”‚   â””â”€â”€ adapters/   # å¤–éƒ¨æœåŠ¡é€‚é…å™¨ - ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ                          â”‚
â”‚  â”‚                                                                             â”‚
â”‚  ğŸ“ interface/       # æ¥å£å±‚ - å¤–éƒ¨æ¥å£ï¼Œä¾èµ–åº”ç”¨å±‚                            â”‚
â”‚  â”‚   â”œâ”€â”€ controllers/ # æ§åˆ¶å™¨ - HTTP APIç«¯ç‚¹                                   â”‚
â”‚  â”‚   â”œâ”€â”€ dtos/       # æ•°æ®ä¼ è¾“å¯¹è±¡ - APIæ•°æ®æ ¼å¼                               â”‚
â”‚  â”‚   â””â”€â”€ guards/     # å®ˆå« - æƒé™æ§åˆ¶å’ŒéªŒè¯                                    â”‚
â”‚  â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å­é¢†åŸŸåˆ’åˆ†ç­–ç•¥

#### 1.3.1 æ ¸å¿ƒå­é¢†åŸŸ

- **ç«™å†…ä¿¡å­é¢†åŸŸ (In-App Notif)**: ç«™å†…é€šçŸ¥çš„åˆ›å»ºã€å­˜å‚¨ã€å±•ç¤ºã€çŠ¶æ€ç®¡ç†
- **é‚®ä»¶é€šçŸ¥å­é¢†åŸŸ (Email Notif)**: é‚®ä»¶é€šçŸ¥çš„å‘é€ã€æ¨¡æ¿ç®¡ç†ã€çŠ¶æ€è·Ÿè¸ª
- **æ¨é€é€šçŸ¥å­é¢†åŸŸ (Push Notif)**: Webæ¨é€ã€ç§»åŠ¨ç«¯æ¨é€çš„ç®¡ç†å’Œå‘é€
- **çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸ (SMS Notif)**: çŸ­ä¿¡é€šçŸ¥çš„å‘é€ã€æˆæœ¬æ§åˆ¶ã€çŠ¶æ€ç®¡ç†

#### 1.3.2 æ”¯æ’‘å­é¢†åŸŸ

- **é€šçŸ¥ç¼–æ’å­é¢†åŸŸ (Notif Orchestration)**: åè°ƒä¸åŒé¢‘é“çš„é€šçŸ¥å‘é€ã€ä¼˜å…ˆçº§ç®¡ç†
- **ç”¨æˆ·åå¥½å­é¢†åŸŸ (User Preferences)**: ç”¨æˆ·å¯¹ä¸åŒé¢‘é“çš„åå¥½è®¾ç½®
- **é€šçŸ¥ç»Ÿè®¡å­é¢†åŸŸ (Notif Analytics)**: å„é¢‘é“é€šçŸ¥æ•ˆæœç»Ÿè®¡ã€ç”¨æˆ·è¡Œä¸ºåˆ†æ

#### 1.3.3 é€šç”¨å­é¢†åŸŸ

- **æ¨¡æ¿ç®¡ç†å­é¢†åŸŸ (Template Management)**: è·¨é¢‘é“çš„æ¨¡æ¿ç®¡ç†ã€å†…å®¹æ¸²æŸ“
- **äº‹ä»¶é›†æˆå­é¢†åŸŸ (Event Integration)**: ä¸šåŠ¡äº‹ä»¶åˆ°é€šçŸ¥äº‹ä»¶çš„è½¬æ¢å’Œè·¯ç”±

### 1.4 äº‹ä»¶é©±åŠ¨ç­–ç•¥

#### 1.4.1 ä½¿ç”¨äº‹ä»¶é©±åŠ¨çš„åœºæ™¯

- **è·¨å­é¢†åŸŸé€šçŸ¥è§¦å‘**: ç”¨æˆ·æ³¨å†Œã€æƒé™å˜æ›´ã€ç³»ç»Ÿç»´æŠ¤ç­‰ä¸šåŠ¡äº‹ä»¶
- **å¼‚æ­¥é€šçŸ¥å‘é€**: é‚®ä»¶å‘é€é˜Ÿåˆ—ã€æ‰¹é‡é€šçŸ¥å¤„ç†
- **å®¡è®¡å’Œç»Ÿè®¡**: é€šçŸ¥å‘é€è®°å½•ã€ç”¨æˆ·è¡Œä¸ºåˆ†æ
- **å­é¢†åŸŸè§£è€¦**: å„å­é¢†åŸŸé€šè¿‡äº‹ä»¶è¿›è¡Œäº¤äº’

#### 1.4.2 äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡

åŸºäºå…¨é¢äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæˆ‘ä»¬é‡‡ç”¨ä»¥ä¸‹è®¾è®¡ç­–ç•¥ï¼š

- **æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ**: ä½¿ç”¨Redis + Bullé˜Ÿåˆ—å®ç°å¼‚æ­¥äº‹ä»¶å¤„ç†
- **äº‹ä»¶å­˜å‚¨**: æ‰€æœ‰é¢†åŸŸäº‹ä»¶æŒä¹…åŒ–åˆ°äº‹ä»¶å­˜å‚¨ï¼Œæ”¯æŒå®¡è®¡å’Œé‡æ”¾
- **å¼‚æ­¥å¤„ç†**: æ‰€æœ‰äº‹ä»¶é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼Œä¿è¯ç³»ç»Ÿå“åº”æ€§
- **é‡è¯•æœºåˆ¶**: å¤±è´¥äº‹ä»¶è‡ªåŠ¨é‡è¯•ï¼Œæ”¯æŒæŒ‡æ•°é€€é¿ç­–ç•¥
- **æ­»ä¿¡é˜Ÿåˆ—**: æ°¸ä¹…å¤±è´¥çš„äº‹ä»¶è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
- **æœ€ç»ˆä¸€è‡´æ€§**: é€šè¿‡å¼‚æ­¥äº‹ä»¶å¤„ç†å®ç°æœ€ç»ˆä¸€è‡´æ€§

### 1.5 åŒ…ç»“æ„è®¾è®¡

#### 1.5.1 ç‹¬ç«‹åŒ…ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é€šçŸ¥é¢†åŸŸæ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç«™å†…ä¿¡å­é¢†åŸŸ (In-App Notif)                               â”‚
â”‚  â”œâ”€â”€ InAppNotif Aggregate                                  â”‚
â”‚  â”œâ”€â”€ NotifCenter Service                                   â”‚
â”‚  â””â”€â”€ ReadStatus Value Object                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é‚®ä»¶é€šçŸ¥å­é¢†åŸŸ (Email Notif)                              â”‚
â”‚  â”œâ”€â”€ EmailNotif Aggregate                                  â”‚
â”‚  â”œâ”€â”€ EmailTemplate Aggregate                               â”‚
â”‚  â””â”€â”€ EmailDelivery Service                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¨é€é€šçŸ¥å­é¢†åŸŸ (Push Notif)                               â”‚
â”‚  â”œâ”€â”€ PushNotif Aggregate                                   â”‚
â”‚  â”œâ”€â”€ PushChannel Aggregate                                 â”‚
â”‚  â””â”€â”€ PushDelivery Service                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸ (SMS Notif)                                â”‚
â”‚  â”œâ”€â”€ SmsNotif Aggregate                                    â”‚
â”‚  â”œâ”€â”€ SmsProvider Aggregate                                 â”‚
â”‚  â””â”€â”€ SmsDelivery Service                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€šçŸ¥ç¼–æ’å­é¢†åŸŸ (Notif Orchestration)                       â”‚
â”‚  â”œâ”€â”€ NotifOrchestrator Service                             â”‚
â”‚  â”œâ”€â”€ ChannelSelector Service                               â”‚
â”‚  â””â”€â”€ PriorityManager Service                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·åå¥½å­é¢†åŸŸ (User Preferences)                          â”‚
â”‚  â”œâ”€â”€ ChannelPreference Aggregate                           â”‚
â”‚  â”œâ”€â”€ NotifSettings Value Object                            â”‚
â”‚  â””â”€â”€ PreferenceService                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€šçŸ¥ç»Ÿè®¡å­é¢†åŸŸ (Notif Analytics)                          â”‚
â”‚  â”œâ”€â”€ ChannelStats Aggregate                                â”‚
â”‚  â”œâ”€â”€ DeliveryRate Value Object                             â”‚
â”‚  â””â”€â”€ AnalyticsService                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¨¡æ¿ç®¡ç†å­é¢†åŸŸ (Template Management)                       â”‚
â”‚  â”œâ”€â”€ MultiChannelTemplate Aggregate                        â”‚
â”‚  â”œâ”€â”€ TemplateRenderer Service                              â”‚
â”‚  â””â”€â”€ ContentAdapter Service                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº‹ä»¶é›†æˆå­é¢†åŸŸ (Event Integration)                         â”‚
â”‚  â”œâ”€â”€ EventMapper Service                                   â”‚
â”‚  â”œâ”€â”€ NotifTrigger Service                                  â”‚
â”‚  â””â”€â”€ EventRouter Service                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.4.2 åŒ…ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åŒ…ä¾èµ–å…³ç³»å›¾                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  orchestration (ç¼–æ’åŒ…)                                    â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: in-app                                          â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: email                                           â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: push                                            â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: sms                                             â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: preferences                                     â”‚
â”‚  â””â”€â”€ ä¾èµ–: templates                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  events (äº‹ä»¶é›†æˆåŒ…)                                        â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: orchestration                                   â”‚
â”‚  â””â”€â”€ ä¾èµ–: å…¶ä»–ä¸šåŠ¡æ¨¡å— (user, tenant, platform)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  analytics (ç»Ÿè®¡åŒ…)                                         â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: in-app                                          â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: email                                           â”‚
â”‚  â”œâ”€â”€ ä¾èµ–: push                                            â”‚
â”‚  â””â”€â”€ ä¾èµ–: sms                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒé€šçŸ¥åŒ… (ç‹¬ç«‹è¿è¡Œ)                                      â”‚
â”‚  â”œâ”€â”€ in-app                                                â”‚
â”‚  â”œâ”€â”€ email                                                 â”‚
â”‚  â”œâ”€â”€ push                                                  â”‚
â”‚  â”œâ”€â”€ sms                                                   â”‚
â”‚  â”œâ”€â”€ preferences                                           â”‚
â”‚  â””â”€â”€ templates                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.4.3 åŒ…ç®¡ç†ç­–ç•¥

**ç‹¬ç«‹éƒ¨ç½²èƒ½åŠ›**ï¼š

- æ¯ä¸ªå­é¢†åŸŸåŒ…éƒ½å¯ä»¥ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- æ”¯æŒå¾®æœåŠ¡æ¶æ„ï¼Œæ¯ä¸ªåŒ…å¯ä»¥éƒ¨ç½²ä¸ºç‹¬ç«‹çš„æœåŠ¡
- æ”¯æŒå®¹å™¨åŒ–éƒ¨ç½²ï¼Œæ¯ä¸ªåŒ…æœ‰ç‹¬ç«‹çš„Dockeré•œåƒ

**ç‰ˆæœ¬ç®¡ç†**ï¼š

- æ¯ä¸ªåŒ…æœ‰ç‹¬ç«‹çš„ç‰ˆæœ¬å·
- æ”¯æŒè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶
- æ”¯æŒåŒ…çš„ç‹¬ç«‹å‡çº§å’Œå›æ»š

**ä¾èµ–ç®¡ç†**ï¼š

- ä½¿ç”¨pnpm workspaceç®¡ç†åŒ…ä¾èµ–
- æ”¯æŒåŒ…çš„å¾ªç¯ä¾èµ–æ£€æµ‹
- æ”¯æŒåŒ…çš„ä¾èµ–ç‰ˆæœ¬é”å®š

**å¼€å‘æ•ˆç‡**ï¼š

- æ”¯æŒåŒ…çš„ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
- æ”¯æŒåŒ…çš„ç‹¬ç«‹CI/CDæµæ°´çº¿
- æ”¯æŒåŒ…çš„ç‹¬ç«‹æ–‡æ¡£å’Œå‘å¸ƒ

#### 1.4.4 å‘½åçº¦å®š

**ä»£ç å‘½åè§„èŒƒ**ï¼š

- åŒ…åï¼šä½¿ç”¨ç®€æ´çš„è‹±æ–‡å•è¯ï¼Œå¦‚ `in-app`ã€`email`ã€`push`ã€`sms`
- ç±»åï¼šä½¿ç”¨ `Notif` ä½œä¸º `Notification` çš„ç®€å†™
- æ–‡ä»¶åï¼šä½¿ç”¨ `notif` ç®€å†™ï¼Œå¦‚ `in-app-notif.aggregate.ts`
- å˜é‡åï¼šä½¿ç”¨ `notif` ç®€å†™ï¼Œå¦‚ `const notif = new InAppNotif()`

**å‘½åç¤ºä¾‹**ï¼š

```typescript
// èšåˆæ ¹ç±»å
export class InAppNotif extends EventSourcedAggregateRoot
export class EmailNotif extends EventSourcedAggregateRoot
export class PushNotif extends EventSourcedAggregateRoot
export class SmsNotif extends EventSourcedAggregateRoot
export class NotifPreferences extends EventSourcedAggregateRoot
export class NotifOrchestration extends EventSourcedAggregateRoot

// æ–‡ä»¶å
in-app-notif.aggregate.ts
email-notif.aggregate.ts
push-notif.aggregate.ts
sms-notif.aggregate.ts
notif-preferences.aggregate.ts
notif-orchestration.aggregate.ts

// å˜é‡å
const notif = new InAppNotif();
const emailNotif = new EmailNotif();
const pushNotif = new PushNotif();
const preferences = new NotifPreferences();
const orchestration = new NotifOrchestration();

// å‘½ä»¤å’ŒæŸ¥è¯¢ç±»å
export class CreateInAppNotifCommand
export class GetInAppNotifsQuery
export class MarkNotifAsReadCommand
export class CreateNotifPreferencesCommand
export class GetNotifPreferencesQuery
export class CreateNotifOrchestrationCommand

// äº‹ä»¶ç±»å
export class InAppNotifCreatedEvent
export class EmailNotifSentEvent
export class PushNotifDeliveredEvent
export class NotifPreferencesCreatedEvent
export class NotifPreferencesUpdatedEvent
export class NotifOrchestrationCreatedEvent
export class NotifOrchestrationCompletedEvent

// æœåŠ¡ç±»å
export class NotifOrchestratorService
export class NotifAnalyticsService
export class NotifTemplateService
export class NotifPreferencesService
export class NotifOrchestrationService
```

**å®Œæ•´å‘½åçº¦å®šè¡¨**ï¼š

| ç±»å‹   | åŸå‘½å                                | æ–°å‘½å                         | ç¤ºä¾‹                             |
| ------ | ------------------------------------- | ------------------------------ | -------------------------------- |
| èšåˆæ ¹ | InAppNotif                            | InAppNotif                     | `InAppNotif`                     |
| èšåˆæ ¹ | EmailNotif                            | EmailNotif                     | `EmailNotif`                     |
| èšåˆæ ¹ | PushNotif                             | PushNotif                      | `PushNotif`                      |
| èšåˆæ ¹ | SmsNotif                              | SmsNotif                       | `SmsNotif`                       |
| èšåˆæ ¹ | NotificationPreferences               | NotifPreferences               | `NotifPreferences`               |
| èšåˆæ ¹ | NotificationOrchestration             | NotifOrchestration             | `NotifOrchestration`             |
| å€¼å¯¹è±¡ | NotifId                               | NotifId                        | `NotifId`                        |
| å€¼å¯¹è±¡ | NotifChannel                          | NotifChannel                   | `NotifChannel`                   |
| å€¼å¯¹è±¡ | NotifStrategy                         | NotifStrategy                  | `NotifStrategy`                  |
| å‘½ä»¤   | CreateInAppNotifCommand               | CreateInAppNotifCommand        | `CreateInAppNotifCommand`        |
| æŸ¥è¯¢   | GetInAppNotifsQuery                   | GetInAppNotifsQuery            | `GetInAppNotifsQuery`            |
| äº‹ä»¶   | InAppNotifCreatedEvent                | InAppNotifCreatedEvent         | `InAppNotifCreatedEvent`         |
| äº‹ä»¶   | NotificationPreferencesCreatedEvent   | NotifPreferencesCreatedEvent   | `NotifPreferencesCreatedEvent`   |
| äº‹ä»¶   | NotificationOrchestrationCreatedEvent | NotifOrchestrationCreatedEvent | `NotifOrchestrationCreatedEvent` |
| æœåŠ¡   | NotifOrchestrator                     | NotifOrchestrator              | `NotifOrchestrator`              |
| æœåŠ¡   | NotificationPreferencesService        | NotifPreferencesService        | `NotifPreferencesService`        |
| æ–‡ä»¶å | in-app-notif.aggregate.ts             | in-app-notif.aggregate.ts      | `in-app-notif.aggregate.ts`      |
| æ–‡ä»¶å | notification-preferences.aggregate.ts | notif-preferences.aggregate.ts | `notif-preferences.aggregate.ts` |
| å˜é‡å | notif                                 | notif                          | `const notif = new InAppNotif()` |

#### 1.4.5 åŒ…é…ç½®ç¤ºä¾‹

**package.json ç¤ºä¾‹ (in-app)**ï¼š

```json
{
  "name": "@aiofix/notif-in-app",
  "version": "1.0.0",
  "description": "ç«™å†…ä¿¡é€šçŸ¥å­é¢†åŸŸåŒ…",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "build": "tsc",
    "test": "jest",
    "lint": "eslint src/**/*.ts",
    "dev": "tsc --watch"
  },
  "dependencies": {
    "@aiofix/shared": "workspace:*",
    "@aiofix/domain": "workspace:*",
    "uuid": "^9.0.0"
  },
  "devDependencies": {
    "@types/uuid": "^9.0.0",
    "typescript": "^5.0.0",
    "jest": "^29.0.0"
  },
  "peerDependencies": {
    "@nestjs/common": "^10.0.0",
    "@nestjs/core": "^10.0.0"
  }
}
```

**tsconfig.json ç¤ºä¾‹**ï¼š

```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "**/*.spec.ts", "**/*.test.ts"]
}
```

**pnpm-workspace.yaml é…ç½®**ï¼š

```yaml
packages:
  - 'packages/*'
  - 'packages/notif/*'
```

## 2. é¢†åŸŸæ¨¡å‹è®¾è®¡

### 2.1 ç«™å†…ä¿¡å­é¢†åŸŸ

#### 2.1.1 InAppNotif (ç«™å†…é€šçŸ¥èšåˆæ ¹)

```typescript
/**
 * @class InAppNotif
 * @description
 * ç«™å†…é€šçŸ¥èšåˆæ ¹ï¼Œè´Ÿè´£ç®¡ç†ç«™å†…é€šçŸ¥ç›¸å…³çš„ä¸šåŠ¡æ–¹æ³•ã€äº‹ä»¶å‘å¸ƒå’Œä¸å˜æ€§çº¦æŸã€‚
 *
 * ä¸šåŠ¡æ–¹æ³•ä¸äº‹ä»¶å‘å¸ƒï¼š
 * 1. æä¾›ç«™å†…é€šçŸ¥åˆ›å»ºã€æ ‡è®°å·²è¯»ã€å½’æ¡£ç­‰ä¸šåŠ¡æ–¹æ³•
 * 2. åœ¨çŠ¶æ€å˜æ›´æ—¶å‘å¸ƒç›¸åº”çš„é¢†åŸŸäº‹ä»¶
 * 3. ç¡®ä¿ä¸šåŠ¡æ“ä½œçš„äº‹åŠ¡ä¸€è‡´æ€§
 * 4. åè°ƒé¢†åŸŸå®ä½“çš„ä¸šåŠ¡æ“ä½œ
 *
 * ä¸å˜æ€§çº¦æŸï¼š
 * 1. èšåˆæ ¹æ§åˆ¶èšåˆå†…æ‰€æœ‰å¯¹è±¡çš„ä¸€è‡´æ€§
 * 2. ç¡®ä¿ä¸šåŠ¡è§„åˆ™åœ¨èšåˆè¾¹ç•Œå†…å¾—åˆ°æ‰§è¡Œ
 * 3. ç®¡ç†èšåˆå†…å®ä½“çš„ç”Ÿå‘½å‘¨æœŸ
 * 4. ä¿è¯äº‹ä»¶å‘å¸ƒçš„åŸå­æ€§
 *
 * æ¶æ„è®¾è®¡ï¼š
 * 1. èšåˆæ ¹ç»§æ‰¿ EventSourcedAggregateRootï¼Œè´Ÿè´£ä¸šåŠ¡åè°ƒå’Œäº‹ä»¶å‘å¸ƒ
 * 2. é¢†åŸŸå®ä½“ç»§æ‰¿ BaseEntityï¼Œè´Ÿè´£çŠ¶æ€ç®¡ç†å’ŒåŸºç¡€è®¾æ–½åŠŸèƒ½
 * 3. é€šè¿‡ç»„åˆæ¨¡å¼å®ç°èŒè´£åˆ†ç¦»
 *
 * @property {InAppNotifEntity} notif ç«™å†…é€šçŸ¥å®ä½“
 */
export class InAppNotif extends EventSourcedAggregateRoot {
  private constructor(private notif: InAppNotifEntity) {
    super();
  }

  /**
   * @method create
   * @description åˆ›å»ºæ–°çš„ç«™å†…é€šçŸ¥èšåˆæ ¹
   * @param {NotifId} id é€šçŸ¥ID
   * @param {TenantId} tenantId ç§Ÿæˆ·ID
   * @param {UserId} recipientId æ¥æ”¶è€…ç”¨æˆ·ID
   * @param {NotifType} type é€šçŸ¥ç±»å‹
   * @param {string} title é€šçŸ¥æ ‡é¢˜
   * @param {string} content é€šçŸ¥å†…å®¹
   * @param {NotifPriority} priority é€šçŸ¥ä¼˜å…ˆçº§
   * @param {Record<string, unknown>} metadata é€šçŸ¥å…ƒæ•°æ®
   * @returns {InAppNotif} åˆ›å»ºçš„ç«™å†…é€šçŸ¥èšåˆæ ¹
   * @throws {InvalidNotifDataError} å½“é€šçŸ¥æ•°æ®æ— æ•ˆæ—¶æŠ›å‡º
   * @static
   */
  public static create(
    id: NotifId,
    tenantId: TenantId,
    recipientId: UserId,
    type: NotifType,
    title: string,
    content: string,
    priority: NotifPriority,
    metadata: Record<string, unknown> = {},
  ): InAppNotif {
    // åˆ›å»ºé¢†åŸŸå®ä½“
    const notifEntity = new InAppNotifEntity(
      id,
      tenantId,
      recipientId,
      type,
      title,
      content,
      priority,
      metadata,
    );

    // åˆ›å»ºèšåˆæ ¹
    const aggregate = new InAppNotif(notifEntity);

    // å‘å¸ƒåˆ›å»ºäº‹ä»¶
    aggregate.addDomainEvent(
      new InAppNotifCreatedEvent(
        id,
        tenantId,
        recipientId,
        type,
        title,
        content,
        priority,
        metadata,
      ),
    );

    return aggregate;
  }

  /**
   * @method markAsRead
   * @description æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
   * @param {string} [updatedBy] æ›´æ–°è€…IDï¼Œé»˜è®¤ä¸º'system'
   * @returns {void}
   * @throws {InvalidStatusTransitionError} å½“çŠ¶æ€è½¬æ¢æ— æ•ˆæ—¶æŠ›å‡º
   */
  public markAsRead(updatedBy: string = 'system'): void {
    const oldStatus = this.notif.getStatus();

    // å§”æ‰˜ç»™é¢†åŸŸå®ä½“å¤„ç†ä¸šåŠ¡é€»è¾‘
    this.notif.markAsRead(updatedBy);

    const newStatus = this.notif.getStatus();
    const readAt = this.notif.getReadAt();

    // å‘å¸ƒå·²è¯»äº‹ä»¶
    this.addDomainEvent(
      new InAppNotifReadEvent(
        this.notif.id,
        this.notif.tenantId,
        this.notif.recipientId,
        oldStatus,
        newStatus,
        readAt!,
      ),
    );
  }

  /**
   * @method archive
   * @description å½’æ¡£é€šçŸ¥
   * @param {string} [updatedBy] æ›´æ–°è€…IDï¼Œé»˜è®¤ä¸º'system'
   * @returns {void}
   * @throws {InvalidStatusTransitionError} å½“çŠ¶æ€è½¬æ¢æ— æ•ˆæ—¶æŠ›å‡º
   */
  public archive(updatedBy: string = 'system'): void {
    const oldStatus = this.notif.getStatus();

    // å§”æ‰˜ç»™é¢†åŸŸå®ä½“å¤„ç†ä¸šåŠ¡é€»è¾‘
    this.notif.archive(updatedBy);

    const archivedAt = this.notif.getArchivedAt();

    // å‘å¸ƒå½’æ¡£äº‹ä»¶
    this.addDomainEvent(
      new InAppNotifArchivedEvent(
        this.notif.id,
        this.notif.tenantId,
        this.notif.recipientId,
        oldStatus,
        archivedAt!,
      ),
    );
  }

  // èšåˆæ ¹è®¿é—®å™¨æ–¹æ³•ï¼Œæä¾›å¯¹å®ä½“å±æ€§çš„è®¿é—®
  public get id(): NotifId {
    return this.notif.id;
  }

  public get tenantId(): TenantId {
    return this.notif.tenantId;
  }

  public get recipientId(): UserId {
    return this.notif.recipientId;
  }

  public get type(): NotifType {
    return this.notif.type;
  }

  public get title(): string {
    return this.notif.title;
  }

  public get content(): string {
    return this.notif.content;
  }

  public get priority(): NotifPriority {
    return this.notif.priority;
  }

  public get metadata(): Record<string, unknown> {
    return this.notif.metadata;
  }

  public get createdAt(): Date {
    return this.notif.createdAt;
  }

  // å®¡è®¡ç›¸å…³è®¿é—®å™¨æ–¹æ³•
  public get createdBy(): string {
    return this.notif.getCreatedBy();
  }

  public get updatedBy(): string {
    return this.notif.getUpdatedBy();
  }

  public get dataVersion(): number {
    return this.notif.getVersion();
  }

  public get isDeleted(): boolean {
    return this.notif.isDeleted();
  }
}
```

#### 2.1.2 InAppNotifEntity (ç«™å†…é€šçŸ¥é¢†åŸŸå®ä½“)

```typescript
/**
 * @class InAppNotifEntity
 * @description
 * ç«™å†…é€šçŸ¥é¢†åŸŸå®ä½“ï¼Œè´Ÿè´£ç»´æŠ¤ç«™å†…é€šçŸ¥çš„èº«ä»½æ ‡è¯†ã€çŠ¶æ€ç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸã€‚
 *
 * èº«ä»½æ ‡è¯†ä¸çŠ¶æ€ç®¡ç†ï¼š
 * 1. é€šè¿‡å”¯ä¸€IDæ ‡è¯†é€šçŸ¥èº«ä»½
 * 2. ç®¡ç†é€šçŸ¥çš„åŸºæœ¬çŠ¶æ€ï¼ˆæœªè¯»ã€å·²è¯»ã€å·²å½’æ¡£ï¼‰
 * 3. ç»´æŠ¤é€šçŸ¥çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€å˜æ›´
 *
 * ä¸šåŠ¡è§„åˆ™ä¸çº¦æŸï¼š
 * 1. é€šçŸ¥IDä¸€æ—¦åˆ›å»ºä¸å¯å˜æ›´
 * 2. é€šçŸ¥çŠ¶æ€å˜æ›´å¿…é¡»éµå¾ªé¢„å®šä¹‰çš„çŠ¶æ€æœº
 * 3. é€šçŸ¥å†…å®¹ä¸èƒ½ä¸ºç©ºæˆ–è¶…è¿‡é•¿åº¦é™åˆ¶
 * 4. é€šçŸ¥å¿…é¡»å±äºæœ‰æ•ˆçš„ç§Ÿæˆ·å’Œç”¨æˆ·
 *
 * åŸºç¡€è®¾æ–½æ”¯æŒï¼š
 * 1. ç»§æ‰¿BaseEntityæä¾›å®¡è®¡è¿½è¸ªåŠŸèƒ½
 * 2. æ”¯æŒä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶
 * 3. æ”¯æŒè½¯åˆ é™¤å’Œæ¢å¤
 * 4. æä¾›å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
 *
 * @property {NotifId} id é€šçŸ¥å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¸å¯å˜æ›´
 * @property {TenantId} tenantId æ‰€å±ç§Ÿæˆ·ID
 * @property {UserId} recipientId æ¥æ”¶è€…ç”¨æˆ·ID
 * @property {NotifType} type é€šçŸ¥ç±»å‹
 * @property {string} title é€šçŸ¥æ ‡é¢˜
 * @property {string} content é€šçŸ¥å†…å®¹
 * @property {NotifPriority} priority é€šçŸ¥ä¼˜å…ˆçº§
 * @property {Record<string, unknown>} metadata é€šçŸ¥å…ƒæ•°æ®
 * @property {ReadStatus} status è¯»å–çŠ¶æ€
 * @property {Date} readAt é˜…è¯»æ—¶é—´
 * @property {Date} archivedAt å½’æ¡£æ—¶é—´
 */
export class InAppNotifEntity extends BaseEntity {
  private readonly statusValidator = new ReadStatusValidator();

  constructor(
    public readonly id: NotifId,
    public readonly tenantId: TenantId,
    public readonly recipientId: UserId,
    public readonly type: NotifType,
    public readonly title: string,
    public readonly content: string,
    public readonly priority: NotifPriority,
    public readonly metadata: Record<string, unknown> = {},
    private status: ReadStatus = ReadStatus.UNREAD,
    private readAt?: Date,
    private archivedAt?: Date,
    createdBy: string = 'system',
  ) {
    super(createdBy);
    this.validate();
  }

  /**
   * @method markAsRead
   * @description æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»
   * @param {string} [updatedBy] æ›´æ–°è€…IDï¼Œé»˜è®¤ä¸º'system'
   * @returns {void}
   * @throws {InvalidStatusTransitionError} å½“çŠ¶æ€è½¬æ¢æ— æ•ˆæ—¶æŠ›å‡º
   */
  public markAsRead(updatedBy: string = 'system'): void {
    const oldStatus = this.status;
    const newStatus = ReadStatus.READ;

    // éªŒè¯çŠ¶æ€è½¬æ¢
    this.statusValidator.validateTransition(oldStatus, newStatus);

    // æ›´æ–°çŠ¶æ€
    this.status = newStatus;
    this.readAt = new Date();

    // æ›´æ–°å®¡è®¡ä¿¡æ¯ï¼ˆä½¿ç”¨åŸºç±»æ–¹æ³•ï¼‰
    this.updateAuditInfo(updatedBy);
  }

  /**
   * @method archive
   * @description å½’æ¡£é€šçŸ¥
   * @param {string} [updatedBy] æ›´æ–°è€…IDï¼Œé»˜è®¤ä¸º'system'
   * @returns {void}
   * @throws {InvalidStatusTransitionError} å½“çŠ¶æ€è½¬æ¢æ— æ•ˆæ—¶æŠ›å‡º
   */
  public archive(updatedBy: string = 'system'): void {
    const oldStatus = this.status;
    const newStatus = ReadStatus.ARCHIVED;

    // éªŒè¯çŠ¶æ€è½¬æ¢
    this.statusValidator.validateTransition(oldStatus, newStatus);

    // æ›´æ–°çŠ¶æ€
    this.status = newStatus;
    this.archivedAt = new Date();

    // æ›´æ–°å®¡è®¡ä¿¡æ¯ï¼ˆä½¿ç”¨åŸºç±»æ–¹æ³•ï¼‰
    this.updateAuditInfo(updatedBy);
  }

  // å®ç°åŸºç±»è¦æ±‚çš„æŠ½è±¡æ–¹æ³•
  public getEntityId(): string {
    return this.id.value;
  }

  public getTenantId(): string {
    return this.tenantId.value;
  }

  // ä¸šåŠ¡æ–¹æ³•
  public isRead(): boolean {
    return this.status === ReadStatus.READ;
  }

  public isArchived(): boolean {
    return this.status === ReadStatus.ARCHIVED;
  }

  public isUnread(): boolean {
    return this.status === ReadStatus.UNREAD;
  }

  public canBeRead(): boolean {
    return this.statusValidator.isReadable(this.status);
  }

  public canBeArchived(): boolean {
    return this.statusValidator.isArchivable(this.status);
  }

  public getStatus(): ReadStatus {
    return this.status;
  }

  public getReadAt(): Date | undefined {
    return this.readAt;
  }

  public getArchivedAt(): Date | undefined {
    return this.archivedAt;
  }

  // é‡å†™åŸºç±»æ–¹æ³•
  protected validate(): void {
    // è°ƒç”¨åŸºç±»çš„éªŒè¯æ–¹æ³•
    super.validate();

    // ä¸šåŠ¡ç‰¹å®šçš„éªŒè¯
    if (!this.id) {
      throw new InvalidNotifDataError('Notif ID is required');
    }

    if (!this.tenantId) {
      throw new InvalidNotifDataError('Tenant ID is required');
    }

    if (!this.recipientId) {
      throw new InvalidNotifDataError('Recipient ID is required');
    }

    if (!this.type) {
      throw new InvalidNotifDataError('Notif type is required');
    }

    if (!this.title || this.title.trim().length === 0) {
      throw new InvalidNotifDataError('Notif title is required');
    }

    if (!this.content || this.content.trim().length === 0) {
      throw new InvalidNotifDataError('Notif content is required');
    }

    if (!this.priority) {
      throw new InvalidNotifDataError('Notif priority is required');
    }

    if (this.title.length > 200) {
      throw new InvalidNotifDataError(
        'Notif title cannot exceed 200 characters',
      );
    }

    if (this.content.length > 5000) {
      throw new InvalidNotifDataError(
        'Notif content cannot exceed 5000 characters',
      );
    }
  }

  public equals(other: InAppNotifEntity): boolean {
    if (!other) return false;
    if (this === other) return true;
    return this.id.equals(other.id);
  }

  public clone(): InAppNotifEntity {
    return new InAppNotifEntity(
      this.id,
      this.tenantId,
      this.recipientId,
      this.type,
      this.title,
      this.content,
      this.priority,
      this.metadata,
      this.status,
      this.readAt,
      this.archivedAt,
      this.getCreatedBy(),
    );
  }

  public toJSON(): object {
    return {
      ...super.toJSON(),
      id: this.id.value,
      tenantId: this.tenantId.value,
      recipientId: this.recipientId.value,
      type: this.type,
      title: this.title,
      content: this.content,
      priority: this.priority,
      metadata: this.metadata,
      status: this.status,
      readAt: this.readAt?.toISOString(),
      archivedAt: this.archivedAt?.toISOString(),
    };
  }
}
```

### 2.2 é‚®ä»¶é€šçŸ¥å­é¢†åŸŸ

#### 2.2.1 EmailNotif (é‚®ä»¶é€šçŸ¥èšåˆæ ¹)

```typescript
/**
 * @class EmailNotif
 * @description
 * é‚®ä»¶é€šçŸ¥èšåˆæ ¹ï¼Œè´Ÿè´£ç®¡ç†é‚®ä»¶é€šçŸ¥çš„å‘é€ã€çŠ¶æ€è·Ÿè¸ªå’Œé‡è¯•æœºåˆ¶ã€‚
 *
 * ä¸šåŠ¡èŒè´£ï¼š
 * 1. ç®¡ç†é‚®ä»¶é€šçŸ¥çš„åˆ›å»ºå’Œå‘é€
 * 2. è·Ÿè¸ªé‚®ä»¶å‘é€çŠ¶æ€
 * 3. å¤„ç†å‘é€å¤±è´¥å’Œé‡è¯•é€»è¾‘
 * 4. ç®¡ç†é‚®ä»¶æ¨¡æ¿å’Œå†…å®¹æ¸²æŸ“
 *
 * ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. é‚®ä»¶é€šçŸ¥å¿…é¡»åŒ…å«æœ‰æ•ˆçš„æ”¶ä»¶äººé‚®ç®±
 * 2. å‘é€çŠ¶æ€åªèƒ½æŒ‰é¢„å®šä¹‰è§„åˆ™è½¬æ¢
 * 3. å‘é€å¤±è´¥æ—¶è‡ªåŠ¨è§¦å‘é‡è¯•æœºåˆ¶
 * 4. è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°åæ ‡è®°ä¸ºæ°¸ä¹…å¤±è´¥
 */
export class EmailNotif extends EventSourcedAggregateRoot {
  private constructor(
    private readonly id: NotifId,
    private readonly tenantId: TenantId,
    private readonly recipientId: UserId,
    private readonly recipientEmail: string,
    private readonly subject: string,
    private readonly content: string,
    private readonly templateId: TemplateId,
    private status: EmailNotifStatus = EmailNotifStatus.PENDING,
    private retryCount: number = 0,
    private readonly maxRetries: number = 3,
    private readonly createdAt: Date = new Date(),
    private updatedAt: Date = new Date(),
  ) {
    super();
  }

  // ä¸šåŠ¡æ–¹æ³•
  public markAsSending(): void {
    if (this.status === EmailNotifStatus.SENDING) {
      return;
    }

    const oldStatus = this.status;
    this.status = EmailNotifStatus.SENDING;
    this.updatedAt = new Date();

    this.addDomainEvent(
      new EmailNotifSendingEvent(
        this.id,
        this.recipientId,
        this.tenantId,
        this.recipientEmail,
        new Date(),
      ),
    );
  }

  public markAsSent(): void {
    if (this.status === EmailNotifStatus.SENT) {
      return;
    }

    const oldStatus = this.status;
    this.status = EmailNotifStatus.SENT;
    this.updatedAt = new Date();

    this.addDomainEvent(
      new EmailNotifSentEvent(
        this.id,
        this.recipientId,
        this.tenantId,
        this.recipientEmail,
        new Date(),
      ),
    );
  }

  public markAsFailed(error: string): void {
    this.retryCount++;
    this.updatedAt = new Date();

    if (this.retryCount >= this.maxRetries) {
      this.status = EmailNotifStatus.PERMANENTLY_FAILED;
      this.addDomainEvent(
        new EmailNotifPermanentlyFailedEvent(
          this.id,
          this.recipientId,
          this.tenantId,
          this.recipientEmail,
          error,
          this.retryCount,
          new Date(),
        ),
      );
    } else {
      this.status = EmailNotifStatus.FAILED;
      this.addDomainEvent(
        new EmailNotifFailedEvent(
          this.id,
          this.recipientId,
          this.tenantId,
          this.recipientEmail,
          error,
          this.retryCount,
          new Date(),
        ),
      );
    }
  }

  public canRetry(): boolean {
    return (
      this.retryCount < this.maxRetries &&
      this.status === EmailNotifStatus.FAILED
    );
  }
}
```

### 2.3 æ¨é€é€šçŸ¥å­é¢†åŸŸ

#### 2.3.1 PushNotif (æ¨é€é€šçŸ¥èšåˆæ ¹)

```typescript
/**
 * @class PushNotif
 * @description
 * æ¨é€é€šçŸ¥èšåˆæ ¹ï¼Œè´Ÿè´£ç®¡ç†Webæ¨é€å’Œç§»åŠ¨ç«¯æ¨é€çš„å‘é€å’ŒçŠ¶æ€ç®¡ç†ã€‚
 *
 * ä¸šåŠ¡èŒè´£ï¼š
 * 1. ç®¡ç†æ¨é€é€šçŸ¥çš„åˆ›å»ºå’Œå‘é€
 * 2. å¤„ç†è®¾å¤‡æ³¨å†Œå’Œæ¨é€ä»¤ç‰Œç®¡ç†
 * 3. è·Ÿè¸ªæ¨é€é€è¾¾çŠ¶æ€
 * 4. å¤„ç†æ¨é€å¤±è´¥å’Œé‡è¯•é€»è¾‘
 *
 * ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. æ¨é€é€šçŸ¥å¿…é¡»å…³è”æœ‰æ•ˆçš„è®¾å¤‡ä»¤ç‰Œ
 * 2. æ¨é€å†…å®¹æœ‰é•¿åº¦é™åˆ¶
 * 3. æ¨é€å¤±è´¥æ—¶æ ¹æ®é”™è¯¯ç±»å‹å†³å®šé‡è¯•ç­–ç•¥
 * 4. æ— æ•ˆä»¤ç‰Œéœ€è¦æ¸…ç†å’Œæ›´æ–°
 */
export class PushNotif extends EventSourcedAggregateRoot {
  private constructor(
    private readonly id: NotifId,
    private readonly tenantId: TenantId,
    private readonly recipientId: UserId,
    private readonly deviceToken: string,
    private readonly title: string,
    private readonly body: string,
    private readonly data: Record<string, any>,
    private status: PushNotifStatus = PushNotifStatus.PENDING,
    private retryCount: number = 0,
    private readonly maxRetries: number = 3,
    private readonly createdAt: Date = new Date(),
    private updatedAt: Date = new Date(),
  ) {
    super();
  }

  // ä¸šåŠ¡æ–¹æ³•
  public markAsSending(): void {
    if (this.status === PushNotifStatus.SENDING) {
      return;
    }

    this.status = PushNotifStatus.SENDING;
    this.updatedAt = new Date();

    this.addDomainEvent(
      new PushNotifSendingEvent(
        this.id,
        this.recipientId,
        this.tenantId,
        this.deviceToken,
        new Date(),
      ),
    );
  }

  public markAsDelivered(): void {
    if (this.status === PushNotifStatus.DELIVERED) {
      return;
    }

    this.status = PushNotifStatus.DELIVERED;
    this.updatedAt = new Date();

    this.addDomainEvent(
      new PushNotifDeliveredEvent(
        this.id,
        this.recipientId,
        this.tenantId,
        this.deviceToken,
        new Date(),
      ),
    );
  }

  public markAsFailed(error: string, errorCode: string): void {
    this.retryCount++;
    this.updatedAt = new Date();

    // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦é‡è¯•
    if (this.isPermanentError(errorCode)) {
      this.status = PushNotifStatus.PERMANENTLY_FAILED;
      this.addDomainEvent(
        new PushNotifPermanentlyFailedEvent(
          this.id,
          this.recipientId,
          this.tenantId,
          this.deviceToken,
          error,
          errorCode,
          new Date(),
        ),
      );
    } else if (this.retryCount >= this.maxRetries) {
      this.status = PushNotifStatus.PERMANENTLY_FAILED;
      this.addDomainEvent(
        new PushNotifPermanentlyFailedEvent(
          this.id,
          this.recipientId,
          this.tenantId,
          this.deviceToken,
          error,
          errorCode,
          new Date(),
        ),
      );
    } else {
      this.status = PushNotifStatus.FAILED;
      this.addDomainEvent(
        new PushNotifFailedEvent(
          this.id,
          this.recipientId,
          this.tenantId,
          this.deviceToken,
          error,
          errorCode,
          this.retryCount,
          new Date(),
        ),
      );
    }
  }

  private isPermanentError(errorCode: string): boolean {
    // æ°¸ä¹…æ€§é”™è¯¯ï¼Œä¸éœ€è¦é‡è¯•
    const permanentErrors = [
      'INVALID_REGISTRATION',
      'NOT_REGISTERED',
      'MISMATCH_SENDER_ID',
    ];
    return permanentErrors.includes(errorCode);
  }
}
```

### 2.4 çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸ

#### 2.4.1 SmsNotif (çŸ­ä¿¡é€šçŸ¥èšåˆæ ¹)

```typescript
/**
 * @class SmsNotif
 * @description
 * çŸ­ä¿¡é€šçŸ¥èšåˆæ ¹ï¼Œè´Ÿè´£ç®¡ç†çŸ­ä¿¡é€šçŸ¥çš„å‘é€ã€æˆæœ¬æ§åˆ¶å’ŒçŠ¶æ€ç®¡ç†ã€‚
 *
 * ä¸šåŠ¡èŒè´£ï¼š
 * 1. ç®¡ç†çŸ­ä¿¡é€šçŸ¥çš„åˆ›å»ºå’Œå‘é€
 * 2. æ§åˆ¶çŸ­ä¿¡å‘é€æˆæœ¬å’Œé¢‘ç‡
 * 3. è·Ÿè¸ªçŸ­ä¿¡é€è¾¾çŠ¶æ€
 * 4. å¤„ç†å‘é€å¤±è´¥å’Œé‡è¯•é€»è¾‘
 *
 * ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. çŸ­ä¿¡å†…å®¹æœ‰é•¿åº¦é™åˆ¶ï¼ˆé€šå¸¸160å­—ç¬¦ï¼‰
 * 2. çŸ­ä¿¡å‘é€æœ‰æˆæœ¬ï¼Œéœ€è¦ä¸¥æ ¼æ§åˆ¶
 * 3. å‘é€é¢‘ç‡æœ‰ä¸¥æ ¼é™åˆ¶
 * 4. å¤±è´¥é‡è¯•æ¬¡æ•°æœ‰é™
 */
export class SmsNotif extends EventSourcedAggregateRoot {
  private constructor(
    private readonly id: NotifId,
    private readonly tenantId: TenantId,
    private readonly recipientId: UserId,
    private readonly recipientPhone: string,
    private readonly content: string,
    private readonly provider: SMSProvider,
    private status: SmsNotifStatus = SmsNotifStatus.PENDING,
    private retryCount: number = 0,
    private readonly maxRetries: number = 2, // çŸ­ä¿¡é‡è¯•æ¬¡æ•°è¾ƒå°‘
    private readonly cost: number = 0,
    private readonly createdAt: Date = new Date(),
    private updatedAt: Date = new Date(),
  ) {
    super();
  }

  // ä¸šåŠ¡æ–¹æ³•
  public markAsSending(): void {
    if (this.status === SmsNotifStatus.SENDING) {
      return;
    }

    this.status = SmsNotifStatus.SENDING;
    this.updatedAt = new Date();

    this.addDomainEvent(
      new SmsNotifSendingEvent(
        this.id,
        this.recipientId,
        this.tenantId,
        this.recipientPhone,
        this.cost,
        new Date(),
      ),
    );
  }

  public markAsSent(): void {
    if (this.status === SmsNotifStatus.SENT) {
      return;
    }

    this.status = SmsNotifStatus.SENT;
    this.updatedAt = new Date();

    this.addDomainEvent(
      new SmsNotifSentEvent(
        this.id,
        this.recipientId,
        this.tenantId,
        this.recipientPhone,
        this.cost,
        new Date(),
      ),
    );
  }

  public markAsFailed(error: string): void {
    this.retryCount++;
    this.updatedAt = new Date();

    if (this.retryCount >= this.maxRetries) {
      this.status = SmsNotifStatus.PERMANENTLY_FAILED;
      this.addDomainEvent(
        new SmsNotifPermanentlyFailedEvent(
          this.id,
          this.recipientId,
          this.tenantId,
          this.recipientPhone,
          error,
          this.cost,
          new Date(),
        ),
      );
    } else {
      this.status = SmsNotifStatus.FAILED;
      this.addDomainEvent(
        new SmsNotifFailedEvent(
          this.id,
          this.recipientId,
          this.tenantId,
          this.recipientPhone,
          error,
          this.cost,
          this.retryCount,
          new Date(),
        ),
      );
    }
  }

  public canRetry(): boolean {
    return (
      this.retryCount < this.maxRetries && this.status === SmsNotifStatus.FAILED
    );
  }
}
```

### 2.5 é€šçŸ¥ç¼–æ’å­é¢†åŸŸ

#### 2.5.1 NotifOrchestrator (é€šçŸ¥ç¼–æ’æœåŠ¡)

```typescript
/**
 * @class NotifOrchestrator
 * @description
 * é€šçŸ¥ç¼–æ’æœåŠ¡ï¼Œè´Ÿè´£åè°ƒä¸åŒé¢‘é“çš„é€šçŸ¥å‘é€å’Œä¼˜å…ˆçº§ç®¡ç†ã€‚
 *
 * ä¸šåŠ¡èŒè´£ï¼š
 * 1. æ¥æ”¶ä¸šåŠ¡äº‹ä»¶å¹¶è½¬æ¢ä¸ºé€šçŸ¥è¯·æ±‚
 * 2. æ ¹æ®ç”¨æˆ·åå¥½é€‰æ‹©é€šçŸ¥é¢‘é“
 * 3. ç®¡ç†é€šçŸ¥å‘é€çš„ä¼˜å…ˆçº§
 * 4. åè°ƒå„é¢‘é“å­é¢†åŸŸçš„é€šçŸ¥å‘é€
 *
 * ä¸šåŠ¡è§„åˆ™ï¼š
 * 1. æ ¹æ®é€šçŸ¥ç±»å‹å’Œç”¨æˆ·åå¥½é€‰æ‹©é¢‘é“
 * 2. ç´§æ€¥é€šçŸ¥ä¼˜å…ˆå‘é€
 * 3. é¿å…é‡å¤å‘é€ç›¸åŒå†…å®¹
 * 4. æ”¯æŒé€šçŸ¥çš„æ‰¹é‡å¤„ç†
 */
@Injectable()
export class NotifOrchestrator {
  constructor(
    private readonly inAppNotifService: InAppNotifService,
    private readonly emailNotifService: EmailNotifService,
    private readonly pushNotifService: PushNotifService,
    private readonly smsNotifService: SmsNotifService,
    private readonly userPreferenceService: UserPreferenceService,
    private readonly eventBus: IEventBus,
  ) {}

  /**
   * @method orchestrateNotif
   * @description ç¼–æ’é€šçŸ¥å‘é€ï¼Œæ ¹æ®ç”¨æˆ·åå¥½å’Œé€šçŸ¥ç±»å‹é€‰æ‹©é¢‘é“
   * @param {NotifRequest} request é€šçŸ¥è¯·æ±‚
   * @returns {Promise<void>}
   */
  async orchestrateNotif(request: NotifRequest): Promise<void> {
    // 1. è·å–ç”¨æˆ·åå¥½è®¾ç½®
    const preferences = await this.userPreferenceService.getUserPreferences(
      request.recipientId,
      request.tenantId,
    );

    // 2. æ ¹æ®é€šçŸ¥ç±»å‹å’Œç”¨æˆ·åå¥½é€‰æ‹©é¢‘é“
    const selectedChannels = this.selectChannels(request, preferences);

    // 3. æŒ‰ä¼˜å…ˆçº§å‘é€é€šçŸ¥
    await this.sendNotifsByPriority(request, selectedChannels);
  }

  private selectChannels(
    request: NotifRequest,
    preferences: UserPreferences,
  ): NotifChannel[] {
    const channels: NotifChannel[] = [];

    // æ ¹æ®é€šçŸ¥ç±»å‹å’Œç”¨æˆ·åå¥½é€‰æ‹©é¢‘é“
    if (preferences.isInAppEnabled(request.type)) {
      channels.push(NotifChannel.IN_APP);
    }

    if (preferences.isEmailEnabled(request.type)) {
      channels.push(NotifChannel.EMAIL);
    }

    if (preferences.isPushEnabled(request.type)) {
      channels.push(NotifChannel.PUSH);
    }

    if (preferences.isSMSEnabled(request.type) && request.isUrgent) {
      channels.push(NotifChannel.SMS);
    }

    return channels;
  }

  private async sendNotifsByPriority(
    request: NotifRequest,
    channels: NotifChannel[],
  ): Promise<void> {
    // æŒ‰ä¼˜å…ˆçº§å‘é€é€šçŸ¥
    const priorityOrder = [
      NotifChannel.SMS,
      NotifChannel.PUSH,
      NotifChannel.IN_APP,
      NotifChannel.EMAIL,
    ];

    for (const channel of priorityOrder) {
      if (channels.includes(channel)) {
        try {
          await this.sendNotifByChannel(request, channel);
        } catch (error) {
          // è®°å½•é”™è¯¯ä½†ä¸ä¸­æ–­å…¶ä»–é¢‘é“çš„å‘é€
          console.error(`Failed to send notif via ${channel}:`, error);
        }
      }
    }
  }

  private async sendNotifByChannel(
    request: NotifRequest,
    channel: NotifChannel,
  ): Promise<void> {
    switch (channel) {
      case NotifChannel.IN_APP:
        await this.inAppNotifService.sendNotif(request);
        break;
      case NotifChannel.EMAIL:
        await this.emailNotifService.sendNotif(request);
        break;
      case NotifChannel.PUSH:
        await this.pushNotifService.sendNotif(request);
        break;
      case NotifChannel.SMS:
        await this.smsNotifService.sendNotif(request);
        break;
    }
  }
}
```

### 2.6 å€¼å¯¹è±¡å’Œæšä¸¾

#### 2.6.1 é€šç”¨å€¼å¯¹è±¡

```typescript
/**
 * @class NotifId
 * @description é€šçŸ¥IDå€¼å¯¹è±¡ï¼Œç¡®ä¿é€šçŸ¥æ ‡è¯†çš„å”¯ä¸€æ€§å’Œæœ‰æ•ˆæ€§
 */
export class NotifId extends ValueObject<string> {
  constructor(value: string) {
    super(value);
    this.validate();
  }

  private validate(): void {
    if (!this.value || this.value.length === 0) {
      throw new InvalidNotifIdError('Notif ID cannot be empty');
    }
  }

  public static generate(): NotifId {
    return new NotifId(uuidv4());
  }
}

/**
 * @class TemplateId
 * @description æ¨¡æ¿IDå€¼å¯¹è±¡ï¼Œç¡®ä¿æ¨¡æ¿æ ‡è¯†çš„å”¯ä¸€æ€§å’Œæœ‰æ•ˆæ€§
 */
export class TemplateId extends ValueObject<string> {
  constructor(value: string) {
    super(value);
    this.validate();
  }

  private validate(): void {
    if (!this.value || this.value.length === 0) {
      throw new InvalidTemplateIdError('Template ID cannot be empty');
    }
  }

  public static generate(): TemplateId {
    return new TemplateId(uuidv4());
  }
}
```

#### 2.6.2 é€šçŸ¥ç±»å‹æšä¸¾

```typescript
/**
 * @enum NotifType
 * @description é€šçŸ¥ç±»å‹æšä¸¾ï¼Œå®šä¹‰ç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰é€šçŸ¥ç±»å‹
 */
export enum NotifType {
  // ç³»ç»Ÿç±»é€šçŸ¥
  SYSTEM = 'system',
  SYSTEM_MAINTENANCE = 'system_maintenance',
  SYSTEM_UPDATE = 'system_update',
  SECURITY_ALERT = 'security_alert',

  // å¹³å°ç®¡ç†ç±»é€šçŸ¥
  PLATFORM_MANAGEMENT = 'platform_management',
  TENANT_CREATED = 'tenant_created',
  TENANT_DELETED = 'tenant_deleted',
  PLATFORM_USER_ASSIGNED = 'platform_user_assigned',

  // ç§Ÿæˆ·ç®¡ç†ç±»é€šçŸ¥
  TENANT_MANAGEMENT = 'tenant_management',
  TENANT_USER_ASSIGNED = 'tenant_user_assigned',
  ORGANIZATION_CREATED = 'organization_created',
  TENANT_CONFIG_UPDATED = 'tenant_config_updated',

  // ç»„ç»‡ç®¡ç†ç±»é€šçŸ¥
  ORGANIZATION_MANAGEMENT = 'organization_management',
  ORGANIZATION_DELETED = 'organization_deleted',
  DEPARTMENT_CREATED = 'department_created',
  ORGANIZATION_STRUCTURE_CHANGED = 'organization_structure_changed',

  // éƒ¨é—¨ç®¡ç†ç±»é€šçŸ¥
  DEPARTMENT_MANAGEMENT = 'department_management',
  DEPARTMENT_USER_ASSIGNED = 'department_user_assigned',
  DEPARTMENT_INFO_UPDATED = 'department_info_updated',
  DEPARTMENT_PERMISSION_CHANGED = 'department_permission_changed',

  // ç”¨æˆ·ç®¡ç†ç±»é€šçŸ¥
  USER_MANAGEMENT = 'user_management',
  USER_REGISTERED = 'user_registered',
  USER_LOGIN = 'user_login',
  USER_PERMISSION_CHANGED = 'user_permission_changed',
  USER_ASSIGNED = 'user_assigned',

  // æƒé™ç®¡ç†ç±»é€šçŸ¥
  PERMISSION_MANAGEMENT = 'permission_management',
  ROLE_ASSIGNED = 'role_assigned',
  ROLE_REVOKED = 'role_revoked',
  PERMISSION_APPLIED = 'permission_applied',
  PERMISSION_APPROVED = 'permission_approved',

  // å®‰å…¨ç±»é€šçŸ¥
  SECURITY = 'security',
  ABNORMAL_LOGIN = 'abnormal_login',
  PERMISSION_VIOLATION = 'permission_violation',
  DATA_ACCESS_ANOMALY = 'data_access_anomaly',
}
```

#### 2.6.3 é€šçŸ¥é¢‘é“æšä¸¾

```typescript
/**
 * @enum NotifChannel
 * @description é€šçŸ¥é¢‘é“æšä¸¾ï¼Œå®šä¹‰ç³»ç»Ÿæ”¯æŒçš„æ‰€æœ‰é€šçŸ¥é¢‘é“
 */
export enum NotifChannel {
  IN_APP = 'in_app', // ç«™å†…ä¿¡
  EMAIL = 'email', // é‚®ä»¶
  PUSH = 'push', // æ¨é€é€šçŸ¥
  SMS = 'sms', // çŸ­ä¿¡
  WEBHOOK = 'webhook', // Webhookï¼ˆæœªæ¥æ‰©å±•ï¼‰
}
```

#### 2.6.4 é€šçŸ¥çŠ¶æ€æšä¸¾

```typescript
/**
 * @enum ReadStatus
 * @description
 * ç«™å†…é€šçŸ¥è¯»å–çŠ¶æ€æšä¸¾ï¼Œå®šä¹‰ç«™å†…é€šçŸ¥çš„è¯»å–çŠ¶æ€ç±»å‹ã€‚
 *
 * çŠ¶æ€ç±»å‹ï¼š
 * 1. UNREAD - æœªè¯»ï¼šç”¨æˆ·å°šæœªæŸ¥çœ‹çš„é€šçŸ¥
 * 2. READ - å·²è¯»ï¼šç”¨æˆ·å·²ç»æŸ¥çœ‹çš„é€šçŸ¥
 * 3. ARCHIVED - å·²å½’æ¡£ï¼šç”¨æˆ·å·²å½’æ¡£çš„é€šçŸ¥
 *
 * çŠ¶æ€è½¬æ¢è§„åˆ™ï¼š
 * 1. UNREAD â†’ READï¼šç”¨æˆ·æŸ¥çœ‹é€šçŸ¥æ—¶
 * 2. READ â†’ ARCHIVEDï¼šç”¨æˆ·å½’æ¡£é€šçŸ¥æ—¶
 * 3. UNREAD â†’ ARCHIVEDï¼šç”¨æˆ·ç›´æ¥å½’æ¡£æœªè¯»é€šçŸ¥æ—¶
 * 4. ä¸å…è®¸åå‘è½¬æ¢
 */
export enum ReadStatus {
  UNREAD = 'UNREAD',
  READ = 'READ',
  ARCHIVED = 'ARCHIVED',
}

/**
 * @class ReadStatusValidator
 * @description
 * è¯»å–çŠ¶æ€éªŒè¯å™¨ï¼Œè´Ÿè´£éªŒè¯çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§ã€‚
 *
 * éªŒè¯èŒè´£ï¼š
 * 1. éªŒè¯çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§
 * 2. æä¾›çŠ¶æ€è½¬æ¢è§„åˆ™æ£€æŸ¥
 * 3. ç¡®ä¿çŠ¶æ€è½¬æ¢çš„ä¸šåŠ¡è§„åˆ™
 */
export class ReadStatusValidator {
  /**
   * @method canTransition
   * @description æ£€æŸ¥æ˜¯å¦å¯ä»¥ä»ä¸€ä¸ªçŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªçŠ¶æ€
   * @param {ReadStatus} fromStatus åŸçŠ¶æ€
   * @param {ReadStatus} toStatus ç›®æ ‡çŠ¶æ€
   * @returns {boolean} æ˜¯å¦å¯ä»¥è½¬æ¢
   */
  public canTransition(fromStatus: ReadStatus, toStatus: ReadStatus): boolean {
    const validTransitions: Record<ReadStatus, ReadStatus[]> = {
      [ReadStatus.UNREAD]: [ReadStatus.READ, ReadStatus.ARCHIVED],
      [ReadStatus.READ]: [ReadStatus.ARCHIVED],
      [ReadStatus.ARCHIVED]: [], // å½’æ¡£çŠ¶æ€ä¸èƒ½è½¬æ¢åˆ°å…¶ä»–çŠ¶æ€
    };

    return validTransitions[fromStatus]?.includes(toStatus) || false;
  }

  /**
   * @method validateTransition
   * @description éªŒè¯çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§ï¼Œå¦‚æœæ— æ•ˆåˆ™æŠ›å‡ºå¼‚å¸¸
   * @param {ReadStatus} fromStatus åŸçŠ¶æ€
   * @param {ReadStatus} toStatus ç›®æ ‡çŠ¶æ€
   * @returns {void}
   * @throws {InvalidStatusTransitionError} å½“çŠ¶æ€è½¬æ¢æ— æ•ˆæ—¶æŠ›å‡º
   */
  public validateTransition(
    fromStatus: ReadStatus,
    toStatus: ReadStatus,
  ): void {
    if (!this.canTransition(fromStatus, toStatus)) {
      throw new InvalidStatusTransitionError(
        `Invalid status transition from ${fromStatus} to ${toStatus}`,
      );
    }
  }

  /**
   * @method isReadable
   * @description æ£€æŸ¥çŠ¶æ€æ˜¯å¦å¯è¯»
   * @param {ReadStatus} status çŠ¶æ€
   * @returns {boolean} æ˜¯å¦å¯è¯»
   */
  public isReadable(status: ReadStatus): boolean {
    return status === ReadStatus.UNREAD;
  }

  /**
   * @method isArchivable
   * @description æ£€æŸ¥çŠ¶æ€æ˜¯å¦å¯å½’æ¡£
   * @param {ReadStatus} status çŠ¶æ€
   * @returns {boolean} æ˜¯å¦å¯å½’æ¡£
   */
  public isArchivable(status: ReadStatus): boolean {
    return [ReadStatus.UNREAD, ReadStatus.READ].includes(status);
  }
}

/**
 * @enum EmailNotifStatus
 * @description é‚®ä»¶é€šçŸ¥çŠ¶æ€æšä¸¾
 */
export enum EmailNotifStatus {
  PENDING = 'pending', // å¾…å‘é€
  SENDING = 'sending', // å‘é€ä¸­
  SENT = 'sent', // å·²å‘é€
  DELIVERED = 'delivered', // å·²é€è¾¾
  FAILED = 'failed', // å‘é€å¤±è´¥
  PERMANENTLY_FAILED = 'permanently_failed', // æ°¸ä¹…å¤±è´¥
  CANCELLED = 'cancelled', // å·²å–æ¶ˆ
}

/**
 * @enum PushNotifStatus
 * @description æ¨é€é€šçŸ¥çŠ¶æ€æšä¸¾
 */
export enum PushNotifStatus {
  PENDING = 'pending', // å¾…å‘é€
  SENDING = 'sending', // å‘é€ä¸­
  DELIVERED = 'delivered', // å·²é€è¾¾
  CLICKED = 'clicked', // å·²ç‚¹å‡»
  FAILED = 'failed', // å‘é€å¤±è´¥
  PERMANENTLY_FAILED = 'permanently_failed', // æ°¸ä¹…å¤±è´¥
  CANCELLED = 'cancelled', // å·²å–æ¶ˆ
}

/**
 * @enum SmsNotifStatus
 * @description çŸ­ä¿¡é€šçŸ¥çŠ¶æ€æšä¸¾
 */
export enum SmsNotifStatus {
  PENDING = 'pending', // å¾…å‘é€
  SENDING = 'sending', // å‘é€ä¸­
  SENT = 'sent', // å·²å‘é€
  DELIVERED = 'delivered', // å·²é€è¾¾
  FAILED = 'failed', // å‘é€å¤±è´¥
  PERMANENTLY_FAILED = 'permanently_failed', // æ°¸ä¹…å¤±è´¥
  CANCELLED = 'cancelled', // å·²å–æ¶ˆ
}
```

#### 2.6.5 é€šçŸ¥ä¼˜å…ˆçº§æšä¸¾

```typescript
/**
 * @enum NotifPriority
 * @description é€šçŸ¥ä¼˜å…ˆçº§æšä¸¾ï¼Œç”¨äºæ§åˆ¶é€šçŸ¥çš„æ˜¾ç¤ºå’Œå‘é€ä¼˜å…ˆçº§
 */
export enum NotifPriority {
  LOW = 'low', // ä½ä¼˜å…ˆçº§
  NORMAL = 'normal', // æ™®é€šä¼˜å…ˆçº§
  HIGH = 'high', // é«˜ä¼˜å…ˆçº§
  URGENT = 'urgent', // ç´§æ€¥ä¼˜å…ˆçº§
  CRITICAL = 'critical', // å…³é”®ä¼˜å…ˆçº§
}
```

#### 2.6.6 SMSæä¾›å•†æšä¸¾

```typescript
/**
 * @enum SMSProvider
 * @description çŸ­ä¿¡æœåŠ¡æä¾›å•†æšä¸¾
 */
export enum SMSProvider {
  ALIYUN = 'aliyun', // é˜¿é‡Œäº‘çŸ­ä¿¡
  TENCENT = 'tencent', // è…¾è®¯äº‘çŸ­ä¿¡
  AWS_SNS = 'aws_sns', // AWS SNS
  TWILIO = 'twilio', // Twilio
  CUSTOM = 'custom', // è‡ªå®šä¹‰æä¾›å•†
}
```

### 2.7 é¢†åŸŸäº‹ä»¶

#### 2.7.1 ç«™å†…ä¿¡å­é¢†åŸŸäº‹ä»¶

```typescript
/**
 * @class InAppNotifCreatedEvent
 * @description ç«™å†…é€šçŸ¥åˆ›å»ºäº‹ä»¶ï¼Œå½“ç«™å†…é€šçŸ¥è¢«åˆ›å»ºæ—¶è§¦å‘
 */
export class InAppNotifCreatedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'InAppNotifCreated';

  constructor(
    public readonly notifId: NotifId,
    public readonly tenantId: TenantId,
    public readonly recipientId: UserId,
    public readonly type: NotifType,
    public readonly title: string,
    public readonly content: string,
    public readonly priority: NotifPriority,
    public readonly metadata: Record<string, unknown>,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class InAppNotifReadEvent
 * @description ç«™å†…é€šçŸ¥å·²è¯»äº‹ä»¶ï¼Œå½“ç«™å†…é€šçŸ¥è¢«æ ‡è®°ä¸ºå·²è¯»æ—¶è§¦å‘
 */
export class InAppNotifReadEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'InAppNotifRead';

  constructor(
    public readonly notifId: NotifId,
    public readonly tenantId: TenantId,
    public readonly recipientId: UserId,
    public readonly oldStatus: ReadStatus,
    public readonly newStatus: ReadStatus,
    public readonly readAt: Date,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class InAppNotifArchivedEvent
 * @description ç«™å†…é€šçŸ¥å½’æ¡£äº‹ä»¶ï¼Œå½“ç«™å†…é€šçŸ¥è¢«å½’æ¡£æ—¶è§¦å‘
 */
export class InAppNotifArchivedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'InAppNotifArchived';

  constructor(
    public readonly notifId: NotifId,
    public readonly tenantId: TenantId,
    public readonly recipientId: UserId,
    public readonly oldStatus: ReadStatus,
    public readonly archivedAt: Date,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}
```

#### 2.7.2 é‚®ä»¶é€šçŸ¥å­é¢†åŸŸäº‹ä»¶

```typescript
/**
 * @class EmailNotifSendingEvent
 * @description é‚®ä»¶é€šçŸ¥å‘é€ä¸­äº‹ä»¶ï¼Œå½“é‚®ä»¶å¼€å§‹å‘é€æ—¶è§¦å‘
 */
export class EmailNotifSendingEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'EmailNotifSending';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientEmail: string,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class EmailNotifSentEvent
 * @description é‚®ä»¶é€šçŸ¥å·²å‘é€äº‹ä»¶ï¼Œå½“é‚®ä»¶å‘é€æˆåŠŸæ—¶è§¦å‘
 */
export class EmailNotifSentEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'EmailNotifSent';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientEmail: string,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class EmailNotifFailedEvent
 * @description é‚®ä»¶é€šçŸ¥å‘é€å¤±è´¥äº‹ä»¶ï¼Œå½“é‚®ä»¶å‘é€å¤±è´¥æ—¶è§¦å‘
 */
export class EmailNotifFailedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'EmailNotifFailed';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientEmail: string,
    public readonly error: string,
    public readonly retryCount: number,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class EmailNotifPermanentlyFailedEvent
 * @description é‚®ä»¶é€šçŸ¥æ°¸ä¹…å¤±è´¥äº‹ä»¶ï¼Œå½“é‚®ä»¶å‘é€è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°æ—¶è§¦å‘
 */
export class EmailNotifPermanentlyFailedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'EmailNotifPermanentlyFailed';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientEmail: string,
    public readonly error: string,
    public readonly retryCount: number,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}
```

#### 2.7.3 æ¨é€é€šçŸ¥å­é¢†åŸŸäº‹ä»¶

```typescript
/**
 * @class PushNotifSendingEvent
 * @description æ¨é€é€šçŸ¥å‘é€ä¸­äº‹ä»¶ï¼Œå½“æ¨é€å¼€å§‹å‘é€æ—¶è§¦å‘
 */
export class PushNotifSendingEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'PushNotifSending';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly deviceToken: string,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class PushNotifDeliveredEvent
 * @description æ¨é€é€šçŸ¥å·²é€è¾¾äº‹ä»¶ï¼Œå½“æ¨é€é€è¾¾æˆåŠŸæ—¶è§¦å‘
 */
export class PushNotifDeliveredEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'PushNotifDelivered';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly deviceToken: string,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class PushNotifFailedEvent
 * @description æ¨é€é€šçŸ¥å‘é€å¤±è´¥äº‹ä»¶ï¼Œå½“æ¨é€å‘é€å¤±è´¥æ—¶è§¦å‘
 */
export class PushNotifFailedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'PushNotifFailed';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly deviceToken: string,
    public readonly error: string,
    public readonly errorCode: string,
    public readonly retryCount: number,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class PushNotifPermanentlyFailedEvent
 * @description æ¨é€é€šçŸ¥æ°¸ä¹…å¤±è´¥äº‹ä»¶ï¼Œå½“æ¨é€å‘é€è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°æˆ–é‡åˆ°æ°¸ä¹…æ€§é”™è¯¯æ—¶è§¦å‘
 */
export class PushNotifPermanentlyFailedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'PushNotifPermanentlyFailed';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly deviceToken: string,
    public readonly error: string,
    public readonly errorCode: string,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}
```

#### 2.7.4 çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸäº‹ä»¶

```typescript
/**
 * @class SmsNotifSendingEvent
 * @description çŸ­ä¿¡é€šçŸ¥å‘é€ä¸­äº‹ä»¶ï¼Œå½“çŸ­ä¿¡å¼€å§‹å‘é€æ—¶è§¦å‘
 */
export class SmsNotifSendingEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'SmsNotifSending';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientPhone: string,
    public readonly cost: number,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class SmsNotifSentEvent
 * @description çŸ­ä¿¡é€šçŸ¥å·²å‘é€äº‹ä»¶ï¼Œå½“çŸ­ä¿¡å‘é€æˆåŠŸæ—¶è§¦å‘
 */
export class SmsNotifSentEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'SmsNotifSent';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientPhone: string,
    public readonly cost: number,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class SmsNotifFailedEvent
 * @description çŸ­ä¿¡é€šçŸ¥å‘é€å¤±è´¥äº‹ä»¶ï¼Œå½“çŸ­ä¿¡å‘é€å¤±è´¥æ—¶è§¦å‘
 */
export class SmsNotifFailedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'SmsNotifFailed';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientPhone: string,
    public readonly error: string,
    public readonly cost: number,
    public readonly retryCount: number,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}

/**
 * @class SmsNotifPermanentlyFailedEvent
 * @description çŸ­ä¿¡é€šçŸ¥æ°¸ä¹…å¤±è´¥äº‹ä»¶ï¼Œå½“çŸ­ä¿¡å‘é€è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°æ—¶è§¦å‘
 */
export class SmsNotifPermanentlyFailedEvent implements IDomainEvent {
  public readonly eventId: string;
  public readonly occurredOn: Date;
  public readonly eventType: string = 'SmsNotifPermanentlyFailed';

  constructor(
    public readonly notifId: string,
    public readonly recipientId: string,
    public readonly tenantId: string,
    public readonly recipientPhone: string,
    public readonly error: string,
    public readonly cost: number,
    public readonly occurredOn: Date = new Date(),
  ) {
    this.eventId = uuidv4();
    this.occurredOn = occurredOn;
  }
}
```

## 3. åº”ç”¨å±‚è®¾è®¡

### 3.1 ç«™å†…ä¿¡å­é¢†åŸŸåº”ç”¨å±‚

#### 3.1.1 ç«™å†…ä¿¡å‘½ä»¤

```typescript
/**
 * @class CreateInAppNotifCommand
 * @description åˆ›å»ºç«™å†…é€šçŸ¥å‘½ä»¤
 */
export class CreateInAppNotifCommand {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId: string,
    public readonly type: NotifType,
    public readonly title: string,
    public readonly content: string,
    public readonly metadata?: any,
    public readonly priority: NotifPriority = NotifPriority.NORMAL,
  ) {}
}

/**
 * @class MarkInAppNotifAsReadCommand
 * @description æ ‡è®°ç«™å†…é€šçŸ¥å·²è¯»å‘½ä»¤
 */
export class MarkInAppNotifAsReadCommand {
  constructor(
    public readonly notifId: string,
    public readonly userId: string,
  ) {}
}

/**
 * @class ArchiveInAppNotifCommand
 * @description å½’æ¡£ç«™å†…é€šçŸ¥å‘½ä»¤
 */
export class ArchiveInAppNotifCommand {
  constructor(
    public readonly notifId: string,
    public readonly userId: string,
  ) {}
}
```

#### 3.1.2 ç«™å†…ä¿¡æŸ¥è¯¢

```typescript
/**
 * @class GetInAppNotifsQuery
 * @description è·å–ç«™å†…é€šçŸ¥åˆ—è¡¨æŸ¥è¯¢
 */
export class GetInAppNotifsQuery {
  constructor(
    public readonly userId: string,
    public readonly tenantId: string,
    public readonly page: number = 1,
    public readonly limit: number = 20,
    public readonly type?: NotifType,
    public readonly status?: InAppNotifStatus,
    public readonly priority?: NotifPriority,
  ) {}
}

/**
 * @class GetInAppNotifStatsQuery
 * @description è·å–ç«™å†…é€šçŸ¥ç»Ÿè®¡æŸ¥è¯¢
 */
export class GetInAppNotifStatsQuery {
  constructor(
    public readonly userId: string,
    public readonly tenantId: string,
    public readonly startDate: Date,
    public readonly endDate: Date,
  ) {}
}
```

### 3.2 é‚®ä»¶é€šçŸ¥å­é¢†åŸŸåº”ç”¨å±‚

#### 3.2.1 é‚®ä»¶é€šçŸ¥å‘½ä»¤

```typescript
/**
 * @class CreateEmailNotifCommand
 * @description åˆ›å»ºé‚®ä»¶é€šçŸ¥å‘½ä»¤
 */
export class CreateEmailNotifCommand {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId: string,
    public readonly recipientEmail: string,
    public readonly subject: string,
    public readonly content: string,
    public readonly templateId?: string,
    public readonly metadata?: any,
  ) {}
}

/**
 * @class SendEmailNotifCommand
 * @description å‘é€é‚®ä»¶é€šçŸ¥å‘½ä»¤
 */
export class SendEmailNotifCommand {
  constructor(
    public readonly notifId: string,
    public readonly retryCount: number = 0,
  ) {}
}

/**
 * @class RetryEmailNotifCommand
 * @description é‡è¯•é‚®ä»¶é€šçŸ¥å‘½ä»¤
 */
export class RetryEmailNotifCommand {
  constructor(public readonly notifId: string) {}
}
```

#### 3.2.2 é‚®ä»¶é€šçŸ¥æŸ¥è¯¢

```typescript
/**
 * @class GetEmailNotifsQuery
 * @description è·å–é‚®ä»¶é€šçŸ¥åˆ—è¡¨æŸ¥è¯¢
 */
export class GetEmailNotifsQuery {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId?: string,
    public readonly status?: EmailNotifStatus,
    public readonly page: number = 1,
    public readonly limit: number = 20,
    public readonly startDate?: Date,
    public readonly endDate?: Date,
  ) {}
}

/**
 * @class GetEmailNotifStatsQuery
 * @description è·å–é‚®ä»¶é€šçŸ¥ç»Ÿè®¡æŸ¥è¯¢
 */
export class GetEmailNotifStatsQuery {
  constructor(
    public readonly tenantId: string,
    public readonly startDate: Date,
    public readonly endDate: Date,
    public readonly groupBy?: 'day' | 'week' | 'month',
  ) {}
}
```

### 3.3 æ¨é€é€šçŸ¥å­é¢†åŸŸåº”ç”¨å±‚

#### 3.3.1 æ¨é€é€šçŸ¥å‘½ä»¤

```typescript
/**
 * @class CreatePushNotifCommand
 * @description åˆ›å»ºæ¨é€é€šçŸ¥å‘½ä»¤
 */
export class CreatePushNotifCommand {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId: string,
    public readonly deviceToken: string,
    public readonly title: string,
    public readonly body: string,
    public readonly data?: Record<string, any>,
    public readonly metadata?: any,
  ) {}
}

/**
 * @class SendPushNotifCommand
 * @description å‘é€æ¨é€é€šçŸ¥å‘½ä»¤
 */
export class SendPushNotifCommand {
  constructor(
    public readonly notifId: string,
    public readonly retryCount: number = 0,
  ) {}
}

/**
 * @class RegisterDeviceTokenCommand
 * @description æ³¨å†Œè®¾å¤‡ä»¤ç‰Œå‘½ä»¤
 */
export class RegisterDeviceTokenCommand {
  constructor(
    public readonly userId: string,
    public readonly tenantId: string,
    public readonly deviceToken: string,
    public readonly deviceType: 'web' | 'ios' | 'android',
    public readonly deviceInfo?: any,
  ) {}
}
```

#### 3.3.2 æ¨é€é€šçŸ¥æŸ¥è¯¢

```typescript
/**
 * @class GetPushNotifsQuery
 * @description è·å–æ¨é€é€šçŸ¥åˆ—è¡¨æŸ¥è¯¢
 */
export class GetPushNotifsQuery {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId?: string,
    public readonly status?: PushNotifStatus,
    public readonly page: number = 1,
    public readonly limit: number = 20,
    public readonly startDate?: Date,
    public readonly endDate?: Date,
  ) {}
}

/**
 * @class GetDeviceTokensQuery
 * @description è·å–è®¾å¤‡ä»¤ç‰Œåˆ—è¡¨æŸ¥è¯¢
 */
export class GetDeviceTokensQuery {
  constructor(
    public readonly userId: string,
    public readonly tenantId: string,
    public readonly deviceType?: 'web' | 'ios' | 'android',
  ) {}
}
```

### 3.4 çŸ­ä¿¡é€šçŸ¥å­é¢†åŸŸåº”ç”¨å±‚

#### 3.4.1 çŸ­ä¿¡é€šçŸ¥å‘½ä»¤

```typescript
/**
 * @class CreateSmsNotifCommand
 * @description åˆ›å»ºçŸ­ä¿¡é€šçŸ¥å‘½ä»¤
 */
export class CreateSmsNotifCommand {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId: string,
    public readonly recipientPhone: string,
    public readonly content: string,
    public readonly provider: SMSProvider,
    public readonly metadata?: any,
  ) {}
}

/**
 * @class SendSmsNotifCommand
 * @description å‘é€çŸ­ä¿¡é€šçŸ¥å‘½ä»¤
 */
export class SendSmsNotifCommand {
  constructor(
    public readonly notifId: string,
    public readonly retryCount: number = 0,
  ) {}
}

/**
 * @class RetrySmsNotifCommand
 * @description é‡è¯•çŸ­ä¿¡é€šçŸ¥å‘½ä»¤
 */
export class RetrySmsNotifCommand {
  constructor(public readonly notifId: string) {}
}
```

#### 3.4.2 çŸ­ä¿¡é€šçŸ¥æŸ¥è¯¢

```typescript
/**
 * @class GetSmsNotifsQuery
 * @description è·å–çŸ­ä¿¡é€šçŸ¥åˆ—è¡¨æŸ¥è¯¢
 */
export class GetSmsNotifsQuery {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId?: string,
    public readonly status?: SmsNotifStatus,
    public readonly provider?: SMSProvider,
    public readonly page: number = 1,
    public readonly limit: number = 20,
    public readonly startDate?: Date,
    public readonly endDate?: Date,
  ) {}
}

/**
 * @class GetSMSCostStatsQuery
 * @description è·å–çŸ­ä¿¡æˆæœ¬ç»Ÿè®¡æŸ¥è¯¢
 */
export class GetSMSCostStatsQuery {
  constructor(
    public readonly tenantId: string,
    public readonly startDate: Date,
    public readonly endDate: Date,
    public readonly groupBy?: 'day' | 'week' | 'month' | 'provider',
  ) {}
}
```

### 3.5 é€šçŸ¥ç¼–æ’å­é¢†åŸŸåº”ç”¨å±‚

#### 3.5.1 é€šçŸ¥ç¼–æ’å‘½ä»¤

```typescript
/**
 * @class OrchestrateNotifCommand
 * @description ç¼–æ’é€šçŸ¥å‘é€å‘½ä»¤
 */
export class OrchestrateNotifCommand {
  constructor(
    public readonly tenantId: string,
    public readonly recipientId: string,
    public readonly type: NotifType,
    public readonly title: string,
    public readonly content: string,
    public readonly metadata?: any,
    public readonly isUrgent: boolean = false,
    public readonly preferredChannels?: NotifChannel[],
  ) {}
}

/**
 * @class BatchOrchestrateNotifCommand
 * @description æ‰¹é‡ç¼–æ’é€šçŸ¥å‘é€å‘½ä»¤
 */
export class BatchOrchestrateNotifCommand {
  constructor(
    public readonly tenantId: string,
    public readonly recipientIds: string[],
    public readonly type: NotifType,
    public readonly title: string,
    public readonly content: string,
    public readonly metadata?: any,
    public readonly isUrgent: boolean = false,
    public readonly preferredChannels?: NotifChannel[],
  ) {}
}
```

#### 3.5.2 é€šçŸ¥ç¼–æ’æŸ¥è¯¢

```typescript
/**
 * @class GetNotifOrchestrationStatsQuery
 * @description è·å–é€šçŸ¥ç¼–æ’ç»Ÿè®¡æŸ¥è¯¢
 */
export class GetNotifOrchestrationStatsQuery {
  constructor(
    public readonly tenantId: string,
    public readonly startDate: Date,
    public readonly endDate: Date,
    public readonly groupBy?: 'channel' | 'type' | 'day' | 'week' | 'month',
  ) {}
}
```

### 3.6 å‘½ä»¤å¤„ç†å™¨

#### 3.6.1 ç«™å†…ä¿¡å‘½ä»¤å¤„ç†å™¨

```typescript
/**
 * @class CreateInAppNotifHandler
 * @description åˆ›å»ºç«™å†…é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(CreateInAppNotifCommand)
export class CreateInAppNotifHandler
  implements ICommandHandler<CreateInAppNotifCommand>
{
  constructor(
    private readonly inAppNotifRepository: IInAppNotifRepository,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: CreateInAppNotifCommand): Promise<void> {
    // åˆ›å»ºç«™å†…é€šçŸ¥èšåˆæ ¹
    const notif = InAppNotif.create(
      NotifId.generate(),
      new TenantId(command.tenantId),
      new UserId(command.recipientId),
      command.type,
      command.title,
      command.content,
      command.priority,
      command.metadata,
    );

    // ä¿å­˜åˆ°ä»“å‚¨
    await this.inAppNotifRepository.save(notif);

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶åˆ°äº‹ä»¶æ€»çº¿ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
    await this.eventBus.publishAll(notif.getUncommittedEvents());
    notif.markEventsAsCommitted();
  }
}

/**
 * @class MarkInAppNotifAsReadHandler
 * @description æ ‡è®°ç«™å†…é€šçŸ¥å·²è¯»å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(MarkInAppNotifAsReadCommand)
export class MarkInAppNotifAsReadHandler
  implements ICommandHandler<MarkInAppNotifAsReadCommand>
{
  constructor(
    private readonly inAppNotifRepository: IInAppNotifRepository,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: MarkInAppNotifAsReadCommand): Promise<void> {
    // æŸ¥è¯¢èšåˆæ ¹
    const notif = await this.inAppNotifRepository.findById(
      new NotifId(command.notifId),
    );

    if (!notif) {
      throw new InAppNotifNotFoundError(command.notifId);
    }

    // è°ƒç”¨ä¸šåŠ¡æ–¹æ³•ï¼Œä¼šå‘å¸ƒäº‹ä»¶
    notif.markAsRead(command.userId);
    await this.inAppNotifRepository.save(notif);

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publishAll(notif.getUncommittedEvents());
    notif.markEventsAsCommitted();
  }
}

/**
 * @class ArchiveInAppNotifHandler
 * @description å½’æ¡£ç«™å†…é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(ArchiveInAppNotifCommand)
export class ArchiveInAppNotifHandler
  implements ICommandHandler<ArchiveInAppNotifCommand>
{
  constructor(
    private readonly inAppNotifRepository: IInAppNotifRepository,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: ArchiveInAppNotifCommand): Promise<void> {
    const notif = await this.inAppNotifRepository.findById(
      new NotifId(command.notifId),
    );

    if (!notif) {
      throw new InAppNotifNotFoundError(command.notifId);
    }

    // å½’æ¡£æ˜¯é‡è¦æ“ä½œï¼Œå‘å¸ƒäº‹ä»¶
    notif.archive(command.userId);
    await this.inAppNotifRepository.save(notif);

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publishAll(notif.getUncommittedEvents());
    notif.markEventsAsCommitted();
  }
}
```

#### 3.6.2 é‚®ä»¶é€šçŸ¥å‘½ä»¤å¤„ç†å™¨

```typescript
/**
 * @class CreateEmailNotifHandler
 * @description åˆ›å»ºé‚®ä»¶é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(CreateEmailNotifCommand)
export class CreateEmailNotifHandler
  implements ICommandHandler<CreateEmailNotifCommand>
{
  constructor(
    private readonly emailNotifRepository: IEmailNotifRepository,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: CreateEmailNotifCommand): Promise<void> {
    // åˆ›å»ºé‚®ä»¶é€šçŸ¥èšåˆæ ¹
    const notif = new EmailNotif(
      NotifId.generate(),
      new TenantId(command.tenantId),
      new UserId(command.recipientId),
      command.recipientEmail,
      command.subject,
      command.content,
      command.templateId ? new TemplateId(command.templateId) : undefined,
    );

    // ä¿å­˜åˆ°ä»“å‚¨
    await this.emailNotifRepository.save(notif);

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publishAll(notif.getUncommittedEvents());
    notif.markEventsAsCommitted();
  }
}

/**
 * @class SendEmailNotifHandler
 * @description å‘é€é‚®ä»¶é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(SendEmailNotifCommand)
export class SendEmailNotifHandler
  implements ICommandHandler<SendEmailNotifCommand>
{
  constructor(
    private readonly emailNotifRepository: IEmailNotifRepository,
    private readonly emailService: IEmailService,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: SendEmailNotifCommand): Promise<void> {
    const notif = await this.emailNotifRepository.findById(
      new NotifId(command.notifId),
    );

    if (!notif) {
      throw new EmailNotifNotFoundError(command.notifId);
    }

    try {
      // æ ‡è®°ä¸ºå‘é€ä¸­
      notif.markAsSending();
      await this.emailNotifRepository.save(notif);

      // å‘å¸ƒå‘é€ä¸­äº‹ä»¶
      await this.eventBus.publishAll(notif.getUncommittedEvents());
      notif.markEventsAsCommitted();

      // å‘é€é‚®ä»¶
      await this.emailService.sendEmail({
        to: notif.getRecipientEmail(),
        subject: notif.getSubject(),
        content: notif.getContent(),
      });

      // æ ‡è®°ä¸ºå·²å‘é€
      notif.markAsSent();
      await this.emailNotifRepository.save(notif);

      // å‘å¸ƒå·²å‘é€äº‹ä»¶
      await this.eventBus.publishAll(notif.getUncommittedEvents());
      notif.markEventsAsCommitted();
    } catch (error) {
      // æ ‡è®°ä¸ºå¤±è´¥
      notif.markAsFailed(error.message);
      await this.emailNotifRepository.save(notif);

      // å‘å¸ƒå¤±è´¥äº‹ä»¶
      await this.eventBus.publishAll(notif.getUncommittedEvents());
      notif.markEventsAsCommitted();
    }
  }
}
```

#### 3.6.3 æ¨é€é€šçŸ¥å‘½ä»¤å¤„ç†å™¨

```typescript
/**
 * @class CreatePushNotifHandler
 * @description åˆ›å»ºæ¨é€é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(CreatePushNotifCommand)
export class CreatePushNotifHandler
  implements ICommandHandler<CreatePushNotifCommand>
{
  constructor(
    private readonly pushNotifRepository: IPushNotifRepository,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: CreatePushNotifCommand): Promise<void> {
    // åˆ›å»ºæ¨é€é€šçŸ¥èšåˆæ ¹
    const notif = new PushNotif(
      NotifId.generate(),
      new TenantId(command.tenantId),
      new UserId(command.recipientId),
      command.deviceToken,
      command.title,
      command.body,
      command.data,
    );

    // ä¿å­˜åˆ°ä»“å‚¨
    await this.pushNotifRepository.save(notif);

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publishAll(notif.getUncommittedEvents());
    notif.markEventsAsCommitted();
  }
}

/**
 * @class SendPushNotifHandler
 * @description å‘é€æ¨é€é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(SendPushNotifCommand)
export class SendPushNotifHandler
  implements ICommandHandler<SendPushNotifCommand>
{
  constructor(
    private readonly pushNotifRepository: IPushNotifRepository,
    private readonly pushService: IPushService,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: SendPushNotifCommand): Promise<void> {
    const notif = await this.pushNotifRepository.findById(
      new NotifId(command.notifId),
    );

    if (!notif) {
      throw new PushNotifNotFoundError(command.notifId);
    }

    try {
      // æ ‡è®°ä¸ºå‘é€ä¸­
      notif.markAsSending();
      await this.pushNotifRepository.save(notif);

      // å‘å¸ƒå‘é€ä¸­äº‹ä»¶
      await this.eventBus.publishAll(notif.getUncommittedEvents());
      notif.markEventsAsCommitted();

      // å‘é€æ¨é€
      const result = await this.pushService.sendPush({
        deviceToken: notif.getDeviceToken(),
        title: notif.getTitle(),
        body: notif.getBody(),
        data: notif.getData(),
      });

      if (result.success) {
        // æ ‡è®°ä¸ºå·²é€è¾¾
        notif.markAsDelivered();
        await this.pushNotifRepository.save(notif);

        // å‘å¸ƒå·²é€è¾¾äº‹ä»¶
        await this.eventBus.publishAll(notif.getUncommittedEvents());
        notif.markEventsAsCommitted();
      } else {
        // æ ‡è®°ä¸ºå¤±è´¥
        notif.markAsFailed(result.error, result.errorCode);
        await this.pushNotifRepository.save(notif);

        // å‘å¸ƒå¤±è´¥äº‹ä»¶
        await this.eventBus.publishAll(notif.getUncommittedEvents());
        notif.markEventsAsCommitted();
      }
    } catch (error) {
      // æ ‡è®°ä¸ºå¤±è´¥
      notif.markAsFailed(error.message, 'UNKNOWN_ERROR');
      await this.pushNotifRepository.save(notif);

      // å‘å¸ƒå¤±è´¥äº‹ä»¶
      await this.eventBus.publishAll(notif.getUncommittedEvents());
      notif.markEventsAsCommitted();
    }
  }
}
```

#### 3.6.4 çŸ­ä¿¡é€šçŸ¥å‘½ä»¤å¤„ç†å™¨

```typescript
/**
 * @class CreateSmsNotifHandler
 * @description åˆ›å»ºçŸ­ä¿¡é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(CreateSmsNotifCommand)
export class CreateSmsNotifHandler
  implements ICommandHandler<CreateSmsNotifCommand>
{
  constructor(
    private readonly smsNotifRepository: ISmsNotifRepository,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: CreateSmsNotifCommand): Promise<void> {
    // åˆ›å»ºçŸ­ä¿¡é€šçŸ¥èšåˆæ ¹
    const notif = new SmsNotif(
      NotifId.generate(),
      new TenantId(command.tenantId),
      new UserId(command.recipientId),
      command.recipientPhone,
      command.content,
      command.provider,
    );

    // ä¿å­˜åˆ°ä»“å‚¨
    await this.smsNotifRepository.save(notif);

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    await this.eventBus.publishAll(notif.getUncommittedEvents());
    notif.markEventsAsCommitted();
  }
}

/**
 * @class SendSmsNotifHandler
 * @description å‘é€çŸ­ä¿¡é€šçŸ¥å‘½ä»¤å¤„ç†å™¨ï¼Œä½¿ç”¨äº‹ä»¶é©±åŠ¨
 */
@CommandHandler(SendSmsNotifCommand)
export class SendSmsNotifHandler
  implements ICommandHandler<SendSmsNotifCommand>
{
  constructor(
    private readonly smsNotifRepository: ISmsNotifRepository,
    private readonly smsService: ISMSService,
    private readonly eventBus: IEventBus,
  ) {}

  async execute(command: SendSmsNotifCommand): Promise<void> {
    const notif = await this.smsNotifRepository.findById(
      new NotifId(command.notifId),
    );

    if (!notif) {
      throw new SmsNotifNotFoundError(command.notifId);
    }

    try {
      // æ ‡è®°ä¸ºå‘é€ä¸­
      notif.markAsSending();
      await this.smsNotifRepository.save(notif);

      // å‘å¸ƒå‘é€ä¸­äº‹ä»¶
      await this.eventBus.publishAll(notif.getUncommittedEvents());
      notif.markEventsAsCommitted();

      // å‘é€çŸ­ä¿¡
      const result = await this.smsService.sendSMS({
        phone: notif.getRecipientPhone(),
        content: notif.getContent(),
        provider: notif.getProvider(),
      });

      if (result.success) {
        // æ ‡è®°ä¸ºå·²å‘é€
        notif.markAsSent();
        await this.smsNotifRepository.save(notif);

        // å‘å¸ƒå·²å‘é€äº‹ä»¶
        await this.eventBus.publishAll(notif.getUncommittedEvents());
        notif.markEventsAsCommitted();
      } else {
        // æ ‡è®°ä¸ºå¤±è´¥
        notif.markAsFailed(result.error);
        await this.smsNotifRepository.save(notif);

        // å‘å¸ƒå¤±è´¥äº‹ä»¶
        await this.eventBus.publishAll(notif.getUncommittedEvents());
        notif.markEventsAsCommitted();
      }
    } catch (error) {
      // æ ‡è®°ä¸ºå¤±è´¥
      notif.markAsFailed(error.message);
      await this.smsNotifRepository.save(notif);

      // å‘å¸ƒå¤±è´¥äº‹ä»¶
      await this.eventBus.publishAll(notif.getUncommittedEvents());
      notif.markEventsAsCommitted();
    }
  }
}
```

#### 3.6.5 é€šçŸ¥ç¼–æ’å‘½ä»¤å¤„ç†å™¨

```typescript
/**
 * @class OrchestrateNotifHandler
 * @description ç¼–æ’é€šçŸ¥å‘é€å‘½ä»¤å¤„ç†å™¨ï¼Œåè°ƒå„é¢‘é“å­é¢†åŸŸ
 */
@CommandHandler(OrchestrateNotifCommand)
export class OrchestrateNotifHandler
  implements ICommandHandler<OrchestrateNotifCommand>
{
  constructor(private readonly notifOrchestrator: NotifOrchestrator) {}

  async execute(command: OrchestrateNotifCommand): Promise<void> {
    // æ„å»ºé€šçŸ¥è¯·æ±‚
    const request: NotifRequest = {
      tenantId: command.tenantId,
      recipientId: command.recipientId,
      type: command.type,
      title: command.title,
      content: command.content,
      metadata: command.metadata,
      isUrgent: command.isUrgent,
      preferredChannels: command.preferredChannels,
    };

    // è°ƒç”¨ç¼–æ’æœåŠ¡
    await this.notifOrchestrator.orchestrateNotif(request);
  }
}

/**
 * @class BatchOrchestrateNotifHandler
 * @description æ‰¹é‡ç¼–æ’é€šçŸ¥å‘é€å‘½ä»¤å¤„ç†å™¨
 */
@CommandHandler(BatchOrchestrateNotifCommand)
export class BatchOrchestrateNotifHandler
  implements ICommandHandler<BatchOrchestrateNotifCommand>
{
  constructor(private readonly notifOrchestrator: NotifOrchestrator) {}

  async execute(command: BatchOrchestrateNotifCommand): Promise<void> {
    // å¹¶è¡Œå¤„ç†æ‰¹é‡é€šçŸ¥
    const promises = command.recipientIds.map(recipientId => {
      const request: NotifRequest = {
        tenantId: command.tenantId,
        recipientId,
        type: command.type,
        title: command.title,
        content: command.content,
        metadata: command.metadata,
        isUrgent: command.isUrgent,
        preferredChannels: command.preferredChannels,
      };

      return this.notifOrchestrator.orchestrateNotif(request);
    });

    // ç­‰å¾…æ‰€æœ‰é€šçŸ¥å¤„ç†å®Œæˆ
    await Promise.allSettled(promises);
  }
}
```

### 3.3 æŸ¥è¯¢å¤„ç†å™¨

#### 3.3.1 GetUserNotifsHandler (ç›´æ¥æŸ¥è¯¢)

```typescript
@QueryHandler(GetUserNotifsQuery)
export class GetUserNotifsHandler implements IQueryHandler<GetUserNotifsQuery> {
  constructor(private readonly notifRepository: INotifRepository) {}

  async execute(query: GetUserNotifsQuery): Promise<NotifListDto> {
    // ç›´æ¥æŸ¥è¯¢ï¼Œä¸ä½¿ç”¨äº‹ä»¶é©±åŠ¨
    const notifs = await this.notifRepository.findByUser(
      new UserId(query.userId),
      new TenantId(query.tenantId),
      query.page,
      query.limit,
      query.type,
      query.status,
    );

    return new NotifListDto(
      notifs.map(n => new NotifDto(n)),
      query.page,
      query.limit,
    );
  }
}
```

### 3.4 å¼‚æ­¥äº‹ä»¶å¤„ç†å™¨

#### 3.4.1 é€šçŸ¥äº‹ä»¶å¤„ç†å™¨

```typescript
/**
 * @class NotificationEventProcessor
 * @description é€šçŸ¥äº‹ä»¶å¼‚æ­¥å¤„ç†å™¨ï¼Œä½¿ç”¨Redis + Bullæ¶ˆæ¯é˜Ÿåˆ—
 */
@Processor('notification_events')
export class NotificationEventProcessor {
  constructor(
    private readonly notifService: NotifService,
    private readonly logger: Logger,
  ) {}

  /**
   * @method handleInAppNotifCreated
   * @description å¤„ç†ç«™å†…é€šçŸ¥åˆ›å»ºäº‹ä»¶
   */
  @Process('InAppNotifCreatedEvent')
  async handleInAppNotifCreated(
    job: Job<InAppNotifCreatedEvent>,
  ): Promise<void> {
    const event = job.data;
    try {
      // å¹¶è¡Œå¤„ç†å¤šä¸ªåç»­æ“ä½œ
      await Promise.allSettled([
        this.updateNotificationStats(event),
        this.sendRealTimeNotification(event),
        this.logAuditEvent(event),
      ]);

      this.logger.log(
        `InAppNotifCreatedEvent processed successfully: ${event.notifId.value}`,
      );
    } catch (error) {
      this.logger.error(
        `Failed to process InAppNotifCreatedEvent: ${event.notifId.value}`,
        error,
      );
      throw error;
    }
  }

  /**
   * @method handleEmailNotifSent
   * @description å¤„ç†é‚®ä»¶é€šçŸ¥å‘é€äº‹ä»¶
   */
  @Process('EmailNotifSentEvent')
  async handleEmailNotifSent(job: Job<EmailNotifSentEvent>): Promise<void> {
    const event = job.data;
    try {
      // å¹¶è¡Œå¤„ç†å¤šä¸ªåç»­æ“ä½œ
      await Promise.allSettled([
        this.updateDeliveryStats(event),
        this.sendDeliveryConfirmation(event),
        this.logEmailDelivery(event),
      ]);

      this.logger.log(
        `EmailNotifSentEvent processed successfully: ${event.notifId}`,
      );
    } catch (error) {
      this.logger.error(
        `Failed to process EmailNotifSentEvent: ${event.notifId}`,
        error,
      );
      throw error;
    }
  }

  /**
   * @method handlePushNotifDelivered
   * @description å¤„ç†æ¨é€é€šçŸ¥é€è¾¾äº‹ä»¶
   */
  @Process('PushNotifDeliveredEvent')
  async handlePushNotifDelivered(
    job: Job<PushNotifDeliveredEvent>,
  ): Promise<void> {
    const event = job.data;
    try {
      // å¹¶è¡Œå¤„ç†å¤šä¸ªåç»­æ“ä½œ
      await Promise.allSettled([
        this.updatePushStats(event),
        this.trackUserEngagement(event),
        this.logPushDelivery(event),
      ]);

      this.logger.log(
        `PushNotifDeliveredEvent processed successfully: ${event.notifId}`,
      );
    } catch (error) {
      this.logger.error(
        `Failed to process PushNotifDeliveredEvent: ${event.notifId}`,
        error,
      );
      throw error;
    }
  }

  private async updateNotificationStats(
    event: InAppNotifCreatedEvent,
  ): Promise<void> {
    // æ›´æ–°é€šçŸ¥ç»Ÿè®¡ä¿¡æ¯
  }

  private async sendRealTimeNotification(
    event: InAppNotifCreatedEvent,
  ): Promise<void> {
    // å‘é€å®æ—¶é€šçŸ¥
  }

  private async logAuditEvent(event: InAppNotifCreatedEvent): Promise<void> {
    // è®°å½•å®¡è®¡æ—¥å¿—
  }

  private async updateDeliveryStats(event: EmailNotifSentEvent): Promise<void> {
    // æ›´æ–°é‚®ä»¶é€è¾¾ç»Ÿè®¡
  }

  private async sendDeliveryConfirmation(
    event: EmailNotifSentEvent,
  ): Promise<void> {
    // å‘é€é€è¾¾ç¡®è®¤
  }

  private async logEmailDelivery(event: EmailNotifSentEvent): Promise<void> {
    // è®°å½•é‚®ä»¶é€è¾¾æ—¥å¿—
  }

  private async updatePushStats(event: PushNotifDeliveredEvent): Promise<void> {
    // æ›´æ–°æ¨é€ç»Ÿè®¡
  }

  private async trackUserEngagement(
    event: PushNotifDeliveredEvent,
  ): Promise<void> {
    // è·Ÿè¸ªç”¨æˆ·å‚ä¸åº¦
  }

  private async logPushDelivery(event: PushNotifDeliveredEvent): Promise<void> {
    // è®°å½•æ¨é€é€è¾¾æ—¥å¿—
  }
}
```

#### 3.4.2 è·¨æ¨¡å—äº‹ä»¶å¤„ç†å™¨

```typescript
/**
 * @class CrossModuleEventProcessor
 * @description è·¨æ¨¡å—äº‹ä»¶å¤„ç†å™¨ï¼Œå¤„ç†æ¥è‡ªå…¶ä»–ä¸šåŠ¡æ¨¡å—çš„äº‹ä»¶
 */
@Processor('cross_module_events')
export class CrossModuleEventProcessor {
  constructor(
    private readonly notifOrchestrator: NotifOrchestrator,
    private readonly logger: Logger,
  ) {}

  /**
   * @method handleUserRegistered
   * @description å¤„ç†ç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼Œè‡ªåŠ¨å‘é€æ¬¢è¿é€šçŸ¥
   */
  @Process('UserRegisteredEvent')
  async handleUserRegistered(job: Job<UserRegisteredEvent>): Promise<void> {
    const event = job.data;
    try {
      // å¼‚æ­¥å‘é€æ¬¢è¿é€šçŸ¥
      await this.notifOrchestrator.orchestrateNotif({
        tenantId: event.tenantId,
        recipientId: event.userId,
        type: NotifType.USER_REGISTERED,
        title: 'æ¬¢è¿åŠ å…¥å¹³å°',
        content: 'æ„Ÿè°¢æ‚¨æ³¨å†Œæˆ‘ä»¬çš„å¹³å°ï¼Œç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼',
        isUrgent: false,
      });

      this.logger.log(`Welcome notification sent for user: ${event.userId}`);
    } catch (error) {
      this.logger.error(
        `Failed to send welcome notification for user: ${event.userId}`,
        error,
      );
      throw error;
    }
  }

  /**
   * @method handlePermissionChanged
   * @description å¤„ç†æƒé™å˜æ›´äº‹ä»¶ï¼Œé€šçŸ¥ç›¸å…³ç”¨æˆ·
   */
  @Process('PermissionChangedEvent')
  async handlePermissionChanged(
    job: Job<PermissionChangedEvent>,
  ): Promise<void> {
    const event = job.data;
    try {
      // å¼‚æ­¥å‘é€æƒé™å˜æ›´é€šçŸ¥
      await this.notifOrchestrator.orchestrateNotif({
        tenantId: event.tenantId,
        recipientId: event.userId,
        type: NotifType.USER_PERMISSION_CHANGED,
        title: 'æƒé™å˜æ›´é€šçŸ¥',
        content: 'æ‚¨çš„è´¦æˆ·æƒé™å·²å‘ç”Ÿå˜æ›´ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚',
        metadata: {
          oldPermissions: event.oldPermissions,
          newPermissions: event.newPermissions,
        },
        isUrgent: true,
      });

      this.logger.log(
        `Permission change notification sent for user: ${event.userId}`,
      );
    } catch (error) {
      this.logger.error(
        `Failed to send permission change notification for user: ${event.userId}`,
        error,
      );
      throw error;
    }
  }
}
```

## 4. åŸºç¡€è®¾æ–½å±‚è®¾è®¡

### 4.1 æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡

#### 4.1.1 NotificationMessageQueueService

```typescript
/**
 * @class NotificationMessageQueueService
 * @description é€šçŸ¥æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ï¼Œè´Ÿè´£å‘å¸ƒå’Œå¤„ç†é€šçŸ¥ç›¸å…³äº‹ä»¶
 */
@Injectable()
export class NotificationMessageQueueService {
  private readonly queues: Map<string, Queue> = new Map();

  constructor(
    private readonly bullModule: BullModule,
    private readonly logger: Logger,
  ) {}

  /**
   * @method publishNotificationEvent
   * @description å‘å¸ƒé€šçŸ¥äº‹ä»¶åˆ°æ¶ˆæ¯é˜Ÿåˆ—
   */
  async publishNotificationEvent(event: IDomainEvent): Promise<void> {
    try {
      const queue = this.getQueue('notification_events');
      await queue.add(
        'process_notification_event',
        {
          eventId: event.eventId,
          eventType: event.eventType,
          aggregateId: event.aggregateId,
          eventData: event.toJSON(),
          occurredOn: event.occurredOn,
          tenantId: this.extractTenantId(event),
        },
        {
          attempts: 3,
          backoff: { type: 'exponential', delay: 2000 },
          removeOnComplete: 100,
          removeOnFail: 50,
        },
      );

      this.logger.log(
        `Notification event published: ${event.eventType} for aggregate ${event.aggregateId}`,
      );
    } catch (error) {
      this.logger.error(
        `Failed to publish notification event: ${event.eventType}`,
        error,
      );
      throw new MessagePublishError(
        `Failed to publish notification event: ${error.message}`,
      );
    }
  }

  /**
   * @method publishCrossModuleEvent
   * @description å‘å¸ƒè·¨æ¨¡å—äº‹ä»¶åˆ°æ¶ˆæ¯é˜Ÿåˆ—
   */
  async publishCrossModuleEvent(event: IDomainEvent): Promise<void> {
    try {
      const queue = this.getQueue('cross_module_events');
      await queue.add(
        'process_cross_module_event',
        {
          eventId: event.eventId,
          eventType: event.eventType,
          aggregateId: event.aggregateId,
          eventData: event.toJSON(),
          occurredOn: event.occurredOn,
          tenantId: this.extractTenantId(event),
        },
        {
          attempts: 3,
          backoff: { type: 'exponential', delay: 2000 },
          removeOnComplete: 100,
          removeOnFail: 50,
        },
      );

      this.logger.log(
        `Cross-module event published: ${event.eventType} for aggregate ${event.aggregateId}`,
      );
    } catch (error) {
      this.logger.error(
        `Failed to publish cross-module event: ${event.eventType}`,
        error,
      );
      throw new MessagePublishError(
        `Failed to publish cross-module event: ${error.message}`,
      );
    }
  }

  /**
   * @method getQueue
   * @description è·å–æˆ–åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
   */
  private getQueue(queueName: string): Queue {
    if (!this.queues.has(queueName)) {
      const queue = new Queue(queueName, {
        connection: {
          host: process.env.REDIS_HOST || 'localhost',
          port: parseInt(process.env.REDIS_PORT || '6379'),
          password: process.env.REDIS_PASSWORD,
        },
      });
      this.queues.set(queueName, queue);
    }
    return this.queues.get(queueName)!;
  }

  /**
   * @method extractTenantId
   * @description ä»äº‹ä»¶ä¸­æå–ç§Ÿæˆ·ID
   */
  private extractTenantId(event: IDomainEvent): string | undefined {
    if ('tenantId' in event) {
      return (event as any).tenantId?.value || (event as any).tenantId;
    }
    return undefined;
  }
}
```

### 4.2 äº‹ä»¶æ€»çº¿æœåŠ¡

#### 4.2.1 NotificationEventBusService

```typescript
/**
 * @class NotificationEventBusService
 * @description é€šçŸ¥äº‹ä»¶æ€»çº¿æœåŠ¡ï¼Œè´Ÿè´£äº‹ä»¶å­˜å‚¨å’Œæ¶ˆæ¯é˜Ÿåˆ—å‘å¸ƒ
 */
@Injectable()
export class NotificationEventBusService {
  constructor(
    private readonly eventStore: IEventStore,
    private readonly messageQueueService: NotificationMessageQueueService,
    private readonly logger: Logger,
  ) {}

  /**
   * @method publish
   * @description å‘å¸ƒå•ä¸ªäº‹ä»¶
   */
  async publish(event: IDomainEvent): Promise<void> {
    try {
      // 1. ä¿å­˜åˆ°äº‹ä»¶å­˜å‚¨
      await this.eventStore.saveEvent(event);

      // 2. å‘å¸ƒåˆ°æ¶ˆæ¯é˜Ÿåˆ—
      await this.messageQueueService.publishNotificationEvent(event);

      this.logger.log(
        `Event published: ${event.eventType} for aggregate ${event.aggregateId}`,
      );
    } catch (error) {
      this.logger.error(`Failed to publish event: ${event.eventType}`, error);
      throw new EventPublishError(`Failed to publish event: ${error.message}`);
    }
  }

  /**
   * @method publishAll
   * @description æ‰¹é‡å‘å¸ƒäº‹ä»¶
   */
  async publishAll(events: IDomainEvent[]): Promise<void> {
    const publishPromises = events.map(event => this.publish(event));
    await Promise.allSettled(publishPromises);
  }

  /**
   * @method publishCrossModuleEvent
   * @description å‘å¸ƒè·¨æ¨¡å—äº‹ä»¶
   */
  async publishCrossModuleEvent(event: IDomainEvent): Promise<void> {
    try {
      // 1. ä¿å­˜åˆ°äº‹ä»¶å­˜å‚¨
      await this.eventStore.saveEvent(event);

      // 2. å‘å¸ƒåˆ°è·¨æ¨¡å—æ¶ˆæ¯é˜Ÿåˆ—
      await this.messageQueueService.publishCrossModuleEvent(event);

      this.logger.log(
        `Cross-module event published: ${event.eventType} for aggregate ${event.aggregateId}`,
      );
    } catch (error) {
      this.logger.error(
        `Failed to publish cross-module event: ${event.eventType}`,
        error,
      );
      throw new EventPublishError(
        `Failed to publish cross-module event: ${error.message}`,
      );
    }
  }
}
```

### 4.3 ä»“å‚¨å®ç°

#### 4.1.1 NotifRepository (æ··åˆç­–ç•¥)

```typescript
@Injectable()
export class NotifRepository implements INotifRepository {
  constructor(
    private readonly databaseAdapter: IDatabaseAdapter,
    private readonly eventStore: IEventStore,
  ) {}

  async save(notification: InAppNotif): Promise<void> {
    // ä¿å­˜èšåˆæ ¹çŠ¶æ€åˆ°å…³ç³»æ•°æ®åº“
    await this.databaseAdapter.execute(
      'INSERT INTO notifications (id, tenant_id, recipient_id, type, title, content, metadata, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)',
      [
        notification.getId().value,
        notification.getTenantId().value,
        notification.getRecipientId().value,
        notification.getType(),
        notification.getTitle(),
        notification.getContent(),
        JSON.stringify(notification.getMetadata()),
        notification.getStatus(),
        notification.getCreatedAt(),
        notification.getUpdatedAt(),
      ],
    );

    // åªæœ‰æœ‰æœªæäº¤äº‹ä»¶æ—¶æ‰ä¿å­˜åˆ°äº‹ä»¶å­˜å‚¨
    const uncommittedEvents = notification.getUncommittedEvents();
    if (uncommittedEvents.length > 0) {
      await this.eventStore.saveEvents(
        notification.getId().value,
        uncommittedEvents,
      );
    }
  }

  async findById(id: NotifId): Promise<InAppNotif | null> {
    // ä¼˜å…ˆä»å…³ç³»æ•°æ®åº“æŸ¥è¯¢ï¼Œæ€§èƒ½æ›´å¥½
    const row = await this.databaseAdapter.query(
      'SELECT * FROM notifications WHERE id = ?',
      [id.value],
    );

    if (!row || row.length === 0) {
      return null;
    }

    // ä»å…³ç³»æ•°æ®åº“é‡å»ºèšåˆæ ¹
    return this.rebuildFromRow(row[0]);
  }

  async findByUser(
    userId: UserId,
    tenantId: TenantId,
    page: number,
    limit: number,
    type?: NotifType,
    status?: NotifStatus,
  ): Promise<InAppNotif[]> {
    // ç›´æ¥æŸ¥è¯¢å…³ç³»æ•°æ®åº“ï¼Œæ€§èƒ½æ›´å¥½
    const offset = (page - 1) * limit;
    let query = `
      SELECT * FROM notifications 
      WHERE recipient_id = ? AND tenant_id = ?
    `;
    const params: any[] = [userId.value, tenantId.value];

    if (type) {
      query += ' AND type = ?';
      params.push(type);
    }

    if (status) {
      query += ' AND status = ?';
      params.push(status);
    }

    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';
    params.push(limit, offset);

    const rows = await this.databaseAdapter.query(query, params);

    // ä»å…³ç³»æ•°æ®åº“é‡å»ºèšåˆæ ¹
    return rows.map(row => this.rebuildFromRow(row));
  }

  private rebuildFromRow(row: any): InAppNotif {
    // ä»å…³ç³»æ•°æ®åº“è¡Œé‡å»ºèšåˆæ ¹
    return new InAppNotif(
      new NotifId(row.id),
      new TenantId(row.tenant_id),
      new UserId(row.recipient_id),
      row.type as NotifType,
      row.title,
      row.content,
      JSON.parse(row.metadata || '{}'),
      row.status as NotifStatus,
      new Date(row.created_at),
      new Date(row.updated_at),
    );
  }
}
```

### 4.2 é€šçŸ¥æ¸ é“é€‚é…å™¨

#### 4.2.1 EmailChannelAdapter

```typescript
@Injectable()
export class EmailChannelAdapter implements INotifChannelAdapter {
  constructor(
    private readonly emailService: IEmailService,
    private readonly templateService: ITemplateService,
  ) {}

  async send(
    notification: InAppNotif,
    recipient: User,
  ): Promise<ChannelResult> {
    try {
      // è·å–é‚®ä»¶æ¨¡æ¿
      const template = await this.templateService.getTemplate(
        notification.getType(),
        NotifChannel.EMAIL,
      );

      // æ¸²æŸ“æ¨¡æ¿
      const rendered = template.render({
        title: notification.getTitle(),
        content: notification.getContent(),
        recipientName: recipient.getName(),
        // å…¶ä»–å˜é‡...
      });

      // å‘é€é‚®ä»¶
      await this.emailService.send({
        to: recipient.getEmail(),
        subject: rendered.subject,
        html: rendered.content,
        metadata: notification.getMetadata(),
      });

      return new ChannelResult(
        NotifChannel.EMAIL,
        ChannelStatus.SUCCESS,
        new Date(),
      );
    } catch (error) {
      return new ChannelResult(
        NotifChannel.EMAIL,
        ChannelStatus.FAILED,
        new Date(),
        error.message,
      );
    }
  }
}
```

### 4.3 äº‹ä»¶å­˜å‚¨ (ç®€åŒ–ç‰ˆ)

#### 4.3.1 EventStore

```typescript
@Injectable()
export class EventStore implements IEventStore {
  constructor(private readonly databaseAdapter: IDatabaseAdapter) {}

  async saveEvents(aggregateId: string, events: IDomainEvent[]): Promise<void> {
    // åªä¿å­˜é‡è¦çš„äº‹ä»¶ï¼Œç”¨äºå®¡è®¡å’Œç»Ÿè®¡
    const eventRecords = events.map(event => ({
      id: event.eventId,
      aggregate_id: aggregateId,
      event_type: event.eventType,
      event_data: JSON.stringify(event),
      occurred_on: event.occurredOn,
      version: this.getNextVersion(aggregateId),
    }));

    await this.databaseAdapter.execute(
      'INSERT INTO domain_events (id, aggregate_id, event_type, event_data, occurred_on, version) VALUES (?, ?, ?, ?, ?, ?)',
      eventRecords.flatMap(record => [
        record.id,
        record.aggregate_id,
        record.event_type,
        record.event_data,
        record.occurred_on,
        record.version,
      ]),
    );
  }

  async getEvents(aggregateId: string): Promise<IDomainEvent[]> {
    // ä¸»è¦ç”¨äºå®¡è®¡å’Œç»Ÿè®¡ï¼Œä¸æ˜¯ä¸»è¦çš„æŸ¥è¯¢è·¯å¾„
    const rows = await this.databaseAdapter.query(
      'SELECT * FROM domain_events WHERE aggregate_id = ? ORDER BY version ASC',
      [aggregateId],
    );

    return rows.map(row => this.deserializeEvent(row));
  }

  private deserializeEvent(row: any): IDomainEvent {
    const eventData = JSON.parse(row.event_data);
    // æ ¹æ®äº‹ä»¶ç±»å‹ååºåˆ—åŒ–
    switch (row.event_type) {
      case 'NotifCreated':
        return new NotifCreatedEvent(
          eventData.notifId,
          eventData.tenantId,
          eventData.recipientId,
          eventData.type,
          eventData.title,
          eventData.content,
          eventData.metadata,
        );
      // å…¶ä»–äº‹ä»¶ç±»å‹...
      default:
        throw new Error(`Unknown event type: ${row.event_type}`);
    }
  }
}
```

## 5. æ¥å£å±‚è®¾è®¡

### 5.1 æ§åˆ¶å™¨

#### 5.1.1 NotifController

```typescript
@Controller('notifications')
@UseGuards(AuthGuard, PermissionGuard)
export class NotifController {
  constructor(
    private readonly commandBus: CommandBus,
    private readonly queryBus: QueryBus,
  ) {}

  @Post()
  @RequirePermissions('notification:create')
  async createNotif(
    @Body() createNotifDto: CreateNotifDto,
    @CurrentUser() user: User,
  ): Promise<NotifDto> {
    const command = new CreateNotifCommand(
      createNotifDto.tenantId,
      createNotifDto.recipientId,
      createNotifDto.type,
      createNotifDto.title,
      createNotifDto.content,
      createNotifDto.metadata,
      createNotifDto.channels,
    );

    await this.commandBus.execute(command);

    // è¿”å›åˆ›å»ºçš„é€šçŸ¥ä¿¡æ¯
    return new NotifDto(/* ... */);
  }

  @Get()
  @RequirePermissions('notification:read')
  async getUserNotifs(
    @Query() query: GetUserNotifsQueryDto,
    @CurrentUser() user: User,
  ): Promise<NotifListDto> {
    const queryCommand = new GetUserNotifsQuery(
      user.id,
      user.tenantId,
      query.page,
      query.limit,
      query.type,
      query.status,
    );

    return await this.queryBus.execute(queryCommand);
  }

  @Patch(':id/read')
  @RequirePermissions('notification:update')
  async markAsRead(
    @Param('id') id: string,
    @CurrentUser() user: User,
  ): Promise<void> {
    const command = new MarkNotifAsReadCommand(id, user.id);
    await this.commandBus.execute(command);
  }
}
```

### 5.2 DTOå®šä¹‰

#### 5.2.1 CreateNotifDto

```typescript
export class CreateNotifDto {
  @IsString()
  @IsNotEmpty()
  tenantId: string;

  @IsString()
  @IsNotEmpty()
  recipientId: string;

  @IsEnum(NotifType)
  type: NotifType;

  @IsString()
  @IsNotEmpty()
  @MaxLength(200)
  title: string;

  @IsString()
  @IsNotEmpty()
  @MaxLength(2000)
  content: string;

  @IsOptional()
  @IsObject()
  metadata?: any;

  @IsOptional()
  @IsArray()
  @IsEnum(NotifChannel, { each: true })
  channels?: NotifChannel[];
}
```

## 6. æ•°æ®åº“è®¾è®¡

### 6.1 è¡¨ç»“æ„è®¾è®¡

#### 6.1.1 notificationsè¡¨

```sql
CREATE TABLE notifications (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    recipient_id VARCHAR(36) NOT NULL,
    type VARCHAR(50) NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    metadata JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_tenant_recipient (tenant_id, recipient_id),
    INDEX idx_tenant_type (tenant_id, type),
    INDEX idx_tenant_status (tenant_id, status),
    INDEX idx_created_at (created_at)
);
```

#### 6.1.2 domain_eventsè¡¨

```sql
CREATE TABLE domain_events (
    id VARCHAR(36) PRIMARY KEY,
    aggregate_id VARCHAR(36) NOT NULL,
    event_type VARCHAR(100) NOT NULL,
    event_data JSONB NOT NULL,
    occurred_on TIMESTAMP NOT NULL,
    version INTEGER NOT NULL,

    INDEX idx_aggregate_id (aggregate_id),
    INDEX idx_occurred_on (occurred_on)
);
```

#### 6.1.3 notification_templatesè¡¨

```sql
CREATE TABLE notification_templates (
    id VARCHAR(36) PRIMARY KEY,
    tenant_id VARCHAR(36) NOT NULL,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    subject VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    variables JSONB,
    channels JSONB NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_tenant_type (tenant_id, type),
    INDEX idx_tenant_active (tenant_id, is_active)
);
```

### 6.2 æ•°æ®éš”ç¦»ç­–ç•¥

#### 6.2.1 å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

```typescript
export class TenantDataIsolationService {
  async addTenantFilter(query: string, tenantId: string): Promise<string> {
    // ä¸ºæŸ¥è¯¢æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤æ¡ä»¶
    if (query.includes('WHERE')) {
      return query.replace('WHERE', `WHERE tenant_id = '${tenantId}' AND`);
    } else {
      return `${query} WHERE tenant_id = '${tenantId}'`;
    }
  }
}
```

## 7. é…ç½®ç®¡ç†

### 7.1 é€šçŸ¥é…ç½®

#### 7.1.1 NotifConfig

```typescript
@Injectable()
export class NotifConfig {
  constructor(private readonly configService: ConfigService) {}

  get emailConfig(): EmailConfig {
    return {
      host: this.configService.get('NOTIFICATION_EMAIL_HOST'),
      port: this.configService.get('NOTIFICATION_EMAIL_PORT'),
      secure: this.configService.get('NOTIFICATION_EMAIL_SECURE'),
      auth: {
        user: this.configService.get('NOTIFICATION_EMAIL_USER'),
        pass: this.configService.get('NOTIFICATION_EMAIL_PASS'),
      },
    };
  }

  get rateLimitConfig(): RateLimitConfig {
    return {
      maxRequests: this.configService.get('NOTIFICATION_RATE_LIMIT_MAX', 1000),
      windowMs: this.configService.get(
        'NOTIFICATION_RATE_LIMIT_WINDOW',
        3600000,
      ),
    };
  }
}
```

## 8. é”™è¯¯å¤„ç†

### 8.1 è‡ªå®šä¹‰å¼‚å¸¸

#### 8.1.1 NotifException

```typescript
export class NotifException extends Error {
  constructor(
    message: string,
    public readonly code: string,
    public readonly statusCode: number = 500,
  ) {
    super(message);
    this.name = 'NotifException';
  }
}

export class NotifNotFoundError extends NotifException {
  constructor(notifId: string) {
    super(`Notif with ID ${notifId} not found`, 'NOTIFICATION_NOT_FOUND', 404);
  }
}

export class InvalidNotifTypeError extends NotifException {
  constructor(type: string) {
    super(
      `Invalid notification type: ${type}`,
      'INVALID_NOTIFICATION_TYPE',
      400,
    );
  }
}
```

### 8.2 å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨

#### 8.2.1 NotifExceptionFilter

```typescript
@Catch(NotifException)
export class NotifExceptionFilter implements ExceptionFilter {
  catch(exception: NotifException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();

    const errorResponse = {
      statusCode: exception.statusCode,
      timestamp: new Date().toISOString(),
      path: request.url,
      message: exception.message,
      code: exception.code,
    };

    response.status(exception.statusCode).json(errorResponse);
  }
}
```

## 9. æµ‹è¯•ç­–ç•¥

### 9.1 å•å…ƒæµ‹è¯•

#### 9.1.1 InAppNotifèšåˆæ ¹æµ‹è¯•

```typescript
describe('InAppNotif', () => {
  let notification: InAppNotif;

  beforeEach(() => {
    notification = InAppNotif.create(
      NotifId.generate(),
      new TenantId('tenant-1'),
      new UserId('user-1'),
      NotifType.SYSTEM,
      'Test Title',
      'Test Content',
      {},
    );
  });

  it('should mark notification as read', () => {
    // Act
    notif.markAsRead();

    // Assert
    expect(notification.getStatus()).toBe(NotifStatus.READ);
    expect(notification.getUncommittedEvents()).toHaveLength(1);
    expect(notification.getUncommittedEvents()[0]).toBeInstanceOf(
      InAppNotifReadEvent,
    );
  });

  it('should not mark as read if already read', () => {
    // Arrange
    notif.markAsRead();
    const eventCount = notification.getUncommittedEvents().length;

    // Act
    notif.markAsRead();

    // Assert
    expect(notification.getUncommittedEvents()).toHaveLength(eventCount);
  });
});
```

### 9.2 é›†æˆæµ‹è¯•

#### 9.2.1 NotifControlleræµ‹è¯•

```typescript
describe('NotifController (Integration)', () => {
  let app: INestApplication;
  let commandBus: CommandBus;
  let queryBus: QueryBus;

  beforeEach(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [NotifModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    commandBus = app.get(CommandBus);
    queryBus = app.get(QueryBus);

    await app.init();
  });

  it('should create notification', async () => {
    // Arrange
    const createDto = new CreateNotifDto();
    createDto.tenantId = 'tenant-1';
    createDto.recipientId = 'user-1';
    createDto.type = NotifType.SYSTEM;
    createDto.title = 'Test Title';
    createDto.content = 'Test Content';

    // Act
    const result = await commandBus.execute(
      new CreateNotifCommand(
        createDto.tenantId,
        createDto.recipientId,
        createDto.type,
        createDto.title,
        createDto.content,
      ),
    );

    // Assert
    expect(result).toBeDefined();
  });
});
```

## 10. éƒ¨ç½²å’Œè¿ç»´

### 10.1 Dockeré…ç½®

#### 10.1.1 Dockerfile

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY dist ./dist
COPY node_modules ./node_modules

EXPOSE 3000

CMD ["node", "dist/main.js"]
```

### 10.2 ç¯å¢ƒé…ç½®

#### 10.2.1 ç¯å¢ƒå˜é‡

```bash
# æ•°æ®åº“é…ç½®
DATABASE_HOST=localhost
DATABASE_PORT=5432
DATABASE_NAME=notification_db
DATABASE_USER=notification_user
DATABASE_PASSWORD=notification_password

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=redis_password

# é‚®ä»¶é…ç½®
NOTIFICATION_EMAIL_HOST=smtp.gmail.com
NOTIFICATION_EMAIL_PORT=587
NOTIFICATION_EMAIL_SECURE=false
NOTIFICATION_EMAIL_USER=your-email@gmail.com
NOTIFICATION_EMAIL_PASS=your-password

# é€Ÿç‡é™åˆ¶
NOTIFICATION_RATE_LIMIT_MAX=1000
NOTIFICATION_RATE_LIMIT_WINDOW=3600000
```

## 11. æ€»ç»“

æœ¬æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆåŸºäºDDDå’ŒClean ArchitectureåŸåˆ™ï¼Œä¸ºé€šçŸ¥æ¨¡å—æä¾›äº†å®Œæ•´çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆã€‚ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬ï¼š

### 11.1 æ¶æ„ä¼˜åŠ¿

- **é¢†åŸŸé©±åŠ¨**: ä»¥ä¸šåŠ¡é¢†åŸŸä¸ºæ ¸å¿ƒç»„ç»‡ä»£ç 
- **å…¨é¢äº‹ä»¶é©±åŠ¨**: æ‰€æœ‰ä¸šåŠ¡æ“ä½œéƒ½é€šè¿‡äº‹ä»¶é©±åŠ¨ï¼Œå®ç°æ¾è€¦åˆå’Œæœ€ç»ˆä¸€è‡´æ€§
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨Redis + Bullæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥äº‹ä»¶å¤„ç†
- **å¤šç§Ÿæˆ·æ”¯æŒ**: å®Œæ•´çš„æ•°æ®éš”ç¦»å’Œæƒé™æ§åˆ¶
- **å¯æ‰©å±•æ€§**: æ’ä»¶åŒ–æ¶æ„æ”¯æŒæ–°æ¸ é“æ¥å…¥
- **é«˜å¯ç”¨æ€§**: åˆ†å¸ƒå¼æ¶æ„æ”¯æŒæ°´å¹³æ‰©å±•
- **å¯é æ€§**: é‡è¯•æœºåˆ¶å’Œæ­»ä¿¡é˜Ÿåˆ—ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±

### 11.2 æŠ€æœ¯ç‰¹ç‚¹

- **TypeScript**: å¼ºç±»å‹æ”¯æŒï¼Œæé«˜ä»£ç è´¨é‡
- **NestJS**: ä¼ä¸šçº§æ¡†æ¶ï¼Œæä¾›å®Œæ•´çš„ä¾èµ–æ³¨å…¥
- **PostgreSQL**: å…³ç³»å‹æ•°æ®åº“ï¼Œæ”¯æŒå¤æ‚æŸ¥è¯¢
- **Redis**: ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæé«˜æ€§èƒ½
- **äº‹ä»¶æº¯æº**: å®Œæ•´çš„çŠ¶æ€å˜æ›´å†å²è®°å½•

### 11.3 MVPå®ç°é‡ç‚¹

- **ç«™å†…ä¿¡é€šçŸ¥**: æ ¸å¿ƒé€šçŸ¥åŠŸèƒ½
- **é‚®ä»¶é€šçŸ¥**: åŸºç¡€å¤–éƒ¨é€šçŸ¥æ¸ é“
- **å¤šç§Ÿæˆ·éš”ç¦»**: æ•°æ®å®‰å…¨å’Œæƒé™æ§åˆ¶
- **å…¨é¢äº‹ä»¶é©±åŠ¨**: ä¸ºåç»­æ‰©å±•å¥ å®šåŸºç¡€ï¼Œå®ç°æ¾è€¦åˆæ¶æ„
- **æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ**: Redis + Bullé˜Ÿåˆ—æ”¯æŒå¼‚æ­¥å¤„ç†å’Œé‡è¯•æœºåˆ¶

é€šè¿‡è¿™ä¸ªæŠ€æœ¯è®¾è®¡æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºä¸€ä¸ªç°ä»£åŒ–ã€å¯æ‰©å±•ã€é«˜å¯ç”¨çš„é€šçŸ¥ç³»ç»Ÿï¼Œæ»¡è¶³SAASå¹³å°çš„å¤šç§Ÿæˆ·éœ€æ±‚ã€‚

### 11.4 èšåˆæ ¹ä¸å®ä½“åˆ†ç¦»æ¶æ„æ€»ç»“

æœ¬æ–¹æ¡ˆé‡‡ç”¨**èšåˆæ ¹ä¸é¢†åŸŸå®ä½“åˆ†ç¦»**çš„æ¶æ„æ¨¡å¼ï¼Œå®ç°äº†ä¸šåŠ¡é€»è¾‘å’ŒåŸºç¡€è®¾æ–½åŠŸèƒ½çš„å®Œç¾åˆ†ç¦»ï¼š

#### æ¶æ„ç‰¹ç‚¹ï¼š

- **èšåˆæ ¹**: ç»§æ‰¿`EventSourcedAggregateRoot`ï¼Œè´Ÿè´£ä¸šåŠ¡åè°ƒå’Œäº‹ä»¶å‘å¸ƒ
- **é¢†åŸŸå®ä½“**: ç»§æ‰¿`BaseEntity`ï¼Œè´Ÿè´£çŠ¶æ€ç®¡ç†å’ŒåŸºç¡€è®¾æ–½åŠŸèƒ½
- **å…¨é¢äº‹ä»¶é©±åŠ¨**: æ‰€æœ‰ä¸šåŠ¡æ“ä½œéƒ½é€šè¿‡äº‹ä»¶é©±åŠ¨ï¼Œä¿è¯æ¶æ„ä¸€è‡´æ€§
- **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨Redis + Bullæ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥äº‹ä»¶å¤„ç†
- **ä¼ä¸šçº§åŠŸèƒ½**: é€šè¿‡BaseEntityæä¾›å®¡è®¡è¿½è¸ªã€ä¹è§‚é”ã€è½¯åˆ é™¤ç­‰åŠŸèƒ½

#### è®¾è®¡ä¼˜åŠ¿ï¼š

- **èŒè´£åˆ†ç¦»**: èšåˆæ ¹ä¸“æ³¨ä¸šåŠ¡åè°ƒï¼Œå®ä½“ä¸“æ³¨çŠ¶æ€ç®¡ç†
- **åŸºç¡€è®¾æ–½å¤ç”¨**: ç»Ÿä¸€çš„å®¡è®¡å’Œç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
- **å¯æµ‹è¯•æ€§**: èšåˆæ ¹å’Œå®ä½“å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- **å¯ç»´æŠ¤æ€§**: ä¸šåŠ¡é€»è¾‘å’ŒåŸºç¡€è®¾æ–½åŠŸèƒ½åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤
- **æ‰©å±•æ€§**: æ”¯æŒæ–°åŠŸèƒ½çš„å¿«é€Ÿæ‰©å±•

è¿™ç§æ¶æ„æ¨¡å¼æ—¢æ»¡è¶³äº†é¡¹ç›®çš„DDD+CQRSæ¶æ„è¦æ±‚ï¼Œåˆæä¾›äº†ä¼ä¸šçº§çš„åŸºç¡€è®¾æ–½åŠŸèƒ½ï¼Œä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚

---

## ğŸ“š æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£ç‰ˆæœ¬**: V2.0  
**åˆ›å»ºæ—¥æœŸ**: 2024-01-01  
**æœ€åæ›´æ–°**: 2024-01-01  
**ç»´æŠ¤è€…**: é¡¹ç›®å¼€å‘å›¢é˜Ÿ

---

## ğŸ” [è¿”å›é¡¶éƒ¨](#é€šçŸ¥æ¨¡å—æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ)

---

_æœ¬æ–‡æ¡£éµå¾ªé¡¹ç›®çš„DDD+CQRS+äº‹ä»¶æº¯æºæ¶æ„è®¾è®¡ï¼Œé‡‡ç”¨å…¨é¢äº‹ä»¶é©±åŠ¨ç­–ç•¥ï¼Œä¸ºé€šçŸ¥æ¨¡å—çš„å¼€å‘å’Œç»´æŠ¤æä¾›å®Œæ•´çš„æŠ€æœ¯æŒ‡å¯¼ã€‚_
