# 短信通知子领域 (SMS Notification Sub-domain)

## 概述

短信通知子领域负责管理短信通知的发送、状态跟踪和业务规则。该子领域遵循DDD和Clean Architecture原则，提供了完整的短信通知业务能力。

## 核心概念

### 1. 短信通知 (SMS Notification)

短信通知是一种通过短信服务提供商向用户手机发送消息的通信方式，支持多种短信提供商（阿里云、腾讯云、华为云、Twilio等）。

### 2. 手机号 (Phone Number)

手机号是用户设备的唯一标识符，用于路由短信通知到正确的设备。

### 3. 短信状态 (SMS Status)

短信状态表示短信通知的当前处理状态，包括待发送、发送中、已发送、已送达、失败等状态。

### 4. 短信内容 (SMS Content)

短信内容封装短信通知的文本内容、模板参数、签名等信息。

### 5. 短信提供商 (SMS Provider)

短信提供商是提供短信发送服务的第三方服务商，包括阿里云、腾讯云、华为云等。

## 领域模型

### 值对象 (Value Objects)

#### PhoneNumber

手机号值对象，封装短信通知的手机号码信息。

**特性：**

- 设备唯一标识符，用于短信通知路由
- 支持多种地区格式（中国大陆、香港、台湾、美国等）
- 自动验证手机号格式和有效性
- 支持国际格式和本地格式转换

**业务规则：**

- 手机号必须符合对应地区的格式要求
- 手机号长度和字符集有严格限制
- 手机号必须支持短信接收功能

#### SmsStatus

短信状态值对象，封装短信通知的状态信息。

**特性：**

- 表示短信通知的当前处理状态
- 支持状态转换和状态机验证
- 记录状态变更时间戳和原因
- 支持重试机制和失败处理

**状态流转：**

- PENDING -> SENDING -> SENT/FAILED
- PENDING -> SCHEDULED -> SENDING -> SENT/FAILED
- FAILED -> RETRYING -> SENDING -> SENT/FAILED
- FAILED -> PERMANENTLY_FAILED (超过最大重试次数)

#### SmsContent

短信内容值对象，封装短信通知的内容信息。

**特性：**

- 支持模板参数替换
- 包含短信签名和编码信息
- 支持多语言和本地化内容
- 自动计算短信段数和长度

**内容结构：**

- 文本内容：短信的主要文本
- 模板ID：模板短信的标识符
- 模板参数：模板参数键值对
- 签名：短信签名信息
- 编码：UTF-8或GSM编码

#### SmsProvider

短信提供商值对象，封装短信服务提供商的信息。

**特性：**

- 支持多种短信提供商类型
- 包含提供商配置和优先级
- 支持地区和编码方式过滤
- 提供提供商可用性检查

**提供商类型：**

- ALIYUN：阿里云短信服务
- TENCENT：腾讯云短信服务
- HUAWEI：华为云短信服务
- TWILIO：Twilio短信服务
- AWS_SNS：AWS SNS短信服务
- CUSTOM：自定义短信服务

### 实体 (Entities)

#### SmsNotifEntity

短信通知实体，负责管理短信通知的状态、业务规则和生命周期。

**实体职责：**

- 管理短信通知的状态和状态转换
- 维护短信通知的业务规则和约束
- 处理短信通知的生命周期管理
- 提供短信通知的业务方法

**状态管理：**

- 短信状态：PENDING -> SENDING -> SENT/FAILED
- 状态转换验证和业务规则检查
- 重试机制和失败处理

**业务规则：**

- 手机号必须有效且可接收短信
- 短信内容必须符合运营商要求
- 状态转换必须遵循预定义的状态机
- 重试次数不能超过最大限制

### 聚合根 (Aggregate Roots)

#### SmsNotif

短信通知聚合根，负责管理短信通知的业务协调和事件发布。

**聚合根职责：**

- 协调短信通知的创建、发送和状态管理
- 发布短信通知相关的领域事件
- 维护短信通知的业务不变性
- 处理短信通知的复杂业务逻辑

**业务协调：**

- 短信通知创建和初始化
- 短信通知发送流程管理
- 短信通知状态转换控制
- 短信通知重试机制管理

**事件发布：**

- 短信通知创建事件
- 短信通知状态变更事件
- 短信通知发送结果事件
- 短信通知重试事件

### 领域事件 (Domain Events)

#### SmsNotifCreatedEvent

短信通知创建事件，表示短信通知已成功创建。

**事件含义：**

- 表示短信通知聚合根已成功创建
- 包含短信通知创建时的关键信息
- 为其他聚合根提供短信通知创建通知

#### SmsNotifSendingEvent

短信通知发送中事件，表示短信通知正在发送过程中。

**事件含义：**

- 表示短信通知已开始发送流程
- 包含短信通知发送时的关键信息

#### SmsNotifSentEvent

短信通知已发送事件，表示短信通知已成功发送到短信服务提供商。

**事件含义：**

- 表示短信通知已成功发送到短信服务提供商
- 包含短信通知发送时的关键信息

#### SmsNotifDeliveredEvent

短信通知已送达事件，表示短信通知已成功送达用户设备。

**事件含义：**

- 表示短信通知已成功送达用户设备
- 包含短信通知送达时的关键信息

#### SmsNotifFailedEvent

短信通知发送失败事件，表示短信通知发送失败。

**事件含义：**

- 表示短信通知发送过程中发生失败
- 包含短信通知失败时的关键信息

#### SmsNotifPermanentlyFailedEvent

短信通知永久失败事件，表示短信通知经过多次重试后仍然失败。

**事件含义：**

- 表示短信通知经过多次重试后仍然失败
- 包含短信通知永久失败时的关键信息

#### SmsNotifRetryingEvent

短信通知重试事件，表示短信通知正在重试发送过程中。

**事件含义：**

- 表示短信通知正在重试发送过程中
- 包含短信通知重试时的关键信息

#### SmsNotifScheduledEvent

短信通知调度事件，表示短信通知已成功调度到指定时间发送。

**事件含义：**

- 表示短信通知已成功调度到指定时间发送
- 包含短信通知调度时的关键信息

#### SmsNotifCancelledEvent

短信通知取消事件，表示短信通知已被取消发送。

**事件含义：**

- 表示短信通知已被取消发送
- 包含短信通知取消时的关键信息

### 领域服务 (Domain Services)

#### SmsNotifService

短信通知领域服务，负责处理跨聚合的业务逻辑和无状态操作。

**领域服务职责：**

- 协调短信通知和用户设备之间的业务规则
- 处理短信通知和短信提供商之间的关联关系
- 管理短信通知的复杂业务逻辑
- 提供短信通知的业务规则验证

**无状态操作：**

- 不维护任何内部状态
- 所有方法都是纯函数
- 可以安全地在多个聚合根之间共享
- 支持并发调用

**业务规则封装：**

- 封装复杂的短信通知计算逻辑
- 提供可重用的业务规则验证
- 隔离跨聚合的复杂业务逻辑

## 业务规则

### 1. 短信通知创建规则

- 短信通知必须关联有效的用户和租户
- 手机号必须有效且可接收短信
- 短信内容必须符合运营商要求
- 短信提供商必须支持该地区和编码方式

### 2. 短信通知发送规则

- 短信通知必须处于待发送或已调度状态
- 短信通知不能已过期
- 短信提供商必须可用
- 手机号必须支持短信接收

### 3. 短信通知状态转换规则

- 状态转换必须遵循预定义的状态机
- 某些状态转换需要满足特定条件
- 状态变更必须记录时间戳和原因

### 4. 短信通知重试规则

- 重试次数不能超过最大重试次数
- 重试间隔根据提供商动态调整
- 永久失败后不再重试

## 使用示例

```typescript
// 1. 创建手机号
const phoneNumber = PhoneNumber.create('13800138000', '+86');

// 2. 创建短信内容
const content = SmsContent.create(
  '您的验证码是123456，请在5分钟内使用。',
  '【公司名称】',
);

// 3. 创建短信提供商
const provider = SmsProvider.create(
  SmsProviderType.ALIYUN,
  '阿里云短信',
  ['CHINA_MAINLAND'],
  [SmsEncoding.UTF8],
  1,
  true,
  { apiKey: 'xxx', apiSecret: 'xxx' },
);

// 4. 创建短信通知聚合根
const smsNotif = SmsNotif.create(
  'sms-123',
  'tenant-456',
  'user-789',
  phoneNumber,
  content,
  provider,
);

// 5. 开始发送短信
smsNotif.startSending();

// 6. 标记为已发送
smsNotif.markAsSent();

// 7. 标记为已送达
smsNotif.markAsDelivered();
```

## 架构特点

### 1. 领域驱动设计 (DDD)

- 清晰的领域模型和业务概念
- 聚合根和实体的明确职责分离
- 丰富的领域事件和业务规则

### 2. Clean Architecture

- 领域层独立于外部框架
- 依赖倒置原则
- 清晰的层次结构

### 3. 事件驱动架构

- 所有状态变更都通过事件记录
- 支持事件溯源和状态重建
- 松耦合的组件通信

### 4. 多租户支持

- 基于租户ID的数据隔离
- 租户级配置和策略
- 跨租户数据安全

## 扩展性

### 1. 新增短信提供商

- 实现新的短信提供商类型
- 添加提供商特定的配置参数
- 扩展提供商选择逻辑

### 2. 新增短信类型

- 扩展短信内容结构
- 添加新的业务规则
- 支持新的模板类型

### 3. 新增业务规则

- 在领域服务中添加新规则
- 扩展验证逻辑
- 支持自定义业务策略

## 测试策略

### 1. 单元测试

- 值对象的验证和转换测试
- 实体的状态管理测试
- 聚合根的业务逻辑测试

### 2. 集成测试

- 短信通知完整流程测试
- 事件发布和处理测试
- 跨组件协作测试

### 3. 性能测试

- 大量短信通知的创建和发送测试
- 并发短信通知处理测试
- 短信提供商选择性能测试

## 监控指标

### 1. 业务指标

- 短信通知发送成功率
- 短信通知送达率
- 短信通知重试率
- 短信通知取消率

### 2. 技术指标

- 短信通知处理延迟
- 短信通知队列长度
- 短信提供商响应时间
- 短信通知错误率

### 3. 审计日志

- 短信通知创建和发送记录
- 状态变更和重试记录
- 短信提供商选择记录
- 业务规则验证记录

该子领域遵循DDD和Clean Architecture原则，提供了高质量、可维护、可扩展的短信通知业务能力。
