# 推送通知子领域 (Push Notification Subdomain)

## 概述

推送通知子领域负责管理推送通知的业务逻辑和领域模型，包括推送通知的创建、发送、状态管理和重试机制。该子领域遵循DDD（领域驱动设计）和Clean Architecture原则，提供完整的推送通知业务能力。

## 核心概念

### 1. 推送通知 (Push Notification)

推送通知是一种主动向用户设备发送消息的通信方式，支持多种推送平台（FCM、APNs、华为推送、小米推送等）。

### 2. 推送令牌 (Push Token)

推送令牌是设备在推送服务中的唯一标识符，用于路由推送通知到正确的设备。

### 3. 推送状态 (Push Status)

推送状态表示推送通知的当前处理状态，包括待发送、发送中、已发送、已送达、失败等状态。

### 4. 推送优先级 (Push Priority)

推送优先级控制推送通知的发送优先级和顺序，影响推送通知的送达速度和可靠性。

## 领域模型

### 值对象 (Value Objects)

#### PushToken

推送令牌值对象，封装推送通知的设备令牌信息。

**特性：**

- 设备唯一标识符，用于推送通知路由
- 支持多种推送平台（FCM、APNs、华为推送等）
- 令牌格式验证和标准化
- 支持令牌的加密和脱敏处理

**业务规则：**

- 令牌必须符合对应平台的格式要求
- 令牌长度和字符集有严格限制
- 令牌需要定期更新和验证
- 支持令牌的批量管理和验证

#### PushStatus

推送状态值对象，封装推送通知的状态信息。

**特性：**

- 表示推送通知的当前处理状态
- 支持状态转换和状态机验证
- 提供状态相关的业务规则
- 支持状态历史跟踪和审计

**状态流转：**

- PENDING -> SENDING -> SENT/FAILED
- PENDING -> SCHEDULED -> SENDING -> SENT/FAILED
- SENT -> DELIVERED/FAILED
- FAILED -> RETRYING -> SENT/PERMANENTLY_FAILED

#### PushPriority

推送优先级值对象，封装推送通知的优先级信息。

**特性：**

- 控制推送通知的发送优先级和顺序
- 影响推送通知的送达速度和可靠性
- 支持不同平台的优先级映射
- 提供优先级相关的业务规则

**优先级级别：**

- CRITICAL：关键通知，立即发送，最高优先级
- HIGH：高优先级通知，优先发送
- NORMAL：普通通知，正常发送
- LOW：低优先级通知，延迟发送
- BACKGROUND：后台通知，最低优先级

#### PushContent

推送内容值对象，封装推送通知的内容信息。

**特性：**

- 支持多语言和本地化内容
- 包含标题、正文、图标等多媒体元素
- 支持富文本和HTML格式
- 提供内容验证和过滤功能

**内容结构：**

- 标题：推送通知的主标题
- 正文：推送通知的详细内容
- 图标：推送通知的图标URL
- 图片：推送通知的图片URL
- 动作：推送通知的点击动作
- 数据：推送通知的附加数据

### 实体 (Entities)

#### PushNotifEntity

推送通知实体，负责管理推送通知的状态、业务规则和生命周期。

**实体职责：**

- 管理推送通知的状态和状态转换
- 维护推送通知的业务规则和约束
- 提供推送通知的查询和验证功能
- 支持推送通知的审计和跟踪

**状态管理：**

- 推送状态：PENDING -> SENDING -> SENT/FAILED
- 状态转换验证和业务规则检查
- 状态历史记录和审计日志
- 支持状态的重试和恢复机制

**业务规则：**

- 推送令牌必须有效且未过期
- 推送内容必须符合平台要求
- 推送优先级影响发送策略
- 支持推送通知的批量处理

### 聚合根 (Aggregates)

#### PushNotifAggregate

推送通知聚合根，负责管理推送通知的业务协调和事件发布。

**聚合根职责：**

- 协调推送通知的创建、发送和状态管理
- 发布推送通知相关的领域事件
- 维护推送通知的业务不变性约束
- 提供推送通知的业务方法

**业务协调：**

- 推送通知创建和初始化
- 推送通知发送流程管理
- 推送通知状态转换控制
- 推送通知重试和恢复机制

**事件发布：**

- 推送通知创建事件
- 推送通知状态变更事件
- 推送通知发送结果事件
- 推送通知重试和失败事件

### 领域事件 (Domain Events)

#### PushNotifCreatedEvent

推送通知创建事件，表示推送通知已成功创建。

**事件含义：**

- 表示推送通知聚合根已成功创建
- 包含推送通知创建时的关键信息
- 为其他聚合根提供推送通知创建通知
- 触发推送通知的后续处理流程

#### PushNotifSendingEvent

推送通知发送中事件，表示推送通知正在发送过程中。

**事件含义：**

- 表示推送通知已开始发送流程
- 包含推送通知发送时的关键信息
- 为其他聚合根提供推送通知发送状态通知
- 触发推送通知的发送监控和跟踪

#### PushNotifSentEvent

推送通知已发送事件，表示推送通知已成功发送到推送服务。

**事件含义：**

- 表示推送通知已成功发送到推送服务
- 包含推送通知发送时的关键信息
- 为其他聚合根提供推送通知发送成功通知
- 触发推送通知的送达监控和跟踪

#### PushNotifDeliveredEvent

推送通知已送达事件，表示推送通知已成功送达用户设备。

**事件含义：**

- 表示推送通知已成功送达用户设备
- 包含推送通知送达时的关键信息
- 为其他聚合根提供推送通知送达成功通知
- 触发推送通知的完成处理和统计

#### PushNotifFailedEvent

推送通知失败事件，表示推送通知发送失败。

**事件含义：**

- 表示推送通知发送过程中发生失败
- 包含推送通知失败时的关键信息
- 为其他聚合根提供推送通知失败通知
- 触发推送通知的重试和恢复机制

#### PushNotifPermanentlyFailedEvent

推送通知永久失败事件，表示推送通知经过多次重试后仍然失败。

**事件含义：**

- 表示推送通知经过多次重试后仍然失败
- 包含推送通知永久失败时的关键信息
- 为其他聚合根提供推送通知永久失败通知
- 触发推送通知的最终失败处理

#### PushNotifRetryingEvent

推送通知重试事件，表示推送通知正在重试发送过程中。

**事件含义：**

- 表示推送通知正在重试发送过程中
- 包含推送通知重试时的关键信息
- 为其他聚合根提供推送通知重试通知
- 触发推送通知的重试监控和跟踪

#### PushNotifScheduledEvent

推送通知调度事件，表示推送通知已成功调度到指定时间发送。

**事件含义：**

- 表示推送通知已成功调度到指定时间发送
- 包含推送通知调度时的关键信息
- 为其他聚合根提供推送通知调度通知
- 触发推送通知的调度监控和跟踪

### 领域服务 (Domain Services)

#### PushNotifService

推送通知领域服务，负责处理跨聚合的业务逻辑和无状态操作。

**领域服务职责：**

- 协调推送通知和用户设备之间的业务规则
- 处理推送通知和推送平台之间的关联关系
- 管理推送通知的复杂计算逻辑
- 提供推送通知的业务规则验证

**无状态操作：**

- 不维护任何内部状态
- 所有方法都是纯函数
- 可以安全地在多个聚合根之间共享
- 支持并发调用

**业务规则封装：**

- 封装复杂的推送通知计算逻辑
- 提供可重用的业务规则验证
- 隔离跨聚合的复杂业务逻辑
- 支持推送通知的批量处理

## 业务规则

### 1. 推送通知创建规则

- 推送通知必须关联有效的用户和租户
- 推送令牌必须有效且未过期
- 推送内容必须符合平台要求
- 推送优先级影响发送策略

### 2. 推送通知发送规则

- 推送通知必须处于待发送或已调度状态
- 推送通知不能已过期
- 推送令牌必须有效
- 推送内容必须完整

### 3. 推送通知状态转换规则

- 状态转换必须遵循预定义的状态机
- 某些状态转换需要满足特定条件
- 失败状态需要记录失败原因
- 支持状态的重试和恢复机制

### 4. 推送通知重试规则

- 重试次数不能超过最大重试次数
- 重试间隔根据优先级动态调整
- 永久失败后不再重试
- 重试失败原因需要记录

## 使用示例

### 创建推送通知

```typescript
import {
  PushNotifAggregate,
  PushToken,
  PushPlatform,
  PushContent,
  PushPriorityLevel,
} from '@aiofix/notif-push';

// 1. 创建推送令牌
const fcmToken = new PushToken('fcm_token_string', PushPlatform.FCM);

// 2. 创建推送内容
const content = new PushContent(
  '新消息通知',
  '您有一条新消息，请及时查看',
  'https://example.com/icon.png',
);

// 3. 创建推送通知聚合根
const aggregate = new PushNotifAggregate();

// 4. 创建推送通知
aggregate.createPushNotif(
  'push-123',
  'tenant-456',
  'user-789',
  fcmToken,
  content,
  PushPriorityLevel.NORMAL,
);
```

### 发送推送通知

```typescript
// 1. 发送推送通知
aggregate.sendPushNotif();

// 2. 标记为已发送
aggregate.markAsSent();

// 3. 标记为已送达
aggregate.markAsDelivered();
```

### 处理推送通知失败

```typescript
// 1. 标记为失败
aggregate.markAsFailed('网络超时');

// 2. 重试推送通知
aggregate.retryPushNotif();

// 3. 标记为永久失败
aggregate.markAsPermanentlyFailed('推送令牌无效');
```

### 调度推送通知

```typescript
// 1. 调度推送通知
const scheduledAt = new Date(Date.now() + 3600000); // 1小时后
aggregate.schedulePushNotif(scheduledAt);
```

### 使用领域服务

```typescript
import { PushNotifService } from '@aiofix/notif-push';

const service = new PushNotifService();

// 1. 检查是否可以发送推送通知
const canSend = await service.canSendPushNotif(
  'user-123',
  fcmToken,
  content,
  PushPriorityLevel.NORMAL,
);

// 2. 计算最优优先级
const optimalPriority = service.calculateOptimalPriority(
  content,
  userPreferences,
  context,
);

// 3. 验证批量推送通知
const validationResult = await service.validatePushNotifBatch(pushNotifs);

// 4. 计算推送通知指标
const metrics = service.calculatePushNotifMetrics(pushNotifs);
```

## 架构特点

### 1. 领域驱动设计 (DDD)

- 清晰的领域模型和业务概念
- 聚合根和实体的明确职责分离
- 领域事件驱动的业务逻辑
- 领域服务处理跨聚合业务规则

### 2. Clean Architecture

- 领域层独立于外部框架
- 依赖倒置原则
- 清晰的层次结构
- 可测试的业务逻辑

### 3. 事件驱动架构

- 所有状态变更都通过事件记录
- 支持事件溯源和状态重建
- 松耦合的组件通信
- 可扩展的事件处理机制

### 4. 多租户支持

- 基于租户ID的数据隔离
- 租户级配置和策略
- 跨租户数据安全
- 租户级监控和统计

## 扩展性

### 1. 新增推送平台

- 实现新的推送令牌验证逻辑
- 添加平台特定的内容格式转换
- 扩展推送服务接口
- 更新平台优先级映射

### 2. 新增推送类型

- 扩展推送内容结构
- 添加新的业务规则
- 实现类型特定的处理逻辑
- 更新状态转换规则

### 3. 新增业务规则

- 在领域服务中添加新规则
- 扩展验证逻辑
- 更新优先级计算算法
- 添加新的指标计算

## 测试

### 1. 单元测试

- 值对象的验证和转换测试
- 实体的状态管理测试
- 聚合根的业务逻辑测试
- 领域服务的计算逻辑测试

### 2. 集成测试

- 推送通知完整流程测试
- 事件发布和处理测试
- 状态转换和重试机制测试
- 批量处理和多租户测试

### 3. 性能测试

- 大量推送通知的创建和发送测试
- 并发推送通知处理测试
- 内存使用和垃圾回收测试
- 数据库查询性能测试

## 监控和日志

### 1. 业务指标

- 推送通知发送成功率
- 推送通知送达率
- 推送通知失败率
- 推送通知重试率

### 2. 技术指标

- 推送通知处理延迟
- 推送通知队列长度
- 推送服务响应时间
- 系统资源使用率

### 3. 审计日志

- 推送通知创建和发送记录
- 状态变更和重试记录
- 失败原因和错误信息
- 用户操作和系统事件

## 总结

推送通知子领域提供了完整的推送通知业务能力，包括：

1. **完整的领域模型**：值对象、实体、聚合根、领域事件和领域服务
2. **丰富的业务规则**：创建、发送、状态管理、重试和调度规则
3. **灵活的状态管理**：支持多种状态转换和状态机验证
4. **强大的扩展性**：支持新增推送平台、类型和业务规则
5. **完善的测试支持**：单元测试、集成测试和性能测试
6. **全面的监控能力**：业务指标、技术指标和审计日志

该子领域遵循DDD和Clean Architecture原则，提供了高质量、可维护、可扩展的推送通知业务能力。
