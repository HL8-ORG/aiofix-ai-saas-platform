{"version":3,"names":["common_1","cov_q4h8f459m","s","require","pino_1","__importDefault","pino_logger_config_service_1","PinoLoggerFactory","constructor","configService","f","createLogger","config","getConfig","pinoOptions","buildPinoOptions","default","createChildLogger","parentLogger","childOptions","child","rebuildLogger","existingLogger","b","flush","level","timestamp","stdTimeFunctions","isoTime","configureTransport","shouldUsePrettyFormat","transport","target","options","colorize","translateTime","ignore","filePath","configureFileTransport","remote","configureRemoteTransport","fileTransport","destination","Array","isArray","targets","push","remoteTransport","url","headers","Authorization","token","undefined","timeout","retries","exports","__decorate","Injectable","PinoLoggerConfigService","_a","Object"],"sources":["/home/arligle/V1/Aiofix/aiofix-ai-saas-platform/packages/logging/src/factories/pino-logger.factory.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport pino from 'pino';\nimport { LogConfig } from '../interfaces/logging.interface';\nimport { PinoLoggerConfigService } from '../services/pino-logger-config.service';\n\n/**\n * @class PinoLoggerFactory\n * @description\n * Pino日志器工厂类，负责创建和配置Pino日志实例。\n *\n * 主要功能包括：\n * 1. 根据配置创建Pino实例\n * 2. 配置传输器和格式化器\n * 3. 处理不同环境的配置差异\n * 4. 提供日志器创建的统一接口\n *\n * 设计原则：\n * - 工厂模式：统一创建Pino实例\n * - 配置驱动：根据配置动态调整\n * - 环境适配：自动适配不同环境\n */\n@Injectable()\nexport class PinoLoggerFactory {\n  constructor(private readonly configService: PinoLoggerConfigService) {}\n\n  /**\n   * @method createLogger\n   * @description 创建Pino日志器实例\n   * @returns {pino.Logger} Pino日志器实例\n   */\n  createLogger(): pino.Logger {\n    const config = this.configService.getConfig();\n    const pinoOptions = this.buildPinoOptions(config);\n    return pino(pinoOptions);\n  }\n\n  /**\n   * @method createChildLogger\n   * @description 创建子日志器\n   * @param {pino.Logger} parentLogger 父日志器\n   * @param {Record<string, any>} childOptions 子日志器选项\n   * @returns {pino.Logger} 子日志器实例\n   */\n  createChildLogger(\n    parentLogger: pino.Logger,\n    childOptions: Record<string, any>,\n  ): pino.Logger {\n    return parentLogger.child(childOptions);\n  }\n\n  /**\n   * @method rebuildLogger\n   * @description 重新构建日志器（用于配置更新后）\n   * @param {pino.Logger} existingLogger 现有日志器\n   * @returns {pino.Logger} 新的日志器实例\n   */\n  rebuildLogger(existingLogger?: pino.Logger): pino.Logger {\n    // 如果存在现有日志器，先关闭它\n    if (existingLogger && existingLogger.flush) {\n      existingLogger.flush();\n    }\n\n    return this.createLogger();\n  }\n\n  /**\n   * @private\n   * @method buildPinoOptions\n   * @description 构建Pino配置选项\n   * @param {LogConfig} config 日志配置\n   * @returns {pino.LoggerOptions} Pino配置选项\n   */\n  private buildPinoOptions(config: LogConfig): pino.LoggerOptions {\n    const pinoOptions: pino.LoggerOptions = {\n      level: config.level,\n      timestamp: config.timestamp ? pino.stdTimeFunctions.isoTime : false,\n    };\n\n    // 配置传输器\n    this.configureTransport(pinoOptions, config);\n\n    return pinoOptions;\n  }\n\n  /**\n   * @private\n   * @method configureTransport\n   * @description 配置传输器\n   * @param {pino.LoggerOptions} pinoOptions Pino配置选项\n   * @param {LogConfig} config 日志配置\n   */\n  private configureTransport(\n    pinoOptions: pino.LoggerOptions,\n    config: LogConfig,\n  ): void {\n    // 在开发环境中使用pino-pretty进行格式化\n    if (this.configService.shouldUsePrettyFormat()) {\n      pinoOptions.transport = {\n        target: 'pino-pretty',\n        options: {\n          colorize: config.colorize,\n          translateTime: 'SYS:standard',\n          ignore: 'pid,hostname',\n        },\n      };\n    }\n\n    // 配置文件传输（如果指定了文件路径）\n    if (config.filePath) {\n      this.configureFileTransport(pinoOptions, config);\n    }\n\n    // 配置远程传输（如果启用了远程日志）\n    if (config.remote) {\n      this.configureRemoteTransport(pinoOptions, config);\n    }\n  }\n\n  /**\n   * @private\n   * @method configureFileTransport\n   * @description 配置文件传输\n   * @param {pino.LoggerOptions} pinoOptions Pino配置选项\n   * @param {LogConfig} config 日志配置\n   */\n  private configureFileTransport(\n    pinoOptions: pino.LoggerOptions,\n    config: LogConfig,\n  ): void {\n    if (!config.filePath) return;\n\n    const fileTransport = {\n      target: 'pino/file',\n      level: config.level,\n      options: {\n        destination: config.filePath,\n      },\n    };\n\n    // 如果已经有transport配置，使用targets数组\n    if (pinoOptions.transport) {\n      if (Array.isArray((pinoOptions.transport as any).targets)) {\n        (pinoOptions.transport as any).targets.push(fileTransport);\n      } else {\n        pinoOptions.transport = {\n          targets: [pinoOptions.transport, fileTransport],\n        } as any;\n      }\n    } else {\n      pinoOptions.transport = fileTransport;\n    }\n  }\n\n  /**\n   * @private\n   * @method configureRemoteTransport\n   * @description 配置远程传输\n   * @param {pino.LoggerOptions} pinoOptions Pino配置选项\n   * @param {LogConfig} config 日志配置\n   */\n  private configureRemoteTransport(\n    pinoOptions: pino.LoggerOptions,\n    config: LogConfig,\n  ): void {\n    if (!config.remote) return;\n\n    const remoteTransport = {\n      target: 'pino-http-send',\n      level: config.level,\n      options: {\n        destination: config.remote.url,\n        headers: {\n          Authorization: config.remote.token\n            ? `Bearer ${config.remote.token}`\n            : undefined,\n          'Content-Type': 'application/json',\n        },\n        timeout: config.remote.timeout,\n        retries: config.remote.retries,\n      },\n    };\n\n    // 如果已经有transport配置，使用targets数组\n    if (pinoOptions.transport) {\n      if (Array.isArray((pinoOptions.transport as any).targets)) {\n        (pinoOptions.transport as any).targets.push(remoteTransport);\n      } else {\n        pinoOptions.transport = {\n          targets: [pinoOptions.transport, remoteTransport],\n        } as any;\n      }\n    } else {\n      pinoOptions.transport = remoteTransport;\n    }\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}