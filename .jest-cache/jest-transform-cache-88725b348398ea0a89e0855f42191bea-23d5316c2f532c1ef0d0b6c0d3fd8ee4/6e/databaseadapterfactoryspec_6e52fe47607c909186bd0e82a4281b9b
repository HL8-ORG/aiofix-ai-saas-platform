1599deb9ccfd9f7ddf13354cb1fb982b
"use strict";
/**
 * @file database-adapter.factory.spec.ts
 * @description 数据库适配器工厂单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock PostgreSQLAdapter
jest.mock('./postgresql.adapter');
const testing_1 = require("@nestjs/testing");
const config_1 = require("@nestjs/config");
const database_adapter_factory_1 = require("./database-adapter.factory");
const isolation_config_1 = require("../config/isolation.config");
const postgresql_adapter_1 = require("./postgresql.adapter");
const MockedPostgreSQLAdapter = postgresql_adapter_1.PostgreSQLAdapter;
describe('DatabaseAdapterFactory', () => {
    let factory;
    let isolationConfig;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            imports: [config_1.ConfigModule],
            providers: [
                database_adapter_factory_1.DatabaseAdapterFactory,
                isolation_config_1.IsolationConfigService,
            ],
        }).compile();
        factory = module.get(database_adapter_factory_1.DatabaseAdapterFactory);
        isolationConfig = module.get(isolation_config_1.IsolationConfigService);
        // 重置 mock
        MockedPostgreSQLAdapter.mockClear();
    });
    describe('createAdapter', () => {
        it('should create database level adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getStrategy').mockReturnValue(isolation_config_1.IsolationStrategy.DATABASE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'tenant_db',
                tenantId: 'tenant-123',
            });
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'tenant_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
        it('should create schema level adapter', () => {
            const mockAdapter = {
                setDefaultSchema: jest.fn(),
                setTenantContext: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getStrategy').mockReturnValue(isolation_config_1.IsolationStrategy.SCHEMA_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                schema: 'tenant_schema',
                tenantId: 'tenant-123',
            });
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                database: 'platform_db',
            }), null, null, null);
            expect(mockAdapter.setDefaultSchema).toHaveBeenCalledWith('tenant_schema');
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
        });
        it('should create table level adapter', () => {
            const mockAdapter = {
                setTenantContext: jest.fn(),
                enableRowLevelSecurity: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getStrategy').mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                tenantId: 'tenant-123',
            });
            jest.spyOn(isolationConfig, 'shouldEnableRLS').mockReturnValue(true);
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                database: 'platform_db',
            }), null, null, null);
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
            expect(mockAdapter.enableRowLevelSecurity).toHaveBeenCalled();
        });
        it('should not enable RLS when configured to disable', () => {
            const mockAdapter = {
                setTenantContext: jest.fn(),
                enableRowLevelSecurity: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getStrategy').mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                tenantId: 'tenant-123',
            });
            jest.spyOn(isolationConfig, 'shouldEnableRLS').mockReturnValue(false);
            factory.createAdapter('tenant-123');
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
            expect(mockAdapter.enableRowLevelSecurity).not.toHaveBeenCalled();
        });
        it('should throw error for unsupported strategy', () => {
            jest.spyOn(isolationConfig, 'getStrategy').mockReturnValue('UNSUPPORTED');
            expect(() => factory.createAdapter('tenant-123')).toThrow('Unsupported isolation strategy: UNSUPPORTED');
        });
    });
    describe('createPlatformAdapter', () => {
        it('should create platform adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getPlatformDatabaseName').mockReturnValue('platform_db');
            const adapter = factory.createPlatformAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'platform_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
    });
    describe('createEventsAdapter', () => {
        it('should create events adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getEventsDatabaseName').mockReturnValue('events_db');
            const adapter = factory.createEventsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'events_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
    });
    describe('createAiVectorsAdapter', () => {
        it('should create AI vectors adapter with default config', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getAiVectorsDatabaseName').mockReturnValue('ai_vectors_db');
            const adapter = factory.createAiVectorsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'ai_vectors_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
        it('should create AI vectors adapter with custom config', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest.spyOn(isolationConfig, 'getAiVectorsDatabaseName').mockReturnValue('ai_vectors_db');
            // 设置自定义AI向量数据库环境变量
            process.env.AI_VECTORS_HOST = 'ai-host';
            process.env.AI_VECTORS_PORT = '5433';
            process.env.AI_VECTORS_USER = 'ai_user';
            process.env.AI_VECTORS_PASSWORD = 'ai_password';
            const adapter = factory.createAiVectorsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'ai-host',
                port: 5433,
                database: 'ai_vectors_db',
                username: 'ai_user',
                password: 'ai_password',
            }), null, null, null);
            // 清理环境变量
            delete process.env.AI_VECTORS_HOST;
            delete process.env.AI_VECTORS_PORT;
            delete process.env.AI_VECTORS_USER;
            delete process.env.AI_VECTORS_PASSWORD;
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2FkYXB0ZXJzL2RhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBUUgseUJBQXlCO0FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQVBsQyw2Q0FBc0Q7QUFDdEQsMkNBQTZEO0FBQzdELHlFQUFvRTtBQUNwRSxpRUFBdUY7QUFDdkYsNkRBQXlEO0FBSXpELE1BQU0sdUJBQXVCLEdBQUcsc0NBQStELENBQUM7QUFFaEcsUUFBUSxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtJQUN0QyxJQUFJLE9BQStCLENBQUM7SUFDcEMsSUFBSSxlQUF1QyxDQUFDO0lBRTVDLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsT0FBTyxFQUFFLENBQUMscUJBQVksQ0FBQztZQUN2QixTQUFTLEVBQUU7Z0JBQ1QsaURBQXNCO2dCQUN0Qix5Q0FBc0I7YUFDdkI7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBeUIsaURBQXNCLENBQUMsQ0FBQztRQUNyRSxlQUFlLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBeUIseUNBQXNCLENBQUMsQ0FBQztRQUU3RSxVQUFVO1FBQ1YsdUJBQXVCLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDdEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtRQUM3QixFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1lBQzlDLE1BQU0sV0FBVyxHQUFHLEVBQVMsQ0FBQztZQUM5Qix1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFX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QUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxNQUFNLENBQUM7WUFDckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsU0FBUyxDQUFDO1lBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEdBQUcsYUFBYSxDQUFDO1lBRWhELE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1lBRWpELE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLG9CQUFvQixDQUNsRCxNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLElBQUksRUFBRSxZQUFZO2dCQUNsQixJQUFJLEVBQUUsU0FBUztnQkFDZixJQUFJLEVBQUUsSUFBSTtnQkFDVixRQUFRLEVBQUUsZUFBZTtnQkFDekIsUUFBUSxFQUFFLFNBQVM7Z0JBQ25CLFFBQVEsRUFBRSxhQUFhO2FBQ3hCLENBQUMsRUFDRixJQUFJLEVBQ0osSUFBSSxFQUNKLElBQUksQ0FDTCxDQUFDO1lBRUYsU0FBUztZQUNULE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDbkMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUNuQyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ25DLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2FkYXB0ZXJzL2RhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgZGF0YWJhc2UtYWRhcHRlci5mYWN0b3J5LnNwZWMudHNcbiAqIEBkZXNjcmlwdGlvbiDmlbDmja7lupPpgILphY3lmajlt6XljoLljZXlhYPmtYvor5VcbiAqL1xuXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IENvbmZpZ01vZHVsZSwgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IERhdGFiYXNlQWRhcHRlckZhY3RvcnkgfSBmcm9tICcuL2RhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeSc7XG5pbXBvcnQgeyBJc29sYXRpb25Db25maWdTZXJ2aWNlLCBJc29sYXRpb25TdHJhdGVneSB9IGZyb20gJy4uL2NvbmZpZy9pc29sYXRpb24uY29uZmlnJztcbmltcG9ydCB7IFBvc3RncmVTUUxBZGFwdGVyIH0gZnJvbSAnLi9wb3N0Z3Jlc3FsLmFkYXB0ZXInO1xuXG4vLyBNb2NrIFBvc3RncmVTUUxBZGFwdGVyXG5qZXN0Lm1vY2soJy4vcG9zdGdyZXNxbC5hZGFwdGVyJyk7XG5jb25zdCBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlciA9IFBvc3RncmVTUUxBZGFwdGVyIGFzIGplc3QuTW9ja2VkQ2xhc3M8dHlwZW9mIFBvc3RncmVTUUxBZGFwdGVyPjtcblxuZGVzY3JpYmUoJ0RhdGFiYXNlQWRhcHRlckZhY3RvcnknLCAoKSA9PiB7XG4gIGxldCBmYWN0b3J5OiBEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5O1xuICBsZXQgaXNvbGF0aW9uQ29uZmlnOiBJc29sYXRpb25Db25maWdTZXJ2aWNlO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbQ29uZmlnTW9kdWxlXSxcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICBEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5LFxuICAgICAgICBJc29sYXRpb25Db25maWdTZXJ2aWNlLFxuICAgICAgXSxcbiAgICB9KS5jb21waWxlKCk7XG5cbiAgICBmYWN0b3J5ID0gbW9kdWxlLmdldDxEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5PihEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5KTtcbiAgICBpc29sYXRpb25Db25maWcgPSBtb2R1bGUuZ2V0PElzb2xhdGlvbkNvbmZpZ1NlcnZpY2U+KElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UpO1xuXG4gICAgLy8g6YeN572uIG1vY2tcbiAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrQ2xlYXIoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZUFkYXB0ZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgZGF0YWJhc2UgbGV2ZWwgYWRhcHRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tBZGFwdGVyID0ge30gYXMgYW55O1xuICAgICAgTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tBZGFwdGVyKTtcbiAgICAgIFxuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRTdHJhdGVneScpLm1vY2tSZXR1cm5WYWx1ZShJc29sYXRpb25TdHJhdGVneS5EQVRBQkFTRV9MRVZFTCk7XG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldENvbm5lY3Rpb25Db25maWcnKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICBkYXRhYmFzZTogJ3RlbmFudF9kYicsXG4gICAgICAgIHRlbmFudElkOiAndGVuYW50LTEyMycsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVuYW50LTEyMycpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgZGF0YWJhc2U6ICd0ZW5hbnRfZGInLFxuICAgICAgICAgIHVzZXJuYW1lOiAnYWlvZml4X3VzZXInLFxuICAgICAgICAgIHBhc3N3b3JkOiAnYWlvZml4X3Bhc3N3b3JkJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIpLnRvQmUobW9ja0FkYXB0ZXIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgc2NoZW1hIGxldmVsIGFkYXB0ZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQWRhcHRlciA9IHtcbiAgICAgICAgc2V0RGVmYXVsdFNjaGVtYTogamVzdC5mbigpLFxuICAgICAgICBzZXRUZW5hbnRDb250ZXh0OiBqZXN0LmZuKCksXG4gICAgICB9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG4gICAgICBcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0U3RyYXRlZ3knKS5tb2NrUmV0dXJuVmFsdWUoSXNvbGF0aW9uU3RyYXRlZ3kuU0NIRU1BX0xFVkVMKTtcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0Q29ubmVjdGlvbkNvbmZpZycpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIGRhdGFiYXNlOiAncGxhdGZvcm1fZGInLFxuICAgICAgICBzY2hlbWE6ICd0ZW5hbnRfc2NoZW1hJyxcbiAgICAgICAgdGVuYW50SWQ6ICd0ZW5hbnQtMTIzJyxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBhZGFwdGVyID0gZmFjdG9yeS5jcmVhdGVBZGFwdGVyKCd0ZW5hbnQtMTIzJyk7XG5cbiAgICAgIGV4cGVjdChNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgZGF0YWJhc2U6ICdwbGF0Zm9ybV9kYicsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5zZXREZWZhdWx0U2NoZW1hKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndGVuYW50X3NjaGVtYScpO1xuICAgICAgZXhwZWN0KG1vY2tBZGFwdGVyLnNldFRlbmFudENvbnRleHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd0ZW5hbnQtMTIzJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSB0YWJsZSBsZXZlbCBhZGFwdGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7XG4gICAgICAgIHNldFRlbmFudENvbnRleHQ6IGplc3QuZm4oKSxcbiAgICAgICAgZW5hYmxlUm93TGV2ZWxTZWN1cml0eTogamVzdC5mbigpLFxuICAgICAgfSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuICAgICAgXG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFN0cmF0ZWd5JykubW9ja1JldHVyblZhbHVlKElzb2xhdGlvblN0cmF0ZWd5LlRBQkxFX0xFVkVMKTtcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0Q29ubmVjdGlvbkNvbmZpZycpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIGRhdGFiYXNlOiAncGxhdGZvcm1fZGInLFxuICAgICAgICB0ZW5hbnRJZDogJ3RlbmFudC0xMjMnLFxuICAgICAgfSk7XG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ3Nob3VsZEVuYWJsZVJMUycpLm1vY2tSZXR1cm5WYWx1ZSh0cnVlKTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVuYW50LTEyMycpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGRhdGFiYXNlOiAncGxhdGZvcm1fZGInLFxuICAgICAgICB9KSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja0FkYXB0ZXIuc2V0VGVuYW50Q29udGV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3RlbmFudC0xMjMnKTtcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5lbmFibGVSb3dMZXZlbFNlY3VyaXR5KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG5vdCBlbmFibGUgUkxTIHdoZW4gY29uZmlndXJlZCB0byBkaXNhYmxlJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7XG4gICAgICAgIHNldFRlbmFudENvbnRleHQ6IGplc3QuZm4oKSxcbiAgICAgICAgZW5hYmxlUm93TGV2ZWxTZWN1cml0eTogamVzdC5mbigpLFxuICAgICAgfSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuICAgICAgXG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFN0cmF0ZWd5JykubW9ja1JldHVyblZhbHVlKElzb2xhdGlvblN0cmF0ZWd5LlRBQkxFX0xFVkVMKTtcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0Q29ubmVjdGlvbkNvbmZpZycpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIGRhdGFiYXNlOiAncGxhdGZvcm1fZGInLFxuICAgICAgICB0ZW5hbnRJZDogJ3RlbmFudC0xMjMnLFxuICAgICAgfSk7XG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ3Nob3VsZEVuYWJsZVJMUycpLm1vY2tSZXR1cm5WYWx1ZShmYWxzZSk7XG5cbiAgICAgIGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVuYW50LTEyMycpO1xuXG4gICAgICBleHBlY3QobW9ja0FkYXB0ZXIuc2V0VGVuYW50Q29udGV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3RlbmFudC0xMjMnKTtcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5lbmFibGVSb3dMZXZlbFNlY3VyaXR5KS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBmb3IgdW5zdXBwb3J0ZWQgc3RyYXRlZ3knLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFN0cmF0ZWd5JykubW9ja1JldHVyblZhbHVlKCdVTlNVUFBPUlRFRCcgYXMgYW55KTtcblxuICAgICAgZXhwZWN0KCgpID0+IGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVuYW50LTEyMycpKS50b1Rocm93KCdVbnN1cHBvcnRlZCBpc29sYXRpb24gc3RyYXRlZ3k6IFVOU1VQUE9SVEVEJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjcmVhdGVQbGF0Zm9ybUFkYXB0ZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgcGxhdGZvcm0gYWRhcHRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tBZGFwdGVyID0ge30gYXMgYW55O1xuICAgICAgTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tBZGFwdGVyKTtcbiAgICAgIFxuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRQbGF0Zm9ybURhdGFiYXNlTmFtZScpLm1vY2tSZXR1cm5WYWx1ZSgncGxhdGZvcm1fZGInKTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlUGxhdGZvcm1BZGFwdGVyKCk7XG5cbiAgICAgIGV4cGVjdChNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgcG9ydDogNTQzMixcbiAgICAgICAgICBkYXRhYmFzZTogJ3BsYXRmb3JtX2RiJyxcbiAgICAgICAgICB1c2VybmFtZTogJ2Fpb2ZpeF91c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ2Fpb2ZpeF9wYXNzd29yZCcsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChhZGFwdGVyKS50b0JlKG1vY2tBZGFwdGVyKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZUV2ZW50c0FkYXB0ZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgZXZlbnRzIGFkYXB0ZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQWRhcHRlciA9IHt9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG4gICAgICBcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0RXZlbnRzRGF0YWJhc2VOYW1lJykubW9ja1JldHVyblZhbHVlKCdldmVudHNfZGInKTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlRXZlbnRzQWRhcHRlcigpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgZGF0YWJhc2U6ICdldmVudHNfZGInLFxuICAgICAgICAgIHVzZXJuYW1lOiAnYWlvZml4X3VzZXInLFxuICAgICAgICAgIHBhc3N3b3JkOiAnYWlvZml4X3Bhc3N3b3JkJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIpLnRvQmUobW9ja0FkYXB0ZXIpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3JlYXRlQWlWZWN0b3JzQWRhcHRlcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBBSSB2ZWN0b3JzIGFkYXB0ZXIgd2l0aCBkZWZhdWx0IGNvbmZpZycsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tBZGFwdGVyID0ge30gYXMgYW55O1xuICAgICAgTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tBZGFwdGVyKTtcbiAgICAgIFxuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRBaVZlY3RvcnNEYXRhYmFzZU5hbWUnKS5tb2NrUmV0dXJuVmFsdWUoJ2FpX3ZlY3RvcnNfZGInKTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlQWlWZWN0b3JzQWRhcHRlcigpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgZGF0YWJhc2U6ICdhaV92ZWN0b3JzX2RiJyxcbiAgICAgICAgICB1c2VybmFtZTogJ2Fpb2ZpeF91c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ2Fpb2ZpeF9wYXNzd29yZCcsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChhZGFwdGVyKS50b0JlKG1vY2tBZGFwdGVyKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY3JlYXRlIEFJIHZlY3RvcnMgYWRhcHRlciB3aXRoIGN1c3RvbSBjb25maWcnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQWRhcHRlciA9IHt9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG4gICAgICBcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0QWlWZWN0b3JzRGF0YWJhc2VOYW1lJykubW9ja1JldHVyblZhbHVlKCdhaV92ZWN0b3JzX2RiJyk7XG5cbiAgICAgIC8vIOiuvue9ruiHquWumuS5iUFJ5ZCR6YeP5pWw5o2u5bqT546v5aKD5Y+Y6YePXG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX0hPU1QgPSAnYWktaG9zdCc7XG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1BPUlQgPSAnNTQzMyc7XG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1VTRVIgPSAnYWlfdXNlcic7XG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1BBU1NXT1JEID0gJ2FpX3Bhc3N3b3JkJztcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlQWlWZWN0b3JzQWRhcHRlcigpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdhaS1ob3N0JyxcbiAgICAgICAgICBwb3J0OiA1NDMzLFxuICAgICAgICAgIGRhdGFiYXNlOiAnYWlfdmVjdG9yc19kYicsXG4gICAgICAgICAgdXNlcm5hbWU6ICdhaV91c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ2FpX3Bhc3N3b3JkJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuXG4gICAgICAvLyDmuIXnkIbnjq/looPlj5jph49cbiAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX0hPU1Q7XG4gICAgICBkZWxldGUgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19QT1JUO1xuICAgICAgZGVsZXRlIHByb2Nlc3MuZW52LkFJX1ZFQ1RPUlNfVVNFUjtcbiAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1BBU1NXT1JEO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9