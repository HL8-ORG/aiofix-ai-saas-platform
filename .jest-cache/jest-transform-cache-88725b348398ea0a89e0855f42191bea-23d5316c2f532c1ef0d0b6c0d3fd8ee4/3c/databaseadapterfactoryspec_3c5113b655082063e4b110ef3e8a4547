9d5234ddd0073721ca6c467285276cba
"use strict";
/**
 * @file database-adapter.factory.spec.ts
 * @description 数据库适配器工厂单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock PostgreSQLAdapter
jest.mock('./postgresql.adapter');
const testing_1 = require("@nestjs/testing");
const config_1 = require("@nestjs/config");
const database_adapter_factory_1 = require("./database-adapter.factory");
const isolation_config_1 = require("../config/isolation.config");
const postgresql_adapter_1 = require("./postgresql.adapter");
const MockedPostgreSQLAdapter = postgresql_adapter_1.PostgreSQLAdapter;
describe('DatabaseAdapterFactory', () => {
    let factory;
    let isolationConfig;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            imports: [config_1.ConfigModule],
            providers: [database_adapter_factory_1.DatabaseAdapterFactory, isolation_config_1.IsolationConfigService],
        }).compile();
        factory = module.get(database_adapter_factory_1.DatabaseAdapterFactory);
        isolationConfig = module.get(isolation_config_1.IsolationConfigService);
        // 重置 mock
        MockedPostgreSQLAdapter.mockClear();
    });
    describe('createAdapter', () => {
        it('should create database level adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.DATABASE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'tenant_db',
                tenantId: 'tenant-123',
            });
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'tenant_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
        it('should create schema level adapter', () => {
            const mockAdapter = {
                setDefaultSchema: jest.fn(),
                setTenantContext: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.SCHEMA_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                schema: 'tenant_schema',
                tenantId: 'tenant-123',
            });
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                database: 'platform_db',
            }), null, null, null);
            expect(mockAdapter.setDefaultSchema).toHaveBeenCalledWith('tenant_schema');
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
        });
        it('should create table level adapter', () => {
            const mockAdapter = {
                setTenantContext: jest.fn(),
                enableRowLevelSecurity: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                tenantId: 'tenant-123',
            });
            jest.spyOn(isolationConfig, 'shouldEnableRLS').mockReturnValue(true);
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                database: 'platform_db',
            }), null, null, null);
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
            expect(mockAdapter.enableRowLevelSecurity).toHaveBeenCalled();
        });
        it('should not enable RLS when configured to disable', () => {
            const mockAdapter = {
                setTenantContext: jest.fn(),
                enableRowLevelSecurity: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                tenantId: 'tenant-123',
            });
            jest.spyOn(isolationConfig, 'shouldEnableRLS').mockReturnValue(false);
            factory.createAdapter('tenant-123');
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
            expect(mockAdapter.enableRowLevelSecurity).not.toHaveBeenCalled();
        });
        it('should throw error for unsupported strategy', () => {
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue('UNSUPPORTED');
            expect(() => factory.createAdapter('tenant-123')).toThrow('Unsupported isolation strategy: UNSUPPORTED');
        });
    });
    describe('createPlatformAdapter', () => {
        it('should create platform adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getPlatformDatabaseName')
                .mockReturnValue('platform_db');
            const adapter = factory.createPlatformAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'platform_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
    });
    describe('createEventsAdapter', () => {
        it('should create events adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getEventsDatabaseName')
                .mockReturnValue('events_db');
            const adapter = factory.createEventsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'events_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
    });
    describe('createAiVectorsAdapter', () => {
        it('should create AI vectors adapter with default config', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getAiVectorsDatabaseName')
                .mockReturnValue('ai_vectors_db');
            const adapter = factory.createAiVectorsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'ai_vectors_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
        it('should create AI vectors adapter with custom config', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getAiVectorsDatabaseName')
                .mockReturnValue('ai_vectors_db');
            // 设置自定义AI向量数据库环境变量
            process.env.AI_VECTORS_HOST = 'ai-host';
            process.env.AI_VECTORS_PORT = '5433';
            process.env.AI_VECTORS_USER = 'ai_user';
            process.env.AI_VECTORS_PASSWORD = 'ai_password';
            const adapter = factory.createAiVectorsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'ai-host',
                port: 5433,
                database: 'ai_vectors_db',
                username: 'ai_user',
                password: 'ai_password',
            }), null, null, null);
            // 清理环境变量
            delete process.env.AI_VECTORS_HOST;
            delete process.env.AI_VECTORS_PORT;
            delete process.env.AI_VECTORS_USER;
            delete process.env.AI_VECTORS_PASSWORD;
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2FkYXB0ZXJzL2RhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBV0gseUJBQXlCO0FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQVZsQyw2Q0FBc0Q7QUFDdEQsMkNBQTZEO0FBQzdELHlFQUFvRTtBQUNwRSxpRUFHb0M7QUFDcEMsNkRBQXlEO0FBSXpELE1BQU0sdUJBQXVCLEdBQUcsc0NBRS9CLENBQUM7QUFFRixRQUFRLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO0lBQ3RDLElBQUksT0FBK0IsQ0FBQztJQUNwQyxJQUFJLGVBQXVDLENBQUM7SUFFNUMsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0sTUFBTSxHQUFrQixNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUMzRCxPQUFPLEVBQUUsQ0FBQyxxQkFBWSxDQUFDO1lBQ3ZCLFNBQVMsRUFBRSxDQUFDLGlEQUFzQixFQUFFLHlDQUFzQixDQUFDO1NBQzVELENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUF5QixpREFBc0IsQ0FBQyxDQUFDO1FBQ3JFLGVBQWUsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUMxQix5Q0FBc0IsQ0FDdkIsQ0FBQztRQUVGLFVBQVU7UUFDVix1QkFBdUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN0QyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO1FBQzdCLEVBQUUsQ0FBQyxzQ0FBc0MsRUFBRSxHQUFHLEVBQUU7WUFDOUMsTUFBTSxXQUFXLEdBQUcsRUFBUyxDQUFDO1lBQzlCLHVCQUF1QixDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FB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QUFDLGVBQWUsR0FBRyxTQUFTLENBQUM7WUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDO1lBQ3JDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQztZQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixHQUFHLGFBQWEsQ0FBQztZQUVoRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUVqRCxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxvQkFBb0IsQ0FDbEQsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixJQUFJLEVBQUUsWUFBWTtnQkFDbEIsSUFBSSxFQUFFLFNBQVM7Z0JBQ2YsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFFBQVEsRUFBRSxTQUFTO2dCQUNuQixRQUFRLEVBQUUsYUFBYTthQUN4QixDQUFDLEVBQ0YsSUFBSSxFQUNKLElBQUksRUFDSixJQUFJLENBQ0wsQ0FBQztZQUVGLFNBQVM7WUFDVCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ25DLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDbkMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUNuQyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2FybGlnbGUvVjEvQWlvZml4L2Fpb2ZpeC1haS1zYWFzLXBsYXRmb3JtL3BhY2thZ2VzL2RhdGFiYXNlL3NyYy9hZGFwdGVycy9kYXRhYmFzZS1hZGFwdGVyLmZhY3Rvcnkuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIGRhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeS5zcGVjLnRzXG4gKiBAZGVzY3JpcHRpb24g5pWw5o2u5bqT6YCC6YWN5Zmo5bel5Y6C5Y2V5YWD5rWL6K+VXG4gKi9cblxuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBDb25maWdNb2R1bGUsIENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5IH0gZnJvbSAnLi9kYXRhYmFzZS1hZGFwdGVyLmZhY3RvcnknO1xuaW1wb3J0IHtcbiAgSXNvbGF0aW9uQ29uZmlnU2VydmljZSxcbiAgSXNvbGF0aW9uU3RyYXRlZ3ksXG59IGZyb20gJy4uL2NvbmZpZy9pc29sYXRpb24uY29uZmlnJztcbmltcG9ydCB7IFBvc3RncmVTUUxBZGFwdGVyIH0gZnJvbSAnLi9wb3N0Z3Jlc3FsLmFkYXB0ZXInO1xuXG4vLyBNb2NrIFBvc3RncmVTUUxBZGFwdGVyXG5qZXN0Lm1vY2soJy4vcG9zdGdyZXNxbC5hZGFwdGVyJyk7XG5jb25zdCBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlciA9IFBvc3RncmVTUUxBZGFwdGVyIGFzIGplc3QuTW9ja2VkQ2xhc3M8XG4gIHR5cGVvZiBQb3N0Z3JlU1FMQWRhcHRlclxuPjtcblxuZGVzY3JpYmUoJ0RhdGFiYXNlQWRhcHRlckZhY3RvcnknLCAoKSA9PiB7XG4gIGxldCBmYWN0b3J5OiBEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5O1xuICBsZXQgaXNvbGF0aW9uQ29uZmlnOiBJc29sYXRpb25Db25maWdTZXJ2aWNlO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbQ29uZmlnTW9kdWxlXSxcbiAgICAgIHByb3ZpZGVyczogW0RhdGFiYXNlQWRhcHRlckZhY3RvcnksIElzb2xhdGlvbkNvbmZpZ1NlcnZpY2VdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGZhY3RvcnkgPSBtb2R1bGUuZ2V0PERhdGFiYXNlQWRhcHRlckZhY3Rvcnk+KERhdGFiYXNlQWRhcHRlckZhY3RvcnkpO1xuICAgIGlzb2xhdGlvbkNvbmZpZyA9IG1vZHVsZS5nZXQ8SXNvbGF0aW9uQ29uZmlnU2VydmljZT4oXG4gICAgICBJc29sYXRpb25Db25maWdTZXJ2aWNlLFxuICAgICk7XG5cbiAgICAvLyDph43nva4gbW9ja1xuICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tDbGVhcigpO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3JlYXRlQWRhcHRlcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBkYXRhYmFzZSBsZXZlbCBhZGFwdGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7fSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRTdHJhdGVneScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWUoSXNvbGF0aW9uU3RyYXRlZ3kuREFUQUJBU0VfTEVWRUwpO1xuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRDb25uZWN0aW9uQ29uZmlnJykubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgZGF0YWJhc2U6ICd0ZW5hbnRfZGInLFxuICAgICAgICB0ZW5hbnRJZDogJ3RlbmFudC0xMjMnLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGFkYXB0ZXIgPSBmYWN0b3J5LmNyZWF0ZUFkYXB0ZXIoJ3RlbmFudC0xMjMnKTtcblxuICAgICAgZXhwZWN0KE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHR5cGU6ICdwb3N0Z3Jlc3FsJyxcbiAgICAgICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICAgICAgICBwb3J0OiA1NDMyLFxuICAgICAgICAgIGRhdGFiYXNlOiAndGVuYW50X2RiJyxcbiAgICAgICAgICB1c2VybmFtZTogJ2Fpb2ZpeF91c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ2Fpb2ZpeF9wYXNzd29yZCcsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChhZGFwdGVyKS50b0JlKG1vY2tBZGFwdGVyKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY3JlYXRlIHNjaGVtYSBsZXZlbCBhZGFwdGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7XG4gICAgICAgIHNldERlZmF1bHRTY2hlbWE6IGplc3QuZm4oKSxcbiAgICAgICAgc2V0VGVuYW50Q29udGV4dDogamVzdC5mbigpLFxuICAgICAgfSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRTdHJhdGVneScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWUoSXNvbGF0aW9uU3RyYXRlZ3kuU0NIRU1BX0xFVkVMKTtcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0Q29ubmVjdGlvbkNvbmZpZycpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIGRhdGFiYXNlOiAncGxhdGZvcm1fZGInLFxuICAgICAgICBzY2hlbWE6ICd0ZW5hbnRfc2NoZW1hJyxcbiAgICAgICAgdGVuYW50SWQ6ICd0ZW5hbnQtMTIzJyxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBhZGFwdGVyID0gZmFjdG9yeS5jcmVhdGVBZGFwdGVyKCd0ZW5hbnQtMTIzJyk7XG5cbiAgICAgIGV4cGVjdChNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgZGF0YWJhc2U6ICdwbGF0Zm9ybV9kYicsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5zZXREZWZhdWx0U2NoZW1hKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ3RlbmFudF9zY2hlbWEnLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5zZXRUZW5hbnRDb250ZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndGVuYW50LTEyMycpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgdGFibGUgbGV2ZWwgYWRhcHRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tBZGFwdGVyID0ge1xuICAgICAgICBzZXRUZW5hbnRDb250ZXh0OiBqZXN0LmZuKCksXG4gICAgICAgIGVuYWJsZVJvd0xldmVsU2VjdXJpdHk6IGplc3QuZm4oKSxcbiAgICAgIH0gYXMgYW55O1xuICAgICAgTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tBZGFwdGVyKTtcblxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0U3RyYXRlZ3knKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlKElzb2xhdGlvblN0cmF0ZWd5LlRBQkxFX0xFVkVMKTtcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0Q29ubmVjdGlvbkNvbmZpZycpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIGRhdGFiYXNlOiAncGxhdGZvcm1fZGInLFxuICAgICAgICB0ZW5hbnRJZDogJ3RlbmFudC0xMjMnLFxuICAgICAgfSk7XG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ3Nob3VsZEVuYWJsZVJMUycpLm1vY2tSZXR1cm5WYWx1ZSh0cnVlKTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVuYW50LTEyMycpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGRhdGFiYXNlOiAncGxhdGZvcm1fZGInLFxuICAgICAgICB9KSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICk7XG4gICAgICBleHBlY3QobW9ja0FkYXB0ZXIuc2V0VGVuYW50Q29udGV4dCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3RlbmFudC0xMjMnKTtcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5lbmFibGVSb3dMZXZlbFNlY3VyaXR5KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG5vdCBlbmFibGUgUkxTIHdoZW4gY29uZmlndXJlZCB0byBkaXNhYmxlJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7XG4gICAgICAgIHNldFRlbmFudENvbnRleHQ6IGplc3QuZm4oKSxcbiAgICAgICAgZW5hYmxlUm93TGV2ZWxTZWN1cml0eTogamVzdC5mbigpLFxuICAgICAgfSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRTdHJhdGVneScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWUoSXNvbGF0aW9uU3RyYXRlZ3kuVEFCTEVfTEVWRUwpO1xuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRDb25uZWN0aW9uQ29uZmlnJykubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgZGF0YWJhc2U6ICdwbGF0Zm9ybV9kYicsXG4gICAgICAgIHRlbmFudElkOiAndGVuYW50LTEyMycsXG4gICAgICB9KTtcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnc2hvdWxkRW5hYmxlUkxTJykubW9ja1JldHVyblZhbHVlKGZhbHNlKTtcblxuICAgICAgZmFjdG9yeS5jcmVhdGVBZGFwdGVyKCd0ZW5hbnQtMTIzJyk7XG5cbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5zZXRUZW5hbnRDb250ZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndGVuYW50LTEyMycpO1xuICAgICAgZXhwZWN0KG1vY2tBZGFwdGVyLmVuYWJsZVJvd0xldmVsU2VjdXJpdHkpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGZvciB1bnN1cHBvcnRlZCBzdHJhdGVneScsICgpID0+IHtcbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFN0cmF0ZWd5JylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZSgnVU5TVVBQT1JURUQnIGFzIGFueSk7XG5cbiAgICAgIGV4cGVjdCgoKSA9PiBmYWN0b3J5LmNyZWF0ZUFkYXB0ZXIoJ3RlbmFudC0xMjMnKSkudG9UaHJvdyhcbiAgICAgICAgJ1Vuc3VwcG9ydGVkIGlzb2xhdGlvbiBzdHJhdGVneTogVU5TVVBQT1JURUQnLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZVBsYXRmb3JtQWRhcHRlcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBwbGF0Zm9ybSBhZGFwdGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7fSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRQbGF0Zm9ybURhdGFiYXNlTmFtZScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWUoJ3BsYXRmb3JtX2RiJyk7XG5cbiAgICAgIGNvbnN0IGFkYXB0ZXIgPSBmYWN0b3J5LmNyZWF0ZVBsYXRmb3JtQWRhcHRlcigpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgZGF0YWJhc2U6ICdwbGF0Zm9ybV9kYicsXG4gICAgICAgICAgdXNlcm5hbWU6ICdhaW9maXhfdXNlcicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdhaW9maXhfcGFzc3dvcmQnLFxuICAgICAgICB9KSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICk7XG4gICAgICBleHBlY3QoYWRhcHRlcikudG9CZShtb2NrQWRhcHRlcik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjcmVhdGVFdmVudHNBZGFwdGVyJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGV2ZW50cyBhZGFwdGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7fSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRFdmVudHNEYXRhYmFzZU5hbWUnKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlKCdldmVudHNfZGInKTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlRXZlbnRzQWRhcHRlcigpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgZGF0YWJhc2U6ICdldmVudHNfZGInLFxuICAgICAgICAgIHVzZXJuYW1lOiAnYWlvZml4X3VzZXInLFxuICAgICAgICAgIHBhc3N3b3JkOiAnYWlvZml4X3Bhc3N3b3JkJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIpLnRvQmUobW9ja0FkYXB0ZXIpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3JlYXRlQWlWZWN0b3JzQWRhcHRlcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBBSSB2ZWN0b3JzIGFkYXB0ZXIgd2l0aCBkZWZhdWx0IGNvbmZpZycsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tBZGFwdGVyID0ge30gYXMgYW55O1xuICAgICAgTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tBZGFwdGVyKTtcblxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0QWlWZWN0b3JzRGF0YWJhc2VOYW1lJylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZSgnYWlfdmVjdG9yc19kYicpO1xuXG4gICAgICBjb25zdCBhZGFwdGVyID0gZmFjdG9yeS5jcmVhdGVBaVZlY3RvcnNBZGFwdGVyKCk7XG5cbiAgICAgIGV4cGVjdChNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgcG9ydDogNTQzMixcbiAgICAgICAgICBkYXRhYmFzZTogJ2FpX3ZlY3RvcnNfZGInLFxuICAgICAgICAgIHVzZXJuYW1lOiAnYWlvZml4X3VzZXInLFxuICAgICAgICAgIHBhc3N3b3JkOiAnYWlvZml4X3Bhc3N3b3JkJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIpLnRvQmUobW9ja0FkYXB0ZXIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgQUkgdmVjdG9ycyBhZGFwdGVyIHdpdGggY3VzdG9tIGNvbmZpZycsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tBZGFwdGVyID0ge30gYXMgYW55O1xuICAgICAgTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tBZGFwdGVyKTtcblxuICAgICAgamVzdFxuICAgICAgICAuc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0QWlWZWN0b3JzRGF0YWJhc2VOYW1lJylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZSgnYWlfdmVjdG9yc19kYicpO1xuXG4gICAgICAvLyDorr7nva7oh6rlrprkuYlBSeWQkemHj+aVsOaNruW6k+eOr+Wig+WPmOmHj1xuICAgICAgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19IT1NUID0gJ2FpLWhvc3QnO1xuICAgICAgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19QT1JUID0gJzU0MzMnO1xuICAgICAgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19VU0VSID0gJ2FpX3VzZXInO1xuICAgICAgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19QQVNTV09SRCA9ICdhaV9wYXNzd29yZCc7XG5cbiAgICAgIGNvbnN0IGFkYXB0ZXIgPSBmYWN0b3J5LmNyZWF0ZUFpVmVjdG9yc0FkYXB0ZXIoKTtcblxuICAgICAgZXhwZWN0KE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHR5cGU6ICdwb3N0Z3Jlc3FsJyxcbiAgICAgICAgICBob3N0OiAnYWktaG9zdCcsXG4gICAgICAgICAgcG9ydDogNTQzMyxcbiAgICAgICAgICBkYXRhYmFzZTogJ2FpX3ZlY3RvcnNfZGInLFxuICAgICAgICAgIHVzZXJuYW1lOiAnYWlfdXNlcicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdhaV9wYXNzd29yZCcsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcblxuICAgICAgLy8g5riF55CG546v5aKD5Y+Y6YePXG4gICAgICBkZWxldGUgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19IT1NUO1xuICAgICAgZGVsZXRlIHByb2Nlc3MuZW52LkFJX1ZFQ1RPUlNfUE9SVDtcbiAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1VTRVI7XG4gICAgICBkZWxldGUgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19QQVNTV09SRDtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==