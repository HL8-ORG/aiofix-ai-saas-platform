56586772a0b870b22ba700bb2d4fe8b5
"use strict";
/**
 * @file redis.config.spec.ts
 * @description Redis配置服务单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
const redis_config_1 = require("./redis.config");
describe('RedisConfig', () => {
    let service;
    let configService;
    beforeEach(async () => {
        const mockConfigService = {
            get: jest.fn().mockReturnValue(undefined),
        };
        const mockLogger = {
            error: jest.fn(),
            info: jest.fn(),
        };
        service = new redis_config_1.RedisConfig(mockConfigService, mockLogger);
        configService = mockConfigService;
    });
    describe('getCacheConfig', () => {
        it('should return default cache configuration', () => {
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const config = service.getCacheConfig();
            expect(config).toEqual({
                host: 'localhost',
                port: 6379,
                password: '',
                db: 0,
                pool: {
                    min: 2,
                    max: 10,
                    idleTimeoutMillis: 30000,
                },
                cache: {
                    ttl: 3600,
                    maxItems: 1000,
                    checkPeriod: 600,
                },
                tenant: {
                    keyPrefix: 'tenant:',
                    namespaceSeparator: ':',
                    defaultTenant: 'platform',
                },
                retryDelayOnFailover: 100,
                maxRetriesPerRequest: 3,
                lazyConnect: true,
                keepAlive: 30000,
                cluster: {
                    enabled: false,
                    nodes: [],
                },
            });
        });
        it('should return configured cache configuration', () => {
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    REDIS_HOST: 'redis-host',
                    REDIS_PORT: '6380',
                    REDIS_PASSWORD: 'redis_password',
                    REDIS_DB: '1',
                    REDIS_CACHE_PREFIX: 'custom:cache:',
                    REDIS_CACHE_TTL: '7200',
                    REDIS_MAX_RETRIES: '5',
                    REDIS_RETRY_DELAY: '200',
                    REDIS_CONNECT_TIMEOUT: '15000',
                    REDIS_COMMAND_TIMEOUT: '8000',
                };
                return configs[key];
            });
            const config = service.getCacheConfig();
            expect(config).toEqual({
                host: 'redis-host',
                port: 6380,
                password: 'redis_password',
                db: 1,
                pool: {
                    min: 2,
                    max: 10,
                    idleTimeoutMillis: 30000,
                },
                cache: {
                    ttl: 3600,
                    maxItems: 1000,
                    checkPeriod: 600,
                },
                tenant: {
                    keyPrefix: 'tenant:',
                    namespaceSeparator: ':',
                    defaultTenant: 'platform',
                },
                retryDelayOnFailover: 100,
                maxRetriesPerRequest: 3,
                lazyConnect: true,
                keepAlive: 30000,
                cluster: {
                    enabled: false,
                    nodes: [],
                },
            });
        });
    });
    describe('getQueueConfig', () => {
        it('should return default message queue configuration', () => {
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const config = service.getQueueConfig();
            expect(config).toEqual({
                redis: {
                    host: 'localhost',
                    port: 6379,
                    password: '',
                    db: 1,
                },
                queue: {
                    concurrency: 5,
                    attempts: 3,
                    backoff: {
                        type: 'exponential',
                        delay: 2000,
                    },
                    removeOnComplete: 100,
                    removeOnFail: 50,
                },
                queues: {
                    'domain-events': {
                        concurrency: 10,
                        attempts: 5,
                        backoff: { type: 'exponential', delay: 2000 },
                    },
                    notifications: {
                        concurrency: 20,
                        attempts: 3,
                        backoff: { type: 'fixed', delay: 1000 },
                    },
                    emails: {
                        concurrency: 5,
                        attempts: 3,
                        backoff: { type: 'exponential', delay: 5000 },
                    },
                    'push-notifications': {
                        concurrency: 15,
                        attempts: 3,
                        backoff: { type: 'fixed', delay: 2000 },
                    },
                    sms: {
                        concurrency: 10,
                        attempts: 3,
                        backoff: { type: 'exponential', delay: 3000 },
                    },
                },
                tenant: {
                    keyPrefix: 'queue:tenant:',
                    namespaceSeparator: ':',
                },
            });
        });
        it('should return configured message queue configuration', () => {
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    REDIS_HOST: 'redis-host',
                    REDIS_PORT: '6380',
                    REDIS_PASSWORD: 'redis_password',
                    REDIS_QUEUE_DB: '2',
                    REDIS_QUEUE_PREFIX: 'custom:queue:',
                    REDIS_MAX_RETRIES: '5',
                    REDIS_RETRY_DELAY: '200',
                };
                return configs[key];
            });
            const config = service.getQueueConfig();
            expect(config).toEqual({
                redis: {
                    host: 'localhost',
                    port: 6379,
                    password: '',
                    db: 1,
                },
                queue: {
                    concurrency: 5,
                    attempts: 3,
                    backoff: {
                        type: 'exponential',
                        delay: 2000,
                    },
                    removeOnComplete: 100,
                    removeOnFail: 50,
                },
                queues: {
                    'domain-events': {
                        concurrency: 10,
                        attempts: 5,
                        backoff: { type: 'exponential', delay: 2000 },
                    },
                    notifications: {
                        concurrency: 20,
                        attempts: 3,
                        backoff: { type: 'fixed', delay: 1000 },
                    },
                    emails: {
                        concurrency: 5,
                        attempts: 3,
                        backoff: { type: 'exponential', delay: 5000 },
                    },
                    'push-notifications': {
                        concurrency: 15,
                        attempts: 3,
                        backoff: { type: 'fixed', delay: 2000 },
                    },
                    sms: {
                        concurrency: 10,
                        attempts: 3,
                        backoff: { type: 'exponential', delay: 3000 },
                    },
                },
                tenant: {
                    keyPrefix: 'queue:tenant:',
                    namespaceSeparator: ':',
                },
            });
        });
    });
    describe('validateConfig', () => {
        it('should validate correct Redis config', () => {
            // Mock configService to return valid values
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    REDIS_HOST: 'localhost',
                    REDIS_PORT: '6379',
                    REDIS_PASSWORD: 'password',
                    REDIS_DB: '0',
                    BULL_REDIS_HOST: 'localhost',
                    BULL_REDIS_PORT: '6379',
                    BULL_REDIS_PASSWORD: 'password',
                    BULL_REDIS_DB: '1',
                };
                return configs[key];
            });
            const isValid = service.validateConfig();
            expect(isValid).toBe(true);
        });
        it('should reject config with missing required fields', () => {
            // Mock configService to return invalid values (negative port)
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    REDIS_HOST: 'localhost',
                    REDIS_PORT: '-1', // 负端口号
                    REDIS_PASSWORD: 'password',
                    REDIS_DB: '0',
                    BULL_REDIS_HOST: 'localhost',
                    BULL_REDIS_PORT: '6379',
                    BULL_REDIS_PASSWORD: 'password',
                    BULL_REDIS_DB: '1',
                };
                return configs[key];
            });
            const isValid = service.validateConfig();
            expect(isValid).toBe(false);
        });
        it('should reject config with invalid port', () => {
            // Mock configService to return invalid port
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    REDIS_HOST: 'localhost',
                    REDIS_PORT: 'invalid', // 无效端口，parseInt会返回NaN
                    REDIS_PASSWORD: 'password',
                    REDIS_DB: '0',
                    BULL_REDIS_HOST: 'localhost',
                    BULL_REDIS_PORT: '6379',
                    BULL_REDIS_PASSWORD: 'password',
                    BULL_REDIS_DB: '1',
                };
                return configs[key];
            });
            const isValid = service.validateConfig();
            expect(isValid).toBe(false);
        });
        it('should reject config with invalid db number', () => {
            // Mock configService to return invalid queue port
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    REDIS_HOST: 'localhost',
                    REDIS_PORT: '6379',
                    REDIS_PASSWORD: 'password',
                    REDIS_DB: '0',
                    BULL_REDIS_HOST: 'localhost',
                    BULL_REDIS_PORT: 'invalid', // 无效队列端口
                    BULL_REDIS_PASSWORD: 'password',
                    BULL_REDIS_DB: '1',
                };
                return configs[key];
            });
            const isValid = service.validateConfig();
            expect(isValid).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2NvbmZpZy9yZWRpcy5jb25maWcuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQUlILGlEQUE2QztBQUU3QyxRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtJQUMzQixJQUFJLE9BQW9CLENBQUM7SUFDekIsSUFBSSxhQUE0QixDQUFDO0lBRWpDLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLGlCQUFpQixHQUFHO1lBQ3hCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztTQUMxQyxDQUFDO1FBRUYsTUFBTSxVQUFVLEdBQUc7WUFDakIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDaEIsQ0FBQztRQUVGLE9BQU8sR0FBRyxJQUFJLDBCQUFXLENBQUMsaUJBQXdCLEVBQUUsVUFBaUIsQ0FBQyxDQUFDO1FBQ3ZFLGFBQWEsR0FBRyxpQkFBd0IsQ0FBQztJQUMzQyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIsRUFBRSxDQUFDLDJDQUEyQyxFQUFFLEdBQUcsRUFBRTtZQUNuRCxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFNUQsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBRXhDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUM7Z0JBQ3JCLElBQUksRUFBRSxXQUFXO2dCQUNqQixJQUFJLEVBQUUsSUFBSTtnQkFDVixRQUFRLEVBQUUsRUFBRTtnQkFDWixFQUFFLEVBQUUsQ0FBQztnQkFDTCxJQUFJLEVB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RUFBRSxHQUFHO2lCQUNuQixDQUFDO2dCQUNGLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3RCLENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2FybGlnbGUvVjEvQWlvZml4L2Fpb2ZpeC1haS1zYWFzLXBsYXRmb3JtL3BhY2thZ2VzL2RhdGFiYXNlL3NyYy9jb25maWcvcmVkaXMuY29uZmlnLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSByZWRpcy5jb25maWcuc3BlYy50c1xuICogQGRlc2NyaXB0aW9uIFJlZGlz6YWN572u5pyN5Yqh5Y2V5YWD5rWL6K+VXG4gKi9cblxuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBDb25maWdNb2R1bGUsIENvbmZpZ1NlcnZpY2UgfSBmcm9tICdAbmVzdGpzL2NvbmZpZyc7XG5pbXBvcnQgeyBSZWRpc0NvbmZpZyB9IGZyb20gJy4vcmVkaXMuY29uZmlnJztcblxuZGVzY3JpYmUoJ1JlZGlzQ29uZmlnJywgKCkgPT4ge1xuICBsZXQgc2VydmljZTogUmVkaXNDb25maWc7XG4gIGxldCBjb25maWdTZXJ2aWNlOiBDb25maWdTZXJ2aWNlO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vY2tDb25maWdTZXJ2aWNlID0ge1xuICAgICAgZ2V0OiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKHVuZGVmaW5lZCksXG4gICAgfTtcblxuICAgIGNvbnN0IG1vY2tMb2dnZXIgPSB7XG4gICAgICBlcnJvcjogamVzdC5mbigpLFxuICAgICAgaW5mbzogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBzZXJ2aWNlID0gbmV3IFJlZGlzQ29uZmlnKG1vY2tDb25maWdTZXJ2aWNlIGFzIGFueSwgbW9ja0xvZ2dlciBhcyBhbnkpO1xuICAgIGNvbmZpZ1NlcnZpY2UgPSBtb2NrQ29uZmlnU2VydmljZSBhcyBhbnk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRDYWNoZUNvbmZpZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiBkZWZhdWx0IGNhY2hlIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrUmV0dXJuVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgY29uZmlnID0gc2VydmljZS5nZXRDYWNoZUNvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0VxdWFsKHtcbiAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgIHBvcnQ6IDYzNzksXG4gICAgICAgIHBhc3N3b3JkOiAnJyxcbiAgICAgICAgZGI6IDAsXG4gICAgICAgIHBvb2w6IHtcbiAgICAgICAgICBtaW46IDIsXG4gICAgICAgICAgbWF4OiAxMCxcbiAgICAgICAgICBpZGxlVGltZW91dE1pbGxpczogMzAwMDAsXG4gICAgICAgIH0sXG4gICAgICAgIGNhY2hlOiB7XG4gICAgICAgICAgdHRsOiAzNjAwLFxuICAgICAgICAgIG1heEl0ZW1zOiAxMDAwLFxuICAgICAgICAgIGNoZWNrUGVyaW9kOiA2MDAsXG4gICAgICAgIH0sXG4gICAgICAgIHRlbmFudDoge1xuICAgICAgICAgIGtleVByZWZpeDogJ3RlbmFudDonLFxuICAgICAgICAgIG5hbWVzcGFjZVNlcGFyYXRvcjogJzonLFxuICAgICAgICAgIGRlZmF1bHRUZW5hbnQ6ICdwbGF0Zm9ybScsXG4gICAgICAgIH0sXG4gICAgICAgIHJldHJ5RGVsYXlPbkZhaWxvdmVyOiAxMDAsXG4gICAgICAgIG1heFJldHJpZXNQZXJSZXF1ZXN0OiAzLFxuICAgICAgICBsYXp5Q29ubmVjdDogdHJ1ZSxcbiAgICAgICAga2VlcEFsaXZlOiAzMDAwMCxcbiAgICAgICAgY2x1c3Rlcjoge1xuICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgIG5vZGVzOiBbXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29uZmlndXJlZCBjYWNoZSBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja0ltcGxlbWVudGF0aW9uKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBjb25maWdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgICAgIFJFRElTX0hPU1Q6ICdyZWRpcy1ob3N0JyxcbiAgICAgICAgICBSRURJU19QT1JUOiAnNjM4MCcsXG4gICAgICAgICAgUkVESVNfUEFTU1dPUkQ6ICdyZWRpc19wYXNzd29yZCcsXG4gICAgICAgICAgUkVESVNfREI6ICcxJyxcbiAgICAgICAgICBSRURJU19DQUNIRV9QUkVGSVg6ICdjdXN0b206Y2FjaGU6JyxcbiAgICAgICAgICBSRURJU19DQUNIRV9UVEw6ICc3MjAwJyxcbiAgICAgICAgICBSRURJU19NQVhfUkVUUklFUzogJzUnLFxuICAgICAgICAgIFJFRElTX1JFVFJZX0RFTEFZOiAnMjAwJyxcbiAgICAgICAgICBSRURJU19DT05ORUNUX1RJTUVPVVQ6ICcxNTAwMCcsXG4gICAgICAgICAgUkVESVNfQ09NTUFORF9USU1FT1VUOiAnODAwMCcsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBjb25maWdzW2tleV07XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgY29uZmlnID0gc2VydmljZS5nZXRDYWNoZUNvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0VxdWFsKHtcbiAgICAgICAgaG9zdDogJ3JlZGlzLWhvc3QnLFxuICAgICAgICBwb3J0OiA2MzgwLFxuICAgICAgICBwYXNzd29yZDogJ3JlZGlzX3Bhc3N3b3JkJyxcbiAgICAgICAgZGI6IDEsXG4gICAgICAgIHBvb2w6IHtcbiAgICAgICAgICBtaW46IDIsXG4gICAgICAgICAgbWF4OiAxMCxcbiAgICAgICAgICBpZGxlVGltZW91dE1pbGxpczogMzAwMDAsXG4gICAgICAgIH0sXG4gICAgICAgIGNhY2hlOiB7XG4gICAgICAgICAgdHRsOiAzNjAwLFxuICAgICAgICAgIG1heEl0ZW1zOiAxMDAwLFxuICAgICAgICAgIGNoZWNrUGVyaW9kOiA2MDAsXG4gICAgICAgIH0sXG4gICAgICAgIHRlbmFudDoge1xuICAgICAgICAgIGtleVByZWZpeDogJ3RlbmFudDonLFxuICAgICAgICAgIG5hbWVzcGFjZVNlcGFyYXRvcjogJzonLFxuICAgICAgICAgIGRlZmF1bHRUZW5hbnQ6ICdwbGF0Zm9ybScsXG4gICAgICAgIH0sXG4gICAgICAgIHJldHJ5RGVsYXlPbkZhaWxvdmVyOiAxMDAsXG4gICAgICAgIG1heFJldHJpZXNQZXJSZXF1ZXN0OiAzLFxuICAgICAgICBsYXp5Q29ubmVjdDogdHJ1ZSxcbiAgICAgICAga2VlcEFsaXZlOiAzMDAwMCxcbiAgICAgICAgY2x1c3Rlcjoge1xuICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgICAgICAgIG5vZGVzOiBbXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0UXVldWVDb25maWcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZGVmYXVsdCBtZXNzYWdlIHF1ZXVlIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrUmV0dXJuVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgY29uZmlnID0gc2VydmljZS5nZXRRdWV1ZUNvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0VxdWFsKHtcbiAgICAgICAgcmVkaXM6IHtcbiAgICAgICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICAgICAgICBwb3J0OiA2Mzc5LFxuICAgICAgICAgIHBhc3N3b3JkOiAnJyxcbiAgICAgICAgICBkYjogMSxcbiAgICAgICAgfSxcbiAgICAgICAgcXVldWU6IHtcbiAgICAgICAgICBjb25jdXJyZW5jeTogNSxcbiAgICAgICAgICBhdHRlbXB0czogMyxcbiAgICAgICAgICBiYWNrb2ZmOiB7XG4gICAgICAgICAgICB0eXBlOiAnZXhwb25lbnRpYWwnLFxuICAgICAgICAgICAgZGVsYXk6IDIwMDAsXG4gICAgICAgICAgfSxcbiAgICAgICAgICByZW1vdmVPbkNvbXBsZXRlOiAxMDAsXG4gICAgICAgICAgcmVtb3ZlT25GYWlsOiA1MCxcbiAgICAgICAgfSxcbiAgICAgICAgcXVldWVzOiB7XG4gICAgICAgICAgJ2RvbWFpbi1ldmVudHMnOiB7XG4gICAgICAgICAgICBjb25jdXJyZW5jeTogMTAsXG4gICAgICAgICAgICBhdHRlbXB0czogNSxcbiAgICAgICAgICAgIGJhY2tvZmY6IHsgdHlwZTogJ2V4cG9uZW50aWFsJywgZGVsYXk6IDIwMDAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG5vdGlmaWNhdGlvbnM6IHtcbiAgICAgICAgICAgIGNvbmN1cnJlbmN5OiAyMCxcbiAgICAgICAgICAgIGF0dGVtcHRzOiAzLFxuICAgICAgICAgICAgYmFja29mZjogeyB0eXBlOiAnZml4ZWQnLCBkZWxheTogMTAwMCB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZW1haWxzOiB7XG4gICAgICAgICAgICBjb25jdXJyZW5jeTogNSxcbiAgICAgICAgICAgIGF0dGVtcHRzOiAzLFxuICAgICAgICAgICAgYmFja29mZjogeyB0eXBlOiAnZXhwb25lbnRpYWwnLCBkZWxheTogNTAwMCB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ3B1c2gtbm90aWZpY2F0aW9ucyc6IHtcbiAgICAgICAgICAgIGNvbmN1cnJlbmN5OiAxNSxcbiAgICAgICAgICAgIGF0dGVtcHRzOiAzLFxuICAgICAgICAgICAgYmFja29mZjogeyB0eXBlOiAnZml4ZWQnLCBkZWxheTogMjAwMCB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc21zOiB7XG4gICAgICAgICAgICBjb25jdXJyZW5jeTogMTAsXG4gICAgICAgICAgICBhdHRlbXB0czogMyxcbiAgICAgICAgICAgIGJhY2tvZmY6IHsgdHlwZTogJ2V4cG9uZW50aWFsJywgZGVsYXk6IDMwMDAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICB0ZW5hbnQ6IHtcbiAgICAgICAgICBrZXlQcmVmaXg6ICdxdWV1ZTp0ZW5hbnQ6JyxcbiAgICAgICAgICBuYW1lc3BhY2VTZXBhcmF0b3I6ICc6JyxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29uZmlndXJlZCBtZXNzYWdlIHF1ZXVlIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICAgUkVESVNfSE9TVDogJ3JlZGlzLWhvc3QnLFxuICAgICAgICAgIFJFRElTX1BPUlQ6ICc2MzgwJyxcbiAgICAgICAgICBSRURJU19QQVNTV09SRDogJ3JlZGlzX3Bhc3N3b3JkJyxcbiAgICAgICAgICBSRURJU19RVUVVRV9EQjogJzInLFxuICAgICAgICAgIFJFRElTX1FVRVVFX1BSRUZJWDogJ2N1c3RvbTpxdWV1ZTonLFxuICAgICAgICAgIFJFRElTX01BWF9SRVRSSUVTOiAnNScsXG4gICAgICAgICAgUkVESVNfUkVUUllfREVMQVk6ICcyMDAnLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY29uZmlnc1trZXldO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHNlcnZpY2UuZ2V0UXVldWVDb25maWcoKTtcblxuICAgICAgZXhwZWN0KGNvbmZpZykudG9FcXVhbCh7XG4gICAgICAgIHJlZGlzOiB7XG4gICAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgcG9ydDogNjM3OSxcbiAgICAgICAgICBwYXNzd29yZDogJycsXG4gICAgICAgICAgZGI6IDEsXG4gICAgICAgIH0sXG4gICAgICAgIHF1ZXVlOiB7XG4gICAgICAgICAgY29uY3VycmVuY3k6IDUsXG4gICAgICAgICAgYXR0ZW1wdHM6IDMsXG4gICAgICAgICAgYmFja29mZjoge1xuICAgICAgICAgICAgdHlwZTogJ2V4cG9uZW50aWFsJyxcbiAgICAgICAgICAgIGRlbGF5OiAyMDAwLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcmVtb3ZlT25Db21wbGV0ZTogMTAwLFxuICAgICAgICAgIHJlbW92ZU9uRmFpbDogNTAsXG4gICAgICAgIH0sXG4gICAgICAgIHF1ZXVlczoge1xuICAgICAgICAgICdkb21haW4tZXZlbnRzJzoge1xuICAgICAgICAgICAgY29uY3VycmVuY3k6IDEwLFxuICAgICAgICAgICAgYXR0ZW1wdHM6IDUsXG4gICAgICAgICAgICBiYWNrb2ZmOiB7IHR5cGU6ICdleHBvbmVudGlhbCcsIGRlbGF5OiAyMDAwIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICBub3RpZmljYXRpb25zOiB7XG4gICAgICAgICAgICBjb25jdXJyZW5jeTogMjAsXG4gICAgICAgICAgICBhdHRlbXB0czogMyxcbiAgICAgICAgICAgIGJhY2tvZmY6IHsgdHlwZTogJ2ZpeGVkJywgZGVsYXk6IDEwMDAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVtYWlsczoge1xuICAgICAgICAgICAgY29uY3VycmVuY3k6IDUsXG4gICAgICAgICAgICBhdHRlbXB0czogMyxcbiAgICAgICAgICAgIGJhY2tvZmY6IHsgdHlwZTogJ2V4cG9uZW50aWFsJywgZGVsYXk6IDUwMDAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdwdXNoLW5vdGlmaWNhdGlvbnMnOiB7XG4gICAgICAgICAgICBjb25jdXJyZW5jeTogMTUsXG4gICAgICAgICAgICBhdHRlbXB0czogMyxcbiAgICAgICAgICAgIGJhY2tvZmY6IHsgdHlwZTogJ2ZpeGVkJywgZGVsYXk6IDIwMDAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHNtczoge1xuICAgICAgICAgICAgY29uY3VycmVuY3k6IDEwLFxuICAgICAgICAgICAgYXR0ZW1wdHM6IDMsXG4gICAgICAgICAgICBiYWNrb2ZmOiB7IHR5cGU6ICdleHBvbmVudGlhbCcsIGRlbGF5OiAzMDAwIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgdGVuYW50OiB7XG4gICAgICAgICAga2V5UHJlZml4OiAncXVldWU6dGVuYW50OicsXG4gICAgICAgICAgbmFtZXNwYWNlU2VwYXJhdG9yOiAnOicsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3ZhbGlkYXRlQ29uZmlnJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgY29ycmVjdCBSZWRpcyBjb25maWcnLCAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGNvbmZpZ1NlcnZpY2UgdG8gcmV0dXJuIHZhbGlkIHZhbHVlc1xuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja0ltcGxlbWVudGF0aW9uKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBjb25maWdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgICAgIFJFRElTX0hPU1Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIFJFRElTX1BPUlQ6ICc2Mzc5JyxcbiAgICAgICAgICBSRURJU19QQVNTV09SRDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgICBSRURJU19EQjogJzAnLFxuICAgICAgICAgIEJVTExfUkVESVNfSE9TVDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgQlVMTF9SRURJU19QT1JUOiAnNjM3OScsXG4gICAgICAgICAgQlVMTF9SRURJU19QQVNTV09SRDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgICBCVUxMX1JFRElTX0RCOiAnMScsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBjb25maWdzW2tleV07XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgaXNWYWxpZCA9IHNlcnZpY2UudmFsaWRhdGVDb25maWcoKTtcbiAgICAgIGV4cGVjdChpc1ZhbGlkKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgY29uZmlnIHdpdGggbWlzc2luZyByZXF1aXJlZCBmaWVsZHMnLCAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGNvbmZpZ1NlcnZpY2UgdG8gcmV0dXJuIGludmFsaWQgdmFsdWVzIChuZWdhdGl2ZSBwb3J0KVxuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja0ltcGxlbWVudGF0aW9uKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBjb25maWdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgICAgIFJFRElTX0hPU1Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIFJFRElTX1BPUlQ6ICctMScsIC8vIOi0n+err+WPo+WPt1xuICAgICAgICAgIFJFRElTX1BBU1NXT1JEOiAncGFzc3dvcmQnLFxuICAgICAgICAgIFJFRElTX0RCOiAnMCcsXG4gICAgICAgICAgQlVMTF9SRURJU19IT1NUOiAnbG9jYWxob3N0JyxcbiAgICAgICAgICBCVUxMX1JFRElTX1BPUlQ6ICc2Mzc5JyxcbiAgICAgICAgICBCVUxMX1JFRElTX1BBU1NXT1JEOiAncGFzc3dvcmQnLFxuICAgICAgICAgIEJVTExfUkVESVNfREI6ICcxJyxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGNvbmZpZ3Nba2V5XTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBpc1ZhbGlkID0gc2VydmljZS52YWxpZGF0ZUNvbmZpZygpO1xuICAgICAgZXhwZWN0KGlzVmFsaWQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgY29uZmlnIHdpdGggaW52YWxpZCBwb3J0JywgKCkgPT4ge1xuICAgICAgLy8gTW9jayBjb25maWdTZXJ2aWNlIHRvIHJldHVybiBpbnZhbGlkIHBvcnRcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tJbXBsZW1lbnRhdGlvbigoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgY29uZmlnczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgICAgICBSRURJU19IT1NUOiAnbG9jYWxob3N0JyxcbiAgICAgICAgICBSRURJU19QT1JUOiAnaW52YWxpZCcsIC8vIOaXoOaViOerr+WPo++8jHBhcnNlSW505Lya6L+U5ZueTmFOXG4gICAgICAgICAgUkVESVNfUEFTU1dPUkQ6ICdwYXNzd29yZCcsXG4gICAgICAgICAgUkVESVNfREI6ICcwJyxcbiAgICAgICAgICBCVUxMX1JFRElTX0hPU1Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIEJVTExfUkVESVNfUE9SVDogJzYzNzknLFxuICAgICAgICAgIEJVTExfUkVESVNfUEFTU1dPUkQ6ICdwYXNzd29yZCcsXG4gICAgICAgICAgQlVMTF9SRURJU19EQjogJzEnLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY29uZmlnc1trZXldO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGlzVmFsaWQgPSBzZXJ2aWNlLnZhbGlkYXRlQ29uZmlnKCk7XG4gICAgICBleHBlY3QoaXNWYWxpZCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBjb25maWcgd2l0aCBpbnZhbGlkIGRiIG51bWJlcicsICgpID0+IHtcbiAgICAgIC8vIE1vY2sgY29uZmlnU2VydmljZSB0byByZXR1cm4gaW52YWxpZCBxdWV1ZSBwb3J0XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICAgUkVESVNfSE9TVDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgUkVESVNfUE9SVDogJzYzNzknLFxuICAgICAgICAgIFJFRElTX1BBU1NXT1JEOiAncGFzc3dvcmQnLFxuICAgICAgICAgIFJFRElTX0RCOiAnMCcsXG4gICAgICAgICAgQlVMTF9SRURJU19IT1NUOiAnbG9jYWxob3N0JyxcbiAgICAgICAgICBCVUxMX1JFRElTX1BPUlQ6ICdpbnZhbGlkJywgLy8g5peg5pWI6Zif5YiX56uv5Y+jXG4gICAgICAgICAgQlVMTF9SRURJU19QQVNTV09SRDogJ3Bhc3N3b3JkJyxcbiAgICAgICAgICBCVUxMX1JFRElTX0RCOiAnMScsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBjb25maWdzW2tleV07XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgaXNWYWxpZCA9IHNlcnZpY2UudmFsaWRhdGVDb25maWcoKTtcbiAgICAgIGV4cGVjdChpc1ZhbGlkKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==