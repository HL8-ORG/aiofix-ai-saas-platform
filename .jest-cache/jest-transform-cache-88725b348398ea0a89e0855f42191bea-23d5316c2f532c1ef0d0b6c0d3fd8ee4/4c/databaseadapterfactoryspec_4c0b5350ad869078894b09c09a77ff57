6db8902695045adaac62a7ce1b5b59d7
"use strict";
/**
 * @file database-adapter.factory.spec.ts
 * @description 数据库适配器工厂单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock PostgreSQLAdapter
jest.mock('./postgresql.adapter');
const database_adapter_factory_1 = require("./database-adapter.factory");
const isolation_config_1 = require("../config/isolation.config");
const postgresql_adapter_1 = require("./postgresql.adapter");
const MockedPostgreSQLAdapter = postgresql_adapter_1.PostgreSQLAdapter;
describe('DatabaseAdapterFactory', () => {
    let factory;
    let isolationConfig;
    beforeEach(async () => {
        // 创建mock ConfigService
        const mockConfigService = {
            get: jest.fn().mockReturnValue(undefined),
        };
        // 直接实例化服务以避免循环依赖
        isolationConfig = new isolation_config_1.IsolationConfigService(mockConfigService);
        factory = new database_adapter_factory_1.DatabaseAdapterFactory(isolationConfig);
        // 重置 mock
        MockedPostgreSQLAdapter.mockClear();
    });
    describe('createAdapter', () => {
        it('should create database level adapter', () => {
            const mockAdapter = {
                setTenantContext: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.DATABASE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'tenant_db',
                tenantId: 'tenant-123',
            });
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'tenant_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
        it('should create schema level adapter', () => {
            const mockAdapter = {
                setDefaultSchema: jest.fn(),
                setTenantContext: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.SCHEMA_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                schema: 'tenant_schema',
                tenantId: 'tenant-123',
            });
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                database: 'platform_db',
            }), null, null, null);
            expect(mockAdapter.setDefaultSchema).toHaveBeenCalledWith('tenant_schema');
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
        });
        it('should create table level adapter', () => {
            const mockAdapter = {
                setTenantContext: jest.fn(),
                enableRowLevelSecurity: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                tenantId: 'tenant-123',
            });
            jest.spyOn(isolationConfig, 'shouldEnableRLS').mockReturnValue(true);
            const adapter = factory.createAdapter('tenant-123');
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                database: 'platform_db',
            }), null, null, null);
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
            expect(mockAdapter.enableRowLevelSecurity).toHaveBeenCalled();
        });
        it('should not enable RLS when configured to disable', () => {
            const mockAdapter = {
                setTenantContext: jest.fn(),
                enableRowLevelSecurity: jest.fn(),
            };
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            jest.spyOn(isolationConfig, 'getConnectionConfig').mockReturnValue({
                database: 'platform_db',
                tenantId: 'tenant-123',
            });
            jest.spyOn(isolationConfig, 'shouldEnableRLS').mockReturnValue(false);
            factory.createAdapter('tenant-123');
            expect(mockAdapter.setTenantContext).toHaveBeenCalledWith('tenant-123');
            expect(mockAdapter.enableRowLevelSecurity).not.toHaveBeenCalled();
        });
        it('should throw error for unsupported strategy', () => {
            jest
                .spyOn(isolationConfig, 'getStrategy')
                .mockReturnValue('UNSUPPORTED');
            expect(() => factory.createAdapter('tenant-123')).toThrow('Unsupported isolation strategy: UNSUPPORTED');
        });
    });
    describe('createPlatformAdapter', () => {
        it('should create platform adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getPlatformDatabaseName')
                .mockReturnValue('platform_db');
            const adapter = factory.createPlatformAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'platform_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
    });
    describe('createEventsAdapter', () => {
        it('should create events adapter', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getEventsDatabaseName')
                .mockReturnValue('events_db');
            const adapter = factory.createEventsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'events_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
    });
    describe('createAiVectorsAdapter', () => {
        it('should create AI vectors adapter with default config', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getAiVectorsDatabaseName')
                .mockReturnValue('ai_vectors_db');
            const adapter = factory.createAiVectorsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'localhost',
                port: 5432,
                database: 'ai_vectors_db',
                username: 'aiofix_user',
                password: 'aiofix_password',
            }), null, null, null);
            expect(adapter).toBe(mockAdapter);
        });
        it('should create AI vectors adapter with custom config', () => {
            const mockAdapter = {};
            MockedPostgreSQLAdapter.mockImplementation(() => mockAdapter);
            jest
                .spyOn(isolationConfig, 'getAiVectorsDatabaseName')
                .mockReturnValue('ai_vectors_db');
            // 设置自定义AI向量数据库环境变量
            process.env.AI_VECTORS_HOST = 'ai-host';
            process.env.AI_VECTORS_PORT = '5433';
            process.env.AI_VECTORS_USER = 'ai_user';
            process.env.AI_VECTORS_PASSWORD = 'ai_password';
            const adapter = factory.createAiVectorsAdapter();
            expect(MockedPostgreSQLAdapter).toHaveBeenCalledWith(expect.objectContaining({
                type: 'postgresql',
                host: 'ai-host',
                port: 5433,
                database: 'ai_vectors_db',
                username: 'ai_user',
                password: 'ai_password',
            }), null, null, null);
            // 清理环境变量
            delete process.env.AI_VECTORS_HOST;
            delete process.env.AI_VECTORS_PORT;
            delete process.env.AI_VECTORS_USER;
            delete process.env.AI_VECTORS_PASSWORD;
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2FkYXB0ZXJzL2RhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBU0gseUJBQXlCO0FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQVJsQyx5RUFBb0U7QUFDcEUsaUVBR29DO0FBQ3BDLDZEQUF5RDtBQUl6RCxNQUFNLHVCQUF1QixHQUFHLHNDQUUvQixDQUFDO0FBRUYsUUFBUSxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtJQUN0QyxJQUFJLE9BQStCLENBQUM7SUFDcEMsSUFBSSxlQUF1QyxDQUFDO0lBRTVDLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQix1QkFBdUI7UUFDdkIsTUFBTSxpQkFBaUIsR0FBRztZQUN4QixHQUFHLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUM7U0FDMUMsQ0FBQztRQUVGLGlCQUFpQjtRQUNqQixlQUFlLEdBQUcsSUFBSSx5Q0FBc0IsQ0FBQyxpQkFBd0IsQ0FBQyxDQUFDO1FBQ3ZFLE9BQU8sR0FBRyxJQUFJLGlEQUFzQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRXRELFVBQVU7UUFDVix1QkFBdUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN0QyxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxlQUFlLEVBQUUsR0FBRyxFQUFFO1FBQzdCLEVBQUUsQ0FBQyxzQ0FBc0MsRUFBRSxHQUFHLEVBQUU7WUFDOUMsTUFBTSxXQUFXLEdBQUc7Z0JBQ2xCLGdCQUFnQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDckIsQ0FBQztZQUNULHVCQUF1QixDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRTlELElBQUk7aUJBQ0QsS0FBSyxDQUFDLGVBQWUsRUFBRSxhQUFhLENBQUM7aUJBQ3JDLGVBQWUsQ0FBQyxvQ0FBaUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUNyRCxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDLGVBQWUsQ0FBQztnQkFDakUsUUFBUSxFQUFFLFdBQVc7Z0JBQ3JCLFFBQVEsRUFBRSxZQUFZO2FBQ3ZCLENBQUMsQ0FBQztZQUVILE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFcEQsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUMsb0JBQW9CLENBQ2xELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsSUFBSSxFQUFFLFlBQVk7Z0JBQ2xCLElBQUksRUFBRSxXQUFXO2dCQUNqQixJQUFJLEVBQUUsSUFBSTtnQkFDVixRQUFRLEVBQUUsV0FBVztnQkFDckIsUUFBUSxFQUFFLGFBQWE7Z0JBQ3ZCLFFBQVEsRUFBRSxpQkFBaUI7YUFDNUIsQ0FBQyxFQUNGLElBQUksRUFDSixJQUFJLEVBQ0osSUFBSSxDQUNMLENBQUM7WUFDRixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLG9DQUFvQyxFQUFFLEdBQUcsRUFBRTtZQUM1QyxNQUFNLFdBQVcsR0FBRztnQkFDbEIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDM0IsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTthQUNyQixDQUFDO1lBQ1QsdUJBQXVCLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFOUQsSUFBSTtpQkFDRCxLQUFLLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQztpQkFDckMsZUFBZSxDQUFDLG9DQUFpQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ25ELElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLHFCQUFxQixDQUFDLENBQUMsZUFBZSxDQUFDO2dCQUNqRSxRQUFRLEVBQUUsYUFBYTtnQkFDdkIsTUFBTSxFQUFFLGVBQWU7Z0JBQ3ZCLFFBQVEsRUFBRSxZQUFZO2FBQ3ZCLENBQUMsQ0FBQztZQUVILE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFcEQsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUMsb0JBQW9CLENBQ2xELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsSUFBSSxFQUFFLFlBQVk7Z0JBQ2xCLFFBQVEsRUFBRSxhQUFhO2FBQ3hCLENBQUMsRUFDRixJQUFJLEVBQ0osSUFBSSxFQUNKLElBQUksQ0FDTCxDQUFDO1lBQ0YsTUFBTSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLG9CQUFvQixDQUN2RCxlQUFlLENBQ2hCLENBQUM7WUFDRixNQUFNLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDMUUsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1lBQzNDLE1BQU0sV0FBVyxHQUFHO2dCQUNsQixnQkFBZ0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2dCQUMzQixzQkFBc0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO2FBQzNCLENBQUM7WUFDVCx1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUU5RCxJQUFJO2lCQUNELEtBQUssQ0FBQyxlQUFlLEVBQUUsYUFBYSxDQUFDO2lCQUNyQyxlQUFlLENBQUMsb0NBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxlQUFlLENBQUM7Z0JBQ2pFLFFBQVEsRUFBRSxhQUFhO2dCQUN2QixRQUFRLEVBQUUsWUFBWTthQUN2QixDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUVyRSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXBELE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLG9CQUFvQixDQUNsRCxNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLElBQUksRUFBRSxZQUFZO2dCQUNsQixRQUFRLEVBQUUsYUFBYTthQUN4QixDQUFDLEVBQ0YsSUFBSSxFQUNKLElBQUksRUFDSixJQUFJLENBQ0wsQ0FBQztZQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN4RSxNQUFNLENBQUMsV0FBVyxDQUFDLHNCQUFzQixDQUFDLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNoRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxrREFBa0QsRUFBRSxHQUFHLEVBQUU7WUFDMUQsTUFBTSxXQUFXLEdBQUc7Z0JBQ2xCLGdCQUFnQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQzNCLHNCQUFzQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDM0IsQ0FBQztZQUNULHVCQUF1QixDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRTlELElBQUk7aUJBQ0QsS0FBSyxDQUFDLGVBQWUsRUFBRSxhQUFhLENBQUM7aUJBQ3JDLGVBQWUsQ0FBQyxvQ0FBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNsRCxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDLGVBQWUsQ0FBQztnQkFDakUsUUFBUSxFQUFFLGFBQWE7Z0JBQ3ZCLFFBQVEsRUFBRSxZQUFZO2FBQ3ZCLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLGlCQUFpQixDQUFDLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXRFLE9BQU8sQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFcEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3hFLE1BQU0sQ0FBQyxXQUFXLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNwRSxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw2Q0FBNkMsRUFBRSxHQUFHLEVBQUU7WUFDckQsSUFBSTtpQkFDRCxLQUFLLENBQUMsZUFBZSxFQUFFLGFBQWEsQ0FBQztpQkFDckMsZUFBZSxDQUFDLGFBQW9CLENBQUMsQ0FBQztZQUV6QyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FDdkQsNkNBQTZDLENBQzlDLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHVCQUF1QixFQUFFLEdBQUcsRUFBRTtRQUNyQyxFQUFFLENBQUMsZ0NBQWdDLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLE1BQU0sV0FBVyxHQUFHLEVBQVMsQ0FBQztZQUM5Qix1QkFBdUIsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUU5RCxJQUFJO2lCQUNELEtBQUssQ0FBQyxlQUFlLEVBQUUseUJBQXlCLENBQUM7aUJBQ2pELGVBQWUsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUVsQyxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUVoRCxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxvQkFBb0IsQ0FDbEQsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixJQUFJLEVBQUUsWUFBWTtnQkFDbEIsSUFBSSxFQUFFLFdBQVc7Z0JBQ2pCLElBQUksRUFBRSxJQUFJO2dCQUNWLFFBQVEsRUFBRSxhQUFhO2dCQUN2QixRQUFRLEVBQUUsYUFBYTtnQkFDdkIsUUFBUSxFQUFFLGlCQUFpQjthQUM1QixDQUFDLEVBQ0YsSUFBSSxFQUNKLElBQUksRUFDSixJQUFJLENBQ0wsQ0FBQztZQUNGLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxxQkFBcUIsRUFBRSxHQUFHLEVBQUU7UUFDbkMsRUFBRSxDQUFDLDhCQUE4QixFQUFFLEdBQUcsRUFBRTtZQUN0QyxNQUFNLFdBQVcsR0FBRyxFQUFTLENBQUM7WUFDOUIsdUJBQXVCLENBQUMsa0JBQWtCLENBQUMsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFOUQsSUFBSTtpQkFDRCxLQUFLLENBQUMsZUFBZSxFQUFFLHVCQUF1QixDQUFDO2lCQUMvQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFaEMsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFFOUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLENBQUMsb0JBQW9CLENBQ2xELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsSUFBSSxFQUFFLFlBQVk7Z0JBQ2xCLElBQUksRUFBRSxXQUFXO2dCQUNqQixJQUFJLEVBQUUsSUFBSTtnQkFDVixRQUFRLEVBQUUsV0FBVztnQkFDckIsUUFBUSxFQUFFLGFBQWE7Z0JBQ3ZCLFFBQVEsRUFBRSxpQkFBaUI7YUFDNUIsQ0FBQyxFQUNGLElBQUksRUFDSixJQUFJLEVBQ0osSUFBSSxDQUNMLENBQUM7WUFDRixNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsd0JBQXdCLEVBQUUsR0FBRyxFQUFFO1FBQ3RDLEVBQUUsQ0FBQyxzREFBc0QsRUFBRSxHQUFHLEVBQUU7WUFDOUQsTUFBTSxXQUFXLEdBQUcsRUFBUyxDQUFDO1lBQzlCLHVCQUF1QixDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRTlELElBQUk7aUJBQ0QsS0FBSyxDQUFDLGVBQWUsRUFBRSwwQkFBMEIsQ0FBQztpQkFDbEQsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBRXBDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1lBRWpELE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLG9CQUFvQixDQUNsRCxNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLElBQUksRUFBRSxZQUFZO2dCQUNsQixJQUFJLEVBQUUsV0FBVztnQkFDakIsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFFBQVEsRUFBRSxhQUFhO2dCQUN2QixRQUFRLEVBQUUsaUJBQWlCO2FBQzVCLENBQUMsRUFDRixJQUFJLEVBQ0osSUFBSSxFQUNKLElBQUksQ0FDTCxDQUFDO1lBQ0YsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxxREFBcUQsRUFBRSxHQUFHLEVBQUU7WUFDN0QsTUFBTSxXQUFXLEdBQUcsRUFBUyxDQUFDO1lBQzlCLHVCQUF1QixDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRTlELElBQUk7aUJBQ0QsS0FBSyxDQUFDLGVBQWUsRUFBRSwwQkFBMEIsQ0FBQztpQkFDbEQsZUFBZSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBRXBDLG1CQUFtQjtZQUNuQixPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsR0FBRyxTQUFTLENBQUM7WUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDO1lBQ3JDLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQztZQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixHQUFHLGFBQWEsQ0FBQztZQUVoRCxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUVqRCxNQUFNLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxvQkFBb0IsQ0FDbEQsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixJQUFJLEVBQUUsWUFBWTtnQkFDbEIsSUFBSSxFQUFFLFNBQVM7Z0JBQ2YsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFFBQVEsRUFBRSxTQUFTO2dCQUNuQixRQUFRLEVBQUUsYUFBYTthQUN4QixDQUFDLEVBQ0YsSUFBSSxFQUNKLElBQUksRUFDSixJQUFJLENBQ0wsQ0FBQztZQUVGLFNBQVM7WUFDVCxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO1lBQ25DLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7WUFDbkMsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztZQUNuQyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2FybGlnbGUvVjEvQWlvZml4L2Fpb2ZpeC1haS1zYWFzLXBsYXRmb3JtL3BhY2thZ2VzL2RhdGFiYXNlL3NyYy9hZGFwdGVycy9kYXRhYmFzZS1hZGFwdGVyLmZhY3Rvcnkuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIGRhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeS5zcGVjLnRzXG4gKiBAZGVzY3JpcHRpb24g5pWw5o2u5bqT6YCC6YWN5Zmo5bel5Y6C5Y2V5YWD5rWL6K+VXG4gKi9cblxuaW1wb3J0IHsgRGF0YWJhc2VBZGFwdGVyRmFjdG9yeSB9IGZyb20gJy4vZGF0YWJhc2UtYWRhcHRlci5mYWN0b3J5JztcbmltcG9ydCB7XG4gIElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UsXG4gIElzb2xhdGlvblN0cmF0ZWd5LFxufSBmcm9tICcuLi9jb25maWcvaXNvbGF0aW9uLmNvbmZpZyc7XG5pbXBvcnQgeyBQb3N0Z3JlU1FMQWRhcHRlciB9IGZyb20gJy4vcG9zdGdyZXNxbC5hZGFwdGVyJztcblxuLy8gTW9jayBQb3N0Z3JlU1FMQWRhcHRlclxuamVzdC5tb2NrKCcuL3Bvc3RncmVzcWwuYWRhcHRlcicpO1xuY29uc3QgTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIgPSBQb3N0Z3JlU1FMQWRhcHRlciBhcyBqZXN0Lk1vY2tlZENsYXNzPFxuICB0eXBlb2YgUG9zdGdyZVNRTEFkYXB0ZXJcbj47XG5cbmRlc2NyaWJlKCdEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5JywgKCkgPT4ge1xuICBsZXQgZmFjdG9yeTogRGF0YWJhc2VBZGFwdGVyRmFjdG9yeTtcbiAgbGV0IGlzb2xhdGlvbkNvbmZpZzogSXNvbGF0aW9uQ29uZmlnU2VydmljZTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAvLyDliJvlu7ptb2NrIENvbmZpZ1NlcnZpY2VcbiAgICBjb25zdCBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICAgIGdldDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh1bmRlZmluZWQpLFxuICAgIH07XG5cbiAgICAvLyDnm7TmjqXlrp7kvovljJbmnI3liqHku6Xpgb/lhY3lvqrnjq/kvp3otZZcbiAgICBpc29sYXRpb25Db25maWcgPSBuZXcgSXNvbGF0aW9uQ29uZmlnU2VydmljZShtb2NrQ29uZmlnU2VydmljZSBhcyBhbnkpO1xuICAgIGZhY3RvcnkgPSBuZXcgRGF0YWJhc2VBZGFwdGVyRmFjdG9yeShpc29sYXRpb25Db25maWcpO1xuXG4gICAgLy8g6YeN572uIG1vY2tcbiAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrQ2xlYXIoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZUFkYXB0ZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgZGF0YWJhc2UgbGV2ZWwgYWRhcHRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tBZGFwdGVyID0ge1xuICAgICAgICBzZXRUZW5hbnRDb250ZXh0OiBqZXN0LmZuKCksXG4gICAgICB9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFN0cmF0ZWd5JylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZShJc29sYXRpb25TdHJhdGVneS5EQVRBQkFTRV9MRVZFTCk7XG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldENvbm5lY3Rpb25Db25maWcnKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICBkYXRhYmFzZTogJ3RlbmFudF9kYicsXG4gICAgICAgIHRlbmFudElkOiAndGVuYW50LTEyMycsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVuYW50LTEyMycpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgZGF0YWJhc2U6ICd0ZW5hbnRfZGInLFxuICAgICAgICAgIHVzZXJuYW1lOiAnYWlvZml4X3VzZXInLFxuICAgICAgICAgIHBhc3N3b3JkOiAnYWlvZml4X3Bhc3N3b3JkJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuICAgICAgZXhwZWN0KGFkYXB0ZXIpLnRvQmUobW9ja0FkYXB0ZXIpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgc2NoZW1hIGxldmVsIGFkYXB0ZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQWRhcHRlciA9IHtcbiAgICAgICAgc2V0RGVmYXVsdFNjaGVtYTogamVzdC5mbigpLFxuICAgICAgICBzZXRUZW5hbnRDb250ZXh0OiBqZXN0LmZuKCksXG4gICAgICB9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFN0cmF0ZWd5JylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZShJc29sYXRpb25TdHJhdGVneS5TQ0hFTUFfTEVWRUwpO1xuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRDb25uZWN0aW9uQ29uZmlnJykubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgZGF0YWJhc2U6ICdwbGF0Zm9ybV9kYicsXG4gICAgICAgIHNjaGVtYTogJ3RlbmFudF9zY2hlbWEnLFxuICAgICAgICB0ZW5hbnRJZDogJ3RlbmFudC0xMjMnLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGFkYXB0ZXIgPSBmYWN0b3J5LmNyZWF0ZUFkYXB0ZXIoJ3RlbmFudC0xMjMnKTtcblxuICAgICAgZXhwZWN0KE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHR5cGU6ICdwb3N0Z3Jlc3FsJyxcbiAgICAgICAgICBkYXRhYmFzZTogJ3BsYXRmb3JtX2RiJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tBZGFwdGVyLnNldERlZmF1bHRTY2hlbWEpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAndGVuYW50X3NjaGVtYScsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1vY2tBZGFwdGVyLnNldFRlbmFudENvbnRleHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd0ZW5hbnQtMTIzJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSB0YWJsZSBsZXZlbCBhZGFwdGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7XG4gICAgICAgIHNldFRlbmFudENvbnRleHQ6IGplc3QuZm4oKSxcbiAgICAgICAgZW5hYmxlUm93TGV2ZWxTZWN1cml0eTogamVzdC5mbigpLFxuICAgICAgfSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRTdHJhdGVneScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWUoSXNvbGF0aW9uU3RyYXRlZ3kuVEFCTEVfTEVWRUwpO1xuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRDb25uZWN0aW9uQ29uZmlnJykubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgZGF0YWJhc2U6ICdwbGF0Zm9ybV9kYicsXG4gICAgICAgIHRlbmFudElkOiAndGVuYW50LTEyMycsXG4gICAgICB9KTtcbiAgICAgIGplc3Quc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnc2hvdWxkRW5hYmxlUkxTJykubW9ja1JldHVyblZhbHVlKHRydWUpO1xuXG4gICAgICBjb25zdCBhZGFwdGVyID0gZmFjdG9yeS5jcmVhdGVBZGFwdGVyKCd0ZW5hbnQtMTIzJyk7XG5cbiAgICAgIGV4cGVjdChNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgZGF0YWJhc2U6ICdwbGF0Zm9ybV9kYicsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtb2NrQWRhcHRlci5zZXRUZW5hbnRDb250ZXh0KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgndGVuYW50LTEyMycpO1xuICAgICAgZXhwZWN0KG1vY2tBZGFwdGVyLmVuYWJsZVJvd0xldmVsU2VjdXJpdHkpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbm90IGVuYWJsZSBSTFMgd2hlbiBjb25maWd1cmVkIHRvIGRpc2FibGUnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQWRhcHRlciA9IHtcbiAgICAgICAgc2V0VGVuYW50Q29udGV4dDogamVzdC5mbigpLFxuICAgICAgICBlbmFibGVSb3dMZXZlbFNlY3VyaXR5OiBqZXN0LmZuKCksXG4gICAgICB9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFN0cmF0ZWd5JylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZShJc29sYXRpb25TdHJhdGVneS5UQUJMRV9MRVZFTCk7XG4gICAgICBqZXN0LnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldENvbm5lY3Rpb25Db25maWcnKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICBkYXRhYmFzZTogJ3BsYXRmb3JtX2RiJyxcbiAgICAgICAgdGVuYW50SWQ6ICd0ZW5hbnQtMTIzJyxcbiAgICAgIH0pO1xuICAgICAgamVzdC5zcHlPbihpc29sYXRpb25Db25maWcsICdzaG91bGRFbmFibGVSTFMnKS5tb2NrUmV0dXJuVmFsdWUoZmFsc2UpO1xuXG4gICAgICBmYWN0b3J5LmNyZWF0ZUFkYXB0ZXIoJ3RlbmFudC0xMjMnKTtcblxuICAgICAgZXhwZWN0KG1vY2tBZGFwdGVyLnNldFRlbmFudENvbnRleHQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCd0ZW5hbnQtMTIzJyk7XG4gICAgICBleHBlY3QobW9ja0FkYXB0ZXIuZW5hYmxlUm93TGV2ZWxTZWN1cml0eSkubm90LnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIHVuc3VwcG9ydGVkIHN0cmF0ZWd5JywgKCkgPT4ge1xuICAgICAgamVzdFxuICAgICAgICAuc3B5T24oaXNvbGF0aW9uQ29uZmlnLCAnZ2V0U3RyYXRlZ3knKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlKCdVTlNVUFBPUlRFRCcgYXMgYW55KTtcblxuICAgICAgZXhwZWN0KCgpID0+IGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVuYW50LTEyMycpKS50b1Rocm93KFxuICAgICAgICAnVW5zdXBwb3J0ZWQgaXNvbGF0aW9uIHN0cmF0ZWd5OiBVTlNVUFBPUlRFRCcsXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3JlYXRlUGxhdGZvcm1BZGFwdGVyJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIHBsYXRmb3JtIGFkYXB0ZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQWRhcHRlciA9IHt9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldFBsYXRmb3JtRGF0YWJhc2VOYW1lJylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZSgncGxhdGZvcm1fZGInKTtcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlUGxhdGZvcm1BZGFwdGVyKCk7XG5cbiAgICAgIGV4cGVjdChNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgcG9ydDogNTQzMixcbiAgICAgICAgICBkYXRhYmFzZTogJ3BsYXRmb3JtX2RiJyxcbiAgICAgICAgICB1c2VybmFtZTogJ2Fpb2ZpeF91c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ2Fpb2ZpeF9wYXNzd29yZCcsXG4gICAgICAgIH0pLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgICBudWxsLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChhZGFwdGVyKS50b0JlKG1vY2tBZGFwdGVyKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NyZWF0ZUV2ZW50c0FkYXB0ZXInLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgZXZlbnRzIGFkYXB0ZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrQWRhcHRlciA9IHt9IGFzIGFueTtcbiAgICAgIE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrQWRhcHRlcik7XG5cbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKGlzb2xhdGlvbkNvbmZpZywgJ2dldEV2ZW50c0RhdGFiYXNlTmFtZScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWUoJ2V2ZW50c19kYicpO1xuXG4gICAgICBjb25zdCBhZGFwdGVyID0gZmFjdG9yeS5jcmVhdGVFdmVudHNBZGFwdGVyKCk7XG5cbiAgICAgIGV4cGVjdChNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlcikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgaG9zdDogJ2xvY2FsaG9zdCcsXG4gICAgICAgICAgcG9ydDogNTQzMixcbiAgICAgICAgICBkYXRhYmFzZTogJ2V2ZW50c19kYicsXG4gICAgICAgICAgdXNlcm5hbWU6ICdhaW9maXhfdXNlcicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdhaW9maXhfcGFzc3dvcmQnLFxuICAgICAgICB9KSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICk7XG4gICAgICBleHBlY3QoYWRhcHRlcikudG9CZShtb2NrQWRhcHRlcik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjcmVhdGVBaVZlY3RvcnNBZGFwdGVyJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIEFJIHZlY3RvcnMgYWRhcHRlciB3aXRoIGRlZmF1bHQgY29uZmlnJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7fSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRBaVZlY3RvcnNEYXRhYmFzZU5hbWUnKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlKCdhaV92ZWN0b3JzX2RiJyk7XG5cbiAgICAgIGNvbnN0IGFkYXB0ZXIgPSBmYWN0b3J5LmNyZWF0ZUFpVmVjdG9yc0FkYXB0ZXIoKTtcblxuICAgICAgZXhwZWN0KE1vY2tlZFBvc3RncmVTUUxBZGFwdGVyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHR5cGU6ICdwb3N0Z3Jlc3FsJyxcbiAgICAgICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICAgICAgICBwb3J0OiA1NDMyLFxuICAgICAgICAgIGRhdGFiYXNlOiAnYWlfdmVjdG9yc19kYicsXG4gICAgICAgICAgdXNlcm5hbWU6ICdhaW9maXhfdXNlcicsXG4gICAgICAgICAgcGFzc3dvcmQ6ICdhaW9maXhfcGFzc3dvcmQnLFxuICAgICAgICB9KSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgbnVsbCxcbiAgICAgICk7XG4gICAgICBleHBlY3QoYWRhcHRlcikudG9CZShtb2NrQWRhcHRlcik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBBSSB2ZWN0b3JzIGFkYXB0ZXIgd2l0aCBjdXN0b20gY29uZmlnJywgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0FkYXB0ZXIgPSB7fSBhcyBhbnk7XG4gICAgICBNb2NrZWRQb3N0Z3JlU1FMQWRhcHRlci5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja0FkYXB0ZXIpO1xuXG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihpc29sYXRpb25Db25maWcsICdnZXRBaVZlY3RvcnNEYXRhYmFzZU5hbWUnKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlKCdhaV92ZWN0b3JzX2RiJyk7XG5cbiAgICAgIC8vIOiuvue9ruiHquWumuS5iUFJ5ZCR6YeP5pWw5o2u5bqT546v5aKD5Y+Y6YePXG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX0hPU1QgPSAnYWktaG9zdCc7XG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1BPUlQgPSAnNTQzMyc7XG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1VTRVIgPSAnYWlfdXNlcic7XG4gICAgICBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1BBU1NXT1JEID0gJ2FpX3Bhc3N3b3JkJztcblxuICAgICAgY29uc3QgYWRhcHRlciA9IGZhY3RvcnkuY3JlYXRlQWlWZWN0b3JzQWRhcHRlcigpO1xuXG4gICAgICBleHBlY3QoTW9ja2VkUG9zdGdyZVNRTEFkYXB0ZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdHlwZTogJ3Bvc3RncmVzcWwnLFxuICAgICAgICAgIGhvc3Q6ICdhaS1ob3N0JyxcbiAgICAgICAgICBwb3J0OiA1NDMzLFxuICAgICAgICAgIGRhdGFiYXNlOiAnYWlfdmVjdG9yc19kYicsXG4gICAgICAgICAgdXNlcm5hbWU6ICdhaV91c2VyJyxcbiAgICAgICAgICBwYXNzd29yZDogJ2FpX3Bhc3N3b3JkJyxcbiAgICAgICAgfSksXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICAgIG51bGwsXG4gICAgICApO1xuXG4gICAgICAvLyDmuIXnkIbnjq/looPlj5jph49cbiAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX0hPU1Q7XG4gICAgICBkZWxldGUgcHJvY2Vzcy5lbnYuQUlfVkVDVE9SU19QT1JUO1xuICAgICAgZGVsZXRlIHByb2Nlc3MuZW52LkFJX1ZFQ1RPUlNfVVNFUjtcbiAgICAgIGRlbGV0ZSBwcm9jZXNzLmVudi5BSV9WRUNUT1JTX1BBU1NXT1JEO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9