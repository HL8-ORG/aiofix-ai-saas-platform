d05859648abdb2ab0456c6d0758005bb
"use strict";
/**
 * @file isolation.config.spec.ts
 * @description 隔离配置服务单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
const isolation_config_1 = require("./isolation.config");
describe('IsolationConfigService', () => {
    let service;
    let configService;
    beforeEach(async () => {
        const mockConfigService = {
            get: jest.fn().mockReturnValue(undefined),
        };
        service = new isolation_config_1.IsolationConfigService(mockConfigService);
        configService = mockConfigService;
    });
    describe('getStrategy', () => {
        it('should return TABLE_LEVEL as default strategy', () => {
            // 模拟环境变量未设置
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const strategy = service.getStrategy();
            expect(strategy).toBe(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
        });
        it('should return DATABASE_LEVEL when configured', () => {
            jest.spyOn(configService, 'get').mockReturnValue('DATABASE_LEVEL');
            const strategy = service.getStrategy();
            expect(strategy).toBe(isolation_config_1.IsolationStrategy.DATABASE_LEVEL);
        });
        it('should return SCHEMA_LEVEL when configured', () => {
            jest.spyOn(configService, 'get').mockReturnValue('SCHEMA_LEVEL');
            const strategy = service.getStrategy();
            expect(strategy).toBe(isolation_config_1.IsolationStrategy.SCHEMA_LEVEL);
        });
        it('should return TABLE_LEVEL when configured', () => {
            jest.spyOn(configService, 'get').mockReturnValue('TABLE_LEVEL');
            const strategy = service.getStrategy();
            expect(strategy).toBe(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
        });
        it('should throw error for invalid strategy', () => {
            jest.spyOn(configService, 'get').mockReturnValue('INVALID_STRATEGY');
            expect(() => service.getStrategy()).toThrow('Invalid isolation strategy: INVALID_STRATEGY');
        });
    });
    describe('getConnectionConfig', () => {
        beforeEach(() => {
            // 设置默认环境变量
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const defaults = {
                    PLATFORM_DB_NAME: 'aiofix_platform',
                    EVENTS_DB_NAME: 'aiofix_events',
                    AI_VECTORS_DB_NAME: 'aiofix_ai_vectors',
                    TENANT_DB_PREFIX: 'tenant_',
                    TENANT_SCHEMA_PREFIX: 'tenant_',
                    SHARED_SCHEMA_NAME: 'shared',
                };
                return defaults[key];
            });
        });
        it('should return platform database config for TABLE_LEVEL strategy', () => {
            jest
                .spyOn(service, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            const config = service.getConnectionConfig('tenant-123');
            expect(config).toEqual({
                database: 'aiofix_platform',
                tenantId: 'tenant-123',
            });
        });
        it('should return tenant database config for DATABASE_LEVEL strategy', () => {
            jest
                .spyOn(service, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.DATABASE_LEVEL);
            const config = service.getConnectionConfig('tenant-123');
            expect(config).toEqual({
                database: 'tenant_tenant-123',
                tenantId: 'tenant-123',
            });
        });
        it('should return schema config for SCHEMA_LEVEL strategy', () => {
            jest
                .spyOn(service, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.SCHEMA_LEVEL);
            const config = service.getConnectionConfig('tenant-123');
            expect(config).toEqual({
                database: 'aiofix_platform',
                schema: 'tenant_tenant-123',
                tenantId: 'tenant-123',
            });
        });
        it('should return platform config when no tenantId provided', () => {
            jest
                .spyOn(service, 'getStrategy')
                .mockReturnValue(isolation_config_1.IsolationStrategy.TABLE_LEVEL);
            const config = service.getConnectionConfig();
            expect(config).toEqual({
                database: 'aiofix_platform',
            });
        });
    });
    describe('shouldEnableRLS', () => {
        it('should return true by default', () => {
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const result = service.shouldEnableRLS();
            expect(result).toBe(true);
        });
        it('should return true when ENABLE_RLS is true', () => {
            jest.spyOn(configService, 'get').mockReturnValue('true');
            const result = service.shouldEnableRLS();
            expect(result).toBe(true);
        });
        it('should return false when ENABLE_RLS is false', () => {
            jest.spyOn(configService, 'get').mockReturnValue('false');
            const result = service.shouldEnableRLS();
            expect(result).toBe(false);
        });
    });
    describe('getDatabaseNames', () => {
        beforeEach(() => {
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const defaults = {
                    PLATFORM_DB_NAME: 'aiofix_platform',
                    EVENTS_DB_NAME: 'aiofix_events',
                    AI_VECTORS_DB_NAME: 'aiofix_ai_vectors',
                };
                return defaults[key];
            });
        });
        it('should return correct database names', () => {
            expect(service.getPlatformDatabaseName()).toBe('aiofix_platform');
            expect(service.getEventsDatabaseName()).toBe('aiofix_events');
            expect(service.getAiVectorsDatabaseName()).toBe('aiofix_ai_vectors');
        });
    });
    describe('getTenantIdField', () => {
        it('should return default tenant field name', () => {
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const fieldName = service.getTenantIdField();
            expect(fieldName).toBe('tenant_id');
        });
        it('should return configured tenant field name', () => {
            jest.spyOn(configService, 'get').mockReturnValue('custom_tenant_id');
            const fieldName = service.getTenantIdField();
            expect(fieldName).toBe('custom_tenant_id');
        });
    });
    describe('shouldAutoAddTenantCondition', () => {
        it('should return true by default', () => {
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const result = service.shouldAutoAddTenantCondition();
            expect(result).toBe(true);
        });
        it('should return configured value', () => {
            jest.spyOn(configService, 'get').mockReturnValue('false');
            const result = service.shouldAutoAddTenantCondition();
            expect(result).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2NvbmZpZy9pc29sYXRpb24uY29uZmlnLnNwZWMudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7QUFJSCx5REFBK0U7QUFFL0UsUUFBUSxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtJQUN0QyxJQUFJLE9BQStCLENBQUM7SUFDcEMsSUFBSSxhQUE0QixDQUFDO0lBRWpDLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLGlCQUFpQixHQUFHO1lBQ3hCLEdBQUcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQztTQUMxQyxDQUFDO1FBRUYsT0FBTyxHQUFHLElBQUkseUNBQXNCLENBQUMsaUJBQXdCLENBQUMsQ0FBQztRQUMvRCxhQUFhLEdBQUcsaUJBQXdCLENBQUM7SUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsYUFBYSxFQUFFLEdBQUcsRUFBRTtRQUMzQixFQUFFLENBQUMsK0NBQStDLEVBQUUsR0FBRyxFQUFFO1lBQ3ZELFlBQVk7WUFDWixJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFNUQsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsb0NBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDdkQsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOENBQThDLEVBQUUsR0FBRyxFQUFFO1lBQ3RELElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBRW5FLE1BQU0sUUFBUSxHQUFHLE9BQU8sQ0FBQyxXQUFX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QUUsR0FBRyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUU1RCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsNEJBQTRCLEVBQUUsQ0FBQztZQUN0RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGdDQUFnQyxFQUFFLEdBQUcsRUFBRTtZQUN4QyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFMUQsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLDRCQUE0QixFQUFFLENBQUM7WUFDdEQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2NvbmZpZy9pc29sYXRpb24uY29uZmlnLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBpc29sYXRpb24uY29uZmlnLnNwZWMudHNcbiAqIEBkZXNjcmlwdGlvbiDpmpTnprvphY3nva7mnI3liqHljZXlhYPmtYvor5VcbiAqL1xuXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IENvbmZpZ01vZHVsZSwgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UsIElzb2xhdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi9pc29sYXRpb24uY29uZmlnJztcblxuZGVzY3JpYmUoJ0lzb2xhdGlvbkNvbmZpZ1NlcnZpY2UnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBJc29sYXRpb25Db25maWdTZXJ2aWNlO1xuICBsZXQgY29uZmlnU2VydmljZTogQ29uZmlnU2VydmljZTtcblxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBtb2NrQ29uZmlnU2VydmljZSA9IHtcbiAgICAgIGdldDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh1bmRlZmluZWQpLFxuICAgIH07XG5cbiAgICBzZXJ2aWNlID0gbmV3IElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UobW9ja0NvbmZpZ1NlcnZpY2UgYXMgYW55KTtcbiAgICBjb25maWdTZXJ2aWNlID0gbW9ja0NvbmZpZ1NlcnZpY2UgYXMgYW55O1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0U3RyYXRlZ3knLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gVEFCTEVfTEVWRUwgYXMgZGVmYXVsdCBzdHJhdGVneScsICgpID0+IHtcbiAgICAgIC8vIOaooeaLn+eOr+Wig+WPmOmHj+acquiuvue9rlxuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja1JldHVyblZhbHVlKHVuZGVmaW5lZCk7XG5cbiAgICAgIGNvbnN0IHN0cmF0ZWd5ID0gc2VydmljZS5nZXRTdHJhdGVneSgpO1xuICAgICAgZXhwZWN0KHN0cmF0ZWd5KS50b0JlKElzb2xhdGlvblN0cmF0ZWd5LlRBQkxFX0xFVkVMKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIERBVEFCQVNFX0xFVkVMIHdoZW4gY29uZmlndXJlZCcsICgpID0+IHtcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tSZXR1cm5WYWx1ZSgnREFUQUJBU0VfTEVWRUwnKTtcblxuICAgICAgY29uc3Qgc3RyYXRlZ3kgPSBzZXJ2aWNlLmdldFN0cmF0ZWd5KCk7XG4gICAgICBleHBlY3Qoc3RyYXRlZ3kpLnRvQmUoSXNvbGF0aW9uU3RyYXRlZ3kuREFUQUJBU0VfTEVWRUwpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gU0NIRU1BX0xFVkVMIHdoZW4gY29uZmlndXJlZCcsICgpID0+IHtcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tSZXR1cm5WYWx1ZSgnU0NIRU1BX0xFVkVMJyk7XG5cbiAgICAgIGNvbnN0IHN0cmF0ZWd5ID0gc2VydmljZS5nZXRTdHJhdGVneSgpO1xuICAgICAgZXhwZWN0KHN0cmF0ZWd5KS50b0JlKElzb2xhdGlvblN0cmF0ZWd5LlNDSEVNQV9MRVZFTCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBUQUJMRV9MRVZFTCB3aGVuIGNvbmZpZ3VyZWQnLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrUmV0dXJuVmFsdWUoJ1RBQkxFX0xFVkVMJyk7XG5cbiAgICAgIGNvbnN0IHN0cmF0ZWd5ID0gc2VydmljZS5nZXRTdHJhdGVneSgpO1xuICAgICAgZXhwZWN0KHN0cmF0ZWd5KS50b0JlKElzb2xhdGlvblN0cmF0ZWd5LlRBQkxFX0xFVkVMKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgZm9yIGludmFsaWQgc3RyYXRlZ3knLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrUmV0dXJuVmFsdWUoJ0lOVkFMSURfU1RSQVRFR1knKTtcblxuICAgICAgZXhwZWN0KCgpID0+IHNlcnZpY2UuZ2V0U3RyYXRlZ3koKSkudG9UaHJvdyhcbiAgICAgICAgJ0ludmFsaWQgaXNvbGF0aW9uIHN0cmF0ZWd5OiBJTlZBTElEX1NUUkFURUdZJyxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRDb25uZWN0aW9uQ29uZmlnJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgLy8g6K6+572u6buY6K6k546v5aKD5Y+Y6YePXG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IGRlZmF1bHRzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgICAgIFBMQVRGT1JNX0RCX05BTUU6ICdhaW9maXhfcGxhdGZvcm0nLFxuICAgICAgICAgIEVWRU5UU19EQl9OQU1FOiAnYWlvZml4X2V2ZW50cycsXG4gICAgICAgICAgQUlfVkVDVE9SU19EQl9OQU1FOiAnYWlvZml4X2FpX3ZlY3RvcnMnLFxuICAgICAgICAgIFRFTkFOVF9EQl9QUkVGSVg6ICd0ZW5hbnRfJyxcbiAgICAgICAgICBURU5BTlRfU0NIRU1BX1BSRUZJWDogJ3RlbmFudF8nLFxuICAgICAgICAgIFNIQVJFRF9TQ0hFTUFfTkFNRTogJ3NoYXJlZCcsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBkZWZhdWx0c1trZXldO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBwbGF0Zm9ybSBkYXRhYmFzZSBjb25maWcgZm9yIFRBQkxFX0xFVkVMIHN0cmF0ZWd5JywgKCkgPT4ge1xuICAgICAgamVzdFxuICAgICAgICAuc3B5T24oc2VydmljZSwgJ2dldFN0cmF0ZWd5JylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZShJc29sYXRpb25TdHJhdGVneS5UQUJMRV9MRVZFTCk7XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHNlcnZpY2UuZ2V0Q29ubmVjdGlvbkNvbmZpZygndGVuYW50LTEyMycpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0VxdWFsKHtcbiAgICAgICAgZGF0YWJhc2U6ICdhaW9maXhfcGxhdGZvcm0nLFxuICAgICAgICB0ZW5hbnRJZDogJ3RlbmFudC0xMjMnLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiB0ZW5hbnQgZGF0YWJhc2UgY29uZmlnIGZvciBEQVRBQkFTRV9MRVZFTCBzdHJhdGVneScsICgpID0+IHtcbiAgICAgIGplc3RcbiAgICAgICAgLnNweU9uKHNlcnZpY2UsICdnZXRTdHJhdGVneScpXG4gICAgICAgIC5tb2NrUmV0dXJuVmFsdWUoSXNvbGF0aW9uU3RyYXRlZ3kuREFUQUJBU0VfTEVWRUwpO1xuXG4gICAgICBjb25zdCBjb25maWcgPSBzZXJ2aWNlLmdldENvbm5lY3Rpb25Db25maWcoJ3RlbmFudC0xMjMnKTtcblxuICAgICAgZXhwZWN0KGNvbmZpZykudG9FcXVhbCh7XG4gICAgICAgIGRhdGFiYXNlOiAndGVuYW50X3RlbmFudC0xMjMnLFxuICAgICAgICB0ZW5hbnRJZDogJ3RlbmFudC0xMjMnLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBzY2hlbWEgY29uZmlnIGZvciBTQ0hFTUFfTEVWRUwgc3RyYXRlZ3knLCAoKSA9PiB7XG4gICAgICBqZXN0XG4gICAgICAgIC5zcHlPbihzZXJ2aWNlLCAnZ2V0U3RyYXRlZ3knKVxuICAgICAgICAubW9ja1JldHVyblZhbHVlKElzb2xhdGlvblN0cmF0ZWd5LlNDSEVNQV9MRVZFTCk7XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHNlcnZpY2UuZ2V0Q29ubmVjdGlvbkNvbmZpZygndGVuYW50LTEyMycpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0VxdWFsKHtcbiAgICAgICAgZGF0YWJhc2U6ICdhaW9maXhfcGxhdGZvcm0nLFxuICAgICAgICBzY2hlbWE6ICd0ZW5hbnRfdGVuYW50LTEyMycsXG4gICAgICAgIHRlbmFudElkOiAndGVuYW50LTEyMycsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHBsYXRmb3JtIGNvbmZpZyB3aGVuIG5vIHRlbmFudElkIHByb3ZpZGVkJywgKCkgPT4ge1xuICAgICAgamVzdFxuICAgICAgICAuc3B5T24oc2VydmljZSwgJ2dldFN0cmF0ZWd5JylcbiAgICAgICAgLm1vY2tSZXR1cm5WYWx1ZShJc29sYXRpb25TdHJhdGVneS5UQUJMRV9MRVZFTCk7XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHNlcnZpY2UuZ2V0Q29ubmVjdGlvbkNvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0VxdWFsKHtcbiAgICAgICAgZGF0YWJhc2U6ICdhaW9maXhfcGxhdGZvcm0nLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzaG91bGRFbmFibGVSTFMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSBieSBkZWZhdWx0JywgKCkgPT4ge1xuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja1JldHVyblZhbHVlKHVuZGVmaW5lZCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlcnZpY2Uuc2hvdWxkRW5hYmxlUkxTKCk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdHJ1ZSB3aGVuIEVOQUJMRV9STFMgaXMgdHJ1ZScsICgpID0+IHtcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tSZXR1cm5WYWx1ZSgndHJ1ZScpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLnNob3VsZEVuYWJsZVJMUygpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGZhbHNlIHdoZW4gRU5BQkxFX1JMUyBpcyBmYWxzZScsICgpID0+IHtcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tSZXR1cm5WYWx1ZSgnZmFsc2UnKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gc2VydmljZS5zaG91bGRFbmFibGVSTFMoKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0RGF0YWJhc2VOYW1lcycsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tJbXBsZW1lbnRhdGlvbigoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgZGVmYXVsdHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICAgUExBVEZPUk1fREJfTkFNRTogJ2Fpb2ZpeF9wbGF0Zm9ybScsXG4gICAgICAgICAgRVZFTlRTX0RCX05BTUU6ICdhaW9maXhfZXZlbnRzJyxcbiAgICAgICAgICBBSV9WRUNUT1JTX0RCX05BTUU6ICdhaW9maXhfYWlfdmVjdG9ycycsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBkZWZhdWx0c1trZXldO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb3JyZWN0IGRhdGFiYXNlIG5hbWVzJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KHNlcnZpY2UuZ2V0UGxhdGZvcm1EYXRhYmFzZU5hbWUoKSkudG9CZSgnYWlvZml4X3BsYXRmb3JtJyk7XG4gICAgICBleHBlY3Qoc2VydmljZS5nZXRFdmVudHNEYXRhYmFzZU5hbWUoKSkudG9CZSgnYWlvZml4X2V2ZW50cycpO1xuICAgICAgZXhwZWN0KHNlcnZpY2UuZ2V0QWlWZWN0b3JzRGF0YWJhc2VOYW1lKCkpLnRvQmUoJ2Fpb2ZpeF9haV92ZWN0b3JzJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRUZW5hbnRJZEZpZWxkJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGRlZmF1bHQgdGVuYW50IGZpZWxkIG5hbWUnLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrUmV0dXJuVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgZmllbGROYW1lID0gc2VydmljZS5nZXRUZW5hbnRJZEZpZWxkKCk7XG4gICAgICBleHBlY3QoZmllbGROYW1lKS50b0JlKCd0ZW5hbnRfaWQnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvbmZpZ3VyZWQgdGVuYW50IGZpZWxkIG5hbWUnLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrUmV0dXJuVmFsdWUoJ2N1c3RvbV90ZW5hbnRfaWQnKTtcblxuICAgICAgY29uc3QgZmllbGROYW1lID0gc2VydmljZS5nZXRUZW5hbnRJZEZpZWxkKCk7XG4gICAgICBleHBlY3QoZmllbGROYW1lKS50b0JlKCdjdXN0b21fdGVuYW50X2lkJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzaG91bGRBdXRvQWRkVGVuYW50Q29uZGl0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIHRydWUgYnkgZGVmYXVsdCcsICgpID0+IHtcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tSZXR1cm5WYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLnNob3VsZEF1dG9BZGRUZW5hbnRDb25kaXRpb24oKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUodHJ1ZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBjb25maWd1cmVkIHZhbHVlJywgKCkgPT4ge1xuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja1JldHVyblZhbHVlKCdmYWxzZScpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBzZXJ2aWNlLnNob3VsZEF1dG9BZGRUZW5hbnRDb25kaXRpb24oKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9