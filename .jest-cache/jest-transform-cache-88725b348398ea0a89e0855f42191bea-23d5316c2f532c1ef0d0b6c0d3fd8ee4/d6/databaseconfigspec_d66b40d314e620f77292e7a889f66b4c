8cb5491aebdcce9c15a18580bad2268a
"use strict";
/**
 * @file database.config.spec.ts
 * @description 数据库配置服务单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
const database_config_1 = require("./database.config");
describe('DatabaseConfig', () => {
    let service;
    let configService;
    beforeEach(async () => {
        const mockConfigService = {
            get: jest.fn().mockReturnValue(undefined),
        };
        const mockLogger = {
            error: jest.fn(),
            info: jest.fn(),
        };
        service = new database_config_1.DatabaseConfig(mockConfigService, mockLogger);
        configService = mockConfigService;
    });
    describe('getPostgreSQLConfig', () => {
        it('should return default PostgreSQL configuration', () => {
            // 模拟环境变量未设置
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const config = service.getPostgresConfig();
            expect(config).toEqual({
                host: 'localhost',
                port: 5432,
                username: 'aiofix_user',
                password: 'aiofix_password',
                database: 'aiofix_platform',
                ssl: false,
                pool: {
                    min: 2,
                    max: 10,
                    acquireTimeoutMillis: 30000,
                    createTimeoutMillis: 30000,
                    destroyTimeoutMillis: 5000,
                    idleTimeoutMillis: 30000,
                    reapIntervalMillis: 1000,
                    createRetryIntervalMillis: 200,
                },
                tenantDatabases: {
                    'tenant-1': 'aiofix_tenant_1',
                    'tenant-2': 'aiofix_tenant_2',
                    'tenant-3': 'aiofix_tenant_3',
                },
                synchronize: false,
                logging: false,
                cache: {
                    duration: 30000,
                },
            });
        });
        it('should return configured PostgreSQL configuration', () => {
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    POSTGRES_HOST: 'custom-host',
                    POSTGRES_PORT: '5433',
                    POSTGRES_USER: 'custom_user',
                    POSTGRES_PASSWORD: 'custom_password',
                    POSTGRES_DB: 'custom_database',
                    POSTGRES_SSL: 'true',
                    POSTGRES_POOL_MIN: '5',
                    POSTGRES_POOL_MAX: '20',
                };
                return configs[key];
            });
            const config = service.getPostgresConfig();
            expect(config).toEqual({
                host: 'custom-host',
                port: 5433,
                username: 'custom_user',
                password: 'custom_password',
                database: 'custom_database',
                ssl: false,
                pool: {
                    min: 5,
                    max: 20,
                    acquireTimeoutMillis: 30000,
                    createTimeoutMillis: 30000,
                    destroyTimeoutMillis: 5000,
                    idleTimeoutMillis: 30000,
                    reapIntervalMillis: 1000,
                    createRetryIntervalMillis: 200,
                },
                tenantDatabases: {
                    'tenant-1': 'aiofix_tenant_1',
                    'tenant-2': 'aiofix_tenant_2',
                    'tenant-3': 'aiofix_tenant_3',
                },
                synchronize: false,
                logging: false,
                cache: {
                    duration: 30000,
                },
            });
        });
        it('should handle SSL configuration as object', () => {
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                if (key === 'NODE_ENV') {
                    return 'production';
                }
                return undefined;
            });
            const config = service.getPostgresConfig();
            expect(config.ssl).toEqual({ rejectUnauthorized: false });
        });
    });
    describe('getMongoDBConfig', () => {
        it('should return default MongoDB configuration', () => {
            jest.spyOn(configService, 'get').mockReturnValue(undefined);
            const config = service.getMongoDBConfig();
            expect(config).toEqual({
                uri: 'mongodb://aiofix_admin:aiofix_password@localhost:27017/aiofix_events?authSource=admin',
                databases: {
                    events: 'aiofix_events',
                    notifications: 'aiofix_notifications',
                },
                options: {
                    maxPoolSize: 10,
                    minPoolSize: 2,
                    maxIdleTimeMS: 30000,
                    serverSelectionTimeoutMS: 5000,
                    socketTimeoutMS: 45000,
                    bufferMaxEntries: 0,
                    useNewUrlParser: true,
                    useUnifiedTopology: true,
                },
                eventStore: {
                    collection: 'domain_events',
                    snapshotCollection: 'aggregate_snapshots',
                    maxEventsPerSnapshot: 100,
                },
                notifications: {
                    collection: 'notifications',
                    indexes: [
                        { keys: { id: 1 }, options: { unique: true } },
                        { keys: { type: 1, status: 1 } },
                        { keys: { tenantId: 1, userId: 1 } },
                        { keys: { createdAt: 1 } },
                    ],
                },
            });
        });
        it('should return configured MongoDB configuration', () => {
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    MONGODB_URI: 'mongodb://mongo_user:mongo_password@mongo-host:27018/mongo_database?authSource=admin',
                    MONGODB_EVENTS_DB: 'custom_events',
                    MONGODB_NOTIFICATIONS_DB: 'custom_notifications',
                };
                return configs[key];
            });
            const config = service.getMongoDBConfig();
            expect(config).toEqual({
                uri: 'mongodb://mongo_user:mongo_password@mongo-host:27018/mongo_database?authSource=admin',
                databases: {
                    events: 'custom_events',
                    notifications: 'custom_notifications',
                },
                options: {
                    maxPoolSize: 10,
                    minPoolSize: 2,
                    maxIdleTimeMS: 30000,
                    serverSelectionTimeoutMS: 5000,
                    socketTimeoutMS: 45000,
                    bufferMaxEntries: 0,
                    useNewUrlParser: true,
                    useUnifiedTopology: true,
                },
                eventStore: {
                    collection: 'domain_events',
                    snapshotCollection: 'aggregate_snapshots',
                    maxEventsPerSnapshot: 100,
                },
                notifications: {
                    collection: 'notifications',
                    indexes: [
                        { keys: { id: 1 }, options: { unique: true } },
                        { keys: { type: 1, status: 1 } },
                        { keys: { tenantId: 1, userId: 1 } },
                        { keys: { createdAt: 1 } },
                    ],
                },
            });
        });
    });
    describe('getTenantPostgresConfig', () => {
        it('should return tenant-specific PostgreSQL config', () => {
            const config = service.getTenantPostgresConfig('tenant-1');
            expect(config).toHaveProperty('database');
            expect(config.database).toBe('aiofix_tenant_1');
        });
        it('should return default tenant config for unknown tenant', () => {
            const config = service.getTenantPostgresConfig('unknown-tenant');
            expect(config).toHaveProperty('database');
            expect(config.database).toBe('aiofix_tenant_unknown-tenant');
        });
    });
    describe('validateConfig', () => {
        it('should validate correct configuration', () => {
            // Mock configService to return valid values
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    POSTGRES_HOST: 'localhost',
                    POSTGRES_DB: 'test_db',
                    POSTGRES_USER: 'test_user',
                    POSTGRES_PASSWORD: 'test_password',
                    MONGODB_URI: 'mongodb://localhost:27017/test_db',
                };
                return configs[key];
            });
            const isValid = service.validateConfig();
            expect(isValid).toBe(true);
        });
        it('should reject invalid PostgreSQL config', () => {
            // Mock configService to return invalid values
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    POSTGRES_HOST: '', // 无效的主机
                    POSTGRES_DB: 'test_db',
                    POSTGRES_USER: 'test_user',
                    MONGODB_URI: 'mongodb://localhost:27017/test_db',
                };
                return configs[key];
            });
            const isValid = service.validateConfig();
            expect(isValid).toBe(false);
        });
        it('should reject invalid MongoDB config', () => {
            // Mock configService to return invalid values
            jest.spyOn(configService, 'get').mockImplementation((key) => {
                const configs = {
                    POSTGRES_HOST: 'localhost',
                    POSTGRES_DB: 'test_db',
                    POSTGRES_USER: 'test_user',
                    MONGODB_URI: '', // 无效的URI
                };
                return configs[key];
            });
            const isValid = service.validateConfig();
            expect(isValid).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2NvbmZpZy9kYXRhYmFzZS5jb25maWcuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOztBQUlILHVEQUFtRDtBQUVuRCxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLElBQUksT0FBdUIsQ0FBQztJQUM1QixJQUFJLGFBQTRCLENBQUM7SUFFakMsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0saUJBQWlCLEdBQUc7WUFDeEIsR0FBRyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDO1NBQzFDLENBQUM7UUFFRixNQUFNLFVBQVUsR0FBRztZQUNqQixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNoQixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtTQUNoQixDQUFDO1FBRUYsT0FBTyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxpQkFBd0IsRUFBRSxVQUFpQixDQUFDLENBQUM7UUFDMUUsYUFBYSxHQUFHLGlCQUF3QixDQUFDO0lBQzNDLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtRQUNuQyxFQUFFLENBQUMsZ0RBQWdELEVBQUUsR0FBRyxFQUFFO1lBQ3hELFlBQVk7WUFDWixJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFNUQsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFFM0MsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFDckIsSUFBSSxFQUFFLFdBQVc7Z0JBQ2pCLElBQUksRUFBRSxJQUFJO2dCQUNWLFFBQVEsRUFBRSxhQUFhO2dCQUN2QixRQUFRLEVBQUUs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QUFXLEVBQUUsbUNBQW1DO2lCQUNqRCxDQUFDO2dCQUNGLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3RCLENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3pDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUIsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsc0NBQXNDLEVBQUUsR0FBRyxFQUFFO1lBQzlDLDhDQUE4QztZQUM5QyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxLQUFLLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEdBQVcsRUFBRSxFQUFFO2dCQUNsRSxNQUFNLE9BQU8sR0FBMkI7b0JBQ3RDLGFBQWEsRUFBRSxXQUFXO29CQUMxQixXQUFXLEVBQUUsU0FBUztvQkFDdEIsYUFBYSxFQUFFLFdBQVc7b0JBQzFCLFdBQVcsRUFBRSxFQUFFLEVBQUUsU0FBUztpQkFDM0IsQ0FBQztnQkFDRixPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN0QixDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN6QyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzlCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9hcmxpZ2xlL1YxL0Fpb2ZpeC9haW9maXgtYWktc2Fhcy1wbGF0Zm9ybS9wYWNrYWdlcy9kYXRhYmFzZS9zcmMvY29uZmlnL2RhdGFiYXNlLmNvbmZpZy5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgZGF0YWJhc2UuY29uZmlnLnNwZWMudHNcbiAqIEBkZXNjcmlwdGlvbiDmlbDmja7lupPphY3nva7mnI3liqHljZXlhYPmtYvor5VcbiAqL1xuXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IENvbmZpZ01vZHVsZSwgQ29uZmlnU2VydmljZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IERhdGFiYXNlQ29uZmlnIH0gZnJvbSAnLi9kYXRhYmFzZS5jb25maWcnO1xuXG5kZXNjcmliZSgnRGF0YWJhc2VDb25maWcnLCAoKSA9PiB7XG4gIGxldCBzZXJ2aWNlOiBEYXRhYmFzZUNvbmZpZztcbiAgbGV0IGNvbmZpZ1NlcnZpY2U6IENvbmZpZ1NlcnZpY2U7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9ja0NvbmZpZ1NlcnZpY2UgPSB7XG4gICAgICBnZXQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUodW5kZWZpbmVkKSxcbiAgICB9O1xuXG4gICAgY29uc3QgbW9ja0xvZ2dlciA9IHtcbiAgICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgICBpbmZvOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIHNlcnZpY2UgPSBuZXcgRGF0YWJhc2VDb25maWcobW9ja0NvbmZpZ1NlcnZpY2UgYXMgYW55LCBtb2NrTG9nZ2VyIGFzIGFueSk7XG4gICAgY29uZmlnU2VydmljZSA9IG1vY2tDb25maWdTZXJ2aWNlIGFzIGFueTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldFBvc3RncmVTUUxDb25maWcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZGVmYXVsdCBQb3N0Z3JlU1FMIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICAvLyDmqKHmi5/njq/looPlj5jph4/mnKrorr7nva5cbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tSZXR1cm5WYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgICBjb25zdCBjb25maWcgPSBzZXJ2aWNlLmdldFBvc3RncmVzQ29uZmlnKCk7XG5cbiAgICAgIGV4cGVjdChjb25maWcpLnRvRXF1YWwoe1xuICAgICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICAgICAgcG9ydDogNTQzMixcbiAgICAgICAgdXNlcm5hbWU6ICdhaW9maXhfdXNlcicsXG4gICAgICAgIHBhc3N3b3JkOiAnYWlvZml4X3Bhc3N3b3JkJyxcbiAgICAgICAgZGF0YWJhc2U6ICdhaW9maXhfcGxhdGZvcm0nLFxuICAgICAgICBzc2w6IGZhbHNlLFxuICAgICAgICBwb29sOiB7XG4gICAgICAgICAgbWluOiAyLFxuICAgICAgICAgIG1heDogMTAsXG4gICAgICAgICAgYWNxdWlyZVRpbWVvdXRNaWxsaXM6IDMwMDAwLFxuICAgICAgICAgIGNyZWF0ZVRpbWVvdXRNaWxsaXM6IDMwMDAwLFxuICAgICAgICAgIGRlc3Ryb3lUaW1lb3V0TWlsbGlzOiA1MDAwLFxuICAgICAgICAgIGlkbGVUaW1lb3V0TWlsbGlzOiAzMDAwMCxcbiAgICAgICAgICByZWFwSW50ZXJ2YWxNaWxsaXM6IDEwMDAsXG4gICAgICAgICAgY3JlYXRlUmV0cnlJbnRlcnZhbE1pbGxpczogMjAwLFxuICAgICAgICB9LFxuICAgICAgICB0ZW5hbnREYXRhYmFzZXM6IHtcbiAgICAgICAgICAndGVuYW50LTEnOiAnYWlvZml4X3RlbmFudF8xJyxcbiAgICAgICAgICAndGVuYW50LTInOiAnYWlvZml4X3RlbmFudF8yJyxcbiAgICAgICAgICAndGVuYW50LTMnOiAnYWlvZml4X3RlbmFudF8zJyxcbiAgICAgICAgfSxcbiAgICAgICAgc3luY2hyb25pemU6IGZhbHNlLFxuICAgICAgICBsb2dnaW5nOiBmYWxzZSxcbiAgICAgICAgY2FjaGU6IHtcbiAgICAgICAgICBkdXJhdGlvbjogMzAwMDAsXG4gICAgICAgIH0sXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvbmZpZ3VyZWQgUG9zdGdyZVNRTCBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja0ltcGxlbWVudGF0aW9uKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBjb25maWdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgICAgIFBPU1RHUkVTX0hPU1Q6ICdjdXN0b20taG9zdCcsXG4gICAgICAgICAgUE9TVEdSRVNfUE9SVDogJzU0MzMnLFxuICAgICAgICAgIFBPU1RHUkVTX1VTRVI6ICdjdXN0b21fdXNlcicsXG4gICAgICAgICAgUE9TVEdSRVNfUEFTU1dPUkQ6ICdjdXN0b21fcGFzc3dvcmQnLFxuICAgICAgICAgIFBPU1RHUkVTX0RCOiAnY3VzdG9tX2RhdGFiYXNlJyxcbiAgICAgICAgICBQT1NUR1JFU19TU0w6ICd0cnVlJyxcbiAgICAgICAgICBQT1NUR1JFU19QT09MX01JTjogJzUnLFxuICAgICAgICAgIFBPU1RHUkVTX1BPT0xfTUFYOiAnMjAnLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY29uZmlnc1trZXldO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHNlcnZpY2UuZ2V0UG9zdGdyZXNDb25maWcoKTtcblxuICAgICAgZXhwZWN0KGNvbmZpZykudG9FcXVhbCh7XG4gICAgICAgIGhvc3Q6ICdjdXN0b20taG9zdCcsXG4gICAgICAgIHBvcnQ6IDU0MzMsXG4gICAgICAgIHVzZXJuYW1lOiAnY3VzdG9tX3VzZXInLFxuICAgICAgICBwYXNzd29yZDogJ2N1c3RvbV9wYXNzd29yZCcsXG4gICAgICAgIGRhdGFiYXNlOiAnY3VzdG9tX2RhdGFiYXNlJyxcbiAgICAgICAgc3NsOiBmYWxzZSxcbiAgICAgICAgcG9vbDoge1xuICAgICAgICAgIG1pbjogNSxcbiAgICAgICAgICBtYXg6IDIwLFxuICAgICAgICAgIGFjcXVpcmVUaW1lb3V0TWlsbGlzOiAzMDAwMCxcbiAgICAgICAgICBjcmVhdGVUaW1lb3V0TWlsbGlzOiAzMDAwMCxcbiAgICAgICAgICBkZXN0cm95VGltZW91dE1pbGxpczogNTAwMCxcbiAgICAgICAgICBpZGxlVGltZW91dE1pbGxpczogMzAwMDAsXG4gICAgICAgICAgcmVhcEludGVydmFsTWlsbGlzOiAxMDAwLFxuICAgICAgICAgIGNyZWF0ZVJldHJ5SW50ZXJ2YWxNaWxsaXM6IDIwMCxcbiAgICAgICAgfSxcbiAgICAgICAgdGVuYW50RGF0YWJhc2VzOiB7XG4gICAgICAgICAgJ3RlbmFudC0xJzogJ2Fpb2ZpeF90ZW5hbnRfMScsXG4gICAgICAgICAgJ3RlbmFudC0yJzogJ2Fpb2ZpeF90ZW5hbnRfMicsXG4gICAgICAgICAgJ3RlbmFudC0zJzogJ2Fpb2ZpeF90ZW5hbnRfMycsXG4gICAgICAgIH0sXG4gICAgICAgIHN5bmNocm9uaXplOiBmYWxzZSxcbiAgICAgICAgbG9nZ2luZzogZmFsc2UsXG4gICAgICAgIGNhY2hlOiB7XG4gICAgICAgICAgZHVyYXRpb246IDMwMDAwLFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBTU0wgY29uZmlndXJhdGlvbiBhcyBvYmplY3QnLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGlmIChrZXkgPT09ICdOT0RFX0VOVicpIHtcbiAgICAgICAgICByZXR1cm4gJ3Byb2R1Y3Rpb24nO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgY29uZmlnID0gc2VydmljZS5nZXRQb3N0Z3Jlc0NvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY29uZmlnLnNzbCkudG9FcXVhbCh7IHJlamVjdFVuYXV0aG9yaXplZDogZmFsc2UgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdnZXRNb25nb0RCQ29uZmlnJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIGRlZmF1bHQgTW9uZ29EQiBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja1JldHVyblZhbHVlKHVuZGVmaW5lZCk7XG5cbiAgICAgIGNvbnN0IGNvbmZpZyA9IHNlcnZpY2UuZ2V0TW9uZ29EQkNvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0VxdWFsKHtcbiAgICAgICAgdXJpOiAnbW9uZ29kYjovL2Fpb2ZpeF9hZG1pbjphaW9maXhfcGFzc3dvcmRAbG9jYWxob3N0OjI3MDE3L2Fpb2ZpeF9ldmVudHM/YXV0aFNvdXJjZT1hZG1pbicsXG4gICAgICAgIGRhdGFiYXNlczoge1xuICAgICAgICAgIGV2ZW50czogJ2Fpb2ZpeF9ldmVudHMnLFxuICAgICAgICAgIG5vdGlmaWNhdGlvbnM6ICdhaW9maXhfbm90aWZpY2F0aW9ucycsXG4gICAgICAgIH0sXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBtYXhQb29sU2l6ZTogMTAsXG4gICAgICAgICAgbWluUG9vbFNpemU6IDIsXG4gICAgICAgICAgbWF4SWRsZVRpbWVNUzogMzAwMDAsXG4gICAgICAgICAgc2VydmVyU2VsZWN0aW9uVGltZW91dE1TOiA1MDAwLFxuICAgICAgICAgIHNvY2tldFRpbWVvdXRNUzogNDUwMDAsXG4gICAgICAgICAgYnVmZmVyTWF4RW50cmllczogMCxcbiAgICAgICAgICB1c2VOZXdVcmxQYXJzZXI6IHRydWUsXG4gICAgICAgICAgdXNlVW5pZmllZFRvcG9sb2d5OiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBldmVudFN0b3JlOiB7XG4gICAgICAgICAgY29sbGVjdGlvbjogJ2RvbWFpbl9ldmVudHMnLFxuICAgICAgICAgIHNuYXBzaG90Q29sbGVjdGlvbjogJ2FnZ3JlZ2F0ZV9zbmFwc2hvdHMnLFxuICAgICAgICAgIG1heEV2ZW50c1BlclNuYXBzaG90OiAxMDAsXG4gICAgICAgIH0sXG4gICAgICAgIG5vdGlmaWNhdGlvbnM6IHtcbiAgICAgICAgICBjb2xsZWN0aW9uOiAnbm90aWZpY2F0aW9ucycsXG4gICAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgeyBrZXlzOiB7IGlkOiAxIH0sIG9wdGlvbnM6IHsgdW5pcXVlOiB0cnVlIH0gfSxcbiAgICAgICAgICAgIHsga2V5czogeyB0eXBlOiAxLCBzdGF0dXM6IDEgfSB9LFxuICAgICAgICAgICAgeyBrZXlzOiB7IHRlbmFudElkOiAxLCB1c2VySWQ6IDEgfSB9LFxuICAgICAgICAgICAgeyBrZXlzOiB7IGNyZWF0ZWRBdDogMSB9IH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gY29uZmlndXJlZCBNb25nb0RCIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICAgTU9OR09EQl9VUkk6XG4gICAgICAgICAgICAnbW9uZ29kYjovL21vbmdvX3VzZXI6bW9uZ29fcGFzc3dvcmRAbW9uZ28taG9zdDoyNzAxOC9tb25nb19kYXRhYmFzZT9hdXRoU291cmNlPWFkbWluJyxcbiAgICAgICAgICBNT05HT0RCX0VWRU5UU19EQjogJ2N1c3RvbV9ldmVudHMnLFxuICAgICAgICAgIE1PTkdPREJfTk9USUZJQ0FUSU9OU19EQjogJ2N1c3RvbV9ub3RpZmljYXRpb25zJyxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGNvbmZpZ3Nba2V5XTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBjb25maWcgPSBzZXJ2aWNlLmdldE1vbmdvREJDb25maWcoKTtcblxuICAgICAgZXhwZWN0KGNvbmZpZykudG9FcXVhbCh7XG4gICAgICAgIHVyaTogJ21vbmdvZGI6Ly9tb25nb191c2VyOm1vbmdvX3Bhc3N3b3JkQG1vbmdvLWhvc3Q6MjcwMTgvbW9uZ29fZGF0YWJhc2U/YXV0aFNvdXJjZT1hZG1pbicsXG4gICAgICAgIGRhdGFiYXNlczoge1xuICAgICAgICAgIGV2ZW50czogJ2N1c3RvbV9ldmVudHMnLFxuICAgICAgICAgIG5vdGlmaWNhdGlvbnM6ICdjdXN0b21fbm90aWZpY2F0aW9ucycsXG4gICAgICAgIH0sXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBtYXhQb29sU2l6ZTogMTAsXG4gICAgICAgICAgbWluUG9vbFNpemU6IDIsXG4gICAgICAgICAgbWF4SWRsZVRpbWVNUzogMzAwMDAsXG4gICAgICAgICAgc2VydmVyU2VsZWN0aW9uVGltZW91dE1TOiA1MDAwLFxuICAgICAgICAgIHNvY2tldFRpbWVvdXRNUzogNDUwMDAsXG4gICAgICAgICAgYnVmZmVyTWF4RW50cmllczogMCxcbiAgICAgICAgICB1c2VOZXdVcmxQYXJzZXI6IHRydWUsXG4gICAgICAgICAgdXNlVW5pZmllZFRvcG9sb2d5OiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgICBldmVudFN0b3JlOiB7XG4gICAgICAgICAgY29sbGVjdGlvbjogJ2RvbWFpbl9ldmVudHMnLFxuICAgICAgICAgIHNuYXBzaG90Q29sbGVjdGlvbjogJ2FnZ3JlZ2F0ZV9zbmFwc2hvdHMnLFxuICAgICAgICAgIG1heEV2ZW50c1BlclNuYXBzaG90OiAxMDAsXG4gICAgICAgIH0sXG4gICAgICAgIG5vdGlmaWNhdGlvbnM6IHtcbiAgICAgICAgICBjb2xsZWN0aW9uOiAnbm90aWZpY2F0aW9ucycsXG4gICAgICAgICAgaW5kZXhlczogW1xuICAgICAgICAgICAgeyBrZXlzOiB7IGlkOiAxIH0sIG9wdGlvbnM6IHsgdW5pcXVlOiB0cnVlIH0gfSxcbiAgICAgICAgICAgIHsga2V5czogeyB0eXBlOiAxLCBzdGF0dXM6IDEgfSB9LFxuICAgICAgICAgICAgeyBrZXlzOiB7IHRlbmFudElkOiAxLCB1c2VySWQ6IDEgfSB9LFxuICAgICAgICAgICAgeyBrZXlzOiB7IGNyZWF0ZWRBdDogMSB9IH0sXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZ2V0VGVuYW50UG9zdGdyZXNDb25maWcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdGVuYW50LXNwZWNpZmljIFBvc3RncmVTUUwgY29uZmlnJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0gc2VydmljZS5nZXRUZW5hbnRQb3N0Z3Jlc0NvbmZpZygndGVuYW50LTEnKTtcblxuICAgICAgZXhwZWN0KGNvbmZpZykudG9IYXZlUHJvcGVydHkoJ2RhdGFiYXNlJyk7XG4gICAgICBleHBlY3QoY29uZmlnLmRhdGFiYXNlKS50b0JlKCdhaW9maXhfdGVuYW50XzEnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGRlZmF1bHQgdGVuYW50IGNvbmZpZyBmb3IgdW5rbm93biB0ZW5hbnQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSBzZXJ2aWNlLmdldFRlbmFudFBvc3RncmVzQ29uZmlnKCd1bmtub3duLXRlbmFudCcpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0hhdmVQcm9wZXJ0eSgnZGF0YWJhc2UnKTtcbiAgICAgIGV4cGVjdChjb25maWcuZGF0YWJhc2UpLnRvQmUoJ2Fpb2ZpeF90ZW5hbnRfdW5rbm93bi10ZW5hbnQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3ZhbGlkYXRlQ29uZmlnJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgY29ycmVjdCBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgICAgLy8gTW9jayBjb25maWdTZXJ2aWNlIHRvIHJldHVybiB2YWxpZCB2YWx1ZXNcbiAgICAgIGplc3Quc3B5T24oY29uZmlnU2VydmljZSwgJ2dldCcpLm1vY2tJbXBsZW1lbnRhdGlvbigoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3QgY29uZmlnczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgICAgICBQT1NUR1JFU19IT1NUOiAnbG9jYWxob3N0JyxcbiAgICAgICAgICBQT1NUR1JFU19EQjogJ3Rlc3RfZGInLFxuICAgICAgICAgIFBPU1RHUkVTX1VTRVI6ICd0ZXN0X3VzZXInLFxuICAgICAgICAgIFBPU1RHUkVTX1BBU1NXT1JEOiAndGVzdF9wYXNzd29yZCcsXG4gICAgICAgICAgTU9OR09EQl9VUkk6ICdtb25nb2RiOi8vbG9jYWxob3N0OjI3MDE3L3Rlc3RfZGInLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY29uZmlnc1trZXldO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGlzVmFsaWQgPSBzZXJ2aWNlLnZhbGlkYXRlQ29uZmlnKCk7XG4gICAgICBleHBlY3QoaXNWYWxpZCkudG9CZSh0cnVlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmVqZWN0IGludmFsaWQgUG9zdGdyZVNRTCBjb25maWcnLCAoKSA9PiB7XG4gICAgICAvLyBNb2NrIGNvbmZpZ1NlcnZpY2UgdG8gcmV0dXJuIGludmFsaWQgdmFsdWVzXG4gICAgICBqZXN0LnNweU9uKGNvbmZpZ1NlcnZpY2UsICdnZXQnKS5tb2NrSW1wbGVtZW50YXRpb24oKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICAgICAgUE9TVEdSRVNfSE9TVDogJycsIC8vIOaXoOaViOeahOS4u+aculxuICAgICAgICAgIFBPU1RHUkVTX0RCOiAndGVzdF9kYicsXG4gICAgICAgICAgUE9TVEdSRVNfVVNFUjogJ3Rlc3RfdXNlcicsXG4gICAgICAgICAgTU9OR09EQl9VUkk6ICdtb25nb2RiOi8vbG9jYWxob3N0OjI3MDE3L3Rlc3RfZGInLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY29uZmlnc1trZXldO1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGlzVmFsaWQgPSBzZXJ2aWNlLnZhbGlkYXRlQ29uZmlnKCk7XG4gICAgICBleHBlY3QoaXNWYWxpZCkudG9CZShmYWxzZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJlamVjdCBpbnZhbGlkIE1vbmdvREIgY29uZmlnJywgKCkgPT4ge1xuICAgICAgLy8gTW9jayBjb25maWdTZXJ2aWNlIHRvIHJldHVybiBpbnZhbGlkIHZhbHVlc1xuICAgICAgamVzdC5zcHlPbihjb25maWdTZXJ2aWNlLCAnZ2V0JykubW9ja0ltcGxlbWVudGF0aW9uKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICBjb25zdCBjb25maWdzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgICAgICAgIFBPU1RHUkVTX0hPU1Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgIFBPU1RHUkVTX0RCOiAndGVzdF9kYicsXG4gICAgICAgICAgUE9TVEdSRVNfVVNFUjogJ3Rlc3RfdXNlcicsXG4gICAgICAgICAgTU9OR09EQl9VUkk6ICcnLCAvLyDml6DmlYjnmoRVUklcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGNvbmZpZ3Nba2V5XTtcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCBpc1ZhbGlkID0gc2VydmljZS52YWxpZGF0ZUNvbmZpZygpO1xuICAgICAgZXhwZWN0KGlzVmFsaWQpLnRvQmUoZmFsc2UpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9