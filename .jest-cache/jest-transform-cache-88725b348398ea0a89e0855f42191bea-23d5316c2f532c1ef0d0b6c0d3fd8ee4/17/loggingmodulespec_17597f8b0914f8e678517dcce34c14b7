e7604667294807282e2ab1ffe39de01b
"use strict";
/**
 * @file logging.module.spec.ts
 * @description 日志模块单元测试
 *
 * 测试Pino日志服务的核心功能，包括：
 * - 日志级别控制
 * - 结构化日志输出
 * - 上下文管理
 * - 性能监控
 * - 错误处理
 */
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const event_emitter_1 = require("@nestjs/event-emitter");
const nestjs_cls_1 = require("nestjs-cls");
const pino_logger_service_1 = require("./services/pino-logger.service");
const pino_logger_config_service_1 = require("./services/pino-logger-config.service");
const pino_logger_factory_1 = require("./factories/pino-logger.factory");
const pino_logging_middleware_1 = require("./middleware/pino-logging.middleware");
const pino_logging_interceptor_1 = require("./interceptors/pino-logging.interceptor");
const logging_interface_1 = require("./interfaces/logging.interface");
describe('LoggingModule', () => {
    let module;
    let loggerService;
    let configService;
    let loggerFactory;
    beforeAll(async () => {
        module = await testing_1.Test.createTestingModule({
            imports: [
                event_emitter_1.EventEmitterModule.forRoot(),
                nestjs_cls_1.ClsModule.forRoot({
                    global: true,
                    middleware: {
                        mount: true,
                        setup: (cls, _req) => {
                            cls.set('requestId', 'test-request-id');
                            cls.set('tenantId', 'test-tenant-id');
                            cls.set('userId', 'test-user-id');
                        },
                    },
                }),
            ],
            providers: [
                {
                    provide: pino_logger_config_service_1.PinoLoggerConfigService,
                    useFactory: () => {
                        return new pino_logger_config_service_1.PinoLoggerConfigService();
                    },
                },
                {
                    provide: pino_logger_factory_1.PinoLoggerFactory,
                    useFactory: (configService) => {
                        return new pino_logger_factory_1.PinoLoggerFactory(configService);
                    },
                    inject: [pino_logger_config_service_1.PinoLoggerConfigService],
                },
                {
                    provide: pino_logger_service_1.PinoLoggerService,
                    useFactory: (eventEmitter, configService, loggerFactory, cls) => {
                        return new pino_logger_service_1.PinoLoggerService(eventEmitter, configService, loggerFactory, cls);
                    },
                    inject: ['EventEmitter2', pino_logger_config_service_1.PinoLoggerConfigService, pino_logger_factory_1.PinoLoggerFactory, 'ClsService'],
                },
                {
                    provide: pino_logging_middleware_1.PinoLoggingMiddleware,
                    useFactory: (logger) => {
                        return new pino_logging_middleware_1.PinoLoggingMiddleware(logger);
                    },
                    inject: [pino_logger_service_1.PinoLoggerService],
                },
                {
                    provide: pino_logging_interceptor_1.PinoLoggingInterceptor,
                    useFactory: (logger) => {
                        return new pino_logging_interceptor_1.PinoLoggingInterceptor(logger);
                    },
                    inject: [pino_logger_service_1.PinoLoggerService],
                },
            ],
        }).compile();
        loggerService = module.get(pino_logger_service_1.PinoLoggerService);
        configService = module.get(pino_logger_config_service_1.PinoLoggerConfigService);
        loggerFactory = module.get(pino_logger_factory_1.PinoLoggerFactory);
    });
    afterAll(async () => {
        if (module) {
            await module.close();
        }
    });
    describe('Module Initialization', () => {
        it('should be defined', () => {
            expect(module).toBeDefined();
        });
        it('should have PinoLoggerService', () => {
            expect(loggerService).toBeDefined();
        });
        it('should have PinoLoggerConfigService', () => {
            expect(configService).toBeDefined();
        });
        it('should have PinoLoggerFactory', () => {
            expect(loggerFactory).toBeDefined();
        });
    });
    describe('PinoLoggerService', () => {
        it('should log different levels', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            loggerService.debug('Debug message', logging_interface_1.LogContext.SYSTEM);
            loggerService.info('Info message', logging_interface_1.LogContext.BUSINESS);
            loggerService.warn('Warning message', logging_interface_1.LogContext.AUTH);
            loggerService.error('Error message', logging_interface_1.LogContext.SYSTEM);
            expect(spy).toHaveBeenCalledTimes(4);
            expect(spy).toHaveBeenCalledWith('debug', 'Debug message', logging_interface_1.LogContext.SYSTEM, undefined, undefined);
            expect(spy).toHaveBeenCalledWith('info', 'Info message', logging_interface_1.LogContext.BUSINESS, undefined, undefined);
            expect(spy).toHaveBeenCalledWith('warn', 'Warning message', logging_interface_1.LogContext.AUTH, undefined, undefined);
            expect(spy).toHaveBeenCalledWith('error', 'Error message', logging_interface_1.LogContext.SYSTEM, undefined, undefined);
            spy.mockRestore();
        });
        it('should log with metadata', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            const metadata = {
                requestId: 'test-request-id',
                tenantId: 'test-tenant-id',
                userId: 'test-user-id',
                operation: 'test-operation',
            };
            loggerService.info('Test message', logging_interface_1.LogContext.BUSINESS, metadata);
            expect(spy).toHaveBeenCalledWith('info', 'Test message', logging_interface_1.LogContext.BUSINESS, metadata, undefined);
            spy.mockRestore();
        });
        it('should log errors with stack trace', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            const error = new Error('Test error');
            loggerService.error('Error occurred', logging_interface_1.LogContext.SYSTEM, undefined, error);
            expect(spy).toHaveBeenCalledWith('error', 'Error occurred', logging_interface_1.LogContext.SYSTEM, undefined, error);
            spy.mockRestore();
        });
        it('should log performance metrics', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            loggerService.performance('test-operation', 150, logging_interface_1.LogContext.PERFORMANCE);
            expect(spy).toHaveBeenCalledWith('info', 'Performance: test-operation took 150ms', logging_interface_1.LogContext.PERFORMANCE, {
                operation: 'test-operation',
                duration: 150,
                type: 'performance',
            });
            spy.mockRestore();
        });
        it('should create child logger', () => {
            const childLogger = loggerService.child(logging_interface_1.LogContext.BUSINESS, {
                tenantId: 'child-tenant',
            });
            expect(childLogger).toBeDefined();
            expect(childLogger).toHaveProperty('info');
            expect(childLogger).toHaveProperty('error');
            expect(childLogger).toHaveProperty('warn');
        });
        it('should get and set log level', () => {
            const originalLevel = loggerService.getLevel();
            loggerService.setLevel('debug');
            expect(loggerService.getLevel()).toBe('debug');
            loggerService.setLevel(originalLevel);
            expect(loggerService.getLevel()).toBe(originalLevel);
        });
        it('should get stats', () => {
            const stats = loggerService.getStats();
            expect(stats).toHaveProperty('totalLogs');
            expect(stats).toHaveProperty('logsByLevel');
            expect(stats).toHaveProperty('logsByContext');
            expect(stats).toHaveProperty('averageLogSize');
        });
    });
    describe('PinoLoggerConfigService', () => {
        it('should get default config', () => {
            const config = configService.getConfig();
            expect(config).toBeDefined();
            expect(config).toHaveProperty('level');
            expect(config).toHaveProperty('format');
            expect(config).toHaveProperty('timestamp');
        });
        it('should update config', () => {
            const originalConfig = configService.getConfig();
            const newConfig = { level: 'debug' };
            configService.updateConfig(newConfig);
            expect(configService.getLevel()).toBe('debug');
            // 恢复原始配置
            configService.updateConfig(originalConfig);
        });
        it('should detect environment', () => {
            const isDev = configService.isDevelopment();
            const isProd = configService.isProduction();
            expect(typeof isDev).toBe('boolean');
            expect(typeof isProd).toBe('boolean');
        });
    });
    describe('PinoLoggerFactory', () => {
        it('should create logger', () => {
            const logger = loggerFactory.createLogger();
            expect(logger).toBeDefined();
            expect(logger).toHaveProperty('info');
            expect(logger).toHaveProperty('error');
            expect(logger).toHaveProperty('warn');
        });
        it('should create child logger', () => {
            const parentLogger = loggerFactory.createLogger();
            const childLogger = loggerFactory.createChildLogger(parentLogger, {
                context: 'test',
            });
            expect(childLogger).toBeDefined();
            expect(childLogger).toHaveProperty('info');
            expect(childLogger).toHaveProperty('error');
        });
    });
    describe('Logging Middleware and Interceptor', () => {
        it('should have middleware defined', () => {
            const middleware = module.get(pino_logging_middleware_1.PinoLoggingMiddleware);
            expect(middleware).toBeDefined();
            expect(middleware).toHaveProperty('use');
        });
        it('should have interceptor defined', () => {
            const interceptor = module.get(pino_logging_interceptor_1.PinoLoggingInterceptor);
            expect(interceptor).toBeDefined();
            expect(interceptor).toHaveProperty('intercept');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvbG9nZ2luZy9zcmMvbG9nZ2luZy5tb2R1bGUuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7R0FVRzs7QUFFSCw2Q0FBc0Q7QUFDdEQseURBQTJEO0FBQzNELDJDQUF1QztBQUN2Qyx3RUFBbUU7QUFDbkUsc0ZBQWdGO0FBQ2hGLHlFQUFvRTtBQUNwRSxrRkFBNkU7QUFDN0Usc0ZBQWlGO0FBQ2pGLHNFQUFzRTtBQUV0RSxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUM3QixJQUFJLE1BQXFCLENBQUM7SUFDMUIsSUFBSSxhQUFnQyxDQUFDO0lBQ3JDLElBQUksYUFBc0MsQ0FBQztJQUMzQyxJQUFJLGFBQWdDLENBQUM7SUFFckMsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLE1BQU0sR0FBRyxNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUN0QyxPQUFPLEVBQUU7Z0JBQ1Asa0NBQWtCLENBQUMsT0FBTyxFQUFFO2dCQUM1QixzQkFBUyxDQUFDLE9BQU8sQ0FBQztvQkFDaEIsTUFBTSxFQUFFLElBQUk7b0JBQ1osVUFBVSxFQUFFO3dCQUNWLEtBQUssRUFBRSxJQUFJO3dCQUNYLEtBQUssRUFBRSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTs0QkFDbkIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsaUJBQWlCLENBQUMsQ0FBQzs0QkFDeEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzs0QkFDdEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7d0JBQ3BDLENBQUM7cUJBQ0Y7aUJBQ0YsQ0FBQzthQUNIO1lBQ0QsU0FBUyxFQUFFO2dCQUNUO29CQUNFLE9BQU8sRUFBRSxvREFBdUI7b0JBQ2hDLFVBQVUsRUFBRSxHQUFHLEVBQUU7d0JBQ2YsT0FB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Q0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2FybGlnbGUvVjEvQWlvZml4L2Fpb2ZpeC1haS1zYWFzLXBsYXRmb3JtL3BhY2thZ2VzL2xvZ2dpbmcvc3JjL2xvZ2dpbmcubW9kdWxlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBsb2dnaW5nLm1vZHVsZS5zcGVjLnRzXG4gKiBAZGVzY3JpcHRpb24g5pel5b+X5qih5Z2X5Y2V5YWD5rWL6K+VXG4gKlxuICog5rWL6K+VUGlub+aXpeW/l+acjeWKoeeahOaguOW/g+WKn+iDve+8jOWMheaLrO+8mlxuICogLSDml6Xlv5fnuqfliKvmjqfliLZcbiAqIC0g57uT5p6E5YyW5pel5b+X6L6T5Ye6XG4gKiAtIOS4iuS4i+aWh+euoeeQhlxuICogLSDmgKfog73nm5HmjqdcbiAqIC0g6ZSZ6K+v5aSE55CGXG4gKi9cblxuaW1wb3J0IHsgVGVzdCwgVGVzdGluZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXJNb2R1bGUgfSBmcm9tICdAbmVzdGpzL2V2ZW50LWVtaXR0ZXInO1xuaW1wb3J0IHsgQ2xzTW9kdWxlIH0gZnJvbSAnbmVzdGpzLWNscyc7XG5pbXBvcnQgeyBQaW5vTG9nZ2VyU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvcGluby1sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvcGluby1sb2dnZXItY29uZmlnLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGlub0xvZ2dlckZhY3RvcnkgfSBmcm9tICcuL2ZhY3Rvcmllcy9waW5vLWxvZ2dlci5mYWN0b3J5JztcbmltcG9ydCB7IFBpbm9Mb2dnaW5nTWlkZGxld2FyZSB9IGZyb20gJy4vbWlkZGxld2FyZS9waW5vLWxvZ2dpbmcubWlkZGxld2FyZSc7XG5pbXBvcnQgeyBQaW5vTG9nZ2luZ0ludGVyY2VwdG9yIH0gZnJvbSAnLi9pbnRlcmNlcHRvcnMvcGluby1sb2dnaW5nLmludGVyY2VwdG9yJztcbmltcG9ydCB7IExvZ0NvbnRleHQsIExvZ0xldmVsIH0gZnJvbSAnLi9pbnRlcmZhY2VzL2xvZ2dpbmcuaW50ZXJmYWNlJztcblxuZGVzY3JpYmUoJ0xvZ2dpbmdNb2R1bGUnLCAoKSA9PiB7XG4gIGxldCBtb2R1bGU6IFRlc3RpbmdNb2R1bGU7XG4gIGxldCBsb2dnZXJTZXJ2aWNlOiBQaW5vTG9nZ2VyU2VydmljZTtcbiAgbGV0IGNvbmZpZ1NlcnZpY2U6IFBpbm9Mb2dnZXJDb25maWdTZXJ2aWNlO1xuICBsZXQgbG9nZ2VyRmFjdG9yeTogUGlub0xvZ2dlckZhY3Rvcnk7XG5cbiAgYmVmb3JlQWxsKGFzeW5jICgpID0+IHtcbiAgICBtb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgaW1wb3J0czogW1xuICAgICAgICBFdmVudEVtaXR0ZXJNb2R1bGUuZm9yUm9vdCgpLFxuICAgICAgICBDbHNNb2R1bGUuZm9yUm9vdCh7XG4gICAgICAgICAgZ2xvYmFsOiB0cnVlLFxuICAgICAgICAgIG1pZGRsZXdhcmU6IHtcbiAgICAgICAgICAgIG1vdW50OiB0cnVlLFxuICAgICAgICAgICAgc2V0dXA6IChjbHMsIF9yZXEpID0+IHtcbiAgICAgICAgICAgICAgY2xzLnNldCgncmVxdWVzdElkJywgJ3Rlc3QtcmVxdWVzdC1pZCcpO1xuICAgICAgICAgICAgICBjbHMuc2V0KCd0ZW5hbnRJZCcsICd0ZXN0LXRlbmFudC1pZCcpO1xuICAgICAgICAgICAgICBjbHMuc2V0KCd1c2VySWQnLCAndGVzdC11c2VyLWlkJyk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pLFxuICAgICAgXSxcbiAgICAgIHByb3ZpZGVyczogW1xuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGlub0xvZ2dlckNvbmZpZ1NlcnZpY2UsXG4gICAgICAgICAgdXNlRmFjdG9yeTogKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZSgpO1xuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQaW5vTG9nZ2VyRmFjdG9yeSxcbiAgICAgICAgICB1c2VGYWN0b3J5OiAoY29uZmlnU2VydmljZTogUGlub0xvZ2dlckNvbmZpZ1NlcnZpY2UpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUGlub0xvZ2dlckZhY3RvcnkoY29uZmlnU2VydmljZSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBpbmplY3Q6IFtQaW5vTG9nZ2VyQ29uZmlnU2VydmljZV0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQaW5vTG9nZ2VyU2VydmljZSxcbiAgICAgICAgICB1c2VGYWN0b3J5OiAoXG4gICAgICAgICAgICBldmVudEVtaXR0ZXI6IGFueSxcbiAgICAgICAgICAgIGNvbmZpZ1NlcnZpY2U6IFBpbm9Mb2dnZXJDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgbG9nZ2VyRmFjdG9yeTogUGlub0xvZ2dlckZhY3RvcnksXG4gICAgICAgICAgICBjbHM6IGFueSxcbiAgICAgICAgICApID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUGlub0xvZ2dlclNlcnZpY2UoZXZlbnRFbWl0dGVyLCBjb25maWdTZXJ2aWNlLCBsb2dnZXJGYWN0b3J5LCBjbHMpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgaW5qZWN0OiBbJ0V2ZW50RW1pdHRlcjInLCBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZSwgUGlub0xvZ2dlckZhY3RvcnksICdDbHNTZXJ2aWNlJ10sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQaW5vTG9nZ2luZ01pZGRsZXdhcmUsXG4gICAgICAgICAgdXNlRmFjdG9yeTogKGxvZ2dlcjogUGlub0xvZ2dlclNlcnZpY2UpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUGlub0xvZ2dpbmdNaWRkbGV3YXJlKGxvZ2dlcik7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBpbmplY3Q6IFtQaW5vTG9nZ2VyU2VydmljZV0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQaW5vTG9nZ2luZ0ludGVyY2VwdG9yLFxuICAgICAgICAgIHVzZUZhY3Rvcnk6IChsb2dnZXI6IFBpbm9Mb2dnZXJTZXJ2aWNlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBpbm9Mb2dnaW5nSW50ZXJjZXB0b3IobG9nZ2VyKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGluamVjdDogW1Bpbm9Mb2dnZXJTZXJ2aWNlXSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgbG9nZ2VyU2VydmljZSA9IG1vZHVsZS5nZXQ8UGlub0xvZ2dlclNlcnZpY2U+KFBpbm9Mb2dnZXJTZXJ2aWNlKTtcbiAgICBjb25maWdTZXJ2aWNlID0gbW9kdWxlLmdldDxQaW5vTG9nZ2VyQ29uZmlnU2VydmljZT4oXG4gICAgICBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZSxcbiAgICApO1xuICAgIGxvZ2dlckZhY3RvcnkgPSBtb2R1bGUuZ2V0PFBpbm9Mb2dnZXJGYWN0b3J5PihQaW5vTG9nZ2VyRmFjdG9yeSk7XG4gIH0pO1xuXG4gIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcbiAgICBpZiAobW9kdWxlKSB7XG4gICAgICBhd2FpdCBtb2R1bGUuY2xvc2UoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdNb2R1bGUgSW5pdGlhbGl6YXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KG1vZHVsZSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGF2ZSBQaW5vTG9nZ2VyU2VydmljZScsICgpID0+IHtcbiAgICAgIGV4cGVjdChsb2dnZXJTZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYXZlIFBpbm9Mb2dnZXJDb25maWdTZXJ2aWNlJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KGNvbmZpZ1NlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhdmUgUGlub0xvZ2dlckZhY3RvcnknLCAoKSA9PiB7XG4gICAgICBleHBlY3QobG9nZ2VyRmFjdG9yeSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Bpbm9Mb2dnZXJTZXJ2aWNlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbG9nIGRpZmZlcmVudCBsZXZlbHMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzcHkgPSBqZXN0XG4gICAgICAgIC5zcHlPbihsb2dnZXJTZXJ2aWNlIGFzIGFueSwgJ2xvZycpXG4gICAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gdW5kZWZpbmVkKTtcblxuICAgICAgbG9nZ2VyU2VydmljZS5kZWJ1ZygnRGVidWcgbWVzc2FnZScsIExvZ0NvbnRleHQuU1lTVEVNKTtcbiAgICAgIGxvZ2dlclNlcnZpY2UuaW5mbygnSW5mbyBtZXNzYWdlJywgTG9nQ29udGV4dC5CVVNJTkVTUyk7XG4gICAgICBsb2dnZXJTZXJ2aWNlLndhcm4oJ1dhcm5pbmcgbWVzc2FnZScsIExvZ0NvbnRleHQuQVVUSCk7XG4gICAgICBsb2dnZXJTZXJ2aWNlLmVycm9yKCdFcnJvciBtZXNzYWdlJywgTG9nQ29udGV4dC5TWVNURU0pO1xuXG4gICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkVGltZXMoNCk7XG4gICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2RlYnVnJyxcbiAgICAgICAgJ0RlYnVnIG1lc3NhZ2UnLFxuICAgICAgICBMb2dDb250ZXh0LlNZU1RFTSxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICApO1xuICAgICAgZXhwZWN0KHNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdpbmZvJyxcbiAgICAgICAgJ0luZm8gbWVzc2FnZScsXG4gICAgICAgIExvZ0NvbnRleHQuQlVTSU5FU1MsXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChzcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnd2FybicsXG4gICAgICAgICdXYXJuaW5nIG1lc3NhZ2UnLFxuICAgICAgICBMb2dDb250ZXh0LkFVVEgsXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChzcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnZXJyb3InLFxuICAgICAgICAnRXJyb3IgbWVzc2FnZScsXG4gICAgICAgIExvZ0NvbnRleHQuU1lTVEVNLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICk7XG5cbiAgICAgIHNweS5tb2NrUmVzdG9yZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsb2cgd2l0aCBtZXRhZGF0YScsICgpID0+IHtcbiAgICAgIGNvbnN0IHNweSA9IGplc3RcbiAgICAgICAgLnNweU9uKGxvZ2dlclNlcnZpY2UgYXMgYW55LCAnbG9nJylcbiAgICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB1bmRlZmluZWQpO1xuICAgICAgY29uc3QgbWV0YWRhdGEgPSB7XG4gICAgICAgIHJlcXVlc3RJZDogJ3Rlc3QtcmVxdWVzdC1pZCcsXG4gICAgICAgIHRlbmFudElkOiAndGVzdC10ZW5hbnQtaWQnLFxuICAgICAgICB1c2VySWQ6ICd0ZXN0LXVzZXItaWQnLFxuICAgICAgICBvcGVyYXRpb246ICd0ZXN0LW9wZXJhdGlvbicsXG4gICAgICB9O1xuXG4gICAgICBsb2dnZXJTZXJ2aWNlLmluZm8oJ1Rlc3QgbWVzc2FnZScsIExvZ0NvbnRleHQuQlVTSU5FU1MsIG1ldGFkYXRhKTtcblxuICAgICAgZXhwZWN0KHNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdpbmZvJyxcbiAgICAgICAgJ1Rlc3QgbWVzc2FnZScsXG4gICAgICAgIExvZ0NvbnRleHQuQlVTSU5FU1MsXG4gICAgICAgIG1ldGFkYXRhLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICApO1xuXG4gICAgICBzcHkubW9ja1Jlc3RvcmUoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbG9nIGVycm9ycyB3aXRoIHN0YWNrIHRyYWNlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc3B5ID0gamVzdFxuICAgICAgICAuc3B5T24obG9nZ2VyU2VydmljZSBhcyBhbnksICdsb2cnKVxuICAgICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHVuZGVmaW5lZCk7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignVGVzdCBlcnJvcicpO1xuXG4gICAgICBsb2dnZXJTZXJ2aWNlLmVycm9yKFxuICAgICAgICAnRXJyb3Igb2NjdXJyZWQnLFxuICAgICAgICBMb2dDb250ZXh0LlNZU1RFTSxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChzcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnZXJyb3InLFxuICAgICAgICAnRXJyb3Igb2NjdXJyZWQnLFxuICAgICAgICBMb2dDb250ZXh0LlNZU1RFTSxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICBlcnJvcixcbiAgICAgICk7XG5cbiAgICAgIHNweS5tb2NrUmVzdG9yZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBsb2cgcGVyZm9ybWFuY2UgbWV0cmljcycsICgpID0+IHtcbiAgICAgIGNvbnN0IHNweSA9IGplc3RcbiAgICAgICAgLnNweU9uKGxvZ2dlclNlcnZpY2UgYXMgYW55LCAnbG9nJylcbiAgICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB1bmRlZmluZWQpO1xuXG4gICAgICBsb2dnZXJTZXJ2aWNlLnBlcmZvcm1hbmNlKCd0ZXN0LW9wZXJhdGlvbicsIDE1MCwgTG9nQ29udGV4dC5QRVJGT1JNQU5DRSk7XG5cbiAgICAgIGV4cGVjdChzcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnaW5mbycsXG4gICAgICAgICdQZXJmb3JtYW5jZTogdGVzdC1vcGVyYXRpb24gdG9vayAxNTBtcycsXG4gICAgICAgIExvZ0NvbnRleHQuUEVSRk9STUFOQ0UsXG4gICAgICAgIHtcbiAgICAgICAgICBvcGVyYXRpb246ICd0ZXN0LW9wZXJhdGlvbicsXG4gICAgICAgICAgZHVyYXRpb246IDE1MCxcbiAgICAgICAgICB0eXBlOiAncGVyZm9ybWFuY2UnLFxuICAgICAgICB9LFxuICAgICAgKTtcblxuICAgICAgc3B5Lm1vY2tSZXN0b3JlKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBjaGlsZCBsb2dnZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBjaGlsZExvZ2dlciA9IGxvZ2dlclNlcnZpY2UuY2hpbGQoTG9nQ29udGV4dC5CVVNJTkVTUywge1xuICAgICAgICB0ZW5hbnRJZDogJ2NoaWxkLXRlbmFudCcsXG4gICAgICB9KTtcbiAgICAgIGV4cGVjdChjaGlsZExvZ2dlcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjaGlsZExvZ2dlcikudG9IYXZlUHJvcGVydHkoJ2luZm8nKTtcbiAgICAgIGV4cGVjdChjaGlsZExvZ2dlcikudG9IYXZlUHJvcGVydHkoJ2Vycm9yJyk7XG4gICAgICBleHBlY3QoY2hpbGRMb2dnZXIpLnRvSGF2ZVByb3BlcnR5KCd3YXJuJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdldCBhbmQgc2V0IGxvZyBsZXZlbCcsICgpID0+IHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsTGV2ZWwgPSBsb2dnZXJTZXJ2aWNlLmdldExldmVsKCk7XG5cbiAgICAgIGxvZ2dlclNlcnZpY2Uuc2V0TGV2ZWwoJ2RlYnVnJyk7XG4gICAgICBleHBlY3QobG9nZ2VyU2VydmljZS5nZXRMZXZlbCgpKS50b0JlKCdkZWJ1ZycpO1xuXG4gICAgICBsb2dnZXJTZXJ2aWNlLnNldExldmVsKG9yaWdpbmFsTGV2ZWwpO1xuICAgICAgZXhwZWN0KGxvZ2dlclNlcnZpY2UuZ2V0TGV2ZWwoKSkudG9CZShvcmlnaW5hbExldmVsKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IHN0YXRzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc3RhdHMgPSBsb2dnZXJTZXJ2aWNlLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCd0b3RhbExvZ3MnKTtcbiAgICAgIGV4cGVjdChzdGF0cykudG9IYXZlUHJvcGVydHkoJ2xvZ3NCeUxldmVsJyk7XG4gICAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCdsb2dzQnlDb250ZXh0Jyk7XG4gICAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCdhdmVyYWdlTG9nU2l6ZScpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUGlub0xvZ2dlckNvbmZpZ1NlcnZpY2UnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBnZXQgZGVmYXVsdCBjb25maWcnLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSBjb25maWdTZXJ2aWNlLmdldENvbmZpZygpO1xuICAgICAgZXhwZWN0KGNvbmZpZykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcpLnRvSGF2ZVByb3BlcnR5KCdsZXZlbCcpO1xuICAgICAgZXhwZWN0KGNvbmZpZykudG9IYXZlUHJvcGVydHkoJ2Zvcm1hdCcpO1xuICAgICAgZXhwZWN0KGNvbmZpZykudG9IYXZlUHJvcGVydHkoJ3RpbWVzdGFtcCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgY29uZmlnJywgKCkgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWxDb25maWcgPSBjb25maWdTZXJ2aWNlLmdldENvbmZpZygpO1xuICAgICAgY29uc3QgbmV3Q29uZmlnID0geyBsZXZlbDogJ2RlYnVnJyBhcyBMb2dMZXZlbCB9O1xuXG4gICAgICBjb25maWdTZXJ2aWNlLnVwZGF0ZUNvbmZpZyhuZXdDb25maWcpO1xuICAgICAgZXhwZWN0KGNvbmZpZ1NlcnZpY2UuZ2V0TGV2ZWwoKSkudG9CZSgnZGVidWcnKTtcblxuICAgICAgLy8g5oGi5aSN5Y6f5aeL6YWN572uXG4gICAgICBjb25maWdTZXJ2aWNlLnVwZGF0ZUNvbmZpZyhvcmlnaW5hbENvbmZpZyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGRldGVjdCBlbnZpcm9ubWVudCcsICgpID0+IHtcbiAgICAgIGNvbnN0IGlzRGV2ID0gY29uZmlnU2VydmljZS5pc0RldmVsb3BtZW50KCk7XG4gICAgICBjb25zdCBpc1Byb2QgPSBjb25maWdTZXJ2aWNlLmlzUHJvZHVjdGlvbigpO1xuXG4gICAgICBleHBlY3QodHlwZW9mIGlzRGV2KS50b0JlKCdib29sZWFuJyk7XG4gICAgICBleHBlY3QodHlwZW9mIGlzUHJvZCkudG9CZSgnYm9vbGVhbicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnUGlub0xvZ2dlckZhY3RvcnknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgbG9nZ2VyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbG9nZ2VyID0gbG9nZ2VyRmFjdG9yeS5jcmVhdGVMb2dnZXIoKTtcbiAgICAgIGV4cGVjdChsb2dnZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QobG9nZ2VyKS50b0hhdmVQcm9wZXJ0eSgnaW5mbycpO1xuICAgICAgZXhwZWN0KGxvZ2dlcikudG9IYXZlUHJvcGVydHkoJ2Vycm9yJyk7XG4gICAgICBleHBlY3QobG9nZ2VyKS50b0hhdmVQcm9wZXJ0eSgnd2FybicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgY2hpbGQgbG9nZ2VyJywgKCkgPT4ge1xuICAgICAgY29uc3QgcGFyZW50TG9nZ2VyID0gbG9nZ2VyRmFjdG9yeS5jcmVhdGVMb2dnZXIoKTtcbiAgICAgIGNvbnN0IGNoaWxkTG9nZ2VyID0gbG9nZ2VyRmFjdG9yeS5jcmVhdGVDaGlsZExvZ2dlcihwYXJlbnRMb2dnZXIsIHtcbiAgICAgICAgY29udGV4dDogJ3Rlc3QnLFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChjaGlsZExvZ2dlcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjaGlsZExvZ2dlcikudG9IYXZlUHJvcGVydHkoJ2luZm8nKTtcbiAgICAgIGV4cGVjdChjaGlsZExvZ2dlcikudG9IYXZlUHJvcGVydHkoJ2Vycm9yJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdMb2dnaW5nIE1pZGRsZXdhcmUgYW5kIEludGVyY2VwdG9yJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaGF2ZSBtaWRkbGV3YXJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBtaWRkbGV3YXJlID0gbW9kdWxlLmdldDxQaW5vTG9nZ2luZ01pZGRsZXdhcmU+KFxuICAgICAgICBQaW5vTG9nZ2luZ01pZGRsZXdhcmUsXG4gICAgICApO1xuICAgICAgZXhwZWN0KG1pZGRsZXdhcmUpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QobWlkZGxld2FyZSkudG9IYXZlUHJvcGVydHkoJ3VzZScpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYXZlIGludGVyY2VwdG9yIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBpbnRlcmNlcHRvciA9IG1vZHVsZS5nZXQ8UGlub0xvZ2dpbmdJbnRlcmNlcHRvcj4oXG4gICAgICAgIFBpbm9Mb2dnaW5nSW50ZXJjZXB0b3IsXG4gICAgICApO1xuICAgICAgZXhwZWN0KGludGVyY2VwdG9yKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGludGVyY2VwdG9yKS50b0hhdmVQcm9wZXJ0eSgnaW50ZXJjZXB0Jyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=