bb00206c3ab524b6ba17cd634d925451
"use strict";
/**
 * @file database.module.spec.ts
 * @description 数据库模块单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock the adapters to avoid actual database connections
jest.mock('./adapters/postgresql.adapter');
const testing_1 = require("@nestjs/testing");
const config_1 = require("@nestjs/config");
const database_module_1 = require("./database.module");
const database_config_1 = require("./config/database.config");
const redis_config_1 = require("./config/redis.config");
const isolation_config_1 = require("./config/isolation.config");
const database_adapter_factory_1 = require("./adapters/database-adapter.factory");
describe('DatabaseModule', () => {
    let module;
    beforeEach(async () => {
        module = await testing_1.Test.createTestingModule({
            imports: [
                config_1.ConfigModule.forRoot({
                    isGlobal: true,
                    envFilePath: '.env.test',
                }),
                database_module_1.DatabaseModule.register({
                    config: {
                        type: 'postgresql',
                        host: 'localhost',
                        port: 5432,
                        username: 'test_user',
                        password: 'test_password',
                        database: 'test_database',
                    },
                    postgresql: false, // 禁用PostgreSQL以避免连接测试
                    mongodb: false, // 禁用MongoDB以避免连接测试
                }),
            ],
        }).compile();
    });
    afterEach(async () => {
        if (module) {
            await module.close();
        }
    });
    describe('Module Registration', () => {
        it('should be defined', () => {
            expect(module).toBeDefined();
        });
        it('should have database config provider', () => {
            const config = module.get('DATABASE_CONFIG');
            expect(config).toBeDefined();
            expect(config.type).toBe('postgresql');
            expect(config.host).toBe('localhost');
            expect(config.port).toBe(5432);
            expect(config.username).toBe('test_user');
            expect(config.password).toBe('test_password');
            expect(config.database).toBe('test_database');
        });
        it('should have database name provider', () => {
            const name = module.get('DATABASE_NAME');
            expect(name).toBeDefined();
            expect(name).toBe('test_database');
        });
    });
    describe('Service Providers', () => {
        it('should provide DatabaseConfigService', () => {
            const service = module.get(database_config_1.DatabaseConfigService);
            expect(service).toBeDefined();
            expect(service).toBeInstanceOf(database_config_1.DatabaseConfigService);
        });
        it('should provide RedisConfigService', () => {
            const service = module.get(redis_config_1.RedisConfigService);
            expect(service).toBeDefined();
            expect(service).toBeInstanceOf(redis_config_1.RedisConfigService);
        });
        it('should provide IsolationConfigService', () => {
            const service = module.get(isolation_config_1.IsolationConfigService);
            expect(service).toBeDefined();
            expect(service).toBeInstanceOf(isolation_config_1.IsolationConfigService);
        });
        it('should provide DatabaseAdapterFactory', () => {
            const factory = module.get(database_adapter_factory_1.DatabaseAdapterFactory);
            expect(factory).toBeDefined();
            expect(factory).toBeInstanceOf(database_adapter_factory_1.DatabaseAdapterFactory);
        });
    });
    describe('Configuration Validation', () => {
        it('should validate PostgreSQL configuration', () => {
            const configService = module.get(database_config_1.DatabaseConfigService);
            const config = configService.getPostgreSQLConfig();
            expect(config).toBeDefined();
            expect(config.type).toBe('postgresql');
            expect(config.host).toBeDefined();
            expect(config.port).toBeDefined();
            expect(config.username).toBeDefined();
            expect(config.password).toBeDefined();
            expect(config.database).toBeDefined();
        });
        it('should validate MongoDB configuration', () => {
            const configService = module.get(database_config_1.DatabaseConfigService);
            const config = configService.getMongoDBConfig();
            expect(config).toBeDefined();
            expect(config.type).toBe('mongodb');
            expect(config.host).toBeDefined();
            expect(config.port).toBeDefined();
            expect(config.username).toBeDefined();
            expect(config.password).toBeDefined();
            expect(config.database).toBeDefined();
        });
        it('should validate Redis configuration', () => {
            const configService = module.get(redis_config_1.RedisConfigService);
            const cacheConfig = configService.getCacheConfig();
            const queueConfig = configService.getMessageQueueConfig();
            const sessionConfig = configService.getSessionConfig();
            expect(cacheConfig).toBeDefined();
            expect(cacheConfig.host).toBeDefined();
            expect(cacheConfig.port).toBeDefined();
            expect(queueConfig).toBeDefined();
            expect(queueConfig.host).toBeDefined();
            expect(queueConfig.port).toBeDefined();
            expect(sessionConfig).toBeDefined();
            expect(sessionConfig.host).toBeDefined();
            expect(sessionConfig.port).toBeDefined();
        });
    });
    describe('Isolation Strategy', () => {
        it('should provide isolation configuration', () => {
            const isolationService = module.get(isolation_config_1.IsolationConfigService);
            const strategy = isolationService.getStrategy();
            expect(strategy).toBeDefined();
            expect(['DATABASE_LEVEL', 'SCHEMA_LEVEL', 'TABLE_LEVEL']).toContain(strategy);
        });
        it('should provide connection configuration', () => {
            const isolationService = module.get(isolation_config_1.IsolationConfigService);
            const config = isolationService.getConnectionConfig('test-tenant');
            expect(config).toBeDefined();
            expect(config.database).toBeDefined();
        });
    });
    describe('Adapter Factory', () => {
        it('should create adapters based on isolation strategy', () => {
            const factory = module.get(database_adapter_factory_1.DatabaseAdapterFactory);
            // 测试创建适配器（不实际连接数据库）
            expect(() => factory.createAdapter('test-tenant')).not.toThrow();
            expect(() => factory.createPlatformAdapter()).not.toThrow();
            expect(() => factory.createEventsAdapter()).not.toThrow();
            expect(() => factory.createAiVectorsAdapter()).not.toThrow();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2RhdGFiYXNlLm1vZHVsZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBVUgseURBQXlEO0FBQ3pELElBQUksQ0FBQyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQVQzQyw2Q0FBc0Q7QUFDdEQsMkNBQThDO0FBQzlDLHVEQUFtRDtBQUNuRCw4REFBaUU7QUFDakUsd0RBQTJEO0FBQzNELGdFQUFtRTtBQUNuRSxrRkFBNkU7QUFLN0UsUUFBUSxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRTtJQUM5QixJQUFJLE1BQXFCLENBQUM7SUFFMUIsVUFBVSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ3BCLE1BQU0sR0FBRyxNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUN0QyxPQUFPLEVBQUU7Z0JBQ1AscUJBQVksQ0FBQyxPQUFPLENBQUM7b0JBQ25CLFFBQVEsRUFBRSxJQUFJO29CQUNkLFdBQVcsRUFBRSxXQUFXO2lCQUN6QixDQUFDO2dCQUNGLGdDQUFjLENBQUMsUUFBUSxDQUFDO29CQUN0QixNQUFNLEVBQUU7d0JBQ04sSUFBSSxFQUFFLFlBQVk7d0JBQ2xCLElBQUksRUFBRSxXQUFXO3dCQUNqQixJQUFJLEVBQUUsSUFBSTt3QkFDVixRQUFRLEVBQUUsV0FBVzt3QkFDckIsUUFBUSxFQUFFLGVBQWU7d0JBQ3pCLFFBQVEsRUFBRSxlQUFlO3FCQUMxQjtvQkFDRCxVQUFVLEVBQUUsS0FBSyxFQUFFLHNCQUFzQjtvQkFDekMsT0FBTyxFQUFFLEtBQUssRUFBRSxtQkFBbUI7aUJBQ3BDLENBQUM7YUFDSDtTQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNmLENBQUMsQ0FBQyxDQUFDO0lBRUgsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLElBQUksTUFBTSxFQUFFLENBQUM7WUFDWCxNQUFNLE1BQU0sQ0FBQyxL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RUFBRTtRQUMvQixFQUFFLENBQUMsb0RBQW9ELEVBQUUsR0FBRyxFQUFFO1lBQzVELE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQ3hCLGlEQUFzQixDQUN2QixDQUFDO1lBRUYsb0JBQW9CO1lBQ3BCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2pFLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUM1RCxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDMUQsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQy9ELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9hcmxpZ2xlL1YxL0Fpb2ZpeC9haW9maXgtYWktc2Fhcy1wbGF0Zm9ybS9wYWNrYWdlcy9kYXRhYmFzZS9zcmMvZGF0YWJhc2UubW9kdWxlLnNwZWMudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAZmlsZSBkYXRhYmFzZS5tb2R1bGUuc3BlYy50c1xuICogQGRlc2NyaXB0aW9uIOaVsOaNruW6k+aooeWdl+WNleWFg+a1i+ivlVxuICovXG5cbmltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgQ29uZmlnTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy9jb25maWcnO1xuaW1wb3J0IHsgRGF0YWJhc2VNb2R1bGUgfSBmcm9tICcuL2RhdGFiYXNlLm1vZHVsZSc7XG5pbXBvcnQgeyBEYXRhYmFzZUNvbmZpZ1NlcnZpY2UgfSBmcm9tICcuL2NvbmZpZy9kYXRhYmFzZS5jb25maWcnO1xuaW1wb3J0IHsgUmVkaXNDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi9jb25maWcvcmVkaXMuY29uZmlnJztcbmltcG9ydCB7IElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UgfSBmcm9tICcuL2NvbmZpZy9pc29sYXRpb24uY29uZmlnJztcbmltcG9ydCB7IERhdGFiYXNlQWRhcHRlckZhY3RvcnkgfSBmcm9tICcuL2FkYXB0ZXJzL2RhdGFiYXNlLWFkYXB0ZXIuZmFjdG9yeSc7XG5cbi8vIE1vY2sgdGhlIGFkYXB0ZXJzIHRvIGF2b2lkIGFjdHVhbCBkYXRhYmFzZSBjb25uZWN0aW9uc1xuamVzdC5tb2NrKCcuL2FkYXB0ZXJzL3Bvc3RncmVzcWwuYWRhcHRlcicpO1xuXG5kZXNjcmliZSgnRGF0YWJhc2VNb2R1bGUnLCAoKSA9PiB7XG4gIGxldCBtb2R1bGU6IFRlc3RpbmdNb2R1bGU7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgbW9kdWxlID0gYXdhaXQgVGVzdC5jcmVhdGVUZXN0aW5nTW9kdWxlKHtcbiAgICAgIGltcG9ydHM6IFtcbiAgICAgICAgQ29uZmlnTW9kdWxlLmZvclJvb3Qoe1xuICAgICAgICAgIGlzR2xvYmFsOiB0cnVlLFxuICAgICAgICAgIGVudkZpbGVQYXRoOiAnLmVudi50ZXN0JyxcbiAgICAgICAgfSksXG4gICAgICAgIERhdGFiYXNlTW9kdWxlLnJlZ2lzdGVyKHtcbiAgICAgICAgICBjb25maWc6IHtcbiAgICAgICAgICAgIHR5cGU6ICdwb3N0Z3Jlc3FsJyxcbiAgICAgICAgICAgIGhvc3Q6ICdsb2NhbGhvc3QnLFxuICAgICAgICAgICAgcG9ydDogNTQzMixcbiAgICAgICAgICAgIHVzZXJuYW1lOiAndGVzdF91c2VyJyxcbiAgICAgICAgICAgIHBhc3N3b3JkOiAndGVzdF9wYXNzd29yZCcsXG4gICAgICAgICAgICBkYXRhYmFzZTogJ3Rlc3RfZGF0YWJhc2UnLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcG9zdGdyZXNxbDogZmFsc2UsIC8vIOemgeeUqFBvc3RncmVTUUzku6Xpgb/lhY3ov57mjqXmtYvor5VcbiAgICAgICAgICBtb25nb2RiOiBmYWxzZSwgLy8g56aB55SoTW9uZ29EQuS7pemBv+WFjei/nuaOpea1i+ivlVxuICAgICAgICB9KSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuICB9KTtcblxuICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGlmIChtb2R1bGUpIHtcbiAgICAgIGF3YWl0IG1vZHVsZS5jbG9zZSgpO1xuICAgIH1cbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ01vZHVsZSBSZWdpc3RyYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KG1vZHVsZSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGF2ZSBkYXRhYmFzZSBjb25maWcgcHJvdmlkZXInLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSBtb2R1bGUuZ2V0KCdEQVRBQkFTRV9DT05GSUcnKTtcbiAgICAgIGV4cGVjdChjb25maWcpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnR5cGUpLnRvQmUoJ3Bvc3RncmVzcWwnKTtcbiAgICAgIGV4cGVjdChjb25maWcuaG9zdCkudG9CZSgnbG9jYWxob3N0Jyk7XG4gICAgICBleHBlY3QoY29uZmlnLnBvcnQpLnRvQmUoNTQzMik7XG4gICAgICBleHBlY3QoY29uZmlnLnVzZXJuYW1lKS50b0JlKCd0ZXN0X3VzZXInKTtcbiAgICAgIGV4cGVjdChjb25maWcucGFzc3dvcmQpLnRvQmUoJ3Rlc3RfcGFzc3dvcmQnKTtcbiAgICAgIGV4cGVjdChjb25maWcuZGF0YWJhc2UpLnRvQmUoJ3Rlc3RfZGF0YWJhc2UnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGF2ZSBkYXRhYmFzZSBuYW1lIHByb3ZpZGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IG1vZHVsZS5nZXQoJ0RBVEFCQVNFX05BTUUnKTtcbiAgICAgIGV4cGVjdChuYW1lKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KG5hbWUpLnRvQmUoJ3Rlc3RfZGF0YWJhc2UnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1NlcnZpY2UgUHJvdmlkZXJzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcHJvdmlkZSBEYXRhYmFzZUNvbmZpZ1NlcnZpY2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXJ2aWNlID0gbW9kdWxlLmdldDxEYXRhYmFzZUNvbmZpZ1NlcnZpY2U+KERhdGFiYXNlQ29uZmlnU2VydmljZSk7XG4gICAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlSW5zdGFuY2VPZihEYXRhYmFzZUNvbmZpZ1NlcnZpY2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcm92aWRlIFJlZGlzQ29uZmlnU2VydmljZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlcnZpY2UgPSBtb2R1bGUuZ2V0PFJlZGlzQ29uZmlnU2VydmljZT4oUmVkaXNDb25maWdTZXJ2aWNlKTtcbiAgICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVJbnN0YW5jZU9mKFJlZGlzQ29uZmlnU2VydmljZSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHByb3ZpZGUgSXNvbGF0aW9uQ29uZmlnU2VydmljZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHNlcnZpY2UgPSBtb2R1bGUuZ2V0PElzb2xhdGlvbkNvbmZpZ1NlcnZpY2U+KFxuICAgICAgICBJc29sYXRpb25Db25maWdTZXJ2aWNlLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVJbnN0YW5jZU9mKElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcm92aWRlIERhdGFiYXNlQWRhcHRlckZhY3RvcnknLCAoKSA9PiB7XG4gICAgICBjb25zdCBmYWN0b3J5ID0gbW9kdWxlLmdldDxEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5PihcbiAgICAgICAgRGF0YWJhc2VBZGFwdGVyRmFjdG9yeSxcbiAgICAgICk7XG4gICAgICBleHBlY3QoZmFjdG9yeSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChmYWN0b3J5KS50b0JlSW5zdGFuY2VPZihEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0NvbmZpZ3VyYXRpb24gVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIFBvc3RncmVTUUwgY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbmZpZ1NlcnZpY2UgPSBtb2R1bGUuZ2V0PERhdGFiYXNlQ29uZmlnU2VydmljZT4oXG4gICAgICAgIERhdGFiYXNlQ29uZmlnU2VydmljZSxcbiAgICAgICk7XG4gICAgICBjb25zdCBjb25maWcgPSBjb25maWdTZXJ2aWNlLmdldFBvc3RncmVTUUxDb25maWcoKTtcblxuICAgICAgZXhwZWN0KGNvbmZpZykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcudHlwZSkudG9CZSgncG9zdGdyZXNxbCcpO1xuICAgICAgZXhwZWN0KGNvbmZpZy5ob3N0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy5wb3J0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy51c2VybmFtZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcucGFzc3dvcmQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLmRhdGFiYXNlKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBNb25nb0RCIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWdTZXJ2aWNlID0gbW9kdWxlLmdldDxEYXRhYmFzZUNvbmZpZ1NlcnZpY2U+KFxuICAgICAgICBEYXRhYmFzZUNvbmZpZ1NlcnZpY2UsXG4gICAgICApO1xuICAgICAgY29uc3QgY29uZmlnID0gY29uZmlnU2VydmljZS5nZXRNb25nb0RCQ29uZmlnKCk7XG5cbiAgICAgIGV4cGVjdChjb25maWcpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnR5cGUpLnRvQmUoJ21vbmdvZGInKTtcbiAgICAgIGV4cGVjdChjb25maWcuaG9zdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcucG9ydCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcudXNlcm5hbWUpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnBhc3N3b3JkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy5kYXRhYmFzZSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgUmVkaXMgY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbmZpZ1NlcnZpY2UgPSBtb2R1bGUuZ2V0PFJlZGlzQ29uZmlnU2VydmljZT4oUmVkaXNDb25maWdTZXJ2aWNlKTtcbiAgICAgIGNvbnN0IGNhY2hlQ29uZmlnID0gY29uZmlnU2VydmljZS5nZXRDYWNoZUNvbmZpZygpO1xuICAgICAgY29uc3QgcXVldWVDb25maWcgPSBjb25maWdTZXJ2aWNlLmdldE1lc3NhZ2VRdWV1ZUNvbmZpZygpO1xuICAgICAgY29uc3Qgc2Vzc2lvbkNvbmZpZyA9IGNvbmZpZ1NlcnZpY2UuZ2V0U2Vzc2lvbkNvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY2FjaGVDb25maWcpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY2FjaGVDb25maWcuaG9zdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjYWNoZUNvbmZpZy5wb3J0KS50b0JlRGVmaW5lZCgpO1xuXG4gICAgICBleHBlY3QocXVldWVDb25maWcpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocXVldWVDb25maWcuaG9zdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChxdWV1ZUNvbmZpZy5wb3J0KS50b0JlRGVmaW5lZCgpO1xuXG4gICAgICBleHBlY3Qoc2Vzc2lvbkNvbmZpZykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChzZXNzaW9uQ29uZmlnLmhvc3QpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3Qoc2Vzc2lvbkNvbmZpZy5wb3J0KS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnSXNvbGF0aW9uIFN0cmF0ZWd5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcHJvdmlkZSBpc29sYXRpb24gY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGlzb2xhdGlvblNlcnZpY2UgPSBtb2R1bGUuZ2V0PElzb2xhdGlvbkNvbmZpZ1NlcnZpY2U+KFxuICAgICAgICBJc29sYXRpb25Db25maWdTZXJ2aWNlLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IHN0cmF0ZWd5ID0gaXNvbGF0aW9uU2VydmljZS5nZXRTdHJhdGVneSgpO1xuXG4gICAgICBleHBlY3Qoc3RyYXRlZ3kpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoWydEQVRBQkFTRV9MRVZFTCcsICdTQ0hFTUFfTEVWRUwnLCAnVEFCTEVfTEVWRUwnXSkudG9Db250YWluKFxuICAgICAgICBzdHJhdGVneSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHByb3ZpZGUgY29ubmVjdGlvbiBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3QgaXNvbGF0aW9uU2VydmljZSA9IG1vZHVsZS5nZXQ8SXNvbGF0aW9uQ29uZmlnU2VydmljZT4oXG4gICAgICAgIElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UsXG4gICAgICApO1xuICAgICAgY29uc3QgY29uZmlnID0gaXNvbGF0aW9uU2VydmljZS5nZXRDb25uZWN0aW9uQ29uZmlnKCd0ZXN0LXRlbmFudCcpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy5kYXRhYmFzZSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FkYXB0ZXIgRmFjdG9yeScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNyZWF0ZSBhZGFwdGVycyBiYXNlZCBvbiBpc29sYXRpb24gc3RyYXRlZ3knLCAoKSA9PiB7XG4gICAgICBjb25zdCBmYWN0b3J5ID0gbW9kdWxlLmdldDxEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5PihcbiAgICAgICAgRGF0YWJhc2VBZGFwdGVyRmFjdG9yeSxcbiAgICAgICk7XG5cbiAgICAgIC8vIOa1i+ivleWIm+W7uumAgumFjeWZqO+8iOS4jeWunumZhei/nuaOpeaVsOaNruW6k++8iVxuICAgICAgZXhwZWN0KCgpID0+IGZhY3RvcnkuY3JlYXRlQWRhcHRlcigndGVzdC10ZW5hbnQnKSkubm90LnRvVGhyb3coKTtcbiAgICAgIGV4cGVjdCgoKSA9PiBmYWN0b3J5LmNyZWF0ZVBsYXRmb3JtQWRhcHRlcigpKS5ub3QudG9UaHJvdygpO1xuICAgICAgZXhwZWN0KCgpID0+IGZhY3RvcnkuY3JlYXRlRXZlbnRzQWRhcHRlcigpKS5ub3QudG9UaHJvdygpO1xuICAgICAgZXhwZWN0KCgpID0+IGZhY3RvcnkuY3JlYXRlQWlWZWN0b3JzQWRhcHRlcigpKS5ub3QudG9UaHJvdygpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9