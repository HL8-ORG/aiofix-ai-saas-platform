4d0eb1374aec37e5cc4a52608a6a9a99
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const pino_logging_middleware_1 = require("./pino-logging.middleware");
const pino_logger_service_1 = require("../services/pino-logger.service");
const logging_interface_1 = require("../interfaces/logging.interface");
describe('PinoLoggingMiddleware', () => {
    let middleware;
    let logger;
    let mockRequest;
    let mockResponse;
    let nextFunction;
    beforeEach(async () => {
        const module = await testing_1.Test.createTestingModule({
            providers: [
                pino_logging_middleware_1.PinoLoggingMiddleware,
                {
                    provide: pino_logger_service_1.PinoLoggerService,
                    useValue: {
                        info: jest.fn(),
                        warn: jest.fn(),
                        error: jest.fn(),
                        performance: jest.fn(),
                    },
                },
            ],
        }).compile();
        middleware = module.get(pino_logging_middleware_1.PinoLoggingMiddleware);
        logger = module.get(pino_logger_service_1.PinoLoggerService);
        // 重置模拟
        jest.clearAllMocks();
    });
    beforeEach(() => {
        // 设置模拟请求
        mockRequest = {
            method: 'GET',
            url: '/api/users',
            headers: {
                'user-agent': 'Mozilla/5.0',
                'x-tenant-id': 'tenant-123',
                'x-user-id': 'user-456',
                authorization: 'Bearer token123',
            },
            query: { page: '1', limit: '10' },
            body: { name: 'test' },
            ip: '192.168.1.1',
            socket: { remoteAddress: '192.168.1.1' },
        };
        // 设置模拟响应
        mockResponse = {
            statusCode: 200,
            send: jest.fn().mockReturnThis(),
        };
        nextFunction = jest.fn();
    });
    it('should be defined', () => {
        expect(middleware).toBeDefined();
    });
    describe('request logging', () => {
        it('should log request information', () => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith('HTTP Request', logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                method: 'GET',
                url: '/api/users',
                userAgent: 'Mozilla/5.0',
                tenantId: 'tenant-123',
                userId: 'user-456',
                ip: '192.168.1.1',
                requestId: expect.unknown(String),
                headers: expect.objectContaining({
                    authorization: '***REDACTED***',
                    'user-agent': 'Mozilla/5.0',
                }),
                query: { page: '1', limit: '10' },
                body: { name: 'test' },
            }));
            expect(nextFunction).toHaveBeenCalled();
        });
        it('should generate unique request ID', () => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                requestId: expect.unknown(String),
            }));
        });
        it('should extract tenant ID from different sources', () => {
            // 测试从查询参数提取
            mockRequest.query = { tenantId: 'query-tenant' };
            mockRequest.headers = { 'user-agent': 'Mozilla/5.0' };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                tenantId: 'query-tenant',
            }));
        });
        it('should extract user ID from different sources', () => {
            // 测试从请求体提取
            mockRequest.body = { userId: 'body-user' };
            mockRequest.headers = { 'user-agent': 'Mozilla/5.0' };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                userId: 'body-user',
            }));
        });
    });
    describe('response logging', () => {
        it('should log successful response', done => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            // 模拟响应发送 - 直接调用重写后的send方法
            mockResponse.send?.('response data');
            // 等待异步日志记录
            setTimeout(() => {
                expect(logger.info).toHaveBeenCalledWith('HTTP Response', logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                    duration: expect.unknown(Number),
                    statusCode: 200,
                }));
                done();
            }, 10);
        });
        it('should log error response as warning', done => {
            mockResponse.statusCode = 404;
            middleware.use(mockRequest, mockResponse, nextFunction);
            // 模拟响应发送
            mockResponse.send?.('error response');
            // 等待异步日志记录
            setTimeout(() => {
                expect(logger.warn).toHaveBeenCalledWith('HTTP Response', logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                    statusCode: 404,
                }));
                done();
            }, 10);
        });
        it('should capture response size', done => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            // 模拟响应发送
            mockResponse.send?.('response data');
            // 等待异步日志记录
            setTimeout(() => {
                expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                    duration: expect.unknown(Number),
                }));
                done();
            }, 10);
        });
    });
    describe('security features', () => {
        it('should sanitize sensitive headers', () => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                headers: expect.objectContaining({
                    authorization: '***REDACTED***',
                    'user-agent': 'Mozilla/5.0',
                }),
            }));
        });
        it('should sanitize sensitive body fields', () => {
            mockRequest.body = {
                username: 'testuser',
                password: 'secret123',
                token: 'jwt-token',
                email: 'test@example.com',
            };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                body: expect.objectContaining({
                    username: 'testuser',
                    password: '***REDACTED***',
                    token: '***REDACTED***',
                    email: 'test@example.com',
                }),
            }));
        });
    });
    describe('client IP detection', () => {
        it('should detect IP from X-Forwarded-For header', () => {
            mockRequest = {
                ...mockRequest,
                headers: {
                    'x-forwarded-for': '192.168.1.100',
                    'user-agent': 'Mozilla/5.0',
                },
                ip: undefined,
            };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                ip: '192.168.1.100',
                tenantId: undefined,
                userId: undefined,
            }));
        });
        it('should fallback to connection remote address', () => {
            mockRequest = {
                ...mockRequest,
                headers: { 'user-agent': 'Mozilla/5.0' },
                ip: undefined,
                socket: { remoteAddress: '192.168.1.200' },
            };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                ip: '192.168.1.200',
            }));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvbG9nZ2luZy9zcmMvbWlkZGxld2FyZS9waW5vLWxvZ2dpbmcubWlkZGxld2FyZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBRXRELHVFQUFrRTtBQUNsRSx5RUFBb0U7QUFDcEUsdUVBQTZEO0FBRTdELFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDckMsSUFBSSxVQUFpQyxDQUFDO0lBQ3RDLElBQUksTUFBeUIsQ0FBQztJQUM5QixJQUFJLFdBQW9DLENBQUM7SUFDekMsSUFBSSxZQUFtQyxDQUFDO0lBQ3hDLElBQUksWUFBdUIsQ0FBQztJQUU1QixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBQzNELFNBQVMsRUFBRTtnQkFDVCwrQ0FBcUI7Z0JBQ3JCO29CQUNFLE9BQU8sRUFBRSx1Q0FBaUI7b0JBQzFCLFFBQVEsRUFBRTt3QkFDUixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTt3QkFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTt3QkFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTt3QkFDaEIsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7cUJBQ3ZCO2lCQUNGO2FBQ0Y7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFFYixVQUFVLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBd0IsK0NBQXFCLENBQUMsQ0FBQztRQUN0RSxNQUFNLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBb0IsdUNBQWlCLENBQUMsQ0FBQztRQUUxRCxPQUFPO1FBQ1AsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLFNBQVM7UUFDVCxXQUFXLEdBQUc7WUFDWixNQUFNLEVBQUUsS0FBSztZQUNiLEdBQUcsRUFBRSxZQUFZO1lBQ2pCLE9BQU8sRUFBRTtnQkFDUCxZQUFZLEVBQUUsYUFBYTtnQkFDM0IsYUFBYSxFQUFFLFlBQVk7Z0JBQzNCLFdBQVcsRUFBRSxVQUFVO2dCQUN2QixhQUFhLEVBQUUsaUJBQWlCO2FBQ2pDO1lBQ0QsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO1lBQ2pDLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7WUFDdEIsRUFBRSxFQUFFLGFBQWE7WUFDakIsTUFBTSxFQUFFLEVBQUUsYUFBYSxFQUFFLGFBQWEsRUFBYTtTQUN6QixDQUFDO1FBRTdCLFNBQVM7UUFDVCxZQUFZLEdBQUc7WUFDYixVQUFVLEVBQUUsR0FBRztZQUNmLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsY0FBYyxFQUFFO1NBQ1IsQ0FBQztRQUUzQixZQUFZLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0lBQzNCLENBQUMsQ0FBQyxDQUFDO0lBRUgsRUFBRSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtRQUMzQixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbkMsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO1FBQy9CLEVBQUUsQ0FBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7WUFDeEMsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQ3RDLGNBQWMsRUFDZCw4QkFBVSxDQUFDLFlBQVksRUFDdkIsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixNQUFNLEVBQUUsS0FBSztnQkFDYixHQUFHLEVBQUUsWUFBWTtnQkFDakIsU0FBUyxFQUFFLGFBQWE7Z0JBQ3hCLFFBQVEsRUFBRSxZQUFZO2dCQUN0QixNQUFNLEVBQUUsVUFBVTtnQkFDbEIsRUFBRSxFQUFFLGFBQWE7Z0JBQ2pCLFNBQVMsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztnQkFDakMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDL0IsYUFBYSxFQUFFLGdCQUFnQjtvQkFDL0IsWUFBWSxFQUFFLGFBQWE7aUJBQzVCLENBQUM7Z0JBQ0YsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO2dCQUNqQyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFO2FBQ3ZCLENBQUMsQ0FDSCxDQUFDO1lBRUYsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDMUMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsbUNBQW1DLEVBQUUsR0FBRyxFQUFFO1lBQzNDLFVBQVUsQ0FBQyxHQUFHLENBQ1osV0FBNkIsRUFDN0IsWUFBNEIsRUFDNUIsWUFBWSxDQUNiLENBQUM7WUFFRixNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUN0QyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUN0Qiw4QkFBVSxDQUFDLFlBQVksRUFDdkIsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUN0QixTQUFTLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7YUFDbEMsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxpREFBaUQsRUFBRSxHQUFHLEVBQUU7WUFDekQsWUFBWTtZQUNaLFdBQVcsQ0FBQyxLQUFLLEdBQUcsRUFBRSxRQUFRLEVBQUUsY0FBYyxFQUFFLENBQUM7WUFDakQsV0FBVyxDQUFDLE9BQU8sR0FBRyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsQ0FBQztZQUV0RCxVQUFVLENBQUMsR0FBRyxDQUNaLFdBQTZCLEVBQzdCLFlBQTRCLEVBQzVCLFlBQVksQ0FDYixDQUFDO1lBRUYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsOEJBQVUsQ0FBQyxZQUFZLEVBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsUUFBUSxFQUFFLGNBQWM7YUFDekIsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQywrQ0FBK0MsRUFBRSxHQUFHLEVBQUU7WUFDdkQsV0FBVztZQUNYLFdBQVcsQ0FBQyxJQUFJLEdBQUcsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUM7WUFDM0MsV0FBVyxDQUFDLE9BQU8sR0FBRyxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUUsQ0FBQztZQUV0RCxVQUFVLENBQUMsR0FBRyxDQUNaLFdBQTZCLEVBQzdCLFlBQTRCLEVBQzVCLFlBQVksQ0FDYixDQUFDO1lBRUYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsOEJBQVUsQ0FBQyxZQUFZLEVBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsTUFBTSxFQUFFLFdBQVc7YUFDcEIsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtRQUNoQyxFQUFFLENBQUMsZ0NBQWdDLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDMUMsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLDBCQUEwQjtZQUMxQixZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsZUFBZSxDQUFDLENBQUM7WUFFckMsV0FBVztZQUNYLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FDdEMsZUFBZSxFQUNmLDhCQUFVLENBQUMsWUFBWSxFQUN2QixNQUFNLENBQUMsZ0JBQWdCLENBQUM7b0JBQ3RCLFFBQVEsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztvQkFDaEMsVUFBVSxFQUFFLEdBQUc7aUJBQ2hCLENBQUMsQ0FDSCxDQUFDO2dCQUNGLElBQUksRUFBRSxDQUFDO1lBQ1QsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ1QsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsc0NBQXNDLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDaEQsWUFBWSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7WUFFOUIsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLFNBQVM7WUFDVCxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztZQUV0QyxXQUFXO1lBQ1gsVUFBVSxDQUFDLEdBQUcsRUFBRTtnQkFDZCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLG9CQUFvQixDQUN0QyxlQUFlLEVBQ2YsOEJBQVUsQ0FBQyxZQUFZLEVBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDdEIsVUFBVSxFQUFFLEdBQUc7aUJBQ2hCLENBQUMsQ0FDSCxDQUFDO2dCQUNGLElBQUksRUFBRSxDQUFDO1lBQ1QsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ1QsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOEJBQThCLEVBQUUsSUFBSSxDQUFDLEVBQUU7WUFDeEMsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLFNBQVM7WUFDVCxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUMsZUFBZSxDQUFDLENBQUM7WUFFckMsV0FBVztZQUNYLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsOEJBQVUsQ0FBQyxZQUFZLEVBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztvQkFDdEIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO2lCQUNqQyxDQUFDLENBQ0gsQ0FBQztnQkFDRixJQUFJLEVBQUUsQ0FBQztZQUNULENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUNULENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQ2pDLEVBQUUsQ0FBQyxtQ0FBbUMsRUFBRSxHQUFHLEVBQUU7WUFDM0MsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQ3RDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQ3RCLDhCQUFVLENBQUMsWUFBWSxFQUN2QixNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLE9BQU8sRUFBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7b0JBQy9CLGFBQWEsRUFBRSxnQkFBZ0I7b0JBQy9CLFlBQVksRUFBRSxhQUFhO2lCQUM1QixDQUFDO2FBQ0gsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyx1Q0FBdUMsRUFBRSxHQUFHLEVBQUU7WUFDL0MsV0FBVyxDQUFDLElBQUksR0FBRztnQkFDakIsUUFBUSxFQUFFLFVBQVU7Z0JBQ3BCLFFBQVEsRUFBRSxXQUFXO2dCQUNyQixLQUFLLEVBQUUsV0FBVztnQkFDbEIsS0FBSyxFQUFFLGtCQUFrQjthQUMxQixDQUFDO1lBRUYsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQ3RDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQ3RCLDhCQUFVLENBQUMsWUFBWSxFQUN2QixNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLElBQUksRUFBRSxNQUFNLENBQUMsZ0JBQWdCLENBQUM7b0JBQzVCLFFBQVEsRUFBRSxVQUFVO29CQUNwQixRQUFRLEVBQUUsZ0JBQWdCO29CQUMxQixLQUFLLEVBQUUsZ0JBQWdCO29CQUN2QixLQUFLLEVBQUUsa0JBQWtCO2lCQUMxQixDQUFDO2FBQ0gsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHFCQUFxQixFQUFFLEdBQUcsRUFBRTtRQUNuQyxFQUFFLENBQUMsOENBQThDLEVBQUUsR0FBRyxFQUFFO1lBQ3RELFdBQVcsR0FBRztnQkFDWixHQUFHLFdBQVc7Z0JBQ2QsT0FBTyxFQUFFO29CQUNQLGlCQUFpQixFQUFFLGVBQWU7b0JBQ2xDLFlBQVksRUFBRSxhQUFhO2lCQUM1QjtnQkFDRCxFQUFFLEVBQUUsU0FBUzthQUNhLENBQUM7WUFFN0IsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQ3RDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQ3RCLDhCQUFVLENBQUMsWUFBWSxFQUN2QixNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLEVBQUUsRUFBRSxlQUFlO2dCQUNuQixRQUFRLEVBQUUsU0FBUztnQkFDbkIsTUFBTSxFQUFFLFNBQVM7YUFDbEIsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyw4Q0FBOEMsRUFBRSxHQUFHLEVBQUU7WUFDdEQsV0FBVyxHQUFHO2dCQUNaLEdBQUcsV0FBVztnQkFDZCxPQUFPLEVBQUUsRUFBRSxZQUFZLEVBQUUsYUFBYSxFQUFFO2dCQUN4QyxFQUFFLEVBQUUsU0FBUztnQkFDYixNQUFNLEVBQUUsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFhO2FBQzNCLENBQUM7WUFFN0IsVUFBVSxDQUFDLEdBQUcsQ0FDWixXQUE2QixFQUM3QixZQUE0QixFQUM1QixZQUFZLENBQ2IsQ0FBQztZQUVGLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQ3RDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQ3RCLDhCQUFVLENBQUMsWUFBWSxFQUN2QixNQUFNLENBQUMsZ0JBQWdCLENBQUM7Z0JBQ3RCLEVBQUUsRUFBRSxlQUFlO2FBQ3BCLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL2FybGlnbGUvVjEvQWlvZml4L2Fpb2ZpeC1haS1zYWFzLXBsYXRmb3JtL3BhY2thZ2VzL2xvZ2dpbmcvc3JjL21pZGRsZXdhcmUvcGluby1sb2dnaW5nLm1pZGRsZXdhcmUuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IEZhc3RpZnlSZXF1ZXN0LCBGYXN0aWZ5UmVwbHkgfSBmcm9tICdmYXN0aWZ5JztcbmltcG9ydCB7IFBpbm9Mb2dnaW5nTWlkZGxld2FyZSB9IGZyb20gJy4vcGluby1sb2dnaW5nLm1pZGRsZXdhcmUnO1xuaW1wb3J0IHsgUGlub0xvZ2dlclNlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9waW5vLWxvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IExvZ0NvbnRleHQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2xvZ2dpbmcuaW50ZXJmYWNlJztcblxuZGVzY3JpYmUoJ1Bpbm9Mb2dnaW5nTWlkZGxld2FyZScsICgpID0+IHtcbiAgbGV0IG1pZGRsZXdhcmU6IFBpbm9Mb2dnaW5nTWlkZGxld2FyZTtcbiAgbGV0IGxvZ2dlcjogUGlub0xvZ2dlclNlcnZpY2U7XG4gIGxldCBtb2NrUmVxdWVzdDogUGFydGlhbDxGYXN0aWZ5UmVxdWVzdD47XG4gIGxldCBtb2NrUmVzcG9uc2U6IFBhcnRpYWw8RmFzdGlmeVJlcGx5PjtcbiAgbGV0IG5leHRGdW5jdGlvbjogamVzdC5Nb2NrO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBwcm92aWRlcnM6IFtcbiAgICAgICAgUGlub0xvZ2dpbmdNaWRkbGV3YXJlLFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGlub0xvZ2dlclNlcnZpY2UsXG4gICAgICAgICAgdXNlVmFsdWU6IHtcbiAgICAgICAgICAgIGluZm86IGplc3QuZm4oKSxcbiAgICAgICAgICAgIHdhcm46IGplc3QuZm4oKSxcbiAgICAgICAgICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgICAgICAgICBwZXJmb3JtYW5jZTogamVzdC5mbigpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIG1pZGRsZXdhcmUgPSBtb2R1bGUuZ2V0PFBpbm9Mb2dnaW5nTWlkZGxld2FyZT4oUGlub0xvZ2dpbmdNaWRkbGV3YXJlKTtcbiAgICBsb2dnZXIgPSBtb2R1bGUuZ2V0PFBpbm9Mb2dnZXJTZXJ2aWNlPihQaW5vTG9nZ2VyU2VydmljZSk7XG5cbiAgICAvLyDph43nva7mqKHmi59cbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgLy8g6K6+572u5qih5ouf6K+35rGCXG4gICAgbW9ja1JlcXVlc3QgPSB7XG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgdXJsOiAnL2FwaS91c2VycycsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICd1c2VyLWFnZW50JzogJ01vemlsbGEvNS4wJyxcbiAgICAgICAgJ3gtdGVuYW50LWlkJzogJ3RlbmFudC0xMjMnLFxuICAgICAgICAneC11c2VyLWlkJzogJ3VzZXItNDU2JyxcbiAgICAgICAgYXV0aG9yaXphdGlvbjogJ0JlYXJlciB0b2tlbjEyMycsXG4gICAgICB9LFxuICAgICAgcXVlcnk6IHsgcGFnZTogJzEnLCBsaW1pdDogJzEwJyB9LFxuICAgICAgYm9keTogeyBuYW1lOiAndGVzdCcgfSxcbiAgICAgIGlwOiAnMTkyLjE2OC4xLjEnLFxuICAgICAgc29ja2V0OiB7IHJlbW90ZUFkZHJlc3M6ICcxOTIuMTY4LjEuMScgfSBhcyB1bmtub3duLFxuICAgIH0gYXMgUGFydGlhbDxGYXN0aWZ5UmVxdWVzdD47XG5cbiAgICAvLyDorr7nva7mqKHmi5/lk43lupRcbiAgICBtb2NrUmVzcG9uc2UgPSB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBzZW5kOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICB9IGFzIFBhcnRpYWw8RmFzdGlmeVJlcGx5PjtcblxuICAgIG5leHRGdW5jdGlvbiA9IGplc3QuZm4oKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBiZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgIGV4cGVjdChtaWRkbGV3YXJlKS50b0JlRGVmaW5lZCgpO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVxdWVzdCBsb2dnaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgbG9nIHJlcXVlc3QgaW5mb3JtYXRpb24nLCAoKSA9PiB7XG4gICAgICBtaWRkbGV3YXJlLnVzZShcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgRmFzdGlmeVJlcXVlc3QsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyBGYXN0aWZ5UmVwbHksXG4gICAgICAgIG5leHRGdW5jdGlvbixcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdIVFRQIFJlcXVlc3QnLFxuICAgICAgICBMb2dDb250ZXh0LkhUVFBfUkVRVUVTVCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgdXJsOiAnL2FwaS91c2VycycsXG4gICAgICAgICAgdXNlckFnZW50OiAnTW96aWxsYS81LjAnLFxuICAgICAgICAgIHRlbmFudElkOiAndGVuYW50LTEyMycsXG4gICAgICAgICAgdXNlcklkOiAndXNlci00NTYnLFxuICAgICAgICAgIGlwOiAnMTkyLjE2OC4xLjEnLFxuICAgICAgICAgIHJlcXVlc3RJZDogZXhwZWN0LnVua25vd24oU3RyaW5nKSxcbiAgICAgICAgICBoZWFkZXJzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICBhdXRob3JpemF0aW9uOiAnKioqUkVEQUNURUQqKionLFxuICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiAnTW96aWxsYS81LjAnLFxuICAgICAgICAgIH0pLFxuICAgICAgICAgIHF1ZXJ5OiB7IHBhZ2U6ICcxJywgbGltaXQ6ICcxMCcgfSxcbiAgICAgICAgICBib2R5OiB7IG5hbWU6ICd0ZXN0JyB9LFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChuZXh0RnVuY3Rpb24pLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2VuZXJhdGUgdW5pcXVlIHJlcXVlc3QgSUQnLCAoKSA9PiB7XG4gICAgICBtaWRkbGV3YXJlLnVzZShcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgRmFzdGlmeVJlcXVlc3QsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyBGYXN0aWZ5UmVwbHksXG4gICAgICAgIG5leHRGdW5jdGlvbixcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC51bmtub3duKFN0cmluZyksXG4gICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgcmVxdWVzdElkOiBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGV4dHJhY3QgdGVuYW50IElEIGZyb20gZGlmZmVyZW50IHNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICAvLyDmtYvor5Xku47mn6Xor6Llj4LmlbDmj5Dlj5ZcbiAgICAgIG1vY2tSZXF1ZXN0LnF1ZXJ5ID0geyB0ZW5hbnRJZDogJ3F1ZXJ5LXRlbmFudCcgfTtcbiAgICAgIG1vY2tSZXF1ZXN0LmhlYWRlcnMgPSB7ICd1c2VyLWFnZW50JzogJ01vemlsbGEvNS4wJyB9O1xuXG4gICAgICBtaWRkbGV3YXJlLnVzZShcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgRmFzdGlmeVJlcXVlc3QsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyBGYXN0aWZ5UmVwbHksXG4gICAgICAgIG5leHRGdW5jdGlvbixcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC51bmtub3duKFN0cmluZyksXG4gICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdGVuYW50SWQ6ICdxdWVyeS10ZW5hbnQnLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGV4dHJhY3QgdXNlciBJRCBmcm9tIGRpZmZlcmVudCBzb3VyY2VzJywgKCkgPT4ge1xuICAgICAgLy8g5rWL6K+V5LuO6K+35rGC5L2T5o+Q5Y+WXG4gICAgICBtb2NrUmVxdWVzdC5ib2R5ID0geyB1c2VySWQ6ICdib2R5LXVzZXInIH07XG4gICAgICBtb2NrUmVxdWVzdC5oZWFkZXJzID0geyAndXNlci1hZ2VudCc6ICdNb3ppbGxhLzUuMCcgfTtcblxuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICBMb2dDb250ZXh0LkhUVFBfUkVRVUVTVCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIHVzZXJJZDogJ2JvZHktdXNlcicsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3Jlc3BvbnNlIGxvZ2dpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBsb2cgc3VjY2Vzc2Z1bCByZXNwb25zZScsIGRvbmUgPT4ge1xuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICAvLyDmqKHmi5/lk43lupTlj5HpgIEgLSDnm7TmjqXosIPnlKjph43lhpnlkI7nmoRzZW5k5pa55rOVXG4gICAgICBtb2NrUmVzcG9uc2Uuc2VuZD8uKCdyZXNwb25zZSBkYXRhJyk7XG5cbiAgICAgIC8vIOetieW+heW8guatpeaXpeW/l+iusOW9lVxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgJ0hUVFAgUmVzcG9uc2UnLFxuICAgICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgIGR1cmF0aW9uOiBleHBlY3QudW5rbm93bihOdW1iZXIpLFxuICAgICAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9LCAxMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxvZyBlcnJvciByZXNwb25zZSBhcyB3YXJuaW5nJywgZG9uZSA9PiB7XG4gICAgICBtb2NrUmVzcG9uc2Uuc3RhdHVzQ29kZSA9IDQwNDtcblxuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICAvLyDmqKHmi5/lk43lupTlj5HpgIFcbiAgICAgIG1vY2tSZXNwb25zZS5zZW5kPy4oJ2Vycm9yIHJlc3BvbnNlJyk7XG5cbiAgICAgIC8vIOetieW+heW8guatpeaXpeW/l+iusOW9lVxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChsb2dnZXIud2FybikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgJ0hUVFAgUmVzcG9uc2UnLFxuICAgICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSwgMTApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjYXB0dXJlIHJlc3BvbnNlIHNpemUnLCBkb25lID0+IHtcbiAgICAgIG1pZGRsZXdhcmUudXNlKFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBGYXN0aWZ5UmVxdWVzdCxcbiAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIEZhc3RpZnlSZXBseSxcbiAgICAgICAgbmV4dEZ1bmN0aW9uLFxuICAgICAgKTtcblxuICAgICAgLy8g5qih5ouf5ZON5bqU5Y+R6YCBXG4gICAgICBtb2NrUmVzcG9uc2Uuc2VuZD8uKCdyZXNwb25zZSBkYXRhJyk7XG5cbiAgICAgIC8vIOetieW+heW8guatpeaXpeW/l+iusOW9lVxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICAgZXhwZWN0LnVua25vd24oU3RyaW5nKSxcbiAgICAgICAgICBMb2dDb250ZXh0LkhUVFBfUkVRVUVTVCxcbiAgICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICBkdXJhdGlvbjogZXhwZWN0LnVua25vd24oTnVtYmVyKSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSwgMTApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc2VjdXJpdHkgZmVhdHVyZXMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBzYW5pdGl6ZSBzZW5zaXRpdmUgaGVhZGVycycsICgpID0+IHtcbiAgICAgIG1pZGRsZXdhcmUudXNlKFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBGYXN0aWZ5UmVxdWVzdCxcbiAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIEZhc3RpZnlSZXBseSxcbiAgICAgICAgbmV4dEZ1bmN0aW9uLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnVua25vd24oU3RyaW5nKSxcbiAgICAgICAgTG9nQ29udGV4dC5IVFRQX1JFUVVFU1QsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBoZWFkZXJzOiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICBhdXRob3JpemF0aW9uOiAnKioqUkVEQUNURUQqKionLFxuICAgICAgICAgICAgJ3VzZXItYWdlbnQnOiAnTW96aWxsYS81LjAnLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHNhbml0aXplIHNlbnNpdGl2ZSBib2R5IGZpZWxkcycsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0LmJvZHkgPSB7XG4gICAgICAgIHVzZXJuYW1lOiAndGVzdHVzZXInLFxuICAgICAgICBwYXNzd29yZDogJ3NlY3JldDEyMycsXG4gICAgICAgIHRva2VuOiAnand0LXRva2VuJyxcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgIH07XG5cbiAgICAgIG1pZGRsZXdhcmUudXNlKFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBGYXN0aWZ5UmVxdWVzdCxcbiAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIEZhc3RpZnlSZXBseSxcbiAgICAgICAgbmV4dEZ1bmN0aW9uLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnVua25vd24oU3RyaW5nKSxcbiAgICAgICAgTG9nQ29udGV4dC5IVFRQX1JFUVVFU1QsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBib2R5OiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgICB1c2VybmFtZTogJ3Rlc3R1c2VyJyxcbiAgICAgICAgICAgIHBhc3N3b3JkOiAnKioqUkVEQUNURUQqKionLFxuICAgICAgICAgICAgdG9rZW46ICcqKipSRURBQ1RFRCoqKicsXG4gICAgICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjbGllbnQgSVAgZGV0ZWN0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZGV0ZWN0IElQIGZyb20gWC1Gb3J3YXJkZWQtRm9yIGhlYWRlcicsICgpID0+IHtcbiAgICAgIG1vY2tSZXF1ZXN0ID0ge1xuICAgICAgICAuLi5tb2NrUmVxdWVzdCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICd4LWZvcndhcmRlZC1mb3InOiAnMTkyLjE2OC4xLjEwMCcsXG4gICAgICAgICAgJ3VzZXItYWdlbnQnOiAnTW96aWxsYS81LjAnLFxuICAgICAgICB9LFxuICAgICAgICBpcDogdW5kZWZpbmVkLFxuICAgICAgfSBhcyBQYXJ0aWFsPEZhc3RpZnlSZXF1ZXN0PjtcblxuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICBMb2dDb250ZXh0LkhUVFBfUkVRVUVTVCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGlwOiAnMTkyLjE2OC4xLjEwMCcsXG4gICAgICAgICAgdGVuYW50SWQ6IHVuZGVmaW5lZCxcbiAgICAgICAgICB1c2VySWQ6IHVuZGVmaW5lZCxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmYWxsYmFjayB0byBjb25uZWN0aW9uIHJlbW90ZSBhZGRyZXNzJywgKCkgPT4ge1xuICAgICAgbW9ja1JlcXVlc3QgPSB7XG4gICAgICAgIC4uLm1vY2tSZXF1ZXN0LFxuICAgICAgICBoZWFkZXJzOiB7ICd1c2VyLWFnZW50JzogJ01vemlsbGEvNS4wJyB9LFxuICAgICAgICBpcDogdW5kZWZpbmVkLFxuICAgICAgICBzb2NrZXQ6IHsgcmVtb3RlQWRkcmVzczogJzE5Mi4xNjguMS4yMDAnIH0gYXMgdW5rbm93bixcbiAgICAgIH0gYXMgUGFydGlhbDxGYXN0aWZ5UmVxdWVzdD47XG5cbiAgICAgIG1pZGRsZXdhcmUudXNlKFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBGYXN0aWZ5UmVxdWVzdCxcbiAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIEZhc3RpZnlSZXBseSxcbiAgICAgICAgbmV4dEZ1bmN0aW9uLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnVua25vd24oU3RyaW5nKSxcbiAgICAgICAgTG9nQ29udGV4dC5IVFRQX1JFUVVFU1QsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBpcDogJzE5Mi4xNjguMS4yMDAnLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=