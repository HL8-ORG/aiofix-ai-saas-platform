9439e1deaab7df48fd3491264c08f9ea
"use strict";
var __esDecorate = (this && this.__esDecorate) || function (ctor, descriptorIn, decorators, contextIn, initializers, extraInitializers) {
    function accept(f) { if (f !== void 0 && typeof f !== "function") throw new TypeError("Function expected"); return f; }
    var kind = contextIn.kind, key = kind === "getter" ? "get" : kind === "setter" ? "set" : "value";
    var target = !descriptorIn && ctor ? contextIn["static"] ? ctor : ctor.prototype : null;
    var descriptor = descriptorIn || (target ? Object.getOwnPropertyDescriptor(target, contextIn.name) : {});
    var _, done = false;
    for (var i = decorators.length - 1; i >= 0; i--) {
        var context = {};
        for (var p in contextIn) context[p] = p === "access" ? {} : contextIn[p];
        for (var p in contextIn.access) context.access[p] = contextIn.access[p];
        context.addInitializer = function (f) { if (done) throw new TypeError("Cannot add initializers after decoration has completed"); extraInitializers.push(accept(f || null)); };
        var result = (0, decorators[i])(kind === "accessor" ? { get: descriptor.get, set: descriptor.set } : descriptor[key], context);
        if (kind === "accessor") {
            if (result === void 0) continue;
            if (result === null || typeof result !== "object") throw new TypeError("Object expected");
            if (_ = accept(result.get)) descriptor.get = _;
            if (_ = accept(result.set)) descriptor.set = _;
            if (_ = accept(result.init)) initializers.unshift(_);
        }
        else if (_ = accept(result)) {
            if (kind === "field") initializers.unshift(_);
            else descriptor[key] = _;
        }
    }
    if (target) Object.defineProperty(target, contextIn.name, descriptor);
    done = true;
};
var __runInitializers = (this && this.__runInitializers) || function (thisArg, initializers, value) {
    var useValue = arguments.length > 2;
    for (var i = 0; i < initializers.length; i++) {
        value = useValue ? initializers[i].call(thisArg, value) : initializers[i].call(thisArg);
    }
    return useValue ? value : void 0;
};
var __setFunctionName = (this && this.__setFunctionName) || function (f, name, prefix) {
    if (typeof name === "symbol") name = name.description ? "[".concat(name.description, "]") : "";
    return Object.defineProperty(f, "name", { configurable: true, value: prefix ? "".concat(prefix, " ", name) : name });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.defaultLoggingConfig = exports.PinoLoggerConfigService = void 0;
const common_1 = require("@nestjs/common");
const logging_interface_1 = require("../interfaces/logging.interface");
/**
 * @class PinoLoggerConfigService
 * @description
 * Pino日志配置管理服务，负责日志配置的初始化、验证和管理。
 *
 * 主要功能包括：
 * 1. 从环境变量和默认值初始化配置
 * 2. 配置验证和类型检查
 * 3. 配置更新和动态调整
 * 4. 环境相关的配置适配
 * 5. 配置持久化和恢复
 *
 * 设计原则：
 * - 单一职责：只负责配置管理
 * - 可测试性：配置逻辑独立，易于单元测试
 * - 可扩展性：支持多种配置源和验证规则
 */
let PinoLoggerConfigService = (() => {
    let _classDecorators = [(0, common_1.Injectable)()];
    let _classDescriptor;
    let _classExtraInitializers = [];
    let _classThis;
    var PinoLoggerConfigService = _classThis = class {
        constructor(customConfig) {
            this.customConfig = customConfig;
            this.config = {};
            this.initializeConfig();
        }
        /**
         * @method getConfig
         * @description 获取当前日志配置
         * @returns {LogConfig} 当前配置的副本
         */
        getConfig() {
            return { ...this.config };
        }
        /**
         * @method updateConfig
         * @description 更新日志配置
         * @param {Partial<LogConfig>} newConfig 新的配置项
         */
        updateConfig(newConfig) {
            this.config = { ...this.config, ...newConfig };
            this.validateConfig(this.config);
        }
        /**
         * @method getLevel
         * @description 获取当前日志级别
         * @returns {LogLevel} 当前日志级别
         */
        getLevel() {
            return this.config.level;
        }
        /**
         * @method setLevel
         * @description 设置日志级别
         * @param {LogLevel} level 新的日志级别
         */
        setLevel(level) {
            this.updateConfig({ level });
        }
        /**
         * @method getFormat
         * @description 获取当前日志格式
         * @returns {LogFormat} 当前日志格式
         */
        getFormat() {
            return this.config.format;
        }
        /**
         * @method setFormat
         * @description 设置日志格式
         * @param {LogFormat} format 新的日志格式
         */
        setFormat(format) {
            this.updateConfig({ format });
        }
        /**
         * @method isProduction
         * @description 检查是否为生产环境
         * @returns {boolean} 是否为生产环境
         */
        isProduction() {
            return process.env.NODE_ENV === 'production';
        }
        /**
         * @method isDevelopment
         * @description 检查是否为开发环境
         * @returns {boolean} 是否为开发环境
         */
        isDevelopment() {
            return process.env.NODE_ENV !== 'production';
        }
        /**
         * @method shouldUsePrettyFormat
         * @description 判断是否应该使用美化格式
         * @returns {boolean} 是否使用美化格式
         */
        shouldUsePrettyFormat() {
            return this.config.format === logging_interface_1.LogFormat.TEXT && this.isDevelopment();
        }
        /**
         * @method resetToDefaults
         * @description 重置为默认配置
         */
        resetToDefaults() {
            this.initializeConfig();
        }
        /**
         * @method validateConfig
         * @description 验证配置的有效性
         * @param {LogConfig} config 要验证的配置
         * @throws {Error} 配置无效时抛出错误
         */
        validateConfig(config) {
            const validLevels = [
                'fatal',
                'error',
                'warn',
                'info',
                'debug',
                'trace',
            ];
            const validFormats = [logging_interface_1.LogFormat.JSON, logging_interface_1.LogFormat.TEXT];
            if (!validLevels.includes(config.level)) {
                throw new Error(`Invalid log level: ${config.level}. Valid levels are: ${validLevels.join(', ')}`);
            }
            if (!validFormats.includes(config.format)) {
                throw new Error(`Invalid log format: ${config.format}. Valid formats are: ${validFormats.join(', ')}`);
            }
            if (config.rotation) {
                if (config.rotation.maxSize &&
                    !this.isValidFileSize(config.rotation.maxSize)) {
                    throw new Error(`Invalid maxSize format: ${config.rotation.maxSize}. Use format like '10m', '1g'`);
                }
            }
            if (config.remote) {
                if (!config.remote.url) {
                    throw new Error('Remote logging URL is required when remote logging is enabled');
                }
                if (config.remote.timeout && config.remote.timeout <= 0) {
                    throw new Error('Remote logging timeout must be positive');
                }
                if (config.remote.retries && config.remote.retries < 0) {
                    throw new Error('Remote logging retries must be non-negative');
                }
            }
        }
        /**
         * @private
         * @method initializeConfig
         * @description 初始化日志配置
         */
        initializeConfig() {
            // 根据环境确定默认格式
            const defaultFormat = this.isProduction() ? logging_interface_1.LogFormat.JSON : logging_interface_1.LogFormat.TEXT;
            // 默认配置
            const defaultConfig = {
                level: process.env.LOG_LEVEL || 'info',
                format: process.env.LOG_FORMAT || defaultFormat,
                colorize: this.isDevelopment(),
                timestamp: true,
                requestId: true,
                tenantId: true,
                userId: true,
                performance: true,
                stackTrace: true,
                filePath: process.env.LOG_FILE_PATH,
                rotation: {
                    maxSize: '10m',
                    maxFiles: 5,
                    interval: '1d',
                },
                remote: process.env.LOG_REMOTE_URL
                    ? {
                        url: process.env.LOG_REMOTE_URL,
                        token: process.env.LOG_REMOTE_TOKEN,
                        timeout: 5000,
                        retries: 3,
                    }
                    : undefined,
            };
            // 合并自定义配置
            this.config = {
                ...defaultConfig,
                ...this.customConfig,
            };
            this.validateConfig(this.config);
        }
        /**
         * @private
         * @method isValidFileSize
         * @description 验证文件大小格式是否有效
         * @param {string} size 文件大小字符串
         * @returns {boolean} 是否有效
         */
        isValidFileSize(size) {
            const sizeRegex = /^\d+[kmg]?$/i;
            return sizeRegex.test(size);
        }
    };
    __setFunctionName(_classThis, "PinoLoggerConfigService");
    (() => {
        const _metadata = typeof Symbol === "function" && Symbol.metadata ? Object.create(null) : void 0;
        __esDecorate(null, _classDescriptor = { value: _classThis }, _classDecorators, { kind: "class", name: _classThis.name, metadata: _metadata }, null, _classExtraInitializers);
        PinoLoggerConfigService = _classThis = _classDescriptor.value;
        if (_metadata) Object.defineProperty(_classThis, Symbol.metadata, { enumerable: true, configurable: true, writable: true, value: _metadata });
        __runInitializers(_classThis, _classExtraInitializers);
    })();
    return PinoLoggerConfigService = _classThis;
})();
exports.PinoLoggerConfigService = PinoLoggerConfigService;
/**
 * @constant defaultLoggingConfig
 * @description 默认日志配置
 */
exports.defaultLoggingConfig = {
    level: 'info',
    format: logging_interface_1.LogFormat.JSON,
    colorize: false,
    timestamp: true,
    requestId: true,
    tenantId: true,
    userId: true,
    performance: true,
    stackTrace: true,
    rotation: {
        maxSize: '10m',
        maxFiles: 5,
        interval: '1d',
    },
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvbG9nZ2luZy9zcmMvc2VydmljZXMvcGluby1sb2dnZXItY29uZmlnLnNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwyQ0FBOEQ7QUFDOUQsdUVBQXVFO0FBSXZFOzs7Ozs7Ozs7Ozs7Ozs7O0dBZ0JHO0lBRVUsdUJBQXVCOzRCQURuQyxJQUFBLG1CQUFVLEdBQUU7Ozs7O1FBSVgsWUFHRSxZQUF5QztZQUFqQyxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7WUFMbkMsV0FBTSxHQUFjLEVBQWUsQ0FBQztZQU8xQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUMxQixDQUFDO1FBRUQ7Ozs7V0FJRztRQUNILFNBQVM7WUFDUCxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDNUIsQ0FBQztRQUVEOzs7O1dBSUc7UUFDSCxZQUFZLENBQUMsU0FBNkI7WUFDeEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFDO1lBQy9DLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25DLENBQUM7UUFFRDs7OztXQUlHO1FBQ0gsUUFBUTtZQUNOLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDM0IsQ0FBQztRQUVEOzs7O1dBSUc7UUFDSCxRQUFRLENBQUMsS0FBZTtZQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUMvQixDQUFDO1FBRUQ7Ozs7V0FJRztRQUNILFNBQVM7WUFDUCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDO1FBQzVCLENBQUM7UUFFRDs7OztXQUlHO1FBQ0gsU0FBUyxDQUFDLE1B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Q0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUIsQ0FBQzs7Ozs7UUFuTkgsNktBb05DOzs7UUFwTlksdURBQXVCOzs7O0FBQXZCLDBEQUF1QjtBQXNOcEM7OztHQUdHO0FBQ1UsUUFBQSxvQkFBb0IsR0FBYztJQUM3QyxLQUFLLEVBQUUsTUFBTTtJQUNiLE1BQU0sRUFBRSw2QkFBUyxDQUFDLElBQUk7SUFDdEIsUUFBUSxFQUFFLEtBQUs7SUFDZixTQUFTLEVBQUUsSUFBSTtJQUNmLFNBQVMsRUFBRSxJQUFJO0lBQ2YsUUFBUSxFQUFFLElBQUk7SUFDZCxNQUFNLEVBQUUsSUFBSTtJQUNaLFdBQVcsRUFBRSxJQUFJO0lBQ2pCLFVBQVUsRUFBRSxJQUFJO0lBQ2hCLFFBQVEsRUFBRTtRQUNSLE9BQU8sRUFBRSxLQUFLO1FBQ2QsUUFBUSxFQUFFLENBQUM7UUFDWCxRQUFRLEVBQUUsSUFBSTtLQUNmO0NBQ0YsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9hcmxpZ2xlL1YxL0Fpb2ZpeC9haW9maXgtYWktc2Fhcy1wbGF0Zm9ybS9wYWNrYWdlcy9sb2dnaW5nL3NyYy9zZXJ2aWNlcy9waW5vLWxvZ2dlci1jb25maWcuc2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQG5lc3Rqcy9jb21tb24nO1xuaW1wb3J0IHsgTG9nQ29uZmlnLCBMb2dGb3JtYXQgfSBmcm9tICcuLi9pbnRlcmZhY2VzL2xvZ2dpbmcuaW50ZXJmYWNlJztcblxuZXhwb3J0IHR5cGUgTG9nTGV2ZWwgPSAnZmF0YWwnIHwgJ2Vycm9yJyB8ICd3YXJuJyB8ICdpbmZvJyB8ICdkZWJ1ZycgfCAndHJhY2UnO1xuXG4vKipcbiAqIEBjbGFzcyBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZVxuICogQGRlc2NyaXB0aW9uXG4gKiBQaW5v5pel5b+X6YWN572u566h55CG5pyN5Yqh77yM6LSf6LSj5pel5b+X6YWN572u55qE5Yid5aeL5YyW44CB6aqM6K+B5ZKM566h55CG44CCXG4gKlxuICog5Li76KaB5Yqf6IO95YyF5ous77yaXG4gKiAxLiDku47njq/looPlj5jph4/lkozpu5jorqTlgLzliJ3lp4vljJbphY3nva5cbiAqIDIuIOmFjee9rumqjOivgeWSjOexu+Wei+ajgOafpVxuICogMy4g6YWN572u5pu05paw5ZKM5Yqo5oCB6LCD5pW0XG4gKiA0LiDnjq/looPnm7jlhbPnmoTphY3nva7pgILphY1cbiAqIDUuIOmFjee9ruaMgeS5heWMluWSjOaBouWkjVxuICpcbiAqIOiuvuiuoeWOn+WIme+8mlxuICogLSDljZXkuIDogYzotKPvvJrlj6rotJ/otKPphY3nva7nrqHnkIZcbiAqIC0g5Y+v5rWL6K+V5oCn77ya6YWN572u6YC76L6R54us56uL77yM5piT5LqO5Y2V5YWD5rWL6K+VXG4gKiAtIOWPr+aJqeWxleaAp++8muaUr+aMgeWkmuenjemFjee9rua6kOWSjOmqjOivgeinhOWImVxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUGlub0xvZ2dlckNvbmZpZ1NlcnZpY2Uge1xuICBwcml2YXRlIGNvbmZpZzogTG9nQ29uZmlnID0ge30gYXMgTG9nQ29uZmlnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdCgnTE9HR0lOR19DT05GSUcnKVxuICAgIHByaXZhdGUgY3VzdG9tQ29uZmlnPzogUGFydGlhbDxMb2dDb25maWc+LFxuICApIHtcbiAgICB0aGlzLmluaXRpYWxpemVDb25maWcoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIGdldENvbmZpZ1xuICAgKiBAZGVzY3JpcHRpb24g6I635Y+W5b2T5YmN5pel5b+X6YWN572uXG4gICAqIEByZXR1cm5zIHtMb2dDb25maWd9IOW9k+WJjemFjee9rueahOWJr+acrFxuICAgKi9cbiAgZ2V0Q29uZmlnKCk6IExvZ0NvbmZpZyB7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5jb25maWcgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIHVwZGF0ZUNvbmZpZ1xuICAgKiBAZGVzY3JpcHRpb24g5pu05paw5pel5b+X6YWN572uXG4gICAqIEBwYXJhbSB7UGFydGlhbDxMb2dDb25maWc+fSBuZXdDb25maWcg5paw55qE6YWN572u6aG5XG4gICAqL1xuICB1cGRhdGVDb25maWcobmV3Q29uZmlnOiBQYXJ0aWFsPExvZ0NvbmZpZz4pOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZyA9IHsgLi4udGhpcy5jb25maWcsIC4uLm5ld0NvbmZpZyB9O1xuICAgIHRoaXMudmFsaWRhdGVDb25maWcodGhpcy5jb25maWcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgZ2V0TGV2ZWxcbiAgICogQGRlc2NyaXB0aW9uIOiOt+WPluW9k+WJjeaXpeW/l+e6p+WIq1xuICAgKiBAcmV0dXJucyB7TG9nTGV2ZWx9IOW9k+WJjeaXpeW/l+e6p+WIq1xuICAgKi9cbiAgZ2V0TGV2ZWwoKTogTG9nTGV2ZWwge1xuICAgIHJldHVybiB0aGlzLmNvbmZpZy5sZXZlbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAbWV0aG9kIHNldExldmVsXG4gICAqIEBkZXNjcmlwdGlvbiDorr7nva7ml6Xlv5fnuqfliKtcbiAgICogQHBhcmFtIHtMb2dMZXZlbH0gbGV2ZWwg5paw55qE5pel5b+X57qn5YirXG4gICAqL1xuICBzZXRMZXZlbChsZXZlbDogTG9nTGV2ZWwpOiB2b2lkIHtcbiAgICB0aGlzLnVwZGF0ZUNvbmZpZyh7IGxldmVsIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgZ2V0Rm9ybWF0XG4gICAqIEBkZXNjcmlwdGlvbiDojrflj5blvZPliY3ml6Xlv5fmoLzlvI9cbiAgICogQHJldHVybnMge0xvZ0Zvcm1hdH0g5b2T5YmN5pel5b+X5qC85byPXG4gICAqL1xuICBnZXRGb3JtYXQoKTogTG9nRm9ybWF0IHtcbiAgICByZXR1cm4gdGhpcy5jb25maWcuZm9ybWF0O1xuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2Qgc2V0Rm9ybWF0XG4gICAqIEBkZXNjcmlwdGlvbiDorr7nva7ml6Xlv5fmoLzlvI9cbiAgICogQHBhcmFtIHtMb2dGb3JtYXR9IGZvcm1hdCDmlrDnmoTml6Xlv5fmoLzlvI9cbiAgICovXG4gIHNldEZvcm1hdChmb3JtYXQ6IExvZ0Zvcm1hdCk6IHZvaWQge1xuICAgIHRoaXMudXBkYXRlQ29uZmlnKHsgZm9ybWF0IH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgaXNQcm9kdWN0aW9uXG4gICAqIEBkZXNjcmlwdGlvbiDmo4Dmn6XmmK/lkKbkuLrnlJ/kuqfnjq/looNcbiAgICogQHJldHVybnMge2Jvb2xlYW59IOaYr+WQpuS4uueUn+S6p+eOr+Wig1xuICAgKi9cbiAgaXNQcm9kdWN0aW9uKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nO1xuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgaXNEZXZlbG9wbWVudFxuICAgKiBAZGVzY3JpcHRpb24g5qOA5p+l5piv5ZCm5Li65byA5Y+R546v5aKDXG4gICAqIEByZXR1cm5zIHtib29sZWFufSDmmK/lkKbkuLrlvIDlj5Hnjq/looNcbiAgICovXG4gIGlzRGV2ZWxvcG1lbnQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbic7XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCBzaG91bGRVc2VQcmV0dHlGb3JtYXRcbiAgICogQGRlc2NyaXB0aW9uIOWIpOaWreaYr+WQpuW6lOivpeS9v+eUqOe+juWMluagvOW8j1xuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0g5piv5ZCm5L2/55So576O5YyW5qC85byPXG4gICAqL1xuICBzaG91bGRVc2VQcmV0dHlGb3JtYXQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLmZvcm1hdCA9PT0gTG9nRm9ybWF0LlRFWFQgJiYgdGhpcy5pc0RldmVsb3BtZW50KCk7XG4gIH1cblxuICAvKipcbiAgICogQG1ldGhvZCByZXNldFRvRGVmYXVsdHNcbiAgICogQGRlc2NyaXB0aW9uIOmHjee9ruS4uum7mOiupOmFjee9rlxuICAgKi9cbiAgcmVzZXRUb0RlZmF1bHRzKCk6IHZvaWQge1xuICAgIHRoaXMuaW5pdGlhbGl6ZUNvbmZpZygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBtZXRob2QgdmFsaWRhdGVDb25maWdcbiAgICogQGRlc2NyaXB0aW9uIOmqjOivgemFjee9rueahOacieaViOaAp1xuICAgKiBAcGFyYW0ge0xvZ0NvbmZpZ30gY29uZmlnIOimgemqjOivgeeahOmFjee9rlxuICAgKiBAdGhyb3dzIHtFcnJvcn0g6YWN572u5peg5pWI5pe25oqb5Ye66ZSZ6K+vXG4gICAqL1xuICB2YWxpZGF0ZUNvbmZpZyhjb25maWc6IExvZ0NvbmZpZyk6IHZvaWQge1xuICAgIGNvbnN0IHZhbGlkTGV2ZWxzOiBMb2dMZXZlbFtdID0gW1xuICAgICAgJ2ZhdGFsJyxcbiAgICAgICdlcnJvcicsXG4gICAgICAnd2FybicsXG4gICAgICAnaW5mbycsXG4gICAgICAnZGVidWcnLFxuICAgICAgJ3RyYWNlJyxcbiAgICBdO1xuICAgIGNvbnN0IHZhbGlkRm9ybWF0czogTG9nRm9ybWF0W10gPSBbTG9nRm9ybWF0LkpTT04sIExvZ0Zvcm1hdC5URVhUXTtcblxuICAgIGlmICghdmFsaWRMZXZlbHMuaW5jbHVkZXMoY29uZmlnLmxldmVsKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgSW52YWxpZCBsb2cgbGV2ZWw6ICR7Y29uZmlnLmxldmVsfS4gVmFsaWQgbGV2ZWxzIGFyZTogJHt2YWxpZExldmVscy5qb2luKCcsICcpfWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICghdmFsaWRGb3JtYXRzLmluY2x1ZGVzKGNvbmZpZy5mb3JtYXQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBJbnZhbGlkIGxvZyBmb3JtYXQ6ICR7Y29uZmlnLmZvcm1hdH0uIFZhbGlkIGZvcm1hdHMgYXJlOiAke3ZhbGlkRm9ybWF0cy5qb2luKCcsICcpfWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjb25maWcucm90YXRpb24pIHtcbiAgICAgIGlmIChcbiAgICAgICAgY29uZmlnLnJvdGF0aW9uLm1heFNpemUgJiZcbiAgICAgICAgIXRoaXMuaXNWYWxpZEZpbGVTaXplKGNvbmZpZy5yb3RhdGlvbi5tYXhTaXplKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgSW52YWxpZCBtYXhTaXplIGZvcm1hdDogJHtjb25maWcucm90YXRpb24ubWF4U2l6ZX0uIFVzZSBmb3JtYXQgbGlrZSAnMTBtJywgJzFnJ2AsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGNvbmZpZy5yZW1vdGUpIHtcbiAgICAgIGlmICghY29uZmlnLnJlbW90ZS51cmwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICdSZW1vdGUgbG9nZ2luZyBVUkwgaXMgcmVxdWlyZWQgd2hlbiByZW1vdGUgbG9nZ2luZyBpcyBlbmFibGVkJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChjb25maWcucmVtb3RlLnRpbWVvdXQgJiYgY29uZmlnLnJlbW90ZS50aW1lb3V0IDw9IDApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdSZW1vdGUgbG9nZ2luZyB0aW1lb3V0IG11c3QgYmUgcG9zaXRpdmUnKTtcbiAgICAgIH1cbiAgICAgIGlmIChjb25maWcucmVtb3RlLnJldHJpZXMgJiYgY29uZmlnLnJlbW90ZS5yZXRyaWVzIDwgMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlbW90ZSBsb2dnaW5nIHJldHJpZXMgbXVzdCBiZSBub24tbmVnYXRpdmUnKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBpbml0aWFsaXplQ29uZmlnXG4gICAqIEBkZXNjcmlwdGlvbiDliJ3lp4vljJbml6Xlv5fphY3nva5cbiAgICovXG4gIHByaXZhdGUgaW5pdGlhbGl6ZUNvbmZpZygpOiB2b2lkIHtcbiAgICAvLyDmoLnmja7njq/looPnoa7lrprpu5jorqTmoLzlvI9cbiAgICBjb25zdCBkZWZhdWx0Rm9ybWF0ID0gdGhpcy5pc1Byb2R1Y3Rpb24oKSA/IExvZ0Zvcm1hdC5KU09OIDogTG9nRm9ybWF0LlRFWFQ7XG5cbiAgICAvLyDpu5jorqTphY3nva5cbiAgICBjb25zdCBkZWZhdWx0Q29uZmlnOiBMb2dDb25maWcgPSB7XG4gICAgICBsZXZlbDogKHByb2Nlc3MuZW52LkxPR19MRVZFTCBhcyBMb2dMZXZlbCkgfHwgJ2luZm8nLFxuICAgICAgZm9ybWF0OiAocHJvY2Vzcy5lbnYuTE9HX0ZPUk1BVCBhcyBMb2dGb3JtYXQpIHx8IGRlZmF1bHRGb3JtYXQsXG4gICAgICBjb2xvcml6ZTogdGhpcy5pc0RldmVsb3BtZW50KCksXG4gICAgICB0aW1lc3RhbXA6IHRydWUsXG4gICAgICByZXF1ZXN0SWQ6IHRydWUsXG4gICAgICB0ZW5hbnRJZDogdHJ1ZSxcbiAgICAgIHVzZXJJZDogdHJ1ZSxcbiAgICAgIHBlcmZvcm1hbmNlOiB0cnVlLFxuICAgICAgc3RhY2tUcmFjZTogdHJ1ZSxcbiAgICAgIGZpbGVQYXRoOiBwcm9jZXNzLmVudi5MT0dfRklMRV9QQVRILFxuICAgICAgcm90YXRpb246IHtcbiAgICAgICAgbWF4U2l6ZTogJzEwbScsXG4gICAgICAgIG1heEZpbGVzOiA1LFxuICAgICAgICBpbnRlcnZhbDogJzFkJyxcbiAgICAgIH0sXG4gICAgICByZW1vdGU6IHByb2Nlc3MuZW52LkxPR19SRU1PVEVfVVJMXG4gICAgICAgID8ge1xuICAgICAgICAgICAgdXJsOiBwcm9jZXNzLmVudi5MT0dfUkVNT1RFX1VSTCxcbiAgICAgICAgICAgIHRva2VuOiBwcm9jZXNzLmVudi5MT0dfUkVNT1RFX1RPS0VOLFxuICAgICAgICAgICAgdGltZW91dDogNTAwMCxcbiAgICAgICAgICAgIHJldHJpZXM6IDMsXG4gICAgICAgICAgfVxuICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICB9O1xuXG4gICAgLy8g5ZCI5bm26Ieq5a6a5LmJ6YWN572uXG4gICAgdGhpcy5jb25maWcgPSB7XG4gICAgICAuLi5kZWZhdWx0Q29uZmlnLFxuICAgICAgLi4udGhpcy5jdXN0b21Db25maWcsXG4gICAgfTtcblxuICAgIHRoaXMudmFsaWRhdGVDb25maWcodGhpcy5jb25maWcpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwcml2YXRlXG4gICAqIEBtZXRob2QgaXNWYWxpZEZpbGVTaXplXG4gICAqIEBkZXNjcmlwdGlvbiDpqozor4Hmlofku7blpKflsI/moLzlvI/mmK/lkKbmnInmlYhcbiAgICogQHBhcmFtIHtzdHJpbmd9IHNpemUg5paH5Lu25aSn5bCP5a2X56ym5LiyXG4gICAqIEByZXR1cm5zIHtib29sZWFufSDmmK/lkKbmnInmlYhcbiAgICovXG4gIHByaXZhdGUgaXNWYWxpZEZpbGVTaXplKHNpemU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHNpemVSZWdleCA9IC9eXFxkK1trbWddPyQvaTtcbiAgICByZXR1cm4gc2l6ZVJlZ2V4LnRlc3Qoc2l6ZSk7XG4gIH1cbn1cblxuLyoqXG4gKiBAY29uc3RhbnQgZGVmYXVsdExvZ2dpbmdDb25maWdcbiAqIEBkZXNjcmlwdGlvbiDpu5jorqTml6Xlv5fphY3nva5cbiAqL1xuZXhwb3J0IGNvbnN0IGRlZmF1bHRMb2dnaW5nQ29uZmlnOiBMb2dDb25maWcgPSB7XG4gIGxldmVsOiAnaW5mbycsXG4gIGZvcm1hdDogTG9nRm9ybWF0LkpTT04sXG4gIGNvbG9yaXplOiBmYWxzZSxcbiAgdGltZXN0YW1wOiB0cnVlLFxuICByZXF1ZXN0SWQ6IHRydWUsXG4gIHRlbmFudElkOiB0cnVlLFxuICB1c2VySWQ6IHRydWUsXG4gIHBlcmZvcm1hbmNlOiB0cnVlLFxuICBzdGFja1RyYWNlOiB0cnVlLFxuICByb3RhdGlvbjoge1xuICAgIG1heFNpemU6ICcxMG0nLFxuICAgIG1heEZpbGVzOiA1LFxuICAgIGludGVydmFsOiAnMWQnLFxuICB9LFxufTtcbiJdLCJ2ZXJzaW9uIjozfQ==