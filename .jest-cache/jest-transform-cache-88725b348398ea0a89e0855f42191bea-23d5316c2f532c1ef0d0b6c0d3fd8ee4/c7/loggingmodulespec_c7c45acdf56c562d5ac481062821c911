b27a986abbefaa8d6a7498f8ff8d8aca
"use strict";
/**
 * @file logging.module.spec.ts
 * @description 日志模块单元测试
 *
 * 测试Pino日志服务的核心功能，包括：
 * - 日志级别控制
 * - 结构化日志输出
 * - 上下文管理
 * - 性能监控
 * - 错误处理
 */
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const event_emitter_1 = require("@nestjs/event-emitter");
const nestjs_cls_1 = require("nestjs-cls");
const pino_logger_service_1 = require("./services/pino-logger.service");
const pino_logger_config_service_1 = require("./services/pino-logger-config.service");
const pino_logger_factory_1 = require("./factories/pino-logger.factory");
const pino_logging_middleware_1 = require("./middleware/pino-logging.middleware");
const pino_logging_interceptor_1 = require("./interceptors/pino-logging.interceptor");
const logging_interface_1 = require("./interfaces/logging.interface");
describe('LoggingModule', () => {
    let module;
    let loggerService;
    let configService;
    let loggerFactory;
    beforeAll(async () => {
        module = await testing_1.Test.createTestingModule({
            imports: [
                event_emitter_1.EventEmitterModule.forRoot(),
                nestjs_cls_1.ClsModule.forRoot({
                    global: true,
                    middleware: {
                        mount: true,
                        setup: (cls, _req) => {
                            cls.set('requestId', 'test-request-id');
                            cls.set('tenantId', 'test-tenant-id');
                            cls.set('userId', 'test-user-id');
                        },
                    },
                }),
            ],
            providers: [
                {
                    provide: pino_logger_config_service_1.PinoLoggerConfigService,
                    useFactory: () => {
                        return new pino_logger_config_service_1.PinoLoggerConfigService();
                    },
                },
                {
                    provide: pino_logger_factory_1.PinoLoggerFactory,
                    useFactory: (configService) => {
                        return new pino_logger_factory_1.PinoLoggerFactory(configService);
                    },
                    inject: [pino_logger_config_service_1.PinoLoggerConfigService],
                },
                {
                    provide: pino_logger_service_1.PinoLoggerService,
                    useFactory: (eventEmitter, configService, loggerFactory, cls) => {
                        return new pino_logger_service_1.PinoLoggerService(eventEmitter, configService, loggerFactory, cls);
                    },
                    inject: [
                        event_emitter_1.EventEmitter2,
                        pino_logger_config_service_1.PinoLoggerConfigService,
                        pino_logger_factory_1.PinoLoggerFactory,
                        nestjs_cls_1.ClsService,
                    ],
                },
                {
                    provide: pino_logging_middleware_1.PinoLoggingMiddleware,
                    useFactory: (logger) => {
                        return new pino_logging_middleware_1.PinoLoggingMiddleware(logger);
                    },
                    inject: [pino_logger_service_1.PinoLoggerService],
                },
                {
                    provide: pino_logging_interceptor_1.PinoLoggingInterceptor,
                    useFactory: (logger) => {
                        return new pino_logging_interceptor_1.PinoLoggingInterceptor(logger);
                    },
                    inject: [pino_logger_service_1.PinoLoggerService],
                },
            ],
        }).compile();
        loggerService = module.get(pino_logger_service_1.PinoLoggerService);
        configService = module.get(pino_logger_config_service_1.PinoLoggerConfigService);
        loggerFactory = module.get(pino_logger_factory_1.PinoLoggerFactory);
    });
    afterAll(async () => {
        if (module) {
            await module.close();
        }
    });
    describe('Module Initialization', () => {
        it('should be defined', () => {
            expect(module).toBeDefined();
        });
        it('should have PinoLoggerService', () => {
            expect(loggerService).toBeDefined();
        });
        it('should have PinoLoggerConfigService', () => {
            expect(configService).toBeDefined();
        });
        it('should have PinoLoggerFactory', () => {
            expect(loggerFactory).toBeDefined();
        });
    });
    describe('PinoLoggerService', () => {
        it('should log different levels', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            loggerService.debug('Debug message', logging_interface_1.LogContext.SYSTEM);
            loggerService.info('Info message', logging_interface_1.LogContext.BUSINESS);
            loggerService.warn('Warning message', logging_interface_1.LogContext.AUTH);
            loggerService.error('Error message', logging_interface_1.LogContext.SYSTEM);
            expect(spy).toHaveBeenCalledTimes(4);
            expect(spy).toHaveBeenCalledWith('debug', 'Debug message', logging_interface_1.LogContext.SYSTEM, undefined, undefined);
            expect(spy).toHaveBeenCalledWith('info', 'Info message', logging_interface_1.LogContext.BUSINESS, undefined, undefined);
            expect(spy).toHaveBeenCalledWith('warn', 'Warning message', logging_interface_1.LogContext.AUTH, undefined, undefined);
            expect(spy).toHaveBeenCalledWith('error', 'Error message', logging_interface_1.LogContext.SYSTEM, undefined, undefined);
            spy.mockRestore();
        });
        it('should log with metadata', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            const metadata = {
                requestId: 'test-request-id',
                tenantId: 'test-tenant-id',
                userId: 'test-user-id',
                operation: 'test-operation',
            };
            loggerService.info('Test message', logging_interface_1.LogContext.BUSINESS, metadata);
            expect(spy).toHaveBeenCalledWith('info', 'Test message', logging_interface_1.LogContext.BUSINESS, metadata, undefined);
            spy.mockRestore();
        });
        it('should log errors with stack trace', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            const error = new Error('Test error');
            loggerService.error('Error occurred', logging_interface_1.LogContext.SYSTEM, undefined, error);
            expect(spy).toHaveBeenCalledWith('error', 'Error occurred', logging_interface_1.LogContext.SYSTEM, undefined, error);
            spy.mockRestore();
        });
        it('should log performance metrics', () => {
            const spy = jest
                .spyOn(loggerService, 'log')
                .mockImplementation(() => undefined);
            loggerService.performance('test-operation', 150, logging_interface_1.LogContext.PERFORMANCE);
            expect(spy).toHaveBeenCalledWith('info', 'Performance: test-operation took 150ms', logging_interface_1.LogContext.PERFORMANCE, {
                operation: 'test-operation',
                duration: 150,
                type: 'performance',
            });
            spy.mockRestore();
        });
        it('should create child logger', () => {
            const childLogger = loggerService.child(logging_interface_1.LogContext.BUSINESS, {
                tenantId: 'child-tenant',
            });
            expect(childLogger).toBeDefined();
            expect(childLogger).toHaveProperty('info');
            expect(childLogger).toHaveProperty('error');
            expect(childLogger).toHaveProperty('warn');
        });
        it('should get and set log level', () => {
            const originalLevel = loggerService.getLevel();
            loggerService.setLevel('debug');
            expect(loggerService.getLevel()).toBe('debug');
            loggerService.setLevel(originalLevel);
            expect(loggerService.getLevel()).toBe(originalLevel);
        });
        it('should get stats', () => {
            const stats = loggerService.getStats();
            expect(stats).toHaveProperty('totalLogs');
            expect(stats).toHaveProperty('logsByLevel');
            expect(stats).toHaveProperty('logsByContext');
            expect(stats).toHaveProperty('averageLogSize');
        });
    });
    describe('PinoLoggerConfigService', () => {
        it('should get default config', () => {
            const config = configService.getConfig();
            expect(config).toBeDefined();
            expect(config).toHaveProperty('level');
            expect(config).toHaveProperty('format');
            expect(config).toHaveProperty('timestamp');
        });
        it('should update config', () => {
            const originalConfig = configService.getConfig();
            const newConfig = { level: 'debug' };
            configService.updateConfig(newConfig);
            expect(configService.getLevel()).toBe('debug');
            // 恢复原始配置
            configService.updateConfig(originalConfig);
        });
        it('should detect environment', () => {
            const isDev = configService.isDevelopment();
            const isProd = configService.isProduction();
            expect(typeof isDev).toBe('boolean');
            expect(typeof isProd).toBe('boolean');
        });
    });
    describe('PinoLoggerFactory', () => {
        it('should create logger', () => {
            const logger = loggerFactory.createLogger();
            expect(logger).toBeDefined();
            expect(logger).toHaveProperty('info');
            expect(logger).toHaveProperty('error');
            expect(logger).toHaveProperty('warn');
        });
        it('should create child logger', () => {
            const parentLogger = loggerFactory.createLogger();
            const childLogger = loggerFactory.createChildLogger(parentLogger, {
                context: 'test',
            });
            expect(childLogger).toBeDefined();
            expect(childLogger).toHaveProperty('info');
            expect(childLogger).toHaveProperty('error');
        });
    });
    describe('Logging Middleware and Interceptor', () => {
        it('should have middleware defined', () => {
            const middleware = module.get(pino_logging_middleware_1.PinoLoggingMiddleware);
            expect(middleware).toBeDefined();
            expect(middleware).toHaveProperty('use');
        });
        it('should have interceptor defined', () => {
            const interceptor = module.get(pino_logging_interceptor_1.PinoLoggingInterceptor);
            expect(interceptor).toBeDefined();
            expect(interceptor).toHaveProperty('intercept');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvbG9nZ2luZy9zcmMvbG9nZ2luZy5tb2R1bGUuc3BlYy50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7R0FVRzs7QUFFSCw2Q0FBc0Q7QUFDdEQseURBQTBFO0FBQzFFLDJDQUFtRDtBQUNuRCx3RUFBbUU7QUFDbkUsc0ZBQWdGO0FBQ2hGLHlFQUFvRTtBQUNwRSxrRkFBNkU7QUFDN0Usc0ZBQWlGO0FBQ2pGLHNFQUFzRTtBQUV0RSxRQUFRLENBQUMsZUFBZSxFQUFFLEdBQUcsRUFBRTtJQUM3QixJQUFJLE1BQXFCLENBQUM7SUFDMUIsSUFBSSxhQUFnQyxDQUFDO0lBQ3JDLElBQUksYUFBc0MsQ0FBQztJQUMzQyxJQUFJLGFBQWdDLENBQUM7SUFFckMsU0FBUyxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ25CLE1BQU0sR0FBRyxNQUFNLGNBQUksQ0FBQyxtQkFBbUIsQ0FBQztZQUN0QyxPQUFPLEVBQUU7Z0JBQ1Asa0NBQWtCLENBQUMsT0FBTyxFQUFFO2dCQUM1QixzQkFBUyxDQUFDLE9BQU8sQ0FBQztvQkFDaEIsTUFBTSxFQUFFLElBQUk7b0JBQ1osVUFBVSxFQUFFO3dCQUNWLEtBQUssRUFBRSxJQUFJO3dCQUNYLEtBQUssRUFBRSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTs0QkFDbkIsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsaUJBQWlCLENBQUMsQ0FBQzs0QkFDeEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQzs0QkFDdEMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7d0JBQ3BDLENBQUM7cUJBQ0Y7aUJBQ0YsQ0FBQzthQUNIO1lBQ0QsU0FBUyxFQUFFO2dCQUNUO29CQUNFLE9BQU8sRUFBRSxvREFBdUI7b0JBQ2hDLFVBQVUsRUFBRSxHQUFHLEVBQUU7d0JBQ2YsT0FBTyxJQUFJLG9EQUF1QixFQUFFLENBQUM7b0JBQ3ZDLENBQUM7aUJBQ0Y7Z0JBQ0Q7b0JBQ0UsT0FBTyxFQUFFLHVDQUFpQjtvQkFDMUIsVUFBVSxFQUFFLENBQUMsYUFBc0MsRUFBRSxFQUFFO3dCQUNyRCxPQUFPLElBQUksdUNBQWlCLENBQUMsYUFBYSxDQUFDLENBQUM7b0JBQzlDLENBQUM7b0JBQ0QsTUFBTSxFQUFFLENBQUMsb0RBQXVCLENBQUM7aUJBQ2xDO2dCQUNEO29CQUNFLE9BQU8sRUFBRSx1Q0FBaUI7b0JBQzFCLFVBQVUsRUFBRSxDQUNWLFlBQTJCLEVBQzNCLGFBQXNDLEVBQ3RDLGFBQWdDLEVBQ2hDLEdBQWUsRUFDZixFQUFFO3dCQUNGLE9BQU8sSUFBSSx1Q0FBaUIsQ0FDMUIsWUFBWSxFQUNaLGFBQWEsRUFDYixhQUFhLEVBQ2IsR0FBRyxDQUNKLENBQUM7b0JBQ0osQ0FBQztvQkFDRCxNQUFNLEVBQUU7d0JBQ04sNkJBQWE7d0JBQ2Isb0RBQXVCO3dCQUN2Qix1Q0FBaUI7d0JBQ2pCLHVCQUFVO3FCQUNYO2lCQUNGO2dCQUNEO29CQUNFLE9BQU8sRUFBRSwrQ0FBcUI7b0JBQzlCLFVBQVUsRUFBRSxDQUFDLE1BQXlCLEVBQUUsRUFBRTt3QkFDeEMsT0FBTyxJQUFJLCtDQUFxQixDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUMzQyxDQUFDO29CQUNELE1BQU0sRUFBRSxDQUFDLHVDQUFpQixDQUFDO2lCQUM1QjtnQkFDRDtvQkFDRSxPQUFPLEVBQUUsaURBQXNCO29CQUMvQixVQUFVLEVBQUUsQ0FBQyxNQUF5QixFQUFFLEVBQUU7d0JBQ3hDLE9BQU8sSUFBSSxpREFBc0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDNUMsQ0FBQztvQkFDRCxNQUFNLEVBQUUsQ0FBQyx1Q0FBaUIsQ0FBQztpQkFDNUI7YUFDRjtTQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLGFBQWEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFvQix1Q0FBaUIsQ0FBQyxDQUFDO1FBQ2pFLGFBQWEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUN4QixvREFBdUIsQ0FDeEIsQ0FBQztRQUNGLGFBQWEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFvQix1Q0FBaUIsQ0FBQyxDQUFDO0lBQ25FLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBQ2xCLElBQUksTUFBTSxFQUFFLENBQUM7WUFDWCxNQUFNLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN2QixDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsdUJBQXVCLEVBQUUsR0FBRyxFQUFFO1FBQ3JDLEVBQUUsQ0FBQyxtQkFBbUIsRUFBRSxHQUFHLEVBQUU7WUFDM0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQy9CLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLCtCQUErQixFQUFFLEdBQUcsRUFBRTtZQUN2QyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFO1lBQzdDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN0QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQywrQkFBK0IsRUFBRSxHQUFHLEVBQUU7WUFDdkMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxFQUFFO1FBQ2pDLEVBQUUsQ0FBQyw2QkFBNkIsRUFBRSxHQUFHLEVBQUU7WUFDckMsTUFBTSxHQUFHLEdBQUcsSUFBSTtpQkFDYixLQUFLLENBQUMsYUFBb0IsRUFBRSxLQUFLLENBQUM7aUJBQ2xDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXZDLGFBQWEsQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLDhCQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEQsYUFBYSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsOEJBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN4RCxhQUFhLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLDhCQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkQsYUFBYSxDQUFDLEtBQUssQ0FBQyxlQUFlLEVBQUUsOEJBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUV4RCxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUM5QixPQUFPLEVBQ1AsZUFBZSxFQUNmLDhCQUFVLENBQUMsTUFBTSxFQUNqQixTQUFTLEVBQ1QsU0FBUyxDQUNWLENBQUM7WUFDRixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsb0JBQW9CLENBQzlCLE1BQU0sRUFDTixjQUFjLEVBQ2QsOEJBQVUsQ0FBQyxRQUFRLEVBQ25CLFNBQVMsRUFDVCxTQUFTLENBQ1YsQ0FBQztZQUNGLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxvQkFBb0IsQ0FDOUIsTUFBTSxFQUNOLGlCQUFpQixFQUNqQiw4QkFBVSxDQUFDLElBQUksRUFDZixTQUFTLEVBQ1QsU0FBUyxDQUNWLENBQUM7WUFDRixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsb0JBQW9CLENBQzlCLE9BQU8sRUFDUCxlQUFlLEVBQ2YsOEJBQVUsQ0FBQyxNQUFNLEVBQ2pCLFNBQVMsRUFDVCxTQUFTLENBQ1YsQ0FBQztZQUVGLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQywwQkFBMEIsRUFBRSxHQUFHLEVBQUU7WUFDbEMsTUFBTSxHQUFHLEdBQUcsSUFBSTtpQkFDYixLQUFLLENBQUMsYUFBb0IsRUFBRSxLQUFLLENBQUM7aUJBQ2xDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sUUFBUSxHQUFHO2dCQUNmLFNBQVMsRUFBRSxpQkFBaUI7Z0JBQzVCLFFBQVEsRUFBRSxnQkFBZ0I7Z0JBQzFCLE1BQU0sRUFBRSxjQUFjO2dCQUN0QixTQUFTLEVBQUUsZ0JBQWdCO2FBQzVCLENBQUM7WUFFRixhQUFhLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSw4QkFBVSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUVsRSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsb0JBQW9CLENBQzlCLE1BQU0sRUFDTixjQUFjLEVBQ2QsOEJBQVUsQ0FBQyxRQUFRLEVBQ25CLFFBQVEsRUFDUixTQUFTLENBQ1YsQ0FBQztZQUVGLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNwQixDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7WUFDNUMsTUFBTSxHQUFHLEdBQUcsSUFBSTtpQkFDYixLQUFLLENBQUMsYUFBb0IsRUFBRSxLQUFLLENBQUM7aUJBQ2xDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBRXRDLGFBQWEsQ0FBQyxLQUFLLENBQ2pCLGdCQUFnQixFQUNoQiw4QkFBVSxDQUFDLE1BQU0sRUFDakIsU0FBUyxFQUNULEtBQUssQ0FDTixDQUFDO1lBRUYsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUM5QixPQUFPLEVBQ1AsZ0JBQWdCLEVBQ2hCLDhCQUFVLENBQUMsTUFBTSxFQUNqQixTQUFTLEVBQ1QsS0FBSyxDQUNOLENBQUM7WUFFRixHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsZ0NBQWdDLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLE1BQU0sR0FBRyxHQUFHLElBQUk7aUJBQ2IsS0FBSyxDQUFDLGFBQW9CLEVBQUUsS0FBSyxDQUFDO2lCQUNsQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUV2QyxhQUFhLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLEdBQUcsRUFBRSw4QkFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXpFLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxvQkFBb0IsQ0FDOUIsTUFBTSxFQUNOLHdDQUF3QyxFQUN4Qyw4QkFBVSxDQUFDLFdBQVcsRUFDdEI7Z0JBQ0UsU0FBUyxFQUFFLGdCQUFnQjtnQkFDM0IsUUFBUSxFQUFFLEdBQUc7Z0JBQ2IsSUFBSSxFQUFFLGFBQWE7YUFDcEIsQ0FDRixDQUFDO1lBRUYsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BCLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDRCQUE0QixFQUFFLEdBQUcsRUFBRTtZQUNwQyxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLDhCQUFVLENBQUMsUUFBUSxFQUFFO2dCQUMzRCxRQUFRLEVBQUUsY0FBYzthQUN6QixDQUFDLENBQUM7WUFDSCxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsOEJBQThCLEVBQUUsR0FBRyxFQUFFO1lBQ3RDLE1BQU0sYUFBYSxHQUFHLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUUvQyxhQUFhLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hDLE1BQU0sQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFL0MsYUFBYSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3ZELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLGtCQUFrQixFQUFFLEdBQUcsRUFBRTtZQUMxQixNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUMxQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDOUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ2pELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMseUJBQXlCLEVBQUUsR0FBRyxFQUFFO1FBQ3ZDLEVBQUUsQ0FBQywyQkFBMkIsRUFBRSxHQUFHLEVBQUU7WUFDbkMsTUFBTSxNQUFNLEdBQUcsYUFBYSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3pDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM3QixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDeEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM3QyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7WUFDOUIsTUFBTSxjQUFjLEdBQUcsYUFBYSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ2pELE1BQU0sU0FBUyxHQUFHLEVBQUUsS0FBSyxFQUFFLE9BQW1CLEVBQUUsQ0FBQztZQUVqRCxhQUFhLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3RDLE1BQU0sQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFL0MsU0FBUztZQUNULGFBQWEsQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDN0MsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsMkJBQTJCLEVBQUUsR0FBRyxFQUFFO1lBQ25DLE1BQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUM1QyxNQUFNLE1BQU0sR0FBRyxhQUFhLENBQUMsWUFBWSxFQUFFLENBQUM7WUFFNUMsTUFBTSxDQUFDLE9BQU8sS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3JDLE1BQU0sQ0FBQyxPQUFPLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtRQUNqQyxFQUFFLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxFQUFFO1lBQzlCLE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUM1QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDN0IsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN0QyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO1lBQ3BDLE1BQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNsRCxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsaUJBQWlCLENBQUMsWUFBWSxFQUFFO2dCQUNoRSxPQUFPLEVBQUUsTUFBTTthQUNoQixDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzlDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO1FBQ2xELEVBQUUsQ0FBQyxnQ0FBZ0MsRUFBRSxHQUFHLEVBQUU7WUFDeEMsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FDM0IsK0NBQXFCLENBQ3RCLENBQUM7WUFDRixNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQyxDQUFDLENBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxpQ0FBaUMsRUFBRSxHQUFHLEVBQUU7WUFDekMsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FDNUIsaURBQXNCLENBQ3ZCLENBQUM7WUFDRixNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDbEMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvbG9nZ2luZy9zcmMvbG9nZ2luZy5tb2R1bGUuc3BlYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBmaWxlIGxvZ2dpbmcubW9kdWxlLnNwZWMudHNcbiAqIEBkZXNjcmlwdGlvbiDml6Xlv5fmqKHlnZfljZXlhYPmtYvor5VcbiAqXG4gKiDmtYvor5VQaW5v5pel5b+X5pyN5Yqh55qE5qC45b+D5Yqf6IO977yM5YyF5ous77yaXG4gKiAtIOaXpeW/l+e6p+WIq+aOp+WItlxuICogLSDnu5PmnoTljJbml6Xlv5fovpPlh7pcbiAqIC0g5LiK5LiL5paH566h55CGXG4gKiAtIOaAp+iDveebkeaOp1xuICogLSDplJnor6/lpITnkIZcbiAqL1xuXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlck1vZHVsZSwgRXZlbnRFbWl0dGVyMiB9IGZyb20gJ0BuZXN0anMvZXZlbnQtZW1pdHRlcic7XG5pbXBvcnQgeyBDbHNNb2R1bGUsIENsc1NlcnZpY2UgfSBmcm9tICduZXN0anMtY2xzJztcbmltcG9ydCB7IFBpbm9Mb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9waW5vLWxvZ2dlci5zZXJ2aWNlJztcbmltcG9ydCB7IFBpbm9Mb2dnZXJDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9waW5vLWxvZ2dlci1jb25maWcuc2VydmljZSc7XG5pbXBvcnQgeyBQaW5vTG9nZ2VyRmFjdG9yeSB9IGZyb20gJy4vZmFjdG9yaWVzL3Bpbm8tbG9nZ2VyLmZhY3RvcnknO1xuaW1wb3J0IHsgUGlub0xvZ2dpbmdNaWRkbGV3YXJlIH0gZnJvbSAnLi9taWRkbGV3YXJlL3Bpbm8tbG9nZ2luZy5taWRkbGV3YXJlJztcbmltcG9ydCB7IFBpbm9Mb2dnaW5nSW50ZXJjZXB0b3IgfSBmcm9tICcuL2ludGVyY2VwdG9ycy9waW5vLWxvZ2dpbmcuaW50ZXJjZXB0b3InO1xuaW1wb3J0IHsgTG9nQ29udGV4dCwgTG9nTGV2ZWwgfSBmcm9tICcuL2ludGVyZmFjZXMvbG9nZ2luZy5pbnRlcmZhY2UnO1xuXG5kZXNjcmliZSgnTG9nZ2luZ01vZHVsZScsICgpID0+IHtcbiAgbGV0IG1vZHVsZTogVGVzdGluZ01vZHVsZTtcbiAgbGV0IGxvZ2dlclNlcnZpY2U6IFBpbm9Mb2dnZXJTZXJ2aWNlO1xuICBsZXQgY29uZmlnU2VydmljZTogUGlub0xvZ2dlckNvbmZpZ1NlcnZpY2U7XG4gIGxldCBsb2dnZXJGYWN0b3J5OiBQaW5vTG9nZ2VyRmFjdG9yeTtcblxuICBiZWZvcmVBbGwoYXN5bmMgKCkgPT4ge1xuICAgIG1vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbXG4gICAgICAgIEV2ZW50RW1pdHRlck1vZHVsZS5mb3JSb290KCksXG4gICAgICAgIENsc01vZHVsZS5mb3JSb290KHtcbiAgICAgICAgICBnbG9iYWw6IHRydWUsXG4gICAgICAgICAgbWlkZGxld2FyZToge1xuICAgICAgICAgICAgbW91bnQ6IHRydWUsXG4gICAgICAgICAgICBzZXR1cDogKGNscywgX3JlcSkgPT4ge1xuICAgICAgICAgICAgICBjbHMuc2V0KCdyZXF1ZXN0SWQnLCAndGVzdC1yZXF1ZXN0LWlkJyk7XG4gICAgICAgICAgICAgIGNscy5zZXQoJ3RlbmFudElkJywgJ3Rlc3QtdGVuYW50LWlkJyk7XG4gICAgICAgICAgICAgIGNscy5zZXQoJ3VzZXJJZCcsICd0ZXN0LXVzZXItaWQnKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZSxcbiAgICAgICAgICB1c2VGYWN0b3J5OiAoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBpbm9Mb2dnZXJDb25maWdTZXJ2aWNlKCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IFBpbm9Mb2dnZXJGYWN0b3J5LFxuICAgICAgICAgIHVzZUZhY3Rvcnk6IChjb25maWdTZXJ2aWNlOiBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQaW5vTG9nZ2VyRmFjdG9yeShjb25maWdTZXJ2aWNlKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGluamVjdDogW1Bpbm9Mb2dnZXJDb25maWdTZXJ2aWNlXSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIHByb3ZpZGU6IFBpbm9Mb2dnZXJTZXJ2aWNlLFxuICAgICAgICAgIHVzZUZhY3Rvcnk6IChcbiAgICAgICAgICAgIGV2ZW50RW1pdHRlcjogRXZlbnRFbWl0dGVyMixcbiAgICAgICAgICAgIGNvbmZpZ1NlcnZpY2U6IFBpbm9Mb2dnZXJDb25maWdTZXJ2aWNlLFxuICAgICAgICAgICAgbG9nZ2VyRmFjdG9yeTogUGlub0xvZ2dlckZhY3RvcnksXG4gICAgICAgICAgICBjbHM6IENsc1NlcnZpY2UsXG4gICAgICAgICAgKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBpbm9Mb2dnZXJTZXJ2aWNlKFxuICAgICAgICAgICAgICBldmVudEVtaXR0ZXIsXG4gICAgICAgICAgICAgIGNvbmZpZ1NlcnZpY2UsXG4gICAgICAgICAgICAgIGxvZ2dlckZhY3RvcnksXG4gICAgICAgICAgICAgIGNscyxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBpbmplY3Q6IFtcbiAgICAgICAgICAgIEV2ZW50RW1pdHRlcjIsXG4gICAgICAgICAgICBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZSxcbiAgICAgICAgICAgIFBpbm9Mb2dnZXJGYWN0b3J5LFxuICAgICAgICAgICAgQ2xzU2VydmljZSxcbiAgICAgICAgICBdLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGlub0xvZ2dpbmdNaWRkbGV3YXJlLFxuICAgICAgICAgIHVzZUZhY3Rvcnk6IChsb2dnZXI6IFBpbm9Mb2dnZXJTZXJ2aWNlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBpbm9Mb2dnaW5nTWlkZGxld2FyZShsb2dnZXIpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgaW5qZWN0OiBbUGlub0xvZ2dlclNlcnZpY2VdLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcHJvdmlkZTogUGlub0xvZ2dpbmdJbnRlcmNlcHRvcixcbiAgICAgICAgICB1c2VGYWN0b3J5OiAobG9nZ2VyOiBQaW5vTG9nZ2VyU2VydmljZSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQaW5vTG9nZ2luZ0ludGVyY2VwdG9yKGxvZ2dlcik7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBpbmplY3Q6IFtQaW5vTG9nZ2VyU2VydmljZV0sXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcblxuICAgIGxvZ2dlclNlcnZpY2UgPSBtb2R1bGUuZ2V0PFBpbm9Mb2dnZXJTZXJ2aWNlPihQaW5vTG9nZ2VyU2VydmljZSk7XG4gICAgY29uZmlnU2VydmljZSA9IG1vZHVsZS5nZXQ8UGlub0xvZ2dlckNvbmZpZ1NlcnZpY2U+KFxuICAgICAgUGlub0xvZ2dlckNvbmZpZ1NlcnZpY2UsXG4gICAgKTtcbiAgICBsb2dnZXJGYWN0b3J5ID0gbW9kdWxlLmdldDxQaW5vTG9nZ2VyRmFjdG9yeT4oUGlub0xvZ2dlckZhY3RvcnkpO1xuICB9KTtcblxuICBhZnRlckFsbChhc3luYyAoKSA9PiB7XG4gICAgaWYgKG1vZHVsZSkge1xuICAgICAgYXdhaXQgbW9kdWxlLmNsb3NlKCk7XG4gICAgfVxuICB9KTtcblxuICBkZXNjcmliZSgnTW9kdWxlIEluaXRpYWxpemF0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICAgIGV4cGVjdChtb2R1bGUpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhdmUgUGlub0xvZ2dlclNlcnZpY2UnLCAoKSA9PiB7XG4gICAgICBleHBlY3QobG9nZ2VyU2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGF2ZSBQaW5vTG9nZ2VyQ29uZmlnU2VydmljZScsICgpID0+IHtcbiAgICAgIGV4cGVjdChjb25maWdTZXJ2aWNlKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBoYXZlIFBpbm9Mb2dnZXJGYWN0b3J5JywgKCkgPT4ge1xuICAgICAgZXhwZWN0KGxvZ2dlckZhY3RvcnkpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdQaW5vTG9nZ2VyU2VydmljZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGxvZyBkaWZmZXJlbnQgbGV2ZWxzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc3B5ID0gamVzdFxuICAgICAgICAuc3B5T24obG9nZ2VyU2VydmljZSBhcyBhbnksICdsb2cnKVxuICAgICAgICAubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IHVuZGVmaW5lZCk7XG5cbiAgICAgIGxvZ2dlclNlcnZpY2UuZGVidWcoJ0RlYnVnIG1lc3NhZ2UnLCBMb2dDb250ZXh0LlNZU1RFTSk7XG4gICAgICBsb2dnZXJTZXJ2aWNlLmluZm8oJ0luZm8gbWVzc2FnZScsIExvZ0NvbnRleHQuQlVTSU5FU1MpO1xuICAgICAgbG9nZ2VyU2VydmljZS53YXJuKCdXYXJuaW5nIG1lc3NhZ2UnLCBMb2dDb250ZXh0LkFVVEgpO1xuICAgICAgbG9nZ2VyU2VydmljZS5lcnJvcignRXJyb3IgbWVzc2FnZScsIExvZ0NvbnRleHQuU1lTVEVNKTtcblxuICAgICAgZXhwZWN0KHNweSkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDQpO1xuICAgICAgZXhwZWN0KHNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgICdkZWJ1ZycsXG4gICAgICAgICdEZWJ1ZyBtZXNzYWdlJyxcbiAgICAgICAgTG9nQ29udGV4dC5TWVNURU0sXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChzcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnaW5mbycsXG4gICAgICAgICdJbmZvIG1lc3NhZ2UnLFxuICAgICAgICBMb2dDb250ZXh0LkJVU0lORVNTLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICk7XG4gICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ3dhcm4nLFxuICAgICAgICAnV2FybmluZyBtZXNzYWdlJyxcbiAgICAgICAgTG9nQ29udGV4dC5BVVRILFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICk7XG4gICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2Vycm9yJyxcbiAgICAgICAgJ0Vycm9yIG1lc3NhZ2UnLFxuICAgICAgICBMb2dDb250ZXh0LlNZU1RFTSxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICApO1xuXG4gICAgICBzcHkubW9ja1Jlc3RvcmUoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbG9nIHdpdGggbWV0YWRhdGEnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzcHkgPSBqZXN0XG4gICAgICAgIC5zcHlPbihsb2dnZXJTZXJ2aWNlIGFzIGFueSwgJ2xvZycpXG4gICAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gdW5kZWZpbmVkKTtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0ge1xuICAgICAgICByZXF1ZXN0SWQ6ICd0ZXN0LXJlcXVlc3QtaWQnLFxuICAgICAgICB0ZW5hbnRJZDogJ3Rlc3QtdGVuYW50LWlkJyxcbiAgICAgICAgdXNlcklkOiAndGVzdC11c2VyLWlkJyxcbiAgICAgICAgb3BlcmF0aW9uOiAndGVzdC1vcGVyYXRpb24nLFxuICAgICAgfTtcblxuICAgICAgbG9nZ2VyU2VydmljZS5pbmZvKCdUZXN0IG1lc3NhZ2UnLCBMb2dDb250ZXh0LkJVU0lORVNTLCBtZXRhZGF0YSk7XG5cbiAgICAgIGV4cGVjdChzcHkpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICAnaW5mbycsXG4gICAgICAgICdUZXN0IG1lc3NhZ2UnLFxuICAgICAgICBMb2dDb250ZXh0LkJVU0lORVNTLFxuICAgICAgICBtZXRhZGF0YSxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgKTtcblxuICAgICAgc3B5Lm1vY2tSZXN0b3JlKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGxvZyBlcnJvcnMgd2l0aCBzdGFjayB0cmFjZScsICgpID0+IHtcbiAgICAgIGNvbnN0IHNweSA9IGplc3RcbiAgICAgICAgLnNweU9uKGxvZ2dlclNlcnZpY2UgYXMgYW55LCAnbG9nJylcbiAgICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB1bmRlZmluZWQpO1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoJ1Rlc3QgZXJyb3InKTtcblxuICAgICAgbG9nZ2VyU2VydmljZS5lcnJvcihcbiAgICAgICAgJ0Vycm9yIG9jY3VycmVkJyxcbiAgICAgICAgTG9nQ29udGV4dC5TWVNURU0sXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuXG4gICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2Vycm9yJyxcbiAgICAgICAgJ0Vycm9yIG9jY3VycmVkJyxcbiAgICAgICAgTG9nQ29udGV4dC5TWVNURU0sXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgZXJyb3IsXG4gICAgICApO1xuXG4gICAgICBzcHkubW9ja1Jlc3RvcmUoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbG9nIHBlcmZvcm1hbmNlIG1ldHJpY3MnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzcHkgPSBqZXN0XG4gICAgICAgIC5zcHlPbihsb2dnZXJTZXJ2aWNlIGFzIGFueSwgJ2xvZycpXG4gICAgICAgIC5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gdW5kZWZpbmVkKTtcblxuICAgICAgbG9nZ2VyU2VydmljZS5wZXJmb3JtYW5jZSgndGVzdC1vcGVyYXRpb24nLCAxNTAsIExvZ0NvbnRleHQuUEVSRk9STUFOQ0UpO1xuXG4gICAgICBleHBlY3Qoc3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ2luZm8nLFxuICAgICAgICAnUGVyZm9ybWFuY2U6IHRlc3Qtb3BlcmF0aW9uIHRvb2sgMTUwbXMnLFxuICAgICAgICBMb2dDb250ZXh0LlBFUkZPUk1BTkNFLFxuICAgICAgICB7XG4gICAgICAgICAgb3BlcmF0aW9uOiAndGVzdC1vcGVyYXRpb24nLFxuICAgICAgICAgIGR1cmF0aW9uOiAxNTAsXG4gICAgICAgICAgdHlwZTogJ3BlcmZvcm1hbmNlJyxcbiAgICAgICAgfSxcbiAgICAgICk7XG5cbiAgICAgIHNweS5tb2NrUmVzdG9yZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgY2hpbGQgbG9nZ2VyJywgKCkgPT4ge1xuICAgICAgY29uc3QgY2hpbGRMb2dnZXIgPSBsb2dnZXJTZXJ2aWNlLmNoaWxkKExvZ0NvbnRleHQuQlVTSU5FU1MsIHtcbiAgICAgICAgdGVuYW50SWQ6ICdjaGlsZC10ZW5hbnQnLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoY2hpbGRMb2dnZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY2hpbGRMb2dnZXIpLnRvSGF2ZVByb3BlcnR5KCdpbmZvJyk7XG4gICAgICBleHBlY3QoY2hpbGRMb2dnZXIpLnRvSGF2ZVByb3BlcnR5KCdlcnJvcicpO1xuICAgICAgZXhwZWN0KGNoaWxkTG9nZ2VyKS50b0hhdmVQcm9wZXJ0eSgnd2FybicpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBnZXQgYW5kIHNldCBsb2cgbGV2ZWwnLCAoKSA9PiB7XG4gICAgICBjb25zdCBvcmlnaW5hbExldmVsID0gbG9nZ2VyU2VydmljZS5nZXRMZXZlbCgpO1xuXG4gICAgICBsb2dnZXJTZXJ2aWNlLnNldExldmVsKCdkZWJ1ZycpO1xuICAgICAgZXhwZWN0KGxvZ2dlclNlcnZpY2UuZ2V0TGV2ZWwoKSkudG9CZSgnZGVidWcnKTtcblxuICAgICAgbG9nZ2VyU2VydmljZS5zZXRMZXZlbChvcmlnaW5hbExldmVsKTtcbiAgICAgIGV4cGVjdChsb2dnZXJTZXJ2aWNlLmdldExldmVsKCkpLnRvQmUob3JpZ2luYWxMZXZlbCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGdldCBzdGF0cycsICgpID0+IHtcbiAgICAgIGNvbnN0IHN0YXRzID0gbG9nZ2VyU2VydmljZS5nZXRTdGF0cygpO1xuICAgICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgndG90YWxMb2dzJyk7XG4gICAgICBleHBlY3Qoc3RhdHMpLnRvSGF2ZVByb3BlcnR5KCdsb2dzQnlMZXZlbCcpO1xuICAgICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgnbG9nc0J5Q29udGV4dCcpO1xuICAgICAgZXhwZWN0KHN0YXRzKS50b0hhdmVQcm9wZXJ0eSgnYXZlcmFnZUxvZ1NpemUnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Bpbm9Mb2dnZXJDb25maWdTZXJ2aWNlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZ2V0IGRlZmF1bHQgY29uZmlnJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0gY29uZmlnU2VydmljZS5nZXRDb25maWcoKTtcbiAgICAgIGV4cGVjdChjb25maWcpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnKS50b0hhdmVQcm9wZXJ0eSgnbGV2ZWwnKTtcbiAgICAgIGV4cGVjdChjb25maWcpLnRvSGF2ZVByb3BlcnR5KCdmb3JtYXQnKTtcbiAgICAgIGV4cGVjdChjb25maWcpLnRvSGF2ZVByb3BlcnR5KCd0aW1lc3RhbXAnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdXBkYXRlIGNvbmZpZycsICgpID0+IHtcbiAgICAgIGNvbnN0IG9yaWdpbmFsQ29uZmlnID0gY29uZmlnU2VydmljZS5nZXRDb25maWcoKTtcbiAgICAgIGNvbnN0IG5ld0NvbmZpZyA9IHsgbGV2ZWw6ICdkZWJ1ZycgYXMgTG9nTGV2ZWwgfTtcblxuICAgICAgY29uZmlnU2VydmljZS51cGRhdGVDb25maWcobmV3Q29uZmlnKTtcbiAgICAgIGV4cGVjdChjb25maWdTZXJ2aWNlLmdldExldmVsKCkpLnRvQmUoJ2RlYnVnJyk7XG5cbiAgICAgIC8vIOaBouWkjeWOn+Wni+mFjee9rlxuICAgICAgY29uZmlnU2VydmljZS51cGRhdGVDb25maWcob3JpZ2luYWxDb25maWcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZXRlY3QgZW52aXJvbm1lbnQnLCAoKSA9PiB7XG4gICAgICBjb25zdCBpc0RldiA9IGNvbmZpZ1NlcnZpY2UuaXNEZXZlbG9wbWVudCgpO1xuICAgICAgY29uc3QgaXNQcm9kID0gY29uZmlnU2VydmljZS5pc1Byb2R1Y3Rpb24oKTtcblxuICAgICAgZXhwZWN0KHR5cGVvZiBpc0RldikudG9CZSgnYm9vbGVhbicpO1xuICAgICAgZXhwZWN0KHR5cGVvZiBpc1Byb2QpLnRvQmUoJ2Jvb2xlYW4nKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1Bpbm9Mb2dnZXJGYWN0b3J5JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY3JlYXRlIGxvZ2dlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IGxvZ2dlciA9IGxvZ2dlckZhY3RvcnkuY3JlYXRlTG9nZ2VyKCk7XG4gICAgICBleHBlY3QobG9nZ2VyKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGxvZ2dlcikudG9IYXZlUHJvcGVydHkoJ2luZm8nKTtcbiAgICAgIGV4cGVjdChsb2dnZXIpLnRvSGF2ZVByb3BlcnR5KCdlcnJvcicpO1xuICAgICAgZXhwZWN0KGxvZ2dlcikudG9IYXZlUHJvcGVydHkoJ3dhcm4nKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY3JlYXRlIGNoaWxkIGxvZ2dlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IHBhcmVudExvZ2dlciA9IGxvZ2dlckZhY3RvcnkuY3JlYXRlTG9nZ2VyKCk7XG4gICAgICBjb25zdCBjaGlsZExvZ2dlciA9IGxvZ2dlckZhY3RvcnkuY3JlYXRlQ2hpbGRMb2dnZXIocGFyZW50TG9nZ2VyLCB7XG4gICAgICAgIGNvbnRleHQ6ICd0ZXN0JyxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QoY2hpbGRMb2dnZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY2hpbGRMb2dnZXIpLnRvSGF2ZVByb3BlcnR5KCdpbmZvJyk7XG4gICAgICBleHBlY3QoY2hpbGRMb2dnZXIpLnRvSGF2ZVByb3BlcnR5KCdlcnJvcicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnTG9nZ2luZyBNaWRkbGV3YXJlIGFuZCBJbnRlcmNlcHRvcicsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGhhdmUgbWlkZGxld2FyZSBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgbWlkZGxld2FyZSA9IG1vZHVsZS5nZXQ8UGlub0xvZ2dpbmdNaWRkbGV3YXJlPihcbiAgICAgICAgUGlub0xvZ2dpbmdNaWRkbGV3YXJlLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChtaWRkbGV3YXJlKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KG1pZGRsZXdhcmUpLnRvSGF2ZVByb3BlcnR5KCd1c2UnKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGF2ZSBpbnRlcmNlcHRvciBkZWZpbmVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgaW50ZXJjZXB0b3IgPSBtb2R1bGUuZ2V0PFBpbm9Mb2dnaW5nSW50ZXJjZXB0b3I+KFxuICAgICAgICBQaW5vTG9nZ2luZ0ludGVyY2VwdG9yLFxuICAgICAgKTtcbiAgICAgIGV4cGVjdChpbnRlcmNlcHRvcikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChpbnRlcmNlcHRvcikudG9IYXZlUHJvcGVydHkoJ2ludGVyY2VwdCcpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sInZlcnNpb24iOjN9