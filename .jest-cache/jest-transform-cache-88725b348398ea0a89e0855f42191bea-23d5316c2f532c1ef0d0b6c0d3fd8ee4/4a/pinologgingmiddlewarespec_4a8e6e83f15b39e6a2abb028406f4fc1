60615b225dda5856ef16a1a9814e5f54
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const testing_1 = require("@nestjs/testing");
const pino_logging_middleware_1 = require("./pino-logging.middleware");
const pino_logger_service_1 = require("../services/pino-logger.service");
const logging_interface_1 = require("../interfaces/logging.interface");
describe('PinoLoggingMiddleware', () => {
    let middleware;
    let logger;
    let mockRequest;
    let mockResponse;
    let nextFunction;
    beforeEach(async () => {
        const mockLogger = {
            info: jest.fn(),
            warn: jest.fn(),
            error: jest.fn(),
            performance: jest.fn(),
        };
        const module = await testing_1.Test.createTestingModule({
            providers: [
                {
                    provide: pino_logging_middleware_1.PinoLoggingMiddleware,
                    useFactory: (logger) => {
                        return new pino_logging_middleware_1.PinoLoggingMiddleware(logger);
                    },
                    inject: [pino_logger_service_1.PinoLoggerService],
                },
                {
                    provide: pino_logger_service_1.PinoLoggerService,
                    useValue: mockLogger,
                },
            ],
        }).compile();
        middleware = module.get(pino_logging_middleware_1.PinoLoggingMiddleware);
        logger = module.get(pino_logger_service_1.PinoLoggerService);
        // 重置模拟
        jest.clearAllMocks();
    });
    beforeEach(() => {
        // 设置模拟请求
        mockRequest = {
            method: 'GET',
            url: '/api/users',
            headers: {
                'user-agent': 'Mozilla/5.0',
                'x-tenant-id': 'tenant-123',
                'x-user-id': 'user-456',
                authorization: 'Bearer token123',
            },
            query: { page: '1', limit: '10' },
            body: { name: 'test' },
            ip: '192.168.1.1',
            socket: { remoteAddress: '192.168.1.1' },
        };
        // 设置模拟响应
        mockResponse = {
            statusCode: 200,
            send: jest.fn().mockReturnThis(),
        };
        nextFunction = jest.fn();
    });
    it('should be defined', () => {
        expect(middleware).toBeDefined();
    });
    describe('request logging', () => {
        it('should log request information', () => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith('HTTP Request', logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                method: 'GET',
                url: '/api/users',
                userAgent: 'Mozilla/5.0',
                tenantId: 'tenant-123',
                userId: 'user-456',
                ip: '192.168.1.1',
                requestId: expect.unknown(String),
                headers: expect.objectContaining({
                    authorization: '***REDACTED***',
                    'user-agent': 'Mozilla/5.0',
                }),
                query: { page: '1', limit: '10' },
                body: { name: 'test' },
            }));
            expect(nextFunction).toHaveBeenCalled();
        });
        it('should generate unique request ID', () => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                requestId: expect.unknown(String),
            }));
        });
        it('should extract tenant ID from different sources', () => {
            // 测试从查询参数提取
            mockRequest.query = { tenantId: 'query-tenant' };
            mockRequest.headers = { 'user-agent': 'Mozilla/5.0' };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                tenantId: 'query-tenant',
            }));
        });
        it('should extract user ID from different sources', () => {
            // 测试从请求体提取
            mockRequest.body = { userId: 'body-user' };
            mockRequest.headers = { 'user-agent': 'Mozilla/5.0' };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                userId: 'body-user',
            }));
        });
    });
    describe('response logging', () => {
        it('should log successful response', done => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            // 模拟响应发送 - 直接调用重写后的send方法
            mockResponse.send?.('response data');
            // 等待异步日志记录
            setTimeout(() => {
                expect(logger.info).toHaveBeenCalledWith('HTTP Response', logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                    duration: expect.unknown(Number),
                    statusCode: 200,
                }));
                done();
            }, 10);
        });
        it('should log error response as warning', done => {
            mockResponse.statusCode = 404;
            middleware.use(mockRequest, mockResponse, nextFunction);
            // 模拟响应发送
            mockResponse.send?.('error response');
            // 等待异步日志记录
            setTimeout(() => {
                expect(logger.warn).toHaveBeenCalledWith('HTTP Response', logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                    statusCode: 404,
                }));
                done();
            }, 10);
        });
        it('should capture response size', done => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            // 模拟响应发送
            mockResponse.send?.('response data');
            // 等待异步日志记录
            setTimeout(() => {
                expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                    duration: expect.unknown(Number),
                }));
                done();
            }, 10);
        });
    });
    describe('security features', () => {
        it('should sanitize sensitive headers', () => {
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                headers: expect.objectContaining({
                    authorization: '***REDACTED***',
                    'user-agent': 'Mozilla/5.0',
                }),
            }));
        });
        it('should sanitize sensitive body fields', () => {
            mockRequest.body = {
                username: 'testuser',
                password: 'secret123',
                token: 'jwt-token',
                email: 'test@example.com',
            };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                body: expect.objectContaining({
                    username: 'testuser',
                    password: '***REDACTED***',
                    token: '***REDACTED***',
                    email: 'test@example.com',
                }),
            }));
        });
    });
    describe('client IP detection', () => {
        it('should detect IP from X-Forwarded-For header', () => {
            mockRequest = {
                ...mockRequest,
                headers: {
                    'x-forwarded-for': '192.168.1.100',
                    'user-agent': 'Mozilla/5.0',
                },
                ip: undefined,
            };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                ip: '192.168.1.100',
                tenantId: undefined,
                userId: undefined,
            }));
        });
        it('should fallback to connection remote address', () => {
            mockRequest = {
                ...mockRequest,
                headers: { 'user-agent': 'Mozilla/5.0' },
                ip: undefined,
                socket: { remoteAddress: '192.168.1.200' },
            };
            middleware.use(mockRequest, mockResponse, nextFunction);
            expect(logger.info).toHaveBeenCalledWith(expect.unknown(String), logging_interface_1.LogContext.HTTP_REQUEST, expect.objectContaining({
                ip: '192.168.1.200',
            }));
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvbG9nZ2luZy9zcmMvbWlkZGxld2FyZS9waW5vLWxvZ2dpbmcubWlkZGxld2FyZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsNkNBQXNEO0FBRXRELHVFQUFrRTtBQUNsRSx5RUFBb0U7QUFDcEUsdUVBQTZEO0FBRTdELFFBQVEsQ0FBQyx1QkFBdUIsRUFBRSxHQUFHLEVBQUU7SUFDckMsSUFBSSxVQUFpQyxDQUFDO0lBQ3RDLElBQUksTUFBeUIsQ0FBQztJQUM5QixJQUFJLFdBQW9DLENBQUM7SUFDekMsSUFBSSxZQUFtQyxDQUFDO0lBQ3hDLElBQUksWUFBdUIsQ0FBQztJQUU1QixVQUFVLENBQUMsS0FBSyxJQUFJLEVBQUU7UUFDcEIsTUFBTSxVQUFVLEdBQUc7WUFDakIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2hCLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3ZCLENBQUM7UUFFRixNQUFNLE1BQU0sR0FBa0IsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDM0QsU0FBUyxFQUFFO2dCQUNUO29CQUNFLE9BQU8sRUFBRSwrQ0FBcUI7b0JBQzlCLFVBQVUsRUFBRSxDQUFDLE1BQXlCLEVBQUUsRUFBRTt3QkFDeEMsT0FBTyxJQUFJLCtDQUFxQixDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUMzQyxDQUFDO29CQUNELE1BQU0sRUFBRSxDQUFDLHVDQUFpQixDQUFDO2lCQUM1QjtnQkFDRDtvQkFDRSxPQUFPLEVBQUUsdUNBQWlCO29CQUMxQixRQUFRLEVBQUUsVUFBVTtpQkFDckI7YUFDRjtTQUNGLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUViLFVBQVUsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUF3QiwrQ0FB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Q0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsOEJBQVUsQ0FBQyxZQUFZLEVBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsRUFBRSxFQUFFLGVBQWU7Z0JBQ25CLFFBQVEsRUFBRSxTQUFTO2dCQUNuQixNQUFNLEVBQUUsU0FBUzthQUNsQixDQUFDLENBQ0gsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLDhDQUE4QyxFQUFFLEdBQUcsRUFBRTtZQUN0RCxXQUFXLEdBQUc7Z0JBQ1osR0FBRyxXQUFXO2dCQUNkLE9BQU8sRUFBRSxFQUFFLFlBQVksRUFBRSxhQUFhLEVBQUU7Z0JBQ3hDLEVBQUUsRUFBRSxTQUFTO2dCQUNiLE1BQU0sRUFBRSxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQWE7YUFDM0IsQ0FBQztZQUU3QixVQUFVLENBQUMsR0FBRyxDQUNaLFdBQTZCLEVBQzdCLFlBQTRCLEVBQzVCLFlBQVksQ0FDYixDQUFDO1lBRUYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxvQkFBb0IsQ0FDdEMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDdEIsOEJBQVUsQ0FBQyxZQUFZLEVBQ3ZCLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztnQkFDdEIsRUFBRSxFQUFFLGVBQWU7YUFDcEIsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvbG9nZ2luZy9zcmMvbWlkZGxld2FyZS9waW5vLWxvZ2dpbmcubWlkZGxld2FyZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRlc3QsIFRlc3RpbmdNb2R1bGUgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuaW1wb3J0IHsgRmFzdGlmeVJlcXVlc3QsIEZhc3RpZnlSZXBseSB9IGZyb20gJ2Zhc3RpZnknO1xuaW1wb3J0IHsgUGlub0xvZ2dpbmdNaWRkbGV3YXJlIH0gZnJvbSAnLi9waW5vLWxvZ2dpbmcubWlkZGxld2FyZSc7XG5pbXBvcnQgeyBQaW5vTG9nZ2VyU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3Bpbm8tbG9nZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9nQ29udGV4dCB9IGZyb20gJy4uL2ludGVyZmFjZXMvbG9nZ2luZy5pbnRlcmZhY2UnO1xuXG5kZXNjcmliZSgnUGlub0xvZ2dpbmdNaWRkbGV3YXJlJywgKCkgPT4ge1xuICBsZXQgbWlkZGxld2FyZTogUGlub0xvZ2dpbmdNaWRkbGV3YXJlO1xuICBsZXQgbG9nZ2VyOiBQaW5vTG9nZ2VyU2VydmljZTtcbiAgbGV0IG1vY2tSZXF1ZXN0OiBQYXJ0aWFsPEZhc3RpZnlSZXF1ZXN0PjtcbiAgbGV0IG1vY2tSZXNwb25zZTogUGFydGlhbDxGYXN0aWZ5UmVwbHk+O1xuICBsZXQgbmV4dEZ1bmN0aW9uOiBqZXN0Lk1vY2s7XG5cbiAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgbW9ja0xvZ2dlciA9IHtcbiAgICAgIGluZm86IGplc3QuZm4oKSxcbiAgICAgIHdhcm46IGplc3QuZm4oKSxcbiAgICAgIGVycm9yOiBqZXN0LmZuKCksXG4gICAgICBwZXJmb3JtYW5jZTogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQaW5vTG9nZ2luZ01pZGRsZXdhcmUsXG4gICAgICAgICAgdXNlRmFjdG9yeTogKGxvZ2dlcjogUGlub0xvZ2dlclNlcnZpY2UpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgUGlub0xvZ2dpbmdNaWRkbGV3YXJlKGxvZ2dlcik7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBpbmplY3Q6IFtQaW5vTG9nZ2VyU2VydmljZV0sXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwcm92aWRlOiBQaW5vTG9nZ2VyU2VydmljZSxcbiAgICAgICAgICB1c2VWYWx1ZTogbW9ja0xvZ2dlcixcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfSkuY29tcGlsZSgpO1xuXG4gICAgbWlkZGxld2FyZSA9IG1vZHVsZS5nZXQ8UGlub0xvZ2dpbmdNaWRkbGV3YXJlPihQaW5vTG9nZ2luZ01pZGRsZXdhcmUpO1xuICAgIGxvZ2dlciA9IG1vZHVsZS5nZXQ8UGlub0xvZ2dlclNlcnZpY2U+KFBpbm9Mb2dnZXJTZXJ2aWNlKTtcblxuICAgIC8vIOmHjee9ruaooeaLn1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyDorr7nva7mqKHmi5/or7fmsYJcbiAgICBtb2NrUmVxdWVzdCA9IHtcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICB1cmw6ICcvYXBpL3VzZXJzJyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ3VzZXItYWdlbnQnOiAnTW96aWxsYS81LjAnLFxuICAgICAgICAneC10ZW5hbnQtaWQnOiAndGVuYW50LTEyMycsXG4gICAgICAgICd4LXVzZXItaWQnOiAndXNlci00NTYnLFxuICAgICAgICBhdXRob3JpemF0aW9uOiAnQmVhcmVyIHRva2VuMTIzJyxcbiAgICAgIH0sXG4gICAgICBxdWVyeTogeyBwYWdlOiAnMScsIGxpbWl0OiAnMTAnIH0sXG4gICAgICBib2R5OiB7IG5hbWU6ICd0ZXN0JyB9LFxuICAgICAgaXA6ICcxOTIuMTY4LjEuMScsXG4gICAgICBzb2NrZXQ6IHsgcmVtb3RlQWRkcmVzczogJzE5Mi4xNjguMS4xJyB9IGFzIHVua25vd24sXG4gICAgfSBhcyBQYXJ0aWFsPEZhc3RpZnlSZXF1ZXN0PjtcblxuICAgIC8vIOiuvue9ruaooeaLn+WTjeW6lFxuICAgIG1vY2tSZXNwb25zZSA9IHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIHNlbmQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIH0gYXMgUGFydGlhbDxGYXN0aWZ5UmVwbHk+O1xuXG4gICAgbmV4dEZ1bmN0aW9uID0gamVzdC5mbigpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGJlIGRlZmluZWQnLCAoKSA9PiB7XG4gICAgZXhwZWN0KG1pZGRsZXdhcmUpLnRvQmVEZWZpbmVkKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdyZXF1ZXN0IGxvZ2dpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBsb2cgcmVxdWVzdCBpbmZvcm1hdGlvbicsICgpID0+IHtcbiAgICAgIG1pZGRsZXdhcmUudXNlKFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBGYXN0aWZ5UmVxdWVzdCxcbiAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIEZhc3RpZnlSZXBseSxcbiAgICAgICAgbmV4dEZ1bmN0aW9uLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgJ0hUVFAgUmVxdWVzdCcsXG4gICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICB1cmw6ICcvYXBpL3VzZXJzJyxcbiAgICAgICAgICB1c2VyQWdlbnQ6ICdNb3ppbGxhLzUuMCcsXG4gICAgICAgICAgdGVuYW50SWQ6ICd0ZW5hbnQtMTIzJyxcbiAgICAgICAgICB1c2VySWQ6ICd1c2VyLTQ1NicsXG4gICAgICAgICAgaXA6ICcxOTIuMTY4LjEuMScsXG4gICAgICAgICAgcmVxdWVzdElkOiBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICAgIGhlYWRlcnM6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb246ICcqKipSRURBQ1RFRCoqKicsXG4gICAgICAgICAgICAndXNlci1hZ2VudCc6ICdNb3ppbGxhLzUuMCcsXG4gICAgICAgICAgfSksXG4gICAgICAgICAgcXVlcnk6IHsgcGFnZTogJzEnLCBsaW1pdDogJzEwJyB9LFxuICAgICAgICAgIGJvZHk6IHsgbmFtZTogJ3Rlc3QnIH0sXG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KG5leHRGdW5jdGlvbikudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBnZW5lcmF0ZSB1bmlxdWUgcmVxdWVzdCBJRCcsICgpID0+IHtcbiAgICAgIG1pZGRsZXdhcmUudXNlKFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBGYXN0aWZ5UmVxdWVzdCxcbiAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIEZhc3RpZnlSZXBseSxcbiAgICAgICAgbmV4dEZ1bmN0aW9uLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnVua25vd24oU3RyaW5nKSxcbiAgICAgICAgTG9nQ29udGV4dC5IVFRQX1JFUVVFU1QsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICByZXF1ZXN0SWQ6IGV4cGVjdC51bmtub3duKFN0cmluZyksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCB0ZW5hbnQgSUQgZnJvbSBkaWZmZXJlbnQgc291cmNlcycsICgpID0+IHtcbiAgICAgIC8vIOa1i+ivleS7juafpeivouWPguaVsOaPkOWPllxuICAgICAgbW9ja1JlcXVlc3QucXVlcnkgPSB7IHRlbmFudElkOiAncXVlcnktdGVuYW50JyB9O1xuICAgICAgbW9ja1JlcXVlc3QuaGVhZGVycyA9IHsgJ3VzZXItYWdlbnQnOiAnTW96aWxsYS81LjAnIH07XG5cbiAgICAgIG1pZGRsZXdhcmUudXNlKFxuICAgICAgICBtb2NrUmVxdWVzdCBhcyBGYXN0aWZ5UmVxdWVzdCxcbiAgICAgICAgbW9ja1Jlc3BvbnNlIGFzIEZhc3RpZnlSZXBseSxcbiAgICAgICAgbmV4dEZ1bmN0aW9uLFxuICAgICAgKTtcblxuICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LnVua25vd24oU3RyaW5nKSxcbiAgICAgICAgTG9nQ29udGV4dC5IVFRQX1JFUVVFU1QsXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICB0ZW5hbnRJZDogJ3F1ZXJ5LXRlbmFudCcsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCB1c2VyIElEIGZyb20gZGlmZmVyZW50IHNvdXJjZXMnLCAoKSA9PiB7XG4gICAgICAvLyDmtYvor5Xku47or7fmsYLkvZPmj5Dlj5ZcbiAgICAgIG1vY2tSZXF1ZXN0LmJvZHkgPSB7IHVzZXJJZDogJ2JvZHktdXNlcicgfTtcbiAgICAgIG1vY2tSZXF1ZXN0LmhlYWRlcnMgPSB7ICd1c2VyLWFnZW50JzogJ01vemlsbGEvNS4wJyB9O1xuXG4gICAgICBtaWRkbGV3YXJlLnVzZShcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgRmFzdGlmeVJlcXVlc3QsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyBGYXN0aWZ5UmVwbHksXG4gICAgICAgIG5leHRGdW5jdGlvbixcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC51bmtub3duKFN0cmluZyksXG4gICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgdXNlcklkOiAnYm9keS11c2VyJyxcbiAgICAgICAgfSksXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncmVzcG9uc2UgbG9nZ2luZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGxvZyBzdWNjZXNzZnVsIHJlc3BvbnNlJywgZG9uZSA9PiB7XG4gICAgICBtaWRkbGV3YXJlLnVzZShcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgRmFzdGlmeVJlcXVlc3QsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyBGYXN0aWZ5UmVwbHksXG4gICAgICAgIG5leHRGdW5jdGlvbixcbiAgICAgICk7XG5cbiAgICAgIC8vIOaooeaLn+WTjeW6lOWPkemAgSAtIOebtOaOpeiwg+eUqOmHjeWGmeWQjueahHNlbmTmlrnms5VcbiAgICAgIG1vY2tSZXNwb25zZS5zZW5kPy4oJ3Jlc3BvbnNlIGRhdGEnKTtcblxuICAgICAgLy8g562J5b6F5byC5q2l5pel5b+X6K6w5b2VXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICAnSFRUUCBSZXNwb25zZScsXG4gICAgICAgICAgTG9nQ29udGV4dC5IVFRQX1JFUVVFU1QsXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgZHVyYXRpb246IGV4cGVjdC51bmtub3duKE51bWJlciksXG4gICAgICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgICAgIGRvbmUoKTtcbiAgICAgIH0sIDEwKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgbG9nIGVycm9yIHJlc3BvbnNlIGFzIHdhcm5pbmcnLCBkb25lID0+IHtcbiAgICAgIG1vY2tSZXNwb25zZS5zdGF0dXNDb2RlID0gNDA0O1xuXG4gICAgICBtaWRkbGV3YXJlLnVzZShcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgRmFzdGlmeVJlcXVlc3QsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyBGYXN0aWZ5UmVwbHksXG4gICAgICAgIG5leHRGdW5jdGlvbixcbiAgICAgICk7XG5cbiAgICAgIC8vIOaooeaLn+WTjeW6lOWPkemAgVxuICAgICAgbW9ja1Jlc3BvbnNlLnNlbmQ/LignZXJyb3IgcmVzcG9uc2UnKTtcblxuICAgICAgLy8g562J5b6F5byC5q2l5pel5b+X6K6w5b2VXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgZXhwZWN0KGxvZ2dlci53YXJuKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICAnSFRUUCBSZXNwb25zZScsXG4gICAgICAgICAgTG9nQ29udGV4dC5IVFRQX1JFUVVFU1QsXG4gICAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9LCAxMCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNhcHR1cmUgcmVzcG9uc2Ugc2l6ZScsIGRvbmUgPT4ge1xuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICAvLyDmqKHmi5/lk43lupTlj5HpgIFcbiAgICAgIG1vY2tSZXNwb25zZS5zZW5kPy4oJ3Jlc3BvbnNlIGRhdGEnKTtcblxuICAgICAgLy8g562J5b6F5byC5q2l5pel5b+X6K6w5b2VXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgZXhwZWN0KGxvZ2dlci5pbmZvKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgICBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgIGR1cmF0aW9uOiBleHBlY3QudW5rbm93bihOdW1iZXIpLFxuICAgICAgICAgIH0pLFxuICAgICAgICApO1xuICAgICAgICBkb25lKCk7XG4gICAgICB9LCAxMCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzZWN1cml0eSBmZWF0dXJlcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHNhbml0aXplIHNlbnNpdGl2ZSBoZWFkZXJzJywgKCkgPT4ge1xuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICBMb2dDb250ZXh0LkhUVFBfUkVRVUVTVCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGhlYWRlcnM6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgIGF1dGhvcml6YXRpb246ICcqKipSRURBQ1RFRCoqKicsXG4gICAgICAgICAgICAndXNlci1hZ2VudCc6ICdNb3ppbGxhLzUuMCcsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgc2FuaXRpemUgc2Vuc2l0aXZlIGJvZHkgZmllbGRzJywgKCkgPT4ge1xuICAgICAgbW9ja1JlcXVlc3QuYm9keSA9IHtcbiAgICAgICAgdXNlcm5hbWU6ICd0ZXN0dXNlcicsXG4gICAgICAgIHBhc3N3b3JkOiAnc2VjcmV0MTIzJyxcbiAgICAgICAgdG9rZW46ICdqd3QtdG9rZW4nLFxuICAgICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgfTtcblxuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICBMb2dDb250ZXh0LkhUVFBfUkVRVUVTVCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGJvZHk6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICAgIHVzZXJuYW1lOiAndGVzdHVzZXInLFxuICAgICAgICAgICAgcGFzc3dvcmQ6ICcqKipSRURBQ1RFRCoqKicsXG4gICAgICAgICAgICB0b2tlbjogJyoqKlJFREFDVEVEKioqJyxcbiAgICAgICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NsaWVudCBJUCBkZXRlY3Rpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBkZXRlY3QgSVAgZnJvbSBYLUZvcndhcmRlZC1Gb3IgaGVhZGVyJywgKCkgPT4ge1xuICAgICAgbW9ja1JlcXVlc3QgPSB7XG4gICAgICAgIC4uLm1vY2tSZXF1ZXN0LFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ3gtZm9yd2FyZGVkLWZvcic6ICcxOTIuMTY4LjEuMTAwJyxcbiAgICAgICAgICAndXNlci1hZ2VudCc6ICdNb3ppbGxhLzUuMCcsXG4gICAgICAgIH0sXG4gICAgICAgIGlwOiB1bmRlZmluZWQsXG4gICAgICB9IGFzIFBhcnRpYWw8RmFzdGlmeVJlcXVlc3Q+O1xuXG4gICAgICBtaWRkbGV3YXJlLnVzZShcbiAgICAgICAgbW9ja1JlcXVlc3QgYXMgRmFzdGlmeVJlcXVlc3QsXG4gICAgICAgIG1vY2tSZXNwb25zZSBhcyBGYXN0aWZ5UmVwbHksXG4gICAgICAgIG5leHRGdW5jdGlvbixcbiAgICAgICk7XG5cbiAgICAgIGV4cGVjdChsb2dnZXIuaW5mbykudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC51bmtub3duKFN0cmluZyksXG4gICAgICAgIExvZ0NvbnRleHQuSFRUUF9SRVFVRVNULFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgaXA6ICcxOTIuMTY4LjEuMTAwJyxcbiAgICAgICAgICB0ZW5hbnRJZDogdW5kZWZpbmVkLFxuICAgICAgICAgIHVzZXJJZDogdW5kZWZpbmVkLFxuICAgICAgICB9KSxcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZhbGxiYWNrIHRvIGNvbm5lY3Rpb24gcmVtb3RlIGFkZHJlc3MnLCAoKSA9PiB7XG4gICAgICBtb2NrUmVxdWVzdCA9IHtcbiAgICAgICAgLi4ubW9ja1JlcXVlc3QsXG4gICAgICAgIGhlYWRlcnM6IHsgJ3VzZXItYWdlbnQnOiAnTW96aWxsYS81LjAnIH0sXG4gICAgICAgIGlwOiB1bmRlZmluZWQsXG4gICAgICAgIHNvY2tldDogeyByZW1vdGVBZGRyZXNzOiAnMTkyLjE2OC4xLjIwMCcgfSBhcyB1bmtub3duLFxuICAgICAgfSBhcyBQYXJ0aWFsPEZhc3RpZnlSZXF1ZXN0PjtcblxuICAgICAgbWlkZGxld2FyZS51c2UoXG4gICAgICAgIG1vY2tSZXF1ZXN0IGFzIEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgICBtb2NrUmVzcG9uc2UgYXMgRmFzdGlmeVJlcGx5LFxuICAgICAgICBuZXh0RnVuY3Rpb24sXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobG9nZ2VyLmluZm8pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QudW5rbm93bihTdHJpbmcpLFxuICAgICAgICBMb2dDb250ZXh0LkhUVFBfUkVRVUVTVCxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIGlwOiAnMTkyLjE2OC4xLjIwMCcsXG4gICAgICAgIH0pLFxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==