{"file":"/home/arligle/V1/Aiofix/aiofix-ai-saas-platform/packages/database/src/config/database.config.spec.ts","mappings":"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","names":[],"sources":["/home/arligle/V1/Aiofix/aiofix-ai-saas-platform/packages/database/src/config/database.config.spec.ts"],"sourcesContent":["/**\n * @file database.config.spec.ts\n * @description 数据库配置服务单元测试\n */\n\nimport { Test, TestingModule } from '@nestjs/testing';\nimport { ConfigModule, ConfigService } from '@nestjs/config';\nimport { DatabaseConfigService } from './database.config';\n\ndescribe('DatabaseConfigService', () => {\n  let service: DatabaseConfigService;\n  let configService: ConfigService;\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      imports: [ConfigModule],\n      providers: [DatabaseConfigService],\n    }).compile();\n\n    service = module.get<DatabaseConfigService>(DatabaseConfigService);\n    configService = module.get<ConfigService>(ConfigService);\n  });\n\n  describe('getPostgreSQLConfig', () => {\n    it('should return default PostgreSQL configuration', () => {\n      // 模拟环境变量未设置\n      jest.spyOn(configService, 'get').mockReturnValue(undefined);\n\n      const config = service.getPostgreSQLConfig();\n\n      expect(config).toEqual({\n        type: 'postgresql',\n        host: 'localhost',\n        port: 5432,\n        username: 'aiofix_user',\n        password: 'aiofix_password',\n        database: 'aiofix_platform',\n        ssl: false,\n        pool: {\n          min: 2,\n          max: 10,\n          acquireTimeoutMillis: 60000,\n          createTimeoutMillis: 30000,\n          destroyTimeoutMillis: 5000,\n          idleTimeoutMillis: 600000,\n          reapIntervalMillis: 1000,\n          createRetryIntervalMillis: 200,\n        },\n      });\n    });\n\n    it('should return configured PostgreSQL configuration', () => {\n      jest.spyOn(configService, 'get').mockImplementation((key: string) => {\n        const configs: Record<string, string> = {\n          POSTGRES_HOST: 'custom-host',\n          POSTGRES_PORT: '5433',\n          POSTGRES_USER: 'custom_user',\n          POSTGRES_PASSWORD: 'custom_password',\n          POSTGRES_DB: 'custom_database',\n          POSTGRES_SSL: 'true',\n          POSTGRES_POOL_MIN: '5',\n          POSTGRES_POOL_MAX: '20',\n        };\n        return configs[key];\n      });\n\n      const config = service.getPostgreSQLConfig();\n\n      expect(config).toEqual({\n        type: 'postgresql',\n        host: 'custom-host',\n        port: 5433,\n        username: 'custom_user',\n        password: 'custom_password',\n        database: 'custom_database',\n        ssl: true,\n        pool: {\n          min: 5,\n          max: 20,\n          acquireTimeoutMillis: 60000,\n          createTimeoutMillis: 30000,\n          destroyTimeoutMillis: 5000,\n          idleTimeoutMillis: 600000,\n          reapIntervalMillis: 1000,\n          createRetryIntervalMillis: 200,\n        },\n      });\n    });\n\n    it('should handle SSL configuration as object', () => {\n      jest.spyOn(configService, 'get').mockImplementation((key: string) => {\n        if (key === 'POSTGRES_SSL') {\n          return '{\"rejectUnauthorized\": false}';\n        }\n        return undefined;\n      });\n\n      const config = service.getPostgreSQLConfig();\n\n      expect(config.ssl).toEqual({ rejectUnauthorized: false });\n    });\n  });\n\n  describe('getMongoDBConfig', () => {\n    it('should return default MongoDB configuration', () => {\n      jest.spyOn(configService, 'get').mockReturnValue(undefined);\n\n      const config = service.getMongoDBConfig();\n\n      expect(config).toEqual({\n        type: 'mongodb',\n        host: 'localhost',\n        port: 27017,\n        username: 'aiofix_user',\n        password: 'aiofix_password',\n        database: 'aiofix_events',\n        ssl: false,\n        pool: {\n          min: 2,\n          max: 10,\n          acquireTimeoutMillis: 60000,\n          createTimeoutMillis: 30000,\n          destroyTimeoutMillis: 5000,\n          idleTimeoutMillis: 600000,\n          reapIntervalMillis: 1000,\n          createRetryIntervalMillis: 200,\n        },\n      });\n    });\n\n    it('should return configured MongoDB configuration', () => {\n      jest.spyOn(configService, 'get').mockImplementation((key: string) => {\n        const configs: Record<string, string> = {\n          MONGODB_HOST: 'mongo-host',\n          MONGODB_PORT: '27018',\n          MONGODB_USER: 'mongo_user',\n          MONGODB_PASSWORD: 'mongo_password',\n          MONGODB_DB: 'mongo_database',\n          MONGODB_SSL: 'true',\n        };\n        return configs[key];\n      });\n\n      const config = service.getMongoDBConfig();\n\n      expect(config).toEqual({\n        type: 'mongodb',\n        host: 'mongo-host',\n        port: 27018,\n        username: 'mongo_user',\n        password: 'mongo_password',\n        database: 'mongo_database',\n        ssl: true,\n        pool: {\n          min: 2,\n          max: 10,\n          acquireTimeoutMillis: 60000,\n          createTimeoutMillis: 30000,\n          destroyTimeoutMillis: 5000,\n          idleTimeoutMillis: 600000,\n          reapIntervalMillis: 1000,\n          createRetryIntervalMillis: 200,\n        },\n      });\n    });\n  });\n\n  describe('getTenantDatabases', () => {\n    it('should return empty array by default', () => {\n      jest.spyOn(configService, 'get').mockReturnValue(undefined);\n\n      const databases = service.getTenantDatabases();\n      expect(databases).toEqual([]);\n    });\n\n    it('should return configured tenant databases', () => {\n      jest\n        .spyOn(configService, 'get')\n        .mockReturnValue('tenant1,tenant2,tenant3');\n\n      const databases = service.getTenantDatabases();\n      expect(databases).toEqual(['tenant1', 'tenant2', 'tenant3']);\n    });\n\n    it('should handle single tenant database', () => {\n      jest.spyOn(configService, 'get').mockReturnValue('tenant1');\n\n      const databases = service.getTenantDatabases();\n      expect(databases).toEqual(['tenant1']);\n    });\n\n    it('should handle empty string', () => {\n      jest.spyOn(configService, 'get').mockReturnValue('');\n\n      const databases = service.getTenantDatabases();\n      expect(databases).toEqual([]);\n    });\n  });\n\n  describe('validateConfig', () => {\n    it('should validate correct PostgreSQL config', () => {\n      const config = {\n        type: 'postgresql' as const,\n        host: 'localhost',\n        port: 5432,\n        username: 'user',\n        password: 'password',\n        database: 'test_db',\n      };\n\n      const isValid = service.validateConfig(config);\n      expect(isValid).toBe(true);\n    });\n\n    it('should validate correct MongoDB config', () => {\n      const config = {\n        type: 'mongodb' as const,\n        host: 'localhost',\n        port: 27017,\n        username: 'user',\n        password: 'password',\n        database: 'test_db',\n      };\n\n      const isValid = service.validateConfig(config);\n      expect(isValid).toBe(true);\n    });\n\n    it('should reject invalid config with missing required fields', () => {\n      const config = {\n        type: 'postgresql' as const,\n        host: 'localhost',\n        // 缺少 port, username, password, database\n      } as any;\n\n      const isValid = service.validateConfig(config);\n      expect(isValid).toBe(false);\n    });\n\n    it('should reject config with invalid type', () => {\n      const config = {\n        type: 'invalid' as any,\n        host: 'localhost',\n        port: 5432,\n        username: 'user',\n        password: 'password',\n        database: 'test_db',\n      };\n\n      const isValid = service.validateConfig(config);\n      expect(isValid).toBe(false);\n    });\n\n    it('should reject config with invalid port', () => {\n      const config = {\n        type: 'postgresql' as const,\n        host: 'localhost',\n        port: 'invalid' as any,\n        username: 'user',\n        password: 'password',\n        database: 'test_db',\n      };\n\n      const isValid = service.validateConfig(config);\n      expect(isValid).toBe(false);\n    });\n  });\n});\n"],"version":3}