6aa9e83be83fa3e001254baf72d85fdb
"use strict";
/**
 * @file database.module.spec.ts
 * @description 数据库模块单元测试
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock the adapters to avoid actual database connections
jest.mock('./adapters/postgresql.adapter');
jest.mock('./adapters/mongodb.adapter');
const testing_1 = require("@nestjs/testing");
const config_1 = require("@nestjs/config");
const database_module_1 = require("./database.module");
const database_config_1 = require("./config/database.config");
const redis_config_1 = require("./config/redis.config");
const isolation_config_1 = require("./config/isolation.config");
const database_adapter_factory_1 = require("./adapters/database-adapter.factory");
describe('DatabaseModule', () => {
    let module;
    beforeEach(async () => {
        module = await testing_1.Test.createTestingModule({
            imports: [
                config_1.ConfigModule.forRoot({
                    isGlobal: true,
                    envFilePath: '.env.test',
                }),
                database_module_1.DatabaseModule.register({
                    config: {
                        type: 'postgresql',
                        host: 'localhost',
                        port: 5432,
                        username: 'test_user',
                        password: 'test_password',
                        database: 'test_database',
                    },
                    postgresql: false, // 禁用PostgreSQL以避免连接测试
                    mongodb: false, // 禁用MongoDB以避免连接测试
                }),
            ],
        }).compile();
    });
    afterEach(async () => {
        if (module) {
            await module.close();
        }
    });
    describe('Module Registration', () => {
        it('should be defined', () => {
            expect(module).toBeDefined();
        });
        it('should have database config provider', () => {
            const config = module.get('DATABASE_CONFIG');
            expect(config).toBeDefined();
            expect(config.type).toBe('postgresql');
            expect(config.host).toBe('localhost');
            expect(config.port).toBe(5432);
            expect(config.username).toBe('test_user');
            expect(config.password).toBe('test_password');
            expect(config.database).toBe('test_database');
        });
        it('should have database name provider', () => {
            const name = module.get('DATABASE_NAME');
            expect(name).toBeDefined();
            expect(name).toBe('test_database');
        });
    });
    describe('Service Providers', () => {
        it('should provide DatabaseConfigService', () => {
            const service = module.get(database_config_1.DatabaseConfigService);
            expect(service).toBeDefined();
            expect(service).toBeInstanceOf(database_config_1.DatabaseConfigService);
        });
        it('should provide RedisConfigService', () => {
            const service = module.get(redis_config_1.RedisConfigService);
            expect(service).toBeDefined();
            expect(service).toBeInstanceOf(redis_config_1.RedisConfigService);
        });
        it('should provide IsolationConfigService', () => {
            const service = module.get(isolation_config_1.IsolationConfigService);
            expect(service).toBeDefined();
            expect(service).toBeInstanceOf(isolation_config_1.IsolationConfigService);
        });
        it('should provide DatabaseAdapterFactory', () => {
            const factory = module.get(database_adapter_factory_1.DatabaseAdapterFactory);
            expect(factory).toBeDefined();
            expect(factory).toBeInstanceOf(database_adapter_factory_1.DatabaseAdapterFactory);
        });
    });
    describe('Configuration Validation', () => {
        it('should validate PostgreSQL configuration', () => {
            const configService = module.get(database_config_1.DatabaseConfigService);
            const config = configService.getPostgreSQLConfig();
            expect(config).toBeDefined();
            expect(config.type).toBe('postgresql');
            expect(config.host).toBeDefined();
            expect(config.port).toBeDefined();
            expect(config.username).toBeDefined();
            expect(config.password).toBeDefined();
            expect(config.database).toBeDefined();
        });
        it('should validate MongoDB configuration', () => {
            const configService = module.get(database_config_1.DatabaseConfigService);
            const config = configService.getMongoDBConfig();
            expect(config).toBeDefined();
            expect(config.type).toBe('mongodb');
            expect(config.host).toBeDefined();
            expect(config.port).toBeDefined();
            expect(config.username).toBeDefined();
            expect(config.password).toBeDefined();
            expect(config.database).toBeDefined();
        });
        it('should validate Redis configuration', () => {
            const configService = module.get(redis_config_1.RedisConfigService);
            const cacheConfig = configService.getCacheConfig();
            const queueConfig = configService.getMessageQueueConfig();
            const sessionConfig = configService.getSessionConfig();
            expect(cacheConfig).toBeDefined();
            expect(cacheConfig.host).toBeDefined();
            expect(cacheConfig.port).toBeDefined();
            expect(queueConfig).toBeDefined();
            expect(queueConfig.host).toBeDefined();
            expect(queueConfig.port).toBeDefined();
            expect(sessionConfig).toBeDefined();
            expect(sessionConfig.host).toBeDefined();
            expect(sessionConfig.port).toBeDefined();
        });
    });
    describe('Isolation Strategy', () => {
        it('should provide isolation configuration', () => {
            const isolationService = module.get(isolation_config_1.IsolationConfigService);
            const strategy = isolationService.getStrategy();
            expect(strategy).toBeDefined();
            expect(['DATABASE_LEVEL', 'SCHEMA_LEVEL', 'TABLE_LEVEL']).toContain(strategy);
        });
        it('should provide connection configuration', () => {
            const isolationService = module.get(isolation_config_1.IsolationConfigService);
            const config = isolationService.getConnectionConfig('test-tenant');
            expect(config).toBeDefined();
            expect(config.database).toBeDefined();
        });
    });
    describe('Adapter Factory', () => {
        it('should create adapters based on isolation strategy', () => {
            const factory = module.get(database_adapter_factory_1.DatabaseAdapterFactory);
            // 测试创建适配器（不实际连接数据库）
            expect(() => factory.createAdapter('test-tenant')).not.toThrow();
            expect(() => factory.createPlatformAdapter()).not.toThrow();
            expect(() => factory.createEventsAdapter()).not.toThrow();
            expect(() => factory.createAiVectorsAdapter()).not.toThrow();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2RhdGFiYXNlLm1vZHVsZS5zcGVjLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7O0FBVUgseURBQXlEO0FBQ3pELElBQUksQ0FBQyxJQUFJLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLENBQUM7QUFWeEMsNkNBQXNEO0FBQ3RELDJDQUE4QztBQUM5Qyx1REFBbUQ7QUFDbkQsOERBQWlFO0FBQ2pFLHdEQUEyRDtBQUMzRCxnRUFBbUU7QUFDbkUsa0ZBQTZFO0FBTTdFLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLEVBQUU7SUFDOUIsSUFBSSxNQUFxQixDQUFDO0lBRTFCLFVBQVUsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNwQixNQUFNLEdBQUcsTUFBTSxjQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDdEMsT0FBTyxFQUFFO2dCQUNQLHFCQUFZLENBQUMsT0FBTyxDQUFDO29CQUNuQixRQUFRLEVBQUUsSUFBSTtvQkFDZCxXQUFXLEVBQUUsV0FBVztpQkFDekIsQ0FBQztnQkFDRixnQ0FBYyxDQUFDLFFBQVEsQ0FBQztvQkFDdEIsTUFBTSxFQUFFO3dCQUNOLElBQUksRUFBRSxZQUFZO3dCQUNsQixJQUFJLEVBQUUsV0FBVzt3QkFDakIsSUFBSSxFQUFFLElBQUk7d0JBQ1YsUUFBUSxFQUFFLFdBQVc7d0JBQ3JCLFFBQVEsRUFBRSxlQUFlO3dCQUN6QixRQUFRLEVBQUUsZUFBZTtxQkFDMUI7b0JBQ0QsVUFBVSxFQUFFLEtBQUssRUFBRSxzQkFBc0I7b0JBQ3pDLE9BQU8sRUFBRSxLQUFLLEVBQUUsbUJBQW1CO2lCQUNwQyxDQUFDO2FBQ0g7U0FDRixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDZixDQUFDLENBQUMsQ0FBQztJQUVILFNBQVMsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUNu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LENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxHQUFHLEVBQUU7UUFDL0IsRUFBRSxDQUFDLG9EQUFvRCxFQUFFLEdBQUcsRUFBRTtZQUM1RCxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUN4QixpREFBc0IsQ0FDdkIsQ0FBQztZQUVGLG9CQUFvQjtZQUNwQixNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqRSxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLHFCQUFxQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDNUQsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQzFELE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUMvRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvYXJsaWdsZS9WMS9BaW9maXgvYWlvZml4LWFpLXNhYXMtcGxhdGZvcm0vcGFja2FnZXMvZGF0YWJhc2Uvc3JjL2RhdGFiYXNlLm1vZHVsZS5zcGVjLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGZpbGUgZGF0YWJhc2UubW9kdWxlLnNwZWMudHNcbiAqIEBkZXNjcmlwdGlvbiDmlbDmja7lupPmqKHlnZfljZXlhYPmtYvor5VcbiAqL1xuXG5pbXBvcnQgeyBUZXN0LCBUZXN0aW5nTW9kdWxlIH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IENvbmZpZ01vZHVsZSB9IGZyb20gJ0BuZXN0anMvY29uZmlnJztcbmltcG9ydCB7IERhdGFiYXNlTW9kdWxlIH0gZnJvbSAnLi9kYXRhYmFzZS5tb2R1bGUnO1xuaW1wb3J0IHsgRGF0YWJhc2VDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi9jb25maWcvZGF0YWJhc2UuY29uZmlnJztcbmltcG9ydCB7IFJlZGlzQ29uZmlnU2VydmljZSB9IGZyb20gJy4vY29uZmlnL3JlZGlzLmNvbmZpZyc7XG5pbXBvcnQgeyBJc29sYXRpb25Db25maWdTZXJ2aWNlIH0gZnJvbSAnLi9jb25maWcvaXNvbGF0aW9uLmNvbmZpZyc7XG5pbXBvcnQgeyBEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5IH0gZnJvbSAnLi9hZGFwdGVycy9kYXRhYmFzZS1hZGFwdGVyLmZhY3RvcnknO1xuXG4vLyBNb2NrIHRoZSBhZGFwdGVycyB0byBhdm9pZCBhY3R1YWwgZGF0YWJhc2UgY29ubmVjdGlvbnNcbmplc3QubW9jaygnLi9hZGFwdGVycy9wb3N0Z3Jlc3FsLmFkYXB0ZXInKTtcbmplc3QubW9jaygnLi9hZGFwdGVycy9tb25nb2RiLmFkYXB0ZXInKTtcblxuZGVzY3JpYmUoJ0RhdGFiYXNlTW9kdWxlJywgKCkgPT4ge1xuICBsZXQgbW9kdWxlOiBUZXN0aW5nTW9kdWxlO1xuXG4gIGJlZm9yZUVhY2goYXN5bmMgKCkgPT4ge1xuICAgIG1vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG4gICAgICBpbXBvcnRzOiBbXG4gICAgICAgIENvbmZpZ01vZHVsZS5mb3JSb290KHtcbiAgICAgICAgICBpc0dsb2JhbDogdHJ1ZSxcbiAgICAgICAgICBlbnZGaWxlUGF0aDogJy5lbnYudGVzdCcsXG4gICAgICAgIH0pLFxuICAgICAgICBEYXRhYmFzZU1vZHVsZS5yZWdpc3Rlcih7XG4gICAgICAgICAgY29uZmlnOiB7XG4gICAgICAgICAgICB0eXBlOiAncG9zdGdyZXNxbCcsXG4gICAgICAgICAgICBob3N0OiAnbG9jYWxob3N0JyxcbiAgICAgICAgICAgIHBvcnQ6IDU0MzIsXG4gICAgICAgICAgICB1c2VybmFtZTogJ3Rlc3RfdXNlcicsXG4gICAgICAgICAgICBwYXNzd29yZDogJ3Rlc3RfcGFzc3dvcmQnLFxuICAgICAgICAgICAgZGF0YWJhc2U6ICd0ZXN0X2RhdGFiYXNlJyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIHBvc3RncmVzcWw6IGZhbHNlLCAvLyDnpoHnlKhQb3N0Z3JlU1FM5Lul6YG/5YWN6L+e5o6l5rWL6K+VXG4gICAgICAgICAgbW9uZ29kYjogZmFsc2UsIC8vIOemgeeUqE1vbmdvRELku6Xpgb/lhY3ov57mjqXmtYvor5VcbiAgICAgICAgfSksXG4gICAgICBdLFxuICAgIH0pLmNvbXBpbGUoKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICBpZiAobW9kdWxlKSB7XG4gICAgICBhd2FpdCBtb2R1bGUuY2xvc2UoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdNb2R1bGUgUmVnaXN0cmF0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYmUgZGVmaW5lZCcsICgpID0+IHtcbiAgICAgIGV4cGVjdChtb2R1bGUpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhdmUgZGF0YWJhc2UgY29uZmlnIHByb3ZpZGVyJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnID0gbW9kdWxlLmdldCgnREFUQUJBU0VfQ09ORklHJyk7XG4gICAgICBleHBlY3QoY29uZmlnKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy50eXBlKS50b0JlKCdwb3N0Z3Jlc3FsJyk7XG4gICAgICBleHBlY3QoY29uZmlnLmhvc3QpLnRvQmUoJ2xvY2FsaG9zdCcpO1xuICAgICAgZXhwZWN0KGNvbmZpZy5wb3J0KS50b0JlKDU0MzIpO1xuICAgICAgZXhwZWN0KGNvbmZpZy51c2VybmFtZSkudG9CZSgndGVzdF91c2VyJyk7XG4gICAgICBleHBlY3QoY29uZmlnLnBhc3N3b3JkKS50b0JlKCd0ZXN0X3Bhc3N3b3JkJyk7XG4gICAgICBleHBlY3QoY29uZmlnLmRhdGFiYXNlKS50b0JlKCd0ZXN0X2RhdGFiYXNlJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhdmUgZGF0YWJhc2UgbmFtZSBwcm92aWRlcicsICgpID0+IHtcbiAgICAgIGNvbnN0IG5hbWUgPSBtb2R1bGUuZ2V0KCdEQVRBQkFTRV9OQU1FJyk7XG4gICAgICBleHBlY3QobmFtZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChuYW1lKS50b0JlKCd0ZXN0X2RhdGFiYXNlJyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdTZXJ2aWNlIFByb3ZpZGVycycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHByb3ZpZGUgRGF0YWJhc2VDb25maWdTZXJ2aWNlJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2VydmljZSA9IG1vZHVsZS5nZXQ8RGF0YWJhc2VDb25maWdTZXJ2aWNlPihEYXRhYmFzZUNvbmZpZ1NlcnZpY2UpO1xuICAgICAgZXhwZWN0KHNlcnZpY2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3Qoc2VydmljZSkudG9CZUluc3RhbmNlT2YoRGF0YWJhc2VDb25maWdTZXJ2aWNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcHJvdmlkZSBSZWRpc0NvbmZpZ1NlcnZpY2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXJ2aWNlID0gbW9kdWxlLmdldDxSZWRpc0NvbmZpZ1NlcnZpY2U+KFJlZGlzQ29uZmlnU2VydmljZSk7XG4gICAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlSW5zdGFuY2VPZihSZWRpc0NvbmZpZ1NlcnZpY2UpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcm92aWRlIElzb2xhdGlvbkNvbmZpZ1NlcnZpY2UnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzZXJ2aWNlID0gbW9kdWxlLmdldDxJc29sYXRpb25Db25maWdTZXJ2aWNlPihcbiAgICAgICAgSXNvbGF0aW9uQ29uZmlnU2VydmljZSxcbiAgICAgICk7XG4gICAgICBleHBlY3Qoc2VydmljZSkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChzZXJ2aWNlKS50b0JlSW5zdGFuY2VPZihJc29sYXRpb25Db25maWdTZXJ2aWNlKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcHJvdmlkZSBEYXRhYmFzZUFkYXB0ZXJGYWN0b3J5JywgKCkgPT4ge1xuICAgICAgY29uc3QgZmFjdG9yeSA9IG1vZHVsZS5nZXQ8RGF0YWJhc2VBZGFwdGVyRmFjdG9yeT4oXG4gICAgICAgIERhdGFiYXNlQWRhcHRlckZhY3RvcnksXG4gICAgICApO1xuICAgICAgZXhwZWN0KGZhY3RvcnkpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoZmFjdG9yeSkudG9CZUluc3RhbmNlT2YoRGF0YWJhc2VBZGFwdGVyRmFjdG9yeSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDb25maWd1cmF0aW9uIFZhbGlkYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCB2YWxpZGF0ZSBQb3N0Z3JlU1FMIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWdTZXJ2aWNlID0gbW9kdWxlLmdldDxEYXRhYmFzZUNvbmZpZ1NlcnZpY2U+KFxuICAgICAgICBEYXRhYmFzZUNvbmZpZ1NlcnZpY2UsXG4gICAgICApO1xuICAgICAgY29uc3QgY29uZmlnID0gY29uZmlnU2VydmljZS5nZXRQb3N0Z3JlU1FMQ29uZmlnKCk7XG5cbiAgICAgIGV4cGVjdChjb25maWcpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnR5cGUpLnRvQmUoJ3Bvc3RncmVzcWwnKTtcbiAgICAgIGV4cGVjdChjb25maWcuaG9zdCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcucG9ydCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcudXNlcm5hbWUpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnBhc3N3b3JkKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy5kYXRhYmFzZSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdmFsaWRhdGUgTW9uZ29EQiBjb25maWd1cmF0aW9uJywgKCkgPT4ge1xuICAgICAgY29uc3QgY29uZmlnU2VydmljZSA9IG1vZHVsZS5nZXQ8RGF0YWJhc2VDb25maWdTZXJ2aWNlPihcbiAgICAgICAgRGF0YWJhc2VDb25maWdTZXJ2aWNlLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IGNvbmZpZ1NlcnZpY2UuZ2V0TW9uZ29EQkNvbmZpZygpO1xuXG4gICAgICBleHBlY3QoY29uZmlnKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy50eXBlKS50b0JlKCdtb25nb2RiJyk7XG4gICAgICBleHBlY3QoY29uZmlnLmhvc3QpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnBvcnQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY29uZmlnLnVzZXJuYW1lKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNvbmZpZy5wYXNzd29yZCkudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcuZGF0YWJhc2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHZhbGlkYXRlIFJlZGlzIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWdTZXJ2aWNlID0gbW9kdWxlLmdldDxSZWRpc0NvbmZpZ1NlcnZpY2U+KFJlZGlzQ29uZmlnU2VydmljZSk7XG4gICAgICBjb25zdCBjYWNoZUNvbmZpZyA9IGNvbmZpZ1NlcnZpY2UuZ2V0Q2FjaGVDb25maWcoKTtcbiAgICAgIGNvbnN0IHF1ZXVlQ29uZmlnID0gY29uZmlnU2VydmljZS5nZXRNZXNzYWdlUXVldWVDb25maWcoKTtcbiAgICAgIGNvbnN0IHNlc3Npb25Db25maWcgPSBjb25maWdTZXJ2aWNlLmdldFNlc3Npb25Db25maWcoKTtcblxuICAgICAgZXhwZWN0KGNhY2hlQ29uZmlnKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGNhY2hlQ29uZmlnLmhvc3QpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoY2FjaGVDb25maWcucG9ydCkudG9CZURlZmluZWQoKTtcblxuICAgICAgZXhwZWN0KHF1ZXVlQ29uZmlnKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHF1ZXVlQ29uZmlnLmhvc3QpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocXVldWVDb25maWcucG9ydCkudG9CZURlZmluZWQoKTtcblxuICAgICAgZXhwZWN0KHNlc3Npb25Db25maWcpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3Qoc2Vzc2lvbkNvbmZpZy5ob3N0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHNlc3Npb25Db25maWcucG9ydCkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0lzb2xhdGlvbiBTdHJhdGVneScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHByb3ZpZGUgaXNvbGF0aW9uIGNvbmZpZ3VyYXRpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCBpc29sYXRpb25TZXJ2aWNlID0gbW9kdWxlLmdldDxJc29sYXRpb25Db25maWdTZXJ2aWNlPihcbiAgICAgICAgSXNvbGF0aW9uQ29uZmlnU2VydmljZSxcbiAgICAgICk7XG4gICAgICBjb25zdCBzdHJhdGVneSA9IGlzb2xhdGlvblNlcnZpY2UuZ2V0U3RyYXRlZ3koKTtcblxuICAgICAgZXhwZWN0KHN0cmF0ZWd5KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KFsnREFUQUJBU0VfTEVWRUwnLCAnU0NIRU1BX0xFVkVMJywgJ1RBQkxFX0xFVkVMJ10pLnRvQ29udGFpbihcbiAgICAgICAgc3RyYXRlZ3ksXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBwcm92aWRlIGNvbm5lY3Rpb24gY29uZmlndXJhdGlvbicsICgpID0+IHtcbiAgICAgIGNvbnN0IGlzb2xhdGlvblNlcnZpY2UgPSBtb2R1bGUuZ2V0PElzb2xhdGlvbkNvbmZpZ1NlcnZpY2U+KFxuICAgICAgICBJc29sYXRpb25Db25maWdTZXJ2aWNlLFxuICAgICAgKTtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IGlzb2xhdGlvblNlcnZpY2UuZ2V0Q29ubmVjdGlvbkNvbmZpZygndGVzdC10ZW5hbnQnKTtcblxuICAgICAgZXhwZWN0KGNvbmZpZykudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChjb25maWcuZGF0YWJhc2UpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdBZGFwdGVyIEZhY3RvcnknLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYWRhcHRlcnMgYmFzZWQgb24gaXNvbGF0aW9uIHN0cmF0ZWd5JywgKCkgPT4ge1xuICAgICAgY29uc3QgZmFjdG9yeSA9IG1vZHVsZS5nZXQ8RGF0YWJhc2VBZGFwdGVyRmFjdG9yeT4oXG4gICAgICAgIERhdGFiYXNlQWRhcHRlckZhY3RvcnksXG4gICAgICApO1xuXG4gICAgICAvLyDmtYvor5XliJvlu7rpgILphY3lmajvvIjkuI3lrp7pmYXov57mjqXmlbDmja7lupPvvIlcbiAgICAgIGV4cGVjdCgoKSA9PiBmYWN0b3J5LmNyZWF0ZUFkYXB0ZXIoJ3Rlc3QtdGVuYW50JykpLm5vdC50b1Rocm93KCk7XG4gICAgICBleHBlY3QoKCkgPT4gZmFjdG9yeS5jcmVhdGVQbGF0Zm9ybUFkYXB0ZXIoKSkubm90LnRvVGhyb3coKTtcbiAgICAgIGV4cGVjdCgoKSA9PiBmYWN0b3J5LmNyZWF0ZUV2ZW50c0FkYXB0ZXIoKSkubm90LnRvVGhyb3coKTtcbiAgICAgIGV4cGVjdCgoKSA9PiBmYWN0b3J5LmNyZWF0ZUFpVmVjdG9yc0FkYXB0ZXIoKSkubm90LnRvVGhyb3coKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==