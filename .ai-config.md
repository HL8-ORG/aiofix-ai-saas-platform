# AI开发配置文件

## 项目信息

**项目名称**：SAAS平台  
**项目类型**：多租户SAAS平台  
**架构模式**：DDD + Clean Architecture + CQRS + 事件溯源  
**技术栈**：NestJS + TypeScript + MikroORM + PostgreSQL + MongoDB + Redis  

## 开发规范

### 语言和注释
- 使用中文回答问题和编写注释
- 修改代码时应当同时修改相应的注释，确保代码与注释一致
- 所有业务逻辑必须有详细的中文注释说明

### 包管理器
- 使用`pnpm`作为包管理器
- 所有依赖安装使用`pnpm install`
- 脚本执行使用`pnpm run`

### 代码质量
- 完成代码编写后应当进行代码`linter`检查，及时修复报错
- 检查或者修复eslint报错时，应当调用mcp-server来参与
- 开发任务完成后应当进行编译检查，及时处理报错

### 文件创建策略
- 创建文件的时候，优先采用分段创建文件的策略，避免工具调用超时
- 大文件应当拆分为多个小文件
- 复杂功能应当分步骤实现

## 项目架构

### 分层架构
```
Interface Layer (接口层)
├── Controllers (控制器)
├── DTOs (数据传输对象)
├── Guards (守卫)
└── Interceptors (拦截器)

Application Layer (应用层)
├── Commands (命令)
├── Queries (查询)
├── Command Handlers (命令处理器)
├── Query Handlers (查询处理器)
├── Event Handlers (事件处理器)
└── Application Services (应用服务)

Domain Layer (领域层)
├── Aggregates (聚合根)
├── Entities (实体)
├── Value Objects (值对象)
├── Domain Services (领域服务)
├── Domain Events (领域事件)
└── Repository Interfaces (仓储接口)

Infrastructure Layer (基础设施层)
├── Repositories (仓储实现)
├── Event Store (事件存储)
├── Database Entities (数据库实体)
├── External Services (外部服务)
└── Configuration (配置)
```

### 核心概念
- **聚合根**：User、Tenant、Organization、Department、Role等
- **领域事件**：UserCreatedEvent、TenantAssignedEvent等
- **命令**：CreateUserCommand、AssignUserToTenantCommand等
- **查询**：GetUserQuery、GetUsersQuery等
- **仓储**：IUserRepository、ITenantRepository等

### 数据隔离
- **五层数据隔离**：Platform → Tenant → Organization → Department → User
- **数据分类**：可共享数据、受保护数据
- **权限控制**：基于角色的访问控制（RBAC）

## 业务规则

### 用户管理
- 所有用户首先都是平台用户，然后可能成为租户用户
- 用户不能同时被分配到不同租户
- 租户用户可以被分配到同一租户的不同组织和部门（兼职）
- 用户离开租户后仍然是平台用户

### 权限管理
- **8种基础角色**：平台管理员、租户管理员、组织管理员、部门管理员、个人用户、租户用户、系统管理员、服务账户
- **权限继承**：下级权限自动继承上级权限
- **最小权限原则**：用户只能获得完成工作所需的最小权限
- **实时权限验证**：每次数据访问都需要实时权限验证

### 数据访问控制
- **平台级数据访问**：平台管理员可以访问所有平台数据
- **租户级数据访问**：租户管理员可以访问租户内所有数据
- **组织级数据访问**：组织管理员可以访问组织内数据
- **部门级数据访问**：部门管理员可以访问部门内数据
- **用户级数据访问**：用户只能访问自己的数据

## 技术实现

### 数据库设计
- **PostgreSQL**：用于结构化数据（用户、租户、组织等）
- **MongoDB**：用于非结构化数据（日志、配置等）
- **Redis**：用于缓存和会话存储
- **MikroORM**：统一ORM，支持PostgreSQL和MongoDB

### 事件溯源
- 所有状态变更都通过事件记录
- 支持时间旅行和审计
- 事件存储支持PostgreSQL和MongoDB
- 快照机制优化性能

### 性能优化
- 使用Redis缓存
- 事件溯源快照机制
- 数据库查询优化
- 异步事件处理

## 开发流程

### 1. 需求分析
- 阅读业务需求文档：`docs/business-requirements.md`
- 理解业务规则和用户故事
- 确定技术实现方案

### 2. 架构设计
- 参考技术设计文档：`docs/technical-design/README.md`
- 设计领域模型
- 确定数据隔离策略

### 3. 代码实现
- 按照分层架构实现代码
- 遵循DDD和Clean Architecture原则
- 实现完整的业务逻辑

### 4. 测试开发
- 单元测试：测试业务逻辑
- 集成测试：测试组件协作
- 端到端测试：测试完整流程

### 5. 质量检查
- 代码linter检查
- 编译检查
- 测试覆盖率检查

## 文档参考

### 核心文档
- **业务需求文档**：`docs/business-requirements.md`
- **技术设计文档**：`docs/technical-design/README.md`
- **AI开发提示词**：`docs/ai-development-prompts.md`
- **快速参考提示词**：`docs/ai-prompts-quick-reference.md`

### 技术设计子文档
- **架构概述**：`docs/technical-design/01-architecture-overview.md`
- **分层架构设计**：`docs/technical-design/02-layered-architecture.md`
- **核心模块与组件设计**：`docs/technical-design/03-core-modules.md`
- **领域模型设计**：`docs/technical-design/04-domain-models.md`
- **应用层实现**：`docs/technical-design/05-application-layer.md`
- **基础设施实现**：`docs/technical-design/06-infrastructure.md`
- **事件溯源设计**：`docs/technical-design/07-event-sourcing.md`
- **部署与运维**：`docs/technical-design/08-deployment.md`
- **多租户数据隔离**：`docs/technical-design/09-multitenant.md`
- **总结**：`docs/technical-design/10-summary.md`

## 常用命令

### 开发命令
```bash
# 安装依赖
pnpm install

# 启动开发服务器
pnpm run start:dev

# 运行测试
pnpm run test

# 代码检查
pnpm run lint

# 代码格式化
pnpm run format

# 构建项目
pnpm run build
```

### 数据库命令
```bash
# 生成迁移文件
pnpm run migration:create

# 运行迁移
pnpm run migration:run

# 回滚迁移
pnpm run migration:revert

# 生成实体
pnpm run entity:create
```

## 注意事项

1. **数据隔离**：所有数据操作都必须考虑多租户数据隔离
2. **权限控制**：所有API端点都必须进行权限验证
3. **事件溯源**：所有状态变更都必须通过事件记录
4. **性能优化**：考虑缓存、索引、异步处理等性能优化
5. **错误处理**：实现优雅的错误处理和恢复机制
6. **测试覆盖**：确保足够的测试覆盖率
7. **文档更新**：代码变更时同步更新相关文档
8. **安全考虑**：注意数据安全和系统安全

## 联系方式

如有问题，请参考项目文档或联系项目团队。
